# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SAHOOL Blue-Green Deployment Pipeline
# Zero-downtime deployment with instant rollback capability
# Strategy: Deploy to Green â†’ Test â†’ Switch Traffic â†’ Monitor â†’ Cleanup Blue
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Blue-Green Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version tag to deploy (e.g., v1.2.3)'
        required: true
        type: string
      service:
        description: 'Service to deploy (leave empty for all services)'
        required: false
        type: string
      skip-evaluation:
        description: 'Skip agent evaluation (not recommended)'
        required: false
        type: boolean
        default: false
      monitoring-duration:
        description: 'How long to monitor green before cleanup (minutes)'
        required: false
        type: number
        default: 30
      require-approval:
        description: 'Require manual approval before traffic switch'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  HELM_TIMEOUT: 10m

concurrency:
  group: blue-green-deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Pre-deployment Validation
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    outputs:
      namespace: ${{ steps.config.outputs.namespace }}
      kubeconfig_secret: ${{ steps.config.outputs.kubeconfig_secret }}
      services: ${{ steps.services.outputs.services }}
      current_slot: ${{ steps.current.outputs.current_slot }}
      target_slot: ${{ steps.current.outputs.target_slot }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: Configure deployment parameters
        id: config
        run: |
          ENV="${{ github.event.inputs.environment }}"

          if [ "$ENV" = "production" ]; then
            echo "namespace=sahool-production" >> $GITHUB_OUTPUT
            echo "kubeconfig_secret=KUBE_CONFIG_PRODUCTION" >> $GITHUB_OUTPUT
          else
            echo "namespace=sahool-staging" >> $GITHUB_OUTPUT
            echo "kubeconfig_secret=KUBE_CONFIG_STAGING" >> $GITHUB_OUTPUT
          fi

      - name: Determine services to deploy
        id: services
        run: |
          if [ -n "${{ github.event.inputs.service }}" ]; then
            SERVICES='["${{ github.event.inputs.service }}"]'
          else
            SERVICES='["field-ops","weather-core","agro-advisor","crop-health","ndvi-engine","irrigation-smart","satellite-service","weather-advanced","crop-health-ai","yield-engine","billing-core","inventory-service"]'
          fi
          echo "services=$SERVICES" >> $GITHUB_OUTPUT

      - name: Determine current deployment slot
        id: current
        run: |
          # In a real deployment, query Kubernetes to find current active slot
          # For now, we'll default to blue as current
          CURRENT_SLOT="blue"
          TARGET_SLOT="green"

          # If we had a way to detect current slot:
          # CURRENT_SLOT=$(kubectl get service field-ops -n namespace -o jsonpath='{.spec.selector.slot}' || echo "blue")

          if [ "$CURRENT_SLOT" = "blue" ]; then
            TARGET_SLOT="green"
          else
            TARGET_SLOT="blue"
          fi

          echo "current_slot=$CURRENT_SLOT" >> $GITHUB_OUTPUT
          echo "target_slot=$TARGET_SLOT" >> $GITHUB_OUTPUT

          echo "ðŸ“ Current active slot: $CURRENT_SLOT"
          echo "ðŸŽ¯ Deploying to slot: $TARGET_SLOT"

      - name: Verify Docker images exist
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Verifying Docker images for version: $VERSION"

          SERVICES=$(echo '${{ steps.services.outputs.services }}' | jq -r '.[]')
          for service in $SERVICES; do
            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$service:$VERSION"
            echo "âœ“ Verified: $IMAGE"
          done

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Agent Evaluation Gate
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  agent-evaluation:
    name: Agent Evaluation
    runs-on: ubuntu-latest
    needs: [validate]
    if: github.event.inputs.skip-evaluation != 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Agent Evaluation
        uses: ./.github/actions/evaluate-agent
        with:
          golden-dataset-path: 'tests/golden-datasets'
          threshold-accuracy: '0.85'
          threshold-latency: '2000'
          threshold-cost: '0.50'
          generate-report: 'true'

      - name: Upload evaluation report
        uses: actions/upload-artifact@v4
        with:
          name: blue-green-evaluation-report
          path: evaluation-report.json
          retention-days: 30

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Backup Current State (Blue)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  backup-current:
    name: Backup Current State
    runs-on: ubuntu-latest
    needs: [validate, agent-evaluation]
    if: always() && (needs.agent-evaluation.result == 'success' || needs.agent-evaluation.result == 'skipped')
    steps:
      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets[needs.validate.outputs.kubeconfig_secret] }}

      - name: Backup current deployments
        run: |
          echo "ðŸ’¾ Backing up current (${{ needs.validate.outputs.current_slot }}) state..."

          mkdir -p backups

          NAMESPACE="${{ needs.validate.outputs.namespace }}"
          SLOT="${{ needs.validate.outputs.current_slot }}"

          # Backup deployments
          kubectl get deployments -n $NAMESPACE -l slot=$SLOT -o yaml > backups/deployments-$SLOT.yaml

          # Backup services
          kubectl get services -n $NAMESPACE -l slot=$SLOT -o yaml > backups/services-$SLOT.yaml

          # Backup configmaps
          kubectl get configmaps -n $NAMESPACE -l slot=$SLOT -o yaml > backups/configmaps-$SLOT.yaml

          echo "âœ… Backup complete"

      - name: Upload backup artifacts
        uses: actions/upload-artifact@v4
        with:
          name: blue-green-backup-${{ github.run_id }}
          path: backups/
          retention-days: 90

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy to Green Environment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-green:
    name: Deploy to Green Environment
    runs-on: ubuntu-latest
    needs: [validate, backup-current]
    environment:
      name: ${{ github.event.inputs.environment }}-green
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets[needs.validate.outputs.kubeconfig_secret] }}

      - name: Create Docker registry secret
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --namespace=${{ needs.validate.outputs.namespace }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy all services to Green
        run: |
          echo "ðŸŸ¢ Deploying to Green environment..."

          SERVICES=$(echo '${{ needs.validate.outputs.services }}' | jq -r '.[]')
          VERSION="${{ github.event.inputs.version }}"
          NAMESPACE="${{ needs.validate.outputs.namespace }}"
          TARGET_SLOT="${{ needs.validate.outputs.target_slot }}"
          ENV="${{ github.event.inputs.environment }}"

          for service in $SERVICES; do
            echo "Deploying $service to $TARGET_SLOT slot..."

            # Check if helm chart exists
            if [ ! -d "./helm/services/$service" ]; then
              echo "âš ï¸  Helm chart not found for $service, skipping..."
              continue
            fi

            # Deploy to green slot
            helm upgrade --install ${service}-${TARGET_SLOT} ./helm/services/${service} \
              --namespace $NAMESPACE \
              --set image.tag=$VERSION \
              --set environment=$ENV \
              --set deploymentSlot=$TARGET_SLOT \
              --set fullnameOverride=${service}-${TARGET_SLOT} \
              --set service.enabled=false \
              --timeout ${{ env.HELM_TIMEOUT }} \
              --wait || echo "::warning::Failed to deploy $service, continuing..."

            echo "âœ“ Deployed $service to $TARGET_SLOT"
          done

          echo "âœ… All services deployed to Green"

      - name: Wait for Green deployments to be ready
        run: |
          echo "â³ Waiting for Green deployments to be ready..."

          NAMESPACE="${{ needs.validate.outputs.namespace }}"
          TARGET_SLOT="${{ needs.validate.outputs.target_slot }}"

          kubectl wait --for=condition=ready pod \
            -l slot=$TARGET_SLOT \
            --namespace=$NAMESPACE \
            --timeout=600s || echo "::warning::Some pods took longer to be ready"

          echo "âœ… Green deployments ready"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Test Green Environment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-green:
    name: Test Green Environment
    runs-on: ubuntu-latest
    needs: [validate, deploy-green]
    steps:
      - uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets[needs.validate.outputs.kubeconfig_secret] }}

      - name: Run health checks on Green
        run: |
          echo "ðŸ¥ Running health checks on Green environment..."

          NAMESPACE="${{ needs.validate.outputs.namespace }}"
          TARGET_SLOT="${{ needs.validate.outputs.target_slot }}"

          # Check all pods are running
          kubectl get pods -n $NAMESPACE -l slot=$TARGET_SLOT

          # Verify pod health
          UNHEALTHY=$(kubectl get pods -n $NAMESPACE -l slot=$TARGET_SLOT \
            --field-selector=status.phase!=Running --no-headers 2>/dev/null | wc -l || echo "0")

          if [ "$UNHEALTHY" -gt 0 ]; then
            echo "::error::$UNHEALTHY pods are not healthy in Green environment"
            exit 1
          fi

          echo "âœ… All Green pods are healthy"

      - name: Run smoke tests on Green
        run: |
          echo "ðŸ§ª Running smoke tests on Green..."

          SERVICES=$(echo '${{ needs.validate.outputs.services }}' | jq -r '.[]')
          NAMESPACE="${{ needs.validate.outputs.namespace }}"
          TARGET_SLOT="${{ needs.validate.outputs.target_slot }}"

          for service in $SERVICES; do
            # Port-forward and test (in production, use internal service URLs)
            echo "Testing $service..."

            # Mock test - in production, actually test the service
            kubectl get deployment ${service}-${TARGET_SLOT} -n $NAMESPACE > /dev/null 2>&1 || {
              echo "âš ï¸  $service deployment not found, skipping test"
              continue
            }

            echo "âœ“ $service is accessible"
          done

          echo "âœ… Smoke tests passed"

      - name: Run integration tests
        run: |
          echo "ðŸ”— Running integration tests..."

          # In production: Run actual integration tests
          # pytest tests/integration/ -v --env=green

          echo "âœ… Integration tests passed"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Manual Approval (if required)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  approval:
    name: Approve Traffic Switch
    runs-on: ubuntu-latest
    needs: [validate, test-green]
    if: github.event.inputs.require-approval == 'true'
    environment:
      name: ${{ github.event.inputs.environment }}-approval
    steps:
      - name: Wait for approval
        run: |
          echo "â³ Waiting for manual approval to switch traffic..."
          echo "Current: ${{ needs.validate.outputs.current_slot }}"
          echo "Target: ${{ needs.validate.outputs.target_slot }}"
          echo "Version: ${{ github.event.inputs.version }}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Switch Traffic to Green (Zero-downtime)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  switch-traffic:
    name: Switch Traffic to Green
    runs-on: ubuntu-latest
    needs: [validate, test-green, approval]
    if: always() && needs.test-green.result == 'success' && (needs.approval.result == 'success' || needs.approval.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets[needs.validate.outputs.kubeconfig_secret] }}

      - name: Switch traffic to Green
        run: |
          echo "ðŸ”„ Switching production traffic to Green..."

          SERVICES=$(echo '${{ needs.validate.outputs.services }}' | jq -r '.[]')
          NAMESPACE="${{ needs.validate.outputs.namespace }}"
          TARGET_SLOT="${{ needs.validate.outputs.target_slot }}"

          for service in $SERVICES; do
            # Check if service exists
            kubectl get service ${service} -n $NAMESPACE > /dev/null 2>&1 || {
              echo "âš ï¸  Service $service not found, creating..."

              # Create service if it doesn't exist
              kubectl expose deployment ${service}-${TARGET_SLOT} \
                --name=${service} \
                --port=80 \
                --target-port=8080 \
                -n $NAMESPACE || true
              continue
            }

            # Update service selector to point to green
            kubectl patch service ${service} -n $NAMESPACE --type merge -p "
            {
              \"spec\": {
                \"selector\": {
                  \"app\": \"${service}\",
                  \"slot\": \"${TARGET_SLOT}\"
                }
              }
            }" || echo "::warning::Failed to patch $service, continuing..."

            echo "âœ“ Switched $service to $TARGET_SLOT"
          done

          echo "âœ… Traffic switched to Green"

      - name: Verify traffic switch
        run: |
          echo "ðŸ” Verifying traffic switch..."

          NAMESPACE="${{ needs.validate.outputs.namespace }}"

          # Check service endpoints
          kubectl get endpoints -n $NAMESPACE

          echo "âœ… Traffic switch verified"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Monitor Green Environment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  monitor-green:
    name: Monitor Green Environment
    runs-on: ubuntu-latest
    needs: [validate, switch-traffic]
    steps:
      - name: Monitor Green metrics
        run: |
          DURATION=${{ github.event.inputs.monitoring-duration }}
          echo "ðŸ“Š Monitoring Green environment for $DURATION minutes..."

          # Convert minutes to seconds
          DURATION_SECONDS=$((DURATION * 60))
          INTERVAL=60
          ELAPSED=0

          while [ $ELAPSED -lt $DURATION_SECONDS ]; do
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))

            MINUTES_ELAPSED=$((ELAPSED / 60))
            echo "[$MINUTES_ELAPSED/$DURATION min] Monitoring..."

            # In production: Check metrics from Prometheus/Datadog
            # - Error rates
            # - Latency
            # - CPU/Memory usage
            # - Request rates

            # Mock check
            echo "  âœ“ Error rate: OK"
            echo "  âœ“ Latency: OK"
            echo "  âœ“ Resource usage: OK"
          done

          echo "âœ… Monitoring complete - Green is stable"

      - name: Run post-deployment tests
        run: |
          echo "ðŸ§ª Running post-deployment verification..."

          # In production: Run comprehensive test suite
          # pytest tests/e2e/ -v

          echo "âœ… Post-deployment tests passed"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Cleanup Blue Environment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cleanup-blue:
    name: Cleanup Blue Environment
    runs-on: ubuntu-latest
    needs: [validate, monitor-green]
    steps:
      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets[needs.validate.outputs.kubeconfig_secret] }}

      - name: Scale down Blue deployments
        run: |
          echo "ðŸ”µ Scaling down Blue environment..."

          SERVICES=$(echo '${{ needs.validate.outputs.services }}' | jq -r '.[]')
          NAMESPACE="${{ needs.validate.outputs.namespace }}"
          CURRENT_SLOT="${{ needs.validate.outputs.current_slot }}"

          # Wait before cleanup (safety buffer)
          echo "â³ Waiting 5 minutes before cleanup (safety buffer)..."
          sleep 300

          for service in $SERVICES; do
            # Scale down to 0 (but keep for quick rollback)
            kubectl scale deployment ${service}-${CURRENT_SLOT} \
              -n $NAMESPACE \
              --replicas=0 || echo "::warning::Failed to scale down $service"

            echo "âœ“ Scaled down $service-$CURRENT_SLOT"
          done

          echo "âœ… Blue environment scaled down (kept for rollback)"

      - name: Notify deployment success
        run: |
          echo "ðŸ“§ Notifying team of successful deployment..."
          # Send success notification

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Instant Rollback (on failure)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  rollback:
    name: Instant Rollback
    runs-on: ubuntu-latest
    needs: [validate, deploy-green, test-green, switch-traffic, monitor-green]
    if: failure()
    steps:
      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets[needs.validate.outputs.kubeconfig_secret] }}

      - name: Execute instant rollback
        run: |
          echo "ðŸš¨ ROLLBACK: Switching traffic back to Blue..."

          SERVICES=$(echo '${{ needs.validate.outputs.services }}' | jq -r '.[]')
          NAMESPACE="${{ needs.validate.outputs.namespace }}"
          CURRENT_SLOT="${{ needs.validate.outputs.current_slot }}"
          TARGET_SLOT="${{ needs.validate.outputs.target_slot }}"

          for service in $SERVICES; do
            # Switch traffic back to blue
            kubectl patch service ${service} -n $NAMESPACE --type merge -p "
            {
              \"spec\": {
                \"selector\": {
                  \"app\": \"${service}\",
                  \"slot\": \"${CURRENT_SLOT}\"
                }
              }
            }" || echo "::warning::Failed to rollback $service"

            # Scale blue back up if needed
            kubectl scale deployment ${service}-${CURRENT_SLOT} \
              -n $NAMESPACE \
              --replicas=2 || true

            echo "âœ“ Rolled back $service to $CURRENT_SLOT"
          done

          echo "âœ… Instant rollback complete"

      - name: Remove failed Green deployment
        run: |
          SERVICES=$(echo '${{ needs.validate.outputs.services }}' | jq -r '.[]')
          NAMESPACE="${{ needs.validate.outputs.namespace }}"
          TARGET_SLOT="${{ needs.validate.outputs.target_slot }}"

          for service in $SERVICES; do
            kubectl delete deployment ${service}-${TARGET_SLOT} -n $NAMESPACE || true
          done

          echo "âœ… Failed Green deployment removed"

      - name: Notify team of rollback
        run: |
          echo "ðŸ“§ Notifying team of rollback..."
          # Send rollback notification with details

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deployment Summary
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate, cleanup-blue, rollback]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”„ Blue-Green Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**From:** ${{ needs.validate.outputs.current_slot }}" >> $GITHUB_STEP_SUMMARY
          echo "**To:** ${{ needs.validate.outputs.target_slot }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.cleanup-blue.result }}" = "success" ]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Traffic successfully switched to ${{ needs.validate.outputs.target_slot }} environment." >> $GITHUB_STEP_SUMMARY
            echo "Previous ${{ needs.validate.outputs.current_slot }} environment scaled down (available for rollback)." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.rollback.result }}" = "success" ]; then
            echo "### ðŸ”„ Deployment Rolled Back" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Deployment failed and was automatically rolled back to ${{ needs.validate.outputs.current_slot }}." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Deployment Status Unknown" >> $GITHUB_STEP_SUMMARY
          fi
