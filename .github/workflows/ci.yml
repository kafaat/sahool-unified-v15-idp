name: SAHOOL CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linters
        run: pip install ruff black isort

      - name: Check imports with isort
        run: isort --check-only kernel/ shared/

      - name: Check formatting with black
        run: black --check kernel/ shared/

      - name: Run ruff
        run: ruff check kernel/ shared/ --output-format=github

  test:
    name: Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: sahool
          POSTGRES_PASSWORD: sahool
          POSTGRES_DB: sahool_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      nats:
        image: nats:2.10-alpine
        ports:
          - 4222:4222

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio pytest-cov httpx

      - name: Run security tests
        run: |
          cd shared/security
          pip install pyjwt fastapi tortoise-orm
          pytest tests/ -v --tb=short

      - name: Run service tests
        run: |
          for service in ndvi_engine weather_core field_chat; do
            if [ -d "kernel/services/$service/tests" ]; then
              echo "Testing $service..."
              cd kernel/services/$service
              pip install -r requirements.txt 2>/dev/null || true
              pytest tests/ -v --tb=short || true
              cd -
            fi
          done

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, test]
    strategy:
      matrix:
        service:
          - field_ops
          - ndvi_engine
          - weather_core
          - field_chat
          - iot_gateway
          - agro_advisor

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ./kernel/services/${{ matrix.service }}
          push: false
          tags: sahool/${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  verify-docker:
    name: Verify Docker Compose v2
    runs-on: ubuntu-latest
    steps:
      - name: Verify Docker & Compose
        run: |
          echo "Docker version:"
          docker --version
          echo ""
          echo "Docker Compose version:"
          docker compose version
          echo ""
          if ! docker compose version >/dev/null 2>&1; then
            echo "[ERROR] Docker Compose v2 is required"
            exit 1
          fi
          echo "Docker Compose v2 verified"

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build, verify-docker]
    steps:
      - uses: actions/checkout@v4

      - name: Create test env
        run: |
          cat > .env <<EOF
          POSTGRES_USER=sahool
          POSTGRES_PASSWORD=sahool
          POSTGRES_DB=sahool
          JWT_SECRET_KEY=test-secret-key-for-ci
          JWT_ALGORITHM=HS256
          LOG_LEVEL=DEBUG
          EOF

      - name: Start services
        run: |
          docker compose up -d postgres nats redis mqtt
          sleep 15

      - name: Run migrations
        run: |
          chmod +x tools/env/migrate.sh
          POSTGRES_HOST=localhost ./tools/env/migrate.sh

      - name: Run smoke tests
        run: |
          chmod +x tools/release/smoke_test.sh
          BASE_URL=http://localhost ./tools/release/smoke_test.sh || true

      - name: Collect logs
        if: failure()
        run: docker compose logs

      - name: Cleanup
        if: always()
        run: docker compose down -v

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [integration]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Build release package
        run: |
          chmod +x tools/release/release_v15_3_2.sh
          SKIP_DOCKER=true SKIP_MIGRATE=true SKIP_SMOKE=true \
            ./tools/release/release_v15_3_2.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sahool-release
          path: ~/sahool-kernel-v15-3-2-final.zip
          retention-days: 30
