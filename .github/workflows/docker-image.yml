name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: satellite-service
            path: apps/services/satellite-service
          - name: crop-growth-model
            path: apps/services/crop-growth-model
          - name: indicators-service
            path: apps/services/indicators-service
          - name: weather-advanced
            path: apps/services/weather-advanced
          - name: crop-health-ai
            path: apps/services/crop-health-ai
          - name: fertilizer-advisor
            path: apps/services/fertilizer-advisor
          - name: irrigation-smart
            path: apps/services/irrigation-smart
          - name: yield-engine
            path: apps/services/yield-engine
          - name: notification-service
            path: apps/services/notification-service
          - name: marketplace-service
            path: apps/services/marketplace-service
          - name: iot-service
            path: apps/services/iot-service
          - name: virtual-sensors
            path: apps/services/virtual-sensors
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Check if Dockerfile exists
      id: check_dockerfile
      run: |
        if [ -f "${{ matrix.service.path }}/Dockerfile" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Build the Docker image
      if: steps.check_dockerfile.outputs.exists == 'true'
      run: |
        docker build ${{ matrix.service.path }} \
          --file ${{ matrix.service.path }}/Dockerfile \
          --tag sahool/${{ matrix.service.name }}:${{ github.sha }}
