name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: field-core
            path: kernel/services/field_core
          - name: field-chat
            path: kernel/services/field_chat
          - name: agro-advisor
            path: kernel/services/agro_advisor
          - name: weather-core
            path: kernel/services/weather_core
          - name: crop-health
            path: kernel/services/crop_health
          - name: iot-gateway
            path: kernel/services/iot_gateway
          - name: ws-gateway
            path: kernel/services/ws_gateway
          - name: field-ops
            path: kernel/services/field_ops
          - name: ndvi-engine
            path: kernel/services/ndvi_engine
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Check if Dockerfile exists
      id: check_dockerfile
      run: |
        if [ -f "${{ matrix.service.path }}/Dockerfile" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Build the Docker image
      if: steps.check_dockerfile.outputs.exists == 'true'
      run: |
        docker build ${{ matrix.service.path }} \
          --file ${{ matrix.service.path }}/Dockerfile \
          --tag sahool/${{ matrix.service.name }}:${{ github.sha }}
