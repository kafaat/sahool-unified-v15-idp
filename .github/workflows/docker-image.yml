name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: satellite-service
            path: apps/services/satellite-service
          - name: crop-growth-model
            path: apps/services/crop-growth-model
          - name: indicators-service
            path: apps/services/indicators-service
          - name: weather-advanced
            path: apps/services/weather-advanced
          # crop-health-ai removed - DEPRECATED (see docs/DEPRECATED_SERVICES.md)
          # Use crop-intelligence-service (port 8095) instead
          - name: fertilizer-advisor
            path: apps/services/fertilizer-advisor
          - name: irrigation-smart
            path: apps/services/irrigation-smart
          - name: yield-engine
            path: apps/services/yield-engine
          - name: notification-service
            path: apps/services/notification-service
          - name: marketplace-service
            path: apps/services/marketplace-service
          - name: iot-service
            path: apps/services/iot-service
          - name: virtual-sensors
            path: apps/services/virtual-sensors
      fail-fast: false

    steps:
    - name: Free up disk space
      run: |
        echo "Disk space before cleanup:"
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force || true
        echo "Disk space after cleanup:"
        df -h

    - uses: actions/checkout@v4

    - name: Check if Dockerfile exists
      id: check_dockerfile
      run: |
        if [ -f "${{ matrix.service.path }}/Dockerfile" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Build the Docker image
      if: steps.check_dockerfile.outputs.exists == 'true'
      run: |
        docker build . \
          --file ${{ matrix.service.path }}/Dockerfile \
          --tag sahool/${{ matrix.service.name }}:${{ github.sha }}
