name: Governance CI

on:
  pull_request:
    paths:
      - "governance/**"
      - "gitops/**"
      - "helm/**"
      - "idp/**"
  push:
    branches: [main, develop]
    paths:
      - "governance/**"
      - "gitops/**"
      - "helm/**"

jobs:
  validate-yaml:
    name: Validate YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint governance YAML
        run: |
          yamllint -d relaxed governance/ || true

      - name: Lint gitops YAML
        run: |
          yamllint -d relaxed gitops/ || true

  validate-schemas:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ajv-cli
        run: npm install -g ajv-cli

      - name: Validate schemas are valid JSON Schema
        run: |
          for schema in governance/schemas/*.json; do
            echo "Validating $schema..."
            ajv compile -s "$schema" || exit 1
          done

  validate-kyverno:
    name: Validate Kyverno Policies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Kyverno CLI
        run: |
          curl -LO https://github.com/kyverno/kyverno/releases/download/v1.11.0/kyverno-cli_v1.11.0_linux_x86_64.tar.gz
          tar -xvf kyverno-cli_v1.11.0_linux_x86_64.tar.gz
          sudo mv kyverno /usr/local/bin/

      - name: Validate Kyverno policies
        run: |
          kyverno validate governance/policies/kyverno/*.yaml

  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Block latest tag in manifests
        run: |
          echo "Checking for :latest tags..."
          if grep -rE "image:.*:latest" --include="*.yaml" --include="*.yml" governance/ gitops/ helm/ 2>/dev/null; then
            echo "ERROR: Found :latest tag in manifests!"
            exit 1
          fi
          echo "No :latest tags found"

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for hardcoded secrets..."
          PATTERNS=(
            "password:"
            "secret:"
            "apiKey:"
          )
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rni "$pattern.*['\"][^${}][^'\"]*['\"]" --include="*.yaml" --include="*.yml" governance/ gitops/ 2>/dev/null | grep -v "secretKeyRef" | grep -v "valueFrom"; then
              echo "WARNING: Potential hardcoded secret found"
              FOUND=1
            fi
          done
          if [ $FOUND -eq 1 ]; then
            echo "Please use secretKeyRef or external secrets"
          fi

  structure-guard:
    name: Structure Guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for legacy paths in new code
        run: |
          echo "Checking for services outside kernel-services-v15.3..."

          # Check for new services in forbidden locations
          FORBIDDEN_PATHS="advisor/ field_suite/ kernel_domain/ services/ apps/"

          for path in $FORBIDDEN_PATHS; do
            if [ -d "$path" ] && [ "$path" != "services/" ]; then
              echo "ERROR: Found legacy path: $path"
              echo "Move to kernel-services-v15.3/ or packages/"
              exit 1
            fi
          done

          echo "✅ No legacy service paths found"

      - name: Validate services.yaml paths exist
        run: |
          echo "Validating governance/services.yaml..."

          # Check that all service paths in services.yaml exist
          python3 << 'EOF'
          import yaml
          import os
          import sys

          with open("governance/services.yaml", "r") as f:
              data = yaml.safe_load(f)

          missing = []
          for name, service in data.get("services", {}).items():
              path = service.get("path", "")
              if path and not os.path.isdir(path):
                  missing.append(f"{name}: {path}")

          if missing:
              print("❌ Missing service paths:")
              for m in missing:
                  print(f"  - {m}")
              sys.exit(1)

          print(f"✅ All {len(data.get('services', {}))} service paths exist")
          EOF

      - name: Check FROZEN marker
        run: |
          if [ ! -f "kernel/services/FROZEN.md" ]; then
            echo "❌ Missing FROZEN.md marker in kernel/services/"
            exit 1
          fi
          echo "✅ FROZEN marker exists"

  governance-report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [validate-yaml, validate-schemas, validate-kyverno, security-checks, structure-guard]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## Governance CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Validation | ${{ needs.validate-yaml.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Schema Validation | ${{ needs.validate-schemas.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kyverno Policies | ${{ needs.validate-kyverno.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Checks | ${{ needs.security-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Structure Guard | ${{ needs.structure-guard.result }} |" >> $GITHUB_STEP_SUMMARY
