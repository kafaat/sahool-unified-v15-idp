name: Governance CI

on:
  pull_request:
    paths:
      - "governance/**"
      - "gitops/**"
      - "helm/**"
      - "idp/**"
      - "apps/**"
  push:
    branches: [main, develop]
    paths:
      - "governance/**"
      - "gitops/**"
      - "helm/**"
      - "apps/**"

permissions:
  contents: read

jobs:
  validate-yaml:
    name: Validate YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint governance YAML
        run: |
          yamllint -d relaxed governance/ || true

      - name: Lint gitops YAML
        run: |
          yamllint -d relaxed gitops/ || true

  validate-schemas:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ajv-cli
        run: npm install -g ajv-cli

      - name: Validate schemas are valid JSON Schema
        run: |
          for schema in governance/schemas/*.json; do
            echo "Validating $schema..."
            ajv compile -s "$schema" || exit 1
          done

  validate-kyverno:
    name: Validate Kyverno Policies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate Kyverno policy syntax
        run: |
          pip install pyyaml
          python3 << 'EOF'
          import yaml
          import sys
          import os
          import glob

          errors = []
          policies = glob.glob("governance/policies/kyverno/*.yaml")

          if not policies:
            print("⚠️ No Kyverno policies found")
            sys.exit(0)

          for policy_file in policies:
            try:
              with open(policy_file, "r") as f:
                docs = list(yaml.safe_load_all(f))

              for doc in docs:
                if doc is None:
                  continue
                # Check required fields for Kyverno policy
                if doc.get("kind") not in ["ClusterPolicy", "Policy"]:
                  continue

                if "metadata" not in doc:
                  errors.append(f"{policy_file}: missing metadata")
                if "spec" not in doc:
                  errors.append(f"{policy_file}: missing spec")
                elif "rules" not in doc.get("spec", {}):
                  errors.append(f"{policy_file}: missing spec.rules")

              print(f"✅ {policy_file}")
            except yaml.YAMLError as e:
              errors.append(f"{policy_file}: YAML error - {e}")
            except Exception as e:
              errors.append(f"{policy_file}: {e}")

          if errors:
            print("\n❌ Validation errors:")
            for e in errors:
              print(f"  {e}")
            sys.exit(1)

          print(f"\n✅ All {len(policies)} Kyverno policies are valid")
          EOF

  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Block latest tag in manifests
        run: |
          echo "Checking for :latest tags..."
          # Exclude Kyverno policies (they contain :latest as patterns to match, not actual image refs)
          if grep -rE "image:.*:latest" --include="*.yaml" --include="*.yml" governance/ gitops/ helm/ 2>/dev/null | grep -v "governance/policies/kyverno/"; then
            echo "ERROR: Found :latest tag in manifests!"
            exit 1
          fi
          echo "No :latest tags found"

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for hardcoded secrets..."
          PATTERNS=(
            "password:"
            "secret:"
            "apiKey:"
          )
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rni "$pattern.*['\"][^${}][^'\"]*['\"]" --include="*.yaml" --include="*.yml" governance/ gitops/ 2>/dev/null | grep -v "secretKeyRef" | grep -v "valueFrom"; then
              echo "WARNING: Potential hardcoded secret found"
              FOUND=1
            fi
          done
          if [ $FOUND -eq 1 ]; then
            echo "Please use secretKeyRef or external secrets"
          fi

  structure-guard:
    name: Structure Guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for legacy paths in new code
        run: |
          echo "Checking for services outside apps/services/..."

          # Forbidden paths - legacy locations that should not exist
          FORBIDDEN_PATHS=(
            "kernel/"
            "kernel-services-v15.3/"
            "frontend/"
            "web_admin/"
            "field_suite/"
            "kernel_domain/"
          )

          FOUND=0
          for path in "${FORBIDDEN_PATHS[@]}"; do
            if [ -d "$path" ]; then
              echo "ERROR: Found legacy path: $path"
              echo "Move to apps/services/, apps/, or packages/"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            exit 1
          fi

          echo "✅ No legacy service paths found"

      - name: Validate services.yaml paths exist
        run: |
          echo "Validating governance/services.yaml..."

          # Check that all service paths in services.yaml exist
          python3 << 'EOF'
          import yaml
          import os
          import sys

          with open("governance/services.yaml", "r") as f:
              data = yaml.safe_load(f)

          errors = []

          # Check services paths - must start with apps/services/
          for name, service in data.get("services", {}).items():
              path = service.get("path", "")
              if path:
                  if not path.startswith("apps/services/"):
                      errors.append(f"❌ {name}: path must start with 'apps/services/' (got: {path})")
                  elif not os.path.isdir(path):
                      errors.append(f"❌ {name}: path does not exist ({path})")

          # Check applications paths - must start with apps/
          for name, app in data.get("applications", {}).items():
              path = app.get("path", "")
              if path:
                  if not path.startswith("apps/"):
                      errors.append(f"❌ {name}: path must start with 'apps/' (got: {path})")
                  elif not os.path.isdir(path):
                      errors.append(f"❌ {name}: path does not exist ({path})")

          if errors:
              print("❌ Validation failed:")
              for e in errors:
                  print(f"  {e}")
              sys.exit(1)

          service_count = len(data.get("services", {}))
          app_count = len(data.get("applications", {}))
          print(f"✅ All {service_count} services and {app_count} applications validated")
          EOF

      - name: Check archive structure
        run: |
          echo "Checking archive structure..."

          # Verify legacy code is properly archived
          if [ -d "archive/kernel-legacy" ]; then
            echo "✅ kernel-legacy archived"
          fi

          if [ -d "archive/frontend-legacy" ]; then
            echo "✅ frontend-legacy archived"
          fi

          echo "✅ Archive structure verified"

  governance-report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [validate-yaml, validate-schemas, validate-kyverno, security-checks, structure-guard]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## Governance CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Validation | ${{ needs.validate-yaml.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Schema Validation | ${{ needs.validate-schemas.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kyverno Policies | ${{ needs.validate-kyverno.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Checks | ${{ needs.security-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Structure Guard | ${{ needs.structure-guard.result }} |" >> $GITHUB_STEP_SUMMARY
