name: Governance CI

on:
  pull_request:
    paths:
      - "governance/**"
      - "gitops/**"
      - "helm/**"
      - "idp/**"
  push:
    branches: [main, develop]
    paths:
      - "governance/**"
      - "gitops/**"
      - "helm/**"

jobs:
  validate-yaml:
    name: Validate YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint governance YAML
        run: |
          yamllint -d relaxed governance/ || true

      - name: Lint gitops YAML
        run: |
          yamllint -d relaxed gitops/ || true

  validate-schemas:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ajv-cli
        run: npm install -g ajv-cli

      - name: Validate schemas are valid JSON Schema
        run: |
          for schema in governance/schemas/*.json; do
            echo "Validating $schema..."
            ajv compile -s "$schema" || exit 1
          done

  validate-kyverno:
    name: Validate Kyverno Policies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Kyverno CLI
        run: |
          curl -LO https://github.com/kyverno/kyverno/releases/download/v1.11.0/kyverno-cli_v1.11.0_linux_x86_64.tar.gz
          tar -xvf kyverno-cli_v1.11.0_linux_x86_64.tar.gz
          sudo mv kyverno /usr/local/bin/

      - name: Validate Kyverno policies
        run: |
          kyverno validate governance/policies/kyverno/*.yaml

  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Block latest tag in manifests
        run: |
          echo "Checking for :latest tags..."
          if grep -rE "image:.*:latest" --include="*.yaml" --include="*.yml" governance/ gitops/ helm/ 2>/dev/null; then
            echo "ERROR: Found :latest tag in manifests!"
            exit 1
          fi
          echo "No :latest tags found"

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for hardcoded secrets..."
          PATTERNS=(
            "password:"
            "secret:"
            "apiKey:"
          )
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rni "$pattern.*['\"][^${}][^'\"]*['\"]" --include="*.yaml" --include="*.yml" governance/ gitops/ 2>/dev/null | grep -v "secretKeyRef" | grep -v "valueFrom"; then
              echo "WARNING: Potential hardcoded secret found"
              FOUND=1
            fi
          done
          if [ $FOUND -eq 1 ]; then
            echo "Please use secretKeyRef or external secrets"
          fi

  governance-report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [validate-yaml, validate-schemas, validate-kyverno, security-checks]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## Governance CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Validation | ${{ needs.validate-yaml.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Schema Validation | ${{ needs.validate-schemas.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kyverno Policies | ${{ needs.validate-kyverno.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Checks | ${{ needs.security-checks.result }} |" >> $GITHUB_STEP_SUMMARY
