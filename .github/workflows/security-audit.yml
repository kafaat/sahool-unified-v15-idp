name: Security Audit

on:
  push:
    branches: [main, develop]
    paths:
      - "apps/**/*.py"
      - "shared/**/*.py"
      - "tests/**/*.py"
      - ".github/workflows/security-audit.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "apps/**/*.py"
      - "shared/**/*.py"
      - "tests/**/*.py"
      - ".github/workflows/security-audit.yml"
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: "0 0 * * 0"

permissions:
  contents: read
  security-events: write

jobs:
  bandit-python-sast:
    name: Bandit Python SAST
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Bandit
        run: |
          pip install bandit bandit-sarif-formatter

      - name: Run Bandit security scan
        run: |
          echo "üîç Running Bandit Python SAST scan..."

          # Create output directory
          mkdir -p security-reports

          # Run Bandit on Python code with JSON output for threshold checking
          # Exit code 1 means findings, which we check below
          bandit -r apps/ shared/ \
            -f json \
            -o security-reports/bandit-report.json \
            --severity-level medium \
            --confidence-level medium \
            -x "*/tests/*,*/__pycache__/*,*/migrations/*,*/.venv/*" || BANDIT_EXIT=$?

          # Run Bandit on Python code with SARIF output for GitHub integration
          bandit -r apps/ shared/ \
            -f sarif \
            -o security-reports/bandit-results.sarif \
            --severity-level medium \
            --confidence-level medium \
            -x "*/tests/*,*/__pycache__/*,*/migrations/*,*/.venv/*" || true

          # Also generate human-readable report
          bandit -r apps/ shared/ \
            -f txt \
            -o security-reports/bandit-results.txt \
            --severity-level medium \
            --confidence-level medium \
            -x "*/tests/*,*/__pycache__/*,*/migrations/*,*/.venv/*" || true

          # Check for high severity issues - these MUST fail the build
          if [ -f "security-reports/bandit-report.json" ]; then
            HIGH_COUNT=$(python3 -c "import json; data=json.load(open('security-reports/bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']))" 2>/dev/null || echo "0")

            echo "High severity issues found: $HIGH_COUNT"

            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "‚ùå Bandit found $HIGH_COUNT high severity security issues"
              cat security-reports/bandit-results.txt
              exit 1
            fi
          fi

          echo "‚úÖ Bandit scan completed - no high severity issues"

      - name: Upload Bandit SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: security-reports/bandit-results.sarif
          category: bandit-python-sast

      - name: Upload Bandit report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: security-reports/
          retention-days: 30

      - name: Check for high severity issues
        run: |
          echo "üîç Checking for high severity vulnerabilities..."

          # Run Bandit again to check for high severity only
          HIGH_ISSUES=$(bandit -r apps/ shared/ \
            -f json \
            --severity-level high \
            --confidence-level high \
            -x "*/tests/*,*/__pycache__/*,*/migrations/*,*/.venv/*" \
            2>/dev/null | python3 -c "import sys, json; data=json.load(sys.stdin); print(len(data.get('results', [])))" 2>/dev/null || echo "0")

          if [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "‚ùå Found $HIGH_ISSUES high severity security issues!"
            echo "Please review the Bandit report and fix critical vulnerabilities."
            exit 1
          fi

          echo "‚úÖ No high severity security issues found"

  semgrep-scan:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          echo "üîç Running Semgrep security scan..."

          # Run with JSON for analysis
          # Exit code 1 means findings, which we check below
          semgrep scan \
            --config auto \
            --config p/python \
            --config p/typescript \
            --config p/javascript \
            --json \
            --output semgrep-report.json \
            --severity ERROR \
            --severity WARNING || SEMGREP_EXIT=$?

          # Run with SARIF for GitHub integration
          semgrep scan \
            --config auto \
            --config p/python \
            --config p/typescript \
            --config p/javascript \
            --sarif \
            --output semgrep-results.sarif \
            --severity ERROR \
            --severity WARNING || true

          # Create empty SARIF if it doesn't exist
          if [ ! -f "semgrep-results.sarif" ]; then
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Semgrep","version":"1.0.0"}},"results":[]}]}' > semgrep-results.sarif
          fi

          # Check for ERROR severity findings - these MUST fail the build
          if [ -f "semgrep-report.json" ]; then
            ERROR_COUNT=$(python3 -c "import json; data=json.load(open('semgrep-report.json')); print(len([r for r in data.get('results', []) if r.get('extra', {}).get('severity') == 'ERROR']))" 2>/dev/null || echo "0")

            echo "Error severity findings: $ERROR_COUNT"

            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "‚ùå Semgrep found $ERROR_COUNT error severity security issues"
              python3 -c "import json; data=json.load(open('semgrep-report.json')); [print(f\"{r['path']}:{r['start']['line']}: {r['check_id']}\") for r in data.get('results', []) if r.get('extra', {}).get('severity') == 'ERROR']" 2>/dev/null || true
              exit 1
            fi
          fi

          echo "‚úÖ Semgrep scan completed - no error severity issues"

      - name: Upload Semgrep SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep-scan

  safety-check:
    name: Python Dependency Safety Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Safety
        run: pip install safety

      - name: Check Python dependencies
        run: |
          echo "üîç Checking Python dependencies for known vulnerabilities..."

          CRITICAL_VULNS=0

          # Find all requirements files
          for req_file in $(find . -name "requirements*.txt" -type f -not -path "./.git/*" -not -path "./archive/*"); do
            echo "Checking: $req_file"
            REPORT_FILE="safety-$(echo $req_file | md5sum | cut -d' ' -f1).json"

            safety check -r "$req_file" --output json > "$REPORT_FILE" || SAFETY_EXIT=$?

            # Count critical/high severity vulnerabilities
            if [ -f "$REPORT_FILE" ]; then
              VULN_COUNT=$(python3 -c "import json; data=json.load(open('$REPORT_FILE')); print(len([v for v in data.get('vulnerabilities', []) if v.get('severity', '').upper() in ['CRITICAL', 'HIGH']]))" 2>/dev/null || echo "0")
              CRITICAL_VULNS=$((CRITICAL_VULNS + VULN_COUNT))

              if [ "$VULN_COUNT" -gt 0 ]; then
                echo "‚ö†Ô∏è Found $VULN_COUNT critical/high vulnerabilities in $req_file"
              fi
            fi
          done

          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "‚ùå Found $CRITICAL_VULNS total critical/high severity vulnerabilities"
            exit 1
          fi

          echo "‚úÖ Dependency check completed - no critical vulnerabilities"
