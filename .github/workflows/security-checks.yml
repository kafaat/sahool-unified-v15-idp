name: Security Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Restrict default permissions for all jobs
permissions:
  contents: read
  actions: read

jobs:
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for secrets in code
        run: |
          echo "ðŸ” Scanning for potential secrets..."

          # Only check for actual embedded secrets, not variable names or paths
          FOUND=0

          # Check for actual private key content (PEM format)
          if grep -rn "-----BEGIN.*PRIVATE KEY-----" --include="*.py" --include="*.js" --include="*.ts" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v ".github/workflows"; then
            echo "âš ï¸ Found embedded private key content"
            FOUND=1
          fi

          # Check for hardcoded AWS credentials (actual values, not env vars)
          if grep -rniE "AKIA[0-9A-Z]{16}" --include="*.py" --include="*.js" --include="*.ts" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v ".github/workflows"; then
            echo "âš ï¸ Found AWS Access Key ID"
            FOUND=1
          fi

          # Check for hardcoded passwords with actual values (not env var references)
          if grep -rniE "password\s*=\s*['\"][a-zA-Z0-9!@#$%^&*]{8,}['\"]" --include="*.py" . 2>/dev/null | grep -v "test_" | grep -v "_test.py" | grep -v "getenv" | grep -v "environ"; then
            echo "âš ï¸ Found hardcoded password"
            FOUND=1
          fi

          if [ $FOUND -eq 1 ]; then
            echo "âŒ Secrets scan failed!"
            exit 1
          fi

          echo "âœ… No secrets found in code"

      - name: Check for sensitive files
        run: |
          echo "ðŸ” Checking for sensitive files..."

          SENSITIVE_FILES=(
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"
            ".env"
            ".env.local"
            "*.credentials"
            "secrets/"
          )

          FOUND=0
          for pattern in "${SENSITIVE_FILES[@]}"; do
            if find . -name "$pattern" -not -path "./.git/*" 2>/dev/null | grep -q .; then
              echo "âš ï¸ Found sensitive file pattern: $pattern"
              find . -name "$pattern" -not -path "./.git/*" 2>/dev/null
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "âŒ Sensitive files found!"
            exit 1
          fi

          echo "âœ… No sensitive files found"

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install safety
        run: pip install safety pip-audit

      - name: Scan Python dependencies with Safety
        continue-on-error: true
        run: |
          echo "ðŸ” Scanning Python dependencies with Safety..."
          # Note: Safety now requires API key for full functionality
          # This step may fail without proper authentication
          SAFETY_FAILED=0
          for req in $(find . -name "requirements.txt" -type f); do
            echo "Scanning: $req"
            if ! safety check -r "$req" --full-report 2>&1; then
              echo "âŒ Safety scan failed for $req"
              SAFETY_FAILED=1
            fi
          done
          if [ $SAFETY_FAILED -eq 1 ]; then
            echo "::error::Critical vulnerabilities found in Python dependencies"
            exit 1
          fi

      - name: Scan Python dependencies with pip-audit
        continue-on-error: true
        run: |
          echo "ðŸ” Scanning Python dependencies with pip-audit..."
          AUDIT_FAILED=0
          for req in $(find . -name "requirements.txt" -type f); do
            echo "Auditing: $req"
            if ! pip-audit -r "$req" 2>&1; then
              echo "âŒ Vulnerabilities found in $req"
              AUDIT_FAILED=1
            fi
          done
          if [ $AUDIT_FAILED -eq 1 ]; then
            echo "::error::Critical vulnerabilities found in Python dependencies"
            exit 1
          fi

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        id: trivy
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '1'

      - name: Create empty SARIF if Trivy failed
        if: always()
        run: |
          if [ ! -f "trivy-results.sarif" ]; then
            echo "Creating empty SARIF file..."
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Trivy","version":"1.0.0"}},"results":[]}]}' > trivy-results.sarif
          fi

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-dependency-scan'

      - name: Report vulnerabilities
        if: steps.trivy.outcome == 'failure'
        run: |
          echo "::warning::Critical or High vulnerabilities found by Trivy"
          echo "Please review the security tab for details"
          echo "## âš ï¸ Security Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
          echo "Trivy detected critical or high severity vulnerabilities." >> $GITHUB_STEP_SUMMARY
          echo "Please review the Security tab for details." >> $GITHUB_STEP_SUMMARY

  code-security:
    name: Code Security Analysis (SAST)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security scanners
        run: pip install bandit semgrep

      - name: Run Bandit security scan
        run: |
          echo "ðŸ” Running Bandit security analysis..."
          # Check if directories exist and have Python files
          if [ -d "apps/services" ] || [ -d "shared" ]; then
            bandit -r apps/services/ shared/ -ll -ii --format sarif -o bandit-results.sarif 2>/dev/null || true
            bandit -r apps/services/ shared/ -ll -ii --format txt 2>/dev/null || true
          fi
          # Create empty SARIF if file doesn't exist
          if [ ! -f "bandit-results.sarif" ]; then
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Bandit","version":"1.0.0"}},"results":[]}]}' > bandit-results.sarif
          fi

      - name: Upload Bandit SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: bandit-results.sarif
          category: 'bandit-sast'

      - name: Run Semgrep SAST
        run: |
          echo "ðŸ” Running Semgrep SAST..."
          # Check if directories exist
          if [ -d "apps/services" ] || [ -d "shared" ]; then
            semgrep --config=auto --sarif -o semgrep-results.sarif apps/services/ shared/ 2>/dev/null || true
          fi
          # Create empty SARIF if file doesn't exist
          if [ ! -f "semgrep-results.sarif" ]; then
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Semgrep","version":"1.0.0"}},"results":[]}]}' > semgrep-results.sarif
          fi

      - name: Upload Semgrep SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep-results.sarif
          category: 'semgrep-sast'

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-results.sarif
            semgrep-results.sarif
          retention-days: 30

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Scan Dockerfiles
        run: |
          echo "ðŸ” Scanning Dockerfiles..."

          for dockerfile in $(find . -name "Dockerfile" -type f); do
            echo "Checking: $dockerfile"

            # Check for root user
            if grep -q "USER root" "$dockerfile"; then
              echo "âš ï¸ WARNING: Container runs as root in $dockerfile"
            fi

            # Check for latest tag
            if grep -qE "FROM .+:latest" "$dockerfile"; then
              echo "âš ï¸ WARNING: Using :latest tag in $dockerfile"
            fi

            # Check for hardcoded secrets
            if grep -qE "(PASSWORD|SECRET|KEY)=" "$dockerfile"; then
              echo "âŒ ERROR: Hardcoded secrets in $dockerfile"
              exit 1
            fi
          done

          echo "âœ… Dockerfile scan complete"

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [secrets-scan, dependency-scan, code-security]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Scan | ${{ needs.secrets-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Security | ${{ needs.code-security.result }} |" >> $GITHUB_STEP_SUMMARY
