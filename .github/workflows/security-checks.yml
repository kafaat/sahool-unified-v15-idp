name: Security Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Restrict default permissions for all jobs
permissions:
  contents: read
  actions: read

jobs:
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for secrets in code
        run: |
          echo "ðŸ” Scanning for potential secrets..."

          # Only check for actual embedded secrets, not variable names or paths
          FOUND=0

          # Check for actual private key content (PEM format)
          if grep -rn "-----BEGIN.*PRIVATE KEY-----" --include="*.py" --include="*.js" --include="*.ts" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v ".github/workflows"; then
            echo "âš ï¸ Found embedded private key content"
            FOUND=1
          fi

          # Check for hardcoded AWS credentials (actual values, not env vars)
          if grep -rniE "AKIA[0-9A-Z]{16}" --include="*.py" --include="*.js" --include="*.ts" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v ".github/workflows"; then
            echo "âš ï¸ Found AWS Access Key ID"
            FOUND=1
          fi

          # Check for hardcoded passwords with actual values (not env var references)
          # Exclude test files and example files
          if grep -rniE "password\s*=\s*['\"][a-zA-Z0-9!@#$%^&*]{8,}['\"]" --include="*.py" . 2>/dev/null | grep -v "test_" | grep -v "_test.py" | grep -v "_example" | grep -v "example_" | grep -v "examples" | grep -v "getenv" | grep -v "environ" | grep -v "mock" | grep -v "fixture"; then
            echo "âš ï¸ Found hardcoded password"
            FOUND=1
          fi

          if [ $FOUND -eq 1 ]; then
            echo "âŒ Secrets scan failed!"
            exit 1
          fi

          echo "âœ… No secrets found in code"

      - name: Check for sensitive files
        run: |
          echo "ðŸ” Checking for sensitive files..."

          # Note: secrets/ directories under gitops/ and shared/ are code templates, not actual secrets
          SENSITIVE_FILES=(
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"
            ".env"
            ".env.local"
            "*.credentials"
          )

          FOUND=0
          for pattern in "${SENSITIVE_FILES[@]}"; do
            # Exclude example files and gitops templates
            MATCHES=$(find . -name "$pattern" -not -path "./.git/*" -not -name "*.example" -not -path "./gitops/*" 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              echo "âš ï¸ Found sensitive file pattern: $pattern"
              echo "$MATCHES"
              FOUND=1
            fi
          done

          # Check for secrets directories at root level only (not code directories)
          if find . -maxdepth 1 -name "secrets" -type d 2>/dev/null | grep -q .; then
            echo "âš ï¸ Found root-level secrets directory"
            FOUND=1
          fi

          if [ $FOUND -eq 1 ]; then
            echo "âŒ Sensitive files found!"
            exit 1
          fi

          echo "âœ… No sensitive files found"

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install safety
        run: pip install safety pip-audit

      - name: Scan Python dependencies with Safety
        run: |
          echo "ðŸ” Scanning Python dependencies with Safety..."

          CRITICAL_VULNS=0
          for req in $(find . -name "requirements.txt" -type f -not -path "./.git/*" -not -path "./archive/*"); do
            echo "Scanning: $req"
            REPORT_FILE="safety-$(echo $req | md5sum | cut -d' ' -f1).json"
            safety check -r "$req" --json > "$REPORT_FILE" || SAFETY_EXIT=$?

            # Count critical/high vulnerabilities
            if [ -f "$REPORT_FILE" ]; then
              VULN_COUNT=$(python3 -c "import json; data=json.load(open('$REPORT_FILE')); print(len([v for v in data.get('vulnerabilities', []) if v.get('severity', '').upper() in ['CRITICAL', 'HIGH']]))" 2>/dev/null || echo "0")
              CRITICAL_VULNS=$((CRITICAL_VULNS + VULN_COUNT))
            fi
          done

          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âŒ Found $CRITICAL_VULNS critical/high severity vulnerabilities"
            exit 1
          fi
          echo "âœ… Safety scan completed - no critical vulnerabilities"

      - name: Scan Python dependencies with pip-audit
        run: |
          echo "ðŸ” Scanning Python dependencies with pip-audit..."

          CRITICAL_VULNS=0

          for req in $(find . -name "requirements.txt" -type f -not -path "./.git/*" -not -path "./archive/*" | head -10); do
            echo "Auditing: $req"
            REPORT_FILE="audit-$(echo $req | md5sum | cut -d' ' -f1).json"

            # Run pip-audit and capture output
            pip-audit -r "$req" --format json -o "$REPORT_FILE" 2>/dev/null || AUDIT_EXIT=$?

            # Check for vulnerabilities with fixes available
            # Exclude starlette/jinja2 as they are constrained at the platform level
            if [ -f "$REPORT_FILE" ]; then
              VULN_COUNT=$(jq '[.dependencies[]? | select(.name != "starlette" and .name != "jinja2") | .vulns[]? | select(.fix_versions != null)] | length' "$REPORT_FILE" 2>/dev/null || echo "0")
              CRITICAL_VULNS=$((CRITICAL_VULNS + VULN_COUNT))
            fi
          done

          if [ "$CRITICAL_VULNS" -gt 5 ]; then
            echo "âŒ Found $CRITICAL_VULNS vulnerabilities with available fixes - please update dependencies"
            exit 1
          fi
          echo "âœ… pip-audit scan completed (found $CRITICAL_VULNS fixable issues)"

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        id: trivy
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '1'

      - name: Create empty SARIF if Trivy failed
        if: failure()
        run: |
          if [ ! -f "trivy-results.sarif" ]; then
            echo "Creating empty SARIF file..."
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Trivy","version":"1.0.0"}},"results":[]}]}' > trivy-results.sarif
          fi

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-dependency-scan'

      - name: Report vulnerabilities
        if: always()
        run: |
          if [ -f "trivy-results.sarif" ]; then
            # Check if there are any results in the SARIF file
            RESULTS=$(cat trivy-results.sarif | python3 -c "import sys,json; d=json.load(sys.stdin); print(len(d.get('runs',[{}])[0].get('results',[])))" 2>/dev/null || echo "0")
            if [ "$RESULTS" != "0" ]; then
              echo "## âš ï¸ Security Scan Results" >> $GITHUB_STEP_SUMMARY
              echo "Trivy detected $RESULTS potential issues. Please review the Security tab." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No critical vulnerabilities found by Trivy"
            fi
          fi

  code-security:
    name: Code Security Analysis (SAST)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security scanners
        run: pip install bandit semgrep

      - name: Run Bandit security scan
        run: |
          echo "ðŸ” Running Bandit security analysis..."

          # Check if directories exist and have Python files
          if [ -d "apps/services" ] || [ -d "shared" ]; then
            # Run Bandit with JSON output for threshold checking
            # Exit code 1 means findings, which we check below
            bandit -r apps/services/ shared/ \
              -f json \
              -o bandit-report.json \
              --severity-level medium \
              --confidence-level medium \
              -x "*/tests/*,*/__pycache__/*,*/migrations/*,*/.venv/*" || BANDIT_EXIT=$?

            # Run Bandit with SARIF output for GitHub
            bandit -r apps/services/ shared/ -ll -ii --format sarif -o bandit-results.sarif \
              -x "*/tests/*,*/__pycache__/*,*/migrations/*,*/.venv/*" || true
          fi

          # Create empty SARIF if file doesn't exist
          if [ ! -f "bandit-results.sarif" ]; then
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Bandit","version":"1.0.0"}},"results":[]}]}' > bandit-results.sarif
          fi

          # Fail if high severity issues found
          if [ -f "bandit-report.json" ]; then
            HIGH_COUNT=$(python3 -c "import json; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']))" 2>/dev/null || echo "0")

            echo "High severity issues: $HIGH_COUNT"

            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "âŒ Found $HIGH_COUNT high severity security issues"
              bandit -r apps/services/ shared/ -ll -ii --format txt \
                -x "*/tests/*,*/__pycache__/*,*/migrations/*,*/.venv/*"
              exit 1
            fi
          fi

          echo "âœ… Bandit scan passed"

      - name: Upload Bandit SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: bandit-results.sarif
          category: 'bandit-sast'

      - name: Run Semgrep SAST
        continue-on-error: true
        run: |
          echo "ðŸ” Running Semgrep SAST..."

          # Check if directories exist
          if [ -d "apps/services" ] || [ -d "shared" ]; then
            # Run with JSON for analysis
            # Exit code 1 means findings, which we check below
            semgrep --config=p/python \
                    --config=p/security-audit \
                    --config=p/secrets \
                    --severity=ERROR \
                    --severity=WARNING \
                    --exclude="**/test_*.py" \
                    --exclude="**/*_test.py" \
                    --exclude="**/tests/**" \
                    --exclude="**/node_modules/**" \
                    --exclude="**/__pycache__/**" \
                    --timeout=300 \
                    --jobs=4 \
                    --json -o semgrep-report.json \
                    apps/services/ shared/ || SEMGREP_EXIT=$?

            # Run with SARIF for GitHub
            semgrep --config=p/python \
                    --config=p/security-audit \
                    --config=p/secrets \
                    --severity=ERROR \
                    --severity=WARNING \
                    --exclude="**/test_*.py" \
                    --exclude="**/*_test.py" \
                    --exclude="**/tests/**" \
                    --exclude="**/node_modules/**" \
                    --exclude="**/__pycache__/**" \
                    --timeout=300 \
                    --jobs=4 \
                    --sarif -o semgrep-results.sarif \
                    apps/services/ shared/ || true
          fi

          # Create empty SARIF if file doesn't exist
          if [ ! -f "semgrep-results.sarif" ]; then
            echo "Creating empty SARIF file..."
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Semgrep","version":"1.0.0"}},"results":[]}]}' > semgrep-results.sarif
          fi

          # Check for ERROR severity findings
          if [ -f "semgrep-report.json" ]; then
            ERROR_COUNT=$(python3 -c "import json; data=json.load(open('semgrep-report.json')); print(len([r for r in data.get('results', []) if r.get('extra', {}).get('severity') == 'ERROR']))" 2>/dev/null || echo "0")

            echo "Error severity findings: $ERROR_COUNT"

            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "âŒ Found $ERROR_COUNT error severity security issues"
              exit 1
            fi
          fi

          echo "âœ… Semgrep scan passed"

      - name: Upload Semgrep SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep-results.sarif
          category: 'semgrep-sast'

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-results.sarif
            semgrep-results.sarif
            bandit-report.json
            semgrep-report.json
          retention-days: 30

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Scan Dockerfiles
        run: |
          echo "ðŸ” Scanning Dockerfiles..."

          for dockerfile in $(find . -name "Dockerfile" -type f); do
            echo "Checking: $dockerfile"

            # Check for root user
            if grep -q "USER root" "$dockerfile"; then
              echo "âš ï¸ WARNING: Container runs as root in $dockerfile"
            fi

            # Check for latest tag
            if grep -qE "FROM .+:latest" "$dockerfile"; then
              echo "âš ï¸ WARNING: Using :latest tag in $dockerfile"
            fi

            # Check for hardcoded secrets
            if grep -qE "(PASSWORD|SECRET|KEY)=" "$dockerfile"; then
              echo "âŒ ERROR: Hardcoded secrets in $dockerfile"
              exit 1
            fi
          done

          echo "âœ… Dockerfile scan complete"

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [secrets-scan, dependency-scan, code-security]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Scan | ${{ needs.secrets-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Security | ${{ needs.code-security.result }} |" >> $GITHUB_STEP_SUMMARY
