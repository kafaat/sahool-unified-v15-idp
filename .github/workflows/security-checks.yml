name: Security Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for secrets in code
        run: |
          echo "ðŸ” Scanning for potential secrets..."

          # Only check for actual embedded secrets, not variable names or paths
          FOUND=0

          # Check for actual private key content (PEM format)
          if grep -rn "-----BEGIN.*PRIVATE KEY-----" --include="*.py" --include="*.js" --include="*.ts" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v ".github/workflows"; then
            echo "âš ï¸ Found embedded private key content"
            FOUND=1
          fi

          # Check for hardcoded AWS credentials (actual values, not env vars)
          if grep -rniE "AKIA[0-9A-Z]{16}" --include="*.py" --include="*.js" --include="*.ts" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v ".github/workflows"; then
            echo "âš ï¸ Found AWS Access Key ID"
            FOUND=1
          fi

          # Check for hardcoded passwords with actual values (not env var references)
          if grep -rniE "password\s*=\s*['\"][a-zA-Z0-9!@#$%^&*]{8,}['\"]" --include="*.py" . 2>/dev/null | grep -v "test_" | grep -v "_test.py" | grep -v "getenv" | grep -v "environ"; then
            echo "âš ï¸ Found hardcoded password"
            FOUND=1
          fi

          if [ $FOUND -eq 1 ]; then
            echo "âŒ Secrets scan failed!"
            exit 1
          fi

          echo "âœ… No secrets found in code"

      - name: Check for sensitive files
        run: |
          echo "ðŸ” Checking for sensitive files..."

          SENSITIVE_FILES=(
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"
            ".env"
            ".env.local"
            "*.credentials"
            "secrets/"
          )

          FOUND=0
          for pattern in "${SENSITIVE_FILES[@]}"; do
            if find . -name "$pattern" -not -path "./.git/*" 2>/dev/null | grep -q .; then
              echo "âš ï¸ Found sensitive file pattern: $pattern"
              find . -name "$pattern" -not -path "./.git/*" 2>/dev/null
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "âŒ Sensitive files found!"
            exit 1
          fi

          echo "âœ… No sensitive files found"

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install safety
        run: pip install safety

      - name: Scan Python dependencies
        run: |
          echo "ðŸ” Scanning Python dependencies..."

          for req in $(find . -name "requirements.txt" -type f); do
            echo "Scanning: $req"
            safety check -r "$req" --full-report || true
          done

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on findings, just report

  code-security:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install bandit
        run: pip install bandit

      - name: Run Bandit security scan
        run: |
          echo "ðŸ” Running Bandit security analysis..."
          bandit -r kernel/ shared/ -ll -ii --format json -o bandit-report.json || true
          bandit -r kernel/ shared/ -ll -ii --format txt || true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Scan Dockerfiles
        run: |
          echo "ðŸ” Scanning Dockerfiles..."

          for dockerfile in $(find . -name "Dockerfile" -type f); do
            echo "Checking: $dockerfile"

            # Check for root user
            if grep -q "USER root" "$dockerfile"; then
              echo "âš ï¸ WARNING: Container runs as root in $dockerfile"
            fi

            # Check for latest tag
            if grep -qE "FROM .+:latest" "$dockerfile"; then
              echo "âš ï¸ WARNING: Using :latest tag in $dockerfile"
            fi

            # Check for hardcoded secrets
            if grep -qE "(PASSWORD|SECRET|KEY)=" "$dockerfile"; then
              echo "âŒ ERROR: Hardcoded secrets in $dockerfile"
              exit 1
            fi
          done

          echo "âœ… Dockerfile scan complete"

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [secrets-scan, dependency-scan, code-security]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Scan | ${{ needs.secrets-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Security | ${{ needs.code-security.result }} |" >> $GITHUB_STEP_SUMMARY
