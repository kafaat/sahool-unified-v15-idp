# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SAHOOL Security Pipeline
# Version: 16.0.0
# Comprehensive security scanning including SAST, dependency scanning,
# container scanning, and secrets detection
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Secrets Detection
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    # SECURITY FIX: Security scans must block the pipeline on failure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@v3.88.0
        # Secrets detection must fail the pipeline
        with:
          path: ./
          base: ""
          extra_args: --only-verified

      - name: Detect hardcoded secrets
        # SECURITY: Hardcoded secrets must fail the pipeline
        run: |
          echo "ðŸ” Scanning for hardcoded secrets..."

          FOUND=0

          # Check for private keys
          if grep -rn "-----BEGIN.*PRIVATE KEY-----" \
            --include="*.py" --include="*.js" --include="*.ts" \
            --include="*.yml" --include="*.yaml" \
            --exclude-dir=".git" --exclude-dir="node_modules" . 2>/dev/null; then
            echo "âŒ Found embedded private keys"
            FOUND=1
          fi

          # Check for AWS credentials
          if grep -rniE "AKIA[0-9A-Z]{16}" \
            --include="*.py" --include="*.js" --include="*.ts" \
            --exclude-dir=".git" --exclude-dir="node_modules" . 2>/dev/null; then
            echo "âŒ Found AWS Access Key"
            FOUND=1
          fi

          # Check for API keys
          if grep -rniE "(api[_-]?key|apikey)\s*=\s*['\"][a-zA-Z0-9]{20,}['\"]" \
            --include="*.py" --include="*.js" --include="*.ts" \
            --exclude-dir=".git" --exclude-dir="node_modules" \
            --exclude="*test*" . 2>/dev/null | grep -v "getenv" | grep -v "environ"; then
            echo "âŒ Found hardcoded API keys"
            FOUND=1
          fi

          if [ $FOUND -eq 1 ]; then
            exit 1
          fi

          echo "âœ… No secrets detected"

      - name: Check for sensitive files
        # SECURITY: Sensitive files must fail the pipeline
        run: |
          echo "ðŸ” Checking for sensitive files..."

          SENSITIVE_PATTERNS=(
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"
            ".env"
            ".env.local"
            "*.credentials"
            "credentials.json"
            "serviceAccount*.json"
          )

          FOUND=0
          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if find . -name "$pattern" \
              -not -path "./.git/*" \
              -not -path "./node_modules/*" \
              -not -name ".env.example" 2>/dev/null | grep -q .; then
              echo "âŒ Found sensitive file pattern: $pattern"
              find . -name "$pattern" -not -path "./.git/*" -not -path "./node_modules/*"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "âš ï¸  Sensitive files detected (informational only - not blocking)"
          fi

          echo "âœ… Sensitive files check complete"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Dependency Vulnerability Scanning
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  dependency-scan-python:
    name: Python Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install scanning tools
        run: |
          pip install --upgrade pip
          pip install safety pip-audit

      - name: Scan with Safety
        run: |
          echo "ðŸ” Scanning Python dependencies with Safety..."

          CRITICAL_VULNS=0
          for req in $(find . -name "requirements.txt" -type f -not -path "./archive/*"); do
            echo "Scanning: $req"
            REPORT_FILE="safety-report-$(echo $req | md5sum | cut -d' ' -f1).json"
            safety check -r "$req" --full-report --json > "$REPORT_FILE" || SAFETY_EXIT=$?

            # Count critical vulnerabilities
            if [ -f "$REPORT_FILE" ]; then
              VULN_COUNT=$(python3 -c "import json; data=json.load(open('$REPORT_FILE')); print(len([v for v in data.get('vulnerabilities', []) if v.get('severity', '').upper() in ['CRITICAL', 'HIGH']]))" 2>/dev/null || echo "0")
              CRITICAL_VULNS=$((CRITICAL_VULNS + VULN_COUNT))
            fi
          done

          # Check pyproject.toml
          if [ -f "pyproject.toml" ]; then
            pip install -e ".[base,infrastructure,testing]" 2>/dev/null || echo "Skipping pyproject install"
            safety check --json > safety-report-pyproject.json || SAFETY_EXIT=$?
          fi

          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âŒ Found $CRITICAL_VULNS critical/high severity vulnerabilities"
            exit 1
          fi
          echo "âœ… No critical vulnerabilities found in Python dependencies"

      - name: Scan with pip-audit
        run: |
          echo "ðŸ” Scanning Python dependencies with pip-audit..."

          CRITICAL_VULNS=0
          for req in $(find . -name "requirements.txt" -type f -not -path "./archive/*"); do
            echo "Auditing: $req"
            REPORT_FILE="audit-report-$(echo $req | md5sum | cut -d' ' -f1).json"
            pip-audit -r "$req" --format json -o "$REPORT_FILE" || AUDIT_EXIT=$?

            # Check for critical vulnerabilities
            if [ -f "$REPORT_FILE" ]; then
              HIGH_COUNT=$(jq '[.dependencies[]?.vulns[]? | select(.fix_versions != null)] | length' "$REPORT_FILE" 2>/dev/null || echo "0")
              CRITICAL_VULNS=$((CRITICAL_VULNS + HIGH_COUNT))
            fi
          done

          if [ "$CRITICAL_VULNS" -gt 5 ]; then
            echo "âŒ Found $CRITICAL_VULNS vulnerabilities with available fixes - please update dependencies"
            exit 1
          fi
          echo "âœ… pip-audit scan completed (found $CRITICAL_VULNS fixable issues)"

      - name: Upload Python scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-dependency-scans
          path: |
            safety-report-*.json
            audit-report-*.json
          retention-days: 30

  dependency-scan-nodejs:
    name: Node.js Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Run npm audit
        run: |
          echo "ðŸ” Scanning Node.js dependencies..."
          npm audit --json > npm-audit-report.json || NPM_AUDIT_EXIT=$?

          # Parse and check for critical/high vulnerabilities
          if [ -f "npm-audit-report.json" ]; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-report.json 2>/dev/null || echo "0")
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-report.json 2>/dev/null || echo "0")

            echo "Critical vulnerabilities: $CRITICAL"
            echo "High vulnerabilities: $HIGH"

            if [ "$CRITICAL" -gt 0 ]; then
              echo "âŒ Found $CRITICAL critical vulnerabilities in Node.js dependencies"
              npm audit --audit-level=critical
              exit 1
            fi

            if [ "$HIGH" -gt 5 ]; then
              echo "âŒ Found $HIGH high vulnerabilities (threshold: 5)"
              exit 1
            fi
          fi

          echo "âœ… npm audit completed successfully"

      - name: Run Snyk scan
        if: ${{ secrets.SNYK_TOKEN != '' }}
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-report.json

      - name: Upload Node.js scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nodejs-dependency-scans
          path: |
            npm-audit-report.json
            snyk-report.json
          retention-days: 30

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # SAST - Static Application Security Testing
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sast-python:
    name: SAST - Python (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          echo "ðŸ” Running Bandit SAST..."

          # Run Bandit with JSON output for threshold checking
          # Exit code 1 means findings, which we handle below
          bandit -r apps/services/ shared/ \
            -f json \
            -o bandit-report.json \
            --severity-level medium \
            --confidence-level medium \
            -x "*/tests/*,*/__pycache__/*,*/migrations/*,*/.venv/*" || BANDIT_EXIT=$?

          # Also generate SARIF for GitHub Security tab
          bandit -r apps/services/ shared/ \
            -ll \
            -ii \
            --format sarif \
            -o bandit-results.sarif \
            -x "*/tests/*,*/__pycache__/*,*/migrations/*,*/.venv/*" || true

          # Create empty SARIF if it doesn't exist
          if [ ! -f "bandit-results.sarif" ]; then
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Bandit","version":"1.0.0"}},"results":[]}]}' > bandit-results.sarif
          fi

          # Fail if high severity issues found
          if [ -f "bandit-report.json" ]; then
            HIGH_COUNT=$(python3 -c "import json; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']))" 2>/dev/null || echo "0")
            MEDIUM_COUNT=$(python3 -c "import json; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') == 'MEDIUM']))" 2>/dev/null || echo "0")

            echo "High severity issues: $HIGH_COUNT"
            echo "Medium severity issues: $MEDIUM_COUNT"

            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "âŒ Found $HIGH_COUNT high severity security issues"
              bandit -r apps/services/ shared/ -ll -ii --format txt -x "*/tests/*,*/__pycache__/*,*/migrations/*,*/.venv/*"
              exit 1
            fi

            # Warn but don't fail for medium severity (threshold of 10)
            if [ "$MEDIUM_COUNT" -gt 10 ]; then
              echo "âš ï¸ Found $MEDIUM_COUNT medium severity issues (threshold: 10)"
              exit 1
            fi
          fi

          echo "âœ… Bandit scan passed"

      - name: Upload Bandit SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: bandit-results.sarif
          category: bandit-sast

  sast-semgrep:
    name: SAST - Multi-language (Semgrep)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep scan
        run: |
          echo "ðŸ” Running Semgrep SAST..."

          # Run Semgrep with JSON output for analysis
          # Exit code 1 means findings, which we handle below
          semgrep scan \
            --config=p/security-audit \
            --config=p/python \
            --config=p/javascript \
            --config=p/typescript \
            --config=p/secrets \
            --json \
            --output=semgrep-report.json \
            --severity=ERROR \
            --severity=WARNING \
            --exclude="**/test_*.py" \
            --exclude="**/*_test.py" \
            --exclude="**/tests/**" \
            --exclude="**/node_modules/**" \
            --exclude="**/__pycache__/**" \
            --timeout=300 \
            apps/ shared/ || SEMGREP_EXIT=$?

          # Also generate SARIF
          semgrep scan \
            --config=p/security-audit \
            --config=p/python \
            --config=p/javascript \
            --config=p/typescript \
            --config=p/secrets \
            --sarif \
            --output=semgrep.sarif \
            --severity=ERROR \
            --severity=WARNING \
            --exclude="**/test_*.py" \
            --exclude="**/*_test.py" \
            --exclude="**/tests/**" \
            --exclude="**/node_modules/**" \
            --exclude="**/__pycache__/**" \
            --timeout=300 \
            apps/ shared/ || true

          # Create empty SARIF if it doesn't exist
          if [ ! -f "semgrep.sarif" ]; then
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Semgrep","version":"1.0.0"}},"results":[]}]}' > semgrep.sarif
          fi

          # Check for critical findings
          if [ -f "semgrep-report.json" ]; then
            ERROR_COUNT=$(python3 -c "import json; data=json.load(open('semgrep-report.json')); print(len([r for r in data.get('results', []) if r.get('extra', {}).get('severity') == 'ERROR']))" 2>/dev/null || echo "0")

            echo "Error severity findings: $ERROR_COUNT"

            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "âŒ Found $ERROR_COUNT error severity security issues"
              python3 -c "import json; data=json.load(open('semgrep-report.json')); [print(f\"{r['path']}:{r['start']['line']}: {r['check_id']} - {r['extra']['message']}\") for r in data.get('results', []) if r.get('extra', {}).get('severity') == 'ERROR']" 2>/dev/null || true
              exit 1
            fi
          fi

          echo "âœ… Semgrep scan passed"

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep-sast

  sast-codeql:
    name: SAST - CodeQL
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: ['python', 'javascript']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Container Security Scanning
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule'
    strategy:
      fail-fast: false
      matrix:
        service:
          - field-ops
          - weather-core
          - satellite-service
          - crop-health-ai
          - billing-core
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t ${{ matrix.service }}:scan apps/services/${{ matrix.service }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:scan
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-${{ matrix.service }}.sarif
          category: trivy-${{ matrix.service }}

      - name: Scan with Grype
        uses: anchore/scan-action@v3
        with:
          image: ${{ matrix.service }}:scan
          fail-build: true
          severity-cutoff: critical

  dockerfile-scan:
    name: Dockerfile Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "**/Dockerfile"
          recursive: true
          failure-threshold: error

      - name: Check Dockerfile best practices
        run: |
          echo "ðŸ” Checking Dockerfile security best practices..."

          CRITICAL_ISSUES=0
          WARNING_COUNT=0

          for dockerfile in $(find . -name "Dockerfile" -type f -not -path "./archive/*"); do
            echo "Checking: $dockerfile"

            # Check for root user - warning only
            if ! grep -q "USER [^r]" "$dockerfile"; then
              echo "âš ï¸  WARNING: No non-root USER directive in $dockerfile"
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi

            # Check for latest tag - warning only
            if grep -qE "FROM .+:latest" "$dockerfile"; then
              echo "âš ï¸  WARNING: Using :latest tag in $dockerfile"
              WARNING_COUNT=$((WARNING_COUNT + 1))
            fi

            # Check for hardcoded secrets - CRITICAL
            if grep -qE "(PASSWORD|SECRET|KEY|TOKEN)=['\"]?[a-zA-Z0-9]+" "$dockerfile"; then
              echo "âŒ CRITICAL: Hardcoded secrets in $dockerfile"
              CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
            fi
          done

          if [ "$CRITICAL_ISSUES" -gt 0 ]; then
            echo "âŒ Found $CRITICAL_ISSUES critical Dockerfile security issues"
            exit 1
          fi

          if [ "$WARNING_COUNT" -gt 10 ]; then
            echo "âš ï¸ Found $WARNING_COUNT Dockerfile warnings (threshold: 10)"
            exit 1
          fi

          echo "âœ… Dockerfile security check complete (warnings: $WARNING_COUNT)"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Infrastructure as Code Security
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  iac-scan:
    name: IaC Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: kubernetes,dockerfile,secrets
          soft_fail: false
          output_format: sarif
          output_file_path: checkov-results.sarif
          # Only fail on high/critical severity
          check: CKV_K8S_1,CKV_K8S_2,CKV_K8S_3,CKV_K8S_4,CKV_K8S_5,CKV_K8S_6,CKV_K8S_7,CKV_K8S_8,CKV_K8S_9,CKV_SECRET_1,CKV_SECRET_2

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
          category: checkov-iac

      - name: Scan Kubernetes manifests
        run: |
          echo "ðŸ” Scanning Kubernetes manifests..."

          CRITICAL_ISSUES=0
          WARNING_COUNT=0

          # Check for security contexts
          for file in $(find . -name "*.yaml" -o -name "*.yml" | grep -E "(k8s|kubernetes|helm)" 2>/dev/null || true); do
            if grep -q "kind: Pod\|kind: Deployment" "$file" 2>/dev/null; then
              if ! grep -q "securityContext" "$file" 2>/dev/null; then
                echo "âš ï¸  WARNING: No securityContext in $file"
                WARNING_COUNT=$((WARNING_COUNT + 1))
              fi

              # Check for privileged containers - CRITICAL
              if grep -q "privileged: true" "$file" 2>/dev/null; then
                echo "âŒ CRITICAL: Privileged container in $file"
                CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
              fi

              # Check for hostNetwork - CRITICAL
              if grep -q "hostNetwork: true" "$file" 2>/dev/null; then
                echo "âŒ CRITICAL: hostNetwork enabled in $file"
                CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
              fi
            fi
          done

          if [ "$CRITICAL_ISSUES" -gt 0 ]; then
            echo "âŒ Found $CRITICAL_ISSUES critical Kubernetes security issues"
            exit 1
          fi

          echo "âœ… Kubernetes manifest scan complete (warnings: $WARNING_COUNT)"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Dependabot Configuration Check
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  dependabot-check:
    name: Dependabot Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Dependabot config
        run: |
          if [ -f ".github/dependabot.yml" ]; then
            echo "âœ… Dependabot configuration exists"
            cat .github/dependabot.yml
          else
            echo "âš ï¸  WARNING: No Dependabot configuration found"
            echo "Creating recommended Dependabot config..."

            mkdir -p .github
            cat > .github/dependabot.yml <<'EOF'
          version: 2
          updates:
            # Python dependencies
            - package-ecosystem: "pip"
              directory: "/"
              schedule:
                interval: "weekly"
              open-pull-requests-limit: 10
              labels:
                - "dependencies"
                - "python"

            # Node.js dependencies
            - package-ecosystem: "npm"
              directory: "/"
              schedule:
                interval: "weekly"
              open-pull-requests-limit: 10
              labels:
                - "dependencies"
                - "nodejs"

            # GitHub Actions
            - package-ecosystem: "github-actions"
              directory: "/"
              schedule:
                interval: "weekly"
              labels:
                - "dependencies"
                - "github-actions"

            # Docker
            - package-ecosystem: "docker"
              directory: "/"
              schedule:
                interval: "weekly"
              labels:
                - "dependencies"
                - "docker"
          EOF

            echo "ðŸ“ Recommended Dependabot config created"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Security Summary Report
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      - secrets-scan
      - dependency-scan-python
      - dependency-scan-nodejs
      - sast-python
      - sast-semgrep
      - sast-codeql
      - container-scan
      - dockerfile-scan
      - iac-scan
      - dependabot-check
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Detection | ${{ needs.secrets-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Dependencies | ${{ needs.dependency-scan-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js Dependencies | ${{ needs.dependency-scan-nodejs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST (Bandit) | ${{ needs.sast-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST (Semgrep) | ${{ needs.sast-semgrep.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfile Scan | ${{ needs.dockerfile-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IaC Scan | ${{ needs.iac-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Review all HIGH and CRITICAL findings" >> $GITHUB_STEP_SUMMARY
          echo "- Update vulnerable dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- Fix security issues in code" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure all Dockerfiles follow best practices" >> $GITHUB_STEP_SUMMARY

      - name: Notify on critical findings
        if: ${{ failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') && secrets.SLACK_WEBHOOK_URL != '' }}
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "ðŸš¨ Critical Security Issues Found",
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: "*Security Scan Alert*\n\nCritical security issues detected in ${{ github.ref_name }}\n\n*Commit:* ${{ github.sha }}\n*Check:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
