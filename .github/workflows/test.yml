# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SAHOOL Test Suite
# Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ù‡ÙˆÙ„
#
# Runs all tests for Frontend and Backend
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Test Suite

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Detect Changes
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      python: ${{ steps.filter.outputs.python }}
      shared: ${{ steps.filter.outputs.shared }}
      mobile: ${{ steps.filter.outputs.mobile }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/web/**'
              - 'apps/admin/**'
              - 'packages/shared-hooks/**'
              - 'packages/shared-ui/**'
              - 'packages/shared-utils/**'
              - 'package.json'
            python:
              - 'apps/services/**'
              - 'shared/**'
              - 'pytest.ini'
              - 'requirements*.txt'
            shared:
              - 'governance/**'
            mobile:
              - 'apps/mobile/**'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Frontend Tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts --legacy-peer-deps || npm install --ignore-scripts --legacy-peer-deps

      - name: Install test dependencies
        run: |
          npm install -D vitest @vitejs/plugin-react jsdom @testing-library/react @testing-library/jest-dom --legacy-peer-deps

      - name: Run shared-hooks tests
        run: |
          echo "ðŸ§ª Running shared-hooks tests..."
          cd packages/shared-hooks
          npx vitest run --reporter=verbose || echo "::warning::shared-hooks tests not configured yet"

      - name: Run shared-ui tests
        run: |
          echo "ðŸ§ª Running shared-ui tests..."
          cd packages/shared-ui
          npx vitest run --reporter=verbose || echo "::warning::shared-ui tests not configured yet"

      - name: TypeScript Type Check
        run: |
          echo "ðŸ“ Running TypeScript type check..."
          npx tsc --noEmit -p apps/web/tsconfig.json || echo "::warning::TypeScript errors found in web app"
          npx tsc --noEmit -p apps/admin/tsconfig.json || echo "::warning::TypeScript errors found in admin app"
        continue-on-error: true

      - name: Build Check
        run: |
          echo "ðŸ—ï¸ Checking build..."
          cd apps/web && npm run build || echo "::warning::Build failed"
        continue-on-error: true

      - name: Test Summary
        if: always()
        run: |
          echo "## Frontend Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Vitest tests completed" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript check completed" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Python Tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install test dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio numpy

      - name: Run NDVI Processor Tests
        run: |
          echo "ðŸ§ª Running NDVI Processor tests..."
          pytest apps/services/ndvi-processor/tests/ -v --tb=short || echo "::warning::NDVI tests failed"

      - name: Run Alert Service Tests
        run: |
          echo "ðŸ§ª Running Alert Service tests..."
          pytest apps/services/alert-service/tests/ -v --tb=short || echo "::warning::Alert tests failed"

      - name: Run Field Service Tests
        run: |
          echo "ðŸ§ª Running Field Service tests..."
          pytest apps/services/field-service/tests/ -v --tb=short || echo "::warning::Field tests failed"

      - name: Generate Coverage Report
        run: |
          echo "ðŸ“Š Generating coverage report..."
          pytest apps/services/ -v --cov=apps/services --cov-report=xml --cov-report=term-missing || true

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Flutter Mobile Tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  flutter-tests:
    name: Flutter Mobile Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.mobile == 'true' || github.event_name == 'push'
    defaults:
      run:
        working-directory: apps/mobile
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          ENV=development
          API_URL=http://localhost:8000/api/v1
          WS_URL=ws://localhost:8090
          ENABLE_OFFLINE_MODE=true
          ENABLE_BACKGROUND_SYNC=true
          EOF

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Analyze code
        run: flutter analyze --no-fatal-infos || echo "::warning::Analysis warnings found"

      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running Flutter unit tests..."
          flutter test test/unit/ --reporter=expanded || echo "::warning::Some unit tests failed"

      - name: Run widget tests
        run: |
          echo "ðŸ§ª Running Flutter widget tests..."
          flutter test test/widget/ --reporter=expanded || echo "::warning::Some widget tests failed"

      - name: Run integration tests
        run: |
          echo "ðŸ§ª Running Flutter integration tests..."
          flutter test test/integration/ --reporter=expanded || echo "::warning::Some integration tests failed"

      - name: Test Summary
        if: always()
        run: |
          echo "## Flutter Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Unit tests completed" >> $GITHUB_STEP_SUMMARY
          echo "- Widget tests completed" >> $GITHUB_STEP_SUMMARY
          echo "- Integration tests completed" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Event Schema Validation
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  schema-validation:
    name: Event Schema Validation
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.shared == 'true' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pyyaml jsonschema

      - name: Validate Event Catalog
        run: |
          echo "ðŸ” Validating event catalog..."
          python -c "
          import yaml
          import json
          import sys
          from pathlib import Path

          catalog_path = Path('governance/events/catalog.yaml')
          schemas_path = Path('governance/events/schemas')

          if not catalog_path.exists():
              print('::warning::Event catalog not found')
              sys.exit(0)

          # Load catalog
          with open(catalog_path) as f:
              catalog = yaml.safe_load(f)

          print(f'âœ… Event catalog loaded: {len(catalog.get(\"events\", {}))} events defined')

          # Validate schemas
          errors = []
          for event_name, event_def in catalog.get('events', {}).items():
              schema_ref = event_def.get('schema', {}).get('\$ref', '')
              if schema_ref:
                  schema_file = schemas_path / schema_ref.replace('./', '')
                  if schema_file.exists():
                      try:
                          with open(schema_file) as f:
                              schema = json.load(f)
                          print(f'  âœ“ {event_name}: schema valid')
                      except json.JSONDecodeError as e:
                          errors.append(f'{event_name}: invalid JSON - {e}')
                  else:
                      print(f'  âš  {event_name}: schema file not found ({schema_file})')

          if errors:
              print('\\nâŒ Schema validation errors:')
              for err in errors:
                  print(f'  - {err}')
              sys.exit(1)

          print('\\nâœ… All event schemas validated')
          "

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Test Summary
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [frontend-tests, python-tests, flutter-tests, schema-validation]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.frontend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.python-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Flutter Tests | ${{ needs.flutter-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Schema Validation | ${{ needs.schema-validation.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check Results
        run: |
          # Count failures but don't fail the workflow for optional tests
          FAILURES=0

          if [[ "${{ needs.frontend-tests.result }}" == "failure" ]]; then
            echo "::warning::Frontend tests had failures"
            FAILURES=$((FAILURES + 1))
          fi

          if [[ "${{ needs.python-tests.result }}" == "failure" ]]; then
            echo "::warning::Python tests had failures"
            FAILURES=$((FAILURES + 1))
          fi

          if [[ "${{ needs.flutter-tests.result }}" == "failure" ]]; then
            echo "::warning::Flutter tests had failures"
            FAILURES=$((FAILURES + 1))
          fi

          if [[ "${{ needs.schema-validation.result }}" == "failure" ]]; then
            echo "::warning::Schema validation had failures"
            FAILURES=$((FAILURES + 1))
          fi

          if [ $FAILURES -gt 0 ]; then
            echo "::warning::$FAILURES test suite(s) had failures - review required"
          fi

          echo "âœ… Test summary completed"
