
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Complete developer guide for the SAHOOL Agricultural Platform">
      
      
        <meta name="author" content="KAFAAT Team">
      
      
      
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Refresh Token Rotation Implementation - SAHOOL Developer Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="light-green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#refresh-token-rotation-implementation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="SAHOOL Developer Documentation" class="md-header__button md-logo" aria-label="SAHOOL Developer Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SAHOOL Developer Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Refresh Token Rotation Implementation
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../index.md" class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../getting-started/installation.md" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../services/overview.md" class="md-tabs__link">
          
  
  
  Services

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../api/authentication/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../development/setup.md" class="md-tabs__link">
          
  
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../contributing/guidelines.md" class="md-tabs__link">
          
  
  
  Contributing

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="SAHOOL Developer Documentation" class="md-nav__button md-logo" aria-label="SAHOOL Developer Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    SAHOOL Developer Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/installation.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/quickstart.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/architecture.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Services
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Services
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services/overview.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services/starter.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Starter Package
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services/professional.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Professional Package
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services/enterprise.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Enterprise Package
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/authentication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Authentication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/field-ops.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Field Operations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/weather/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Weather
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/satellite.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Satellite
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/setup.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/testing.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/deployment.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Contributing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/guidelines.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Guidelines
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/code-style.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Style
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="refresh-token-rotation-implementation">Refresh Token Rotation Implementation<a class="headerlink" href="#refresh-token-rotation-implementation" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>This document describes the refresh token rotation security feature implemented in the SAHOOL authentication system. Refresh token rotation is a security best practice that mitigates the risk of token theft and replay attacks.</p>
<h2 id="problem-statement">Problem Statement<a class="headerlink" href="#problem-statement" title="Permanent link">&para;</a></h2>
<p><strong>Before:</strong> Refresh tokens could be reused indefinitely until expiration, making them vulnerable to:</p>
<ul>
<li>Token theft and replay attacks</li>
<li>Unauthorized access if a token is compromised</li>
<li>No detection mechanism for token reuse</li>
</ul>
<h2 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">&para;</a></h2>
<p><strong>After:</strong> Implemented automatic refresh token rotation with:</p>
<ol>
<li><strong>One-time use tokens:</strong> Each refresh token can only be used once</li>
<li><strong>Token family tracking:</strong> All rotated tokens share a family ID</li>
<li><strong>Reuse detection:</strong> Detects when a used token is replayed</li>
<li><strong>Family invalidation:</strong> Invalidates all tokens in a family when reuse is detected</li>
<li><strong>Dual storage:</strong> Tokens stored in both PostgreSQL (persistence) and Redis (fast blacklisting)</li>
</ol>
<h2 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h2>
<h3 id="token-family-flow">Token Family Flow<a class="headerlink" href="#token-family-flow" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>Login
  └─&gt; Token Family A created
      ├─&gt; Refresh Token 1 (JTI: abc123, Family: A)
      └─&gt; Access Token 1

First Refresh
  ├─&gt; Token 1 marked as USED
  ├─&gt; Token 1 added to Redis blacklist (5 min TTL)
  └─&gt; New tokens generated
      ├─&gt; Refresh Token 2 (JTI: def456, Family: A)
      └─&gt; Access Token 2

Second Refresh
  ├─&gt; Token 2 marked as USED
  ├─&gt; Token 2 added to Redis blacklist
  └─&gt; New tokens generated
      ├─&gt; Refresh Token 3 (JTI: ghi789, Family: A)
      └─&gt; Access Token 3

Reuse Attack (using Token 1 again)
  ├─&gt; Detect Token 1 is already USED
  ├─&gt; Invalidate ENTIRE Family A
  │   ├─&gt; Mark all tokens in family as REVOKED (PostgreSQL)
  │   └─&gt; Blacklist all tokens in family (Redis)
  └─&gt; Throw UnauthorizedException
</code></pre></div>

<h2 id="implementation-details">Implementation Details<a class="headerlink" href="#implementation-details" title="Permanent link">&para;</a></h2>
<h3 id="1-database-schema-updates">1. Database Schema Updates<a class="headerlink" href="#1-database-schema-updates" title="Permanent link">&para;</a></h3>
<p><strong>File:</strong> <code>/home/user/sahool-unified-v15-idp/apps/services/user-service/prisma/schema.prisma</code></p>
<p>Added to <code>RefreshToken</code> model:</p>
<ul>
<li><code>jti</code>: Unique JWT ID for token identification</li>
<li><code>family</code>: Token family ID for rotation tracking</li>
<li><code>used</code>: Boolean flag indicating if token was used</li>
<li><code>usedAt</code>: Timestamp of when token was used</li>
<li><code>replacedBy</code>: JTI of the replacement token</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">model</span><span class="w"> </span><span class="n">RefreshToken</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="n">id</span><span class="w">          </span><span class="n">String</span><span class="w">   </span><span class="nv">@id</span><span class="w"> </span><span class="nv">@default</span><span class="p">(</span><span class="n">uuid</span><span class="p">())</span>
<span class="w">  </span><span class="n">userId</span><span class="w">      </span><span class="n">String</span><span class="w">   </span><span class="nv">@map</span><span class="p">(</span><span class="ss">&quot;user_id&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">jti</span><span class="w">         </span><span class="n">String</span><span class="w">   </span><span class="nv">@unique</span>
<span class="w">  </span><span class="n">family</span><span class="w">      </span><span class="n">String</span><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Token</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">rotation</span><span class="w"> </span><span class="n">tracking</span>
<span class="w">  </span><span class="n">token</span><span class="w">       </span><span class="n">String</span><span class="w">   </span><span class="nv">@unique</span>
<span class="w">  </span><span class="n">expiresAt</span><span class="w">   </span><span class="nc">DateTime</span><span class="w"> </span><span class="nv">@map</span><span class="p">(</span><span class="ss">&quot;expires_at&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">revoked</span><span class="w">     </span><span class="k">Boolean</span><span class="w">  </span><span class="nv">@default</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
<span class="w">  </span><span class="n">used</span><span class="w">        </span><span class="k">Boolean</span><span class="w">  </span><span class="nv">@default</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
<span class="w">  </span><span class="n">usedAt</span><span class="w">      </span><span class="nc">DateTime</span><span class="vm">?</span><span class="w"> </span><span class="nv">@map</span><span class="p">(</span><span class="ss">&quot;used_at&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">replacedBy</span><span class="w">  </span><span class="n">String</span><span class="vm">?</span><span class="w">  </span><span class="nv">@map</span><span class="p">(</span><span class="ss">&quot;replaced_by&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">createdAt</span><span class="w">   </span><span class="nc">DateTime</span><span class="w"> </span><span class="nv">@default</span><span class="p">(</span><span class="n">now</span><span class="p">())</span><span class="w"> </span><span class="nv">@map</span><span class="p">(</span><span class="ss">&quot;created_at&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="k">user</span><span class="w">        </span><span class="k">User</span><span class="w">     </span><span class="nv">@relation</span><span class="p">(</span><span class="nl">fields</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">userId</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="k">references</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">id</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="nl">onDelete</span><span class="p">:</span><span class="w"> </span><span class="k">Cascade</span><span class="p">)</span>

<span class="w">  </span><span class="nb">@@index</span><span class="p">(</span><span class="o">[</span><span class="n">userId</span><span class="o">]</span><span class="p">)</span>
<span class="w">  </span><span class="nb">@@index</span><span class="p">(</span><span class="o">[</span><span class="n">jti</span><span class="o">]</span><span class="p">)</span>
<span class="w">  </span><span class="nb">@@index</span><span class="p">(</span><span class="o">[</span><span class="n">family</span><span class="o">]</span><span class="p">)</span>
<span class="w">  </span><span class="nb">@@index</span><span class="p">(</span><span class="o">[</span><span class="n">token</span><span class="o">]</span><span class="p">)</span>
<span class="w">  </span><span class="nb">@@index</span><span class="p">(</span><span class="o">[</span><span class="n">expiresAt</span><span class="o">]</span><span class="p">)</span>
<span class="w">  </span><span class="nb">@@map</span><span class="p">(</span><span class="ss">&quot;refresh_tokens&quot;</span><span class="p">)</span>
<span class="err">}</span>
</code></pre></div>

<h3 id="2-jwt-payload-updates">2. JWT Payload Updates<a class="headerlink" href="#2-jwt-payload-updates" title="Permanent link">&para;</a></h3>
<p><strong>File:</strong> <code>/home/user/sahool-unified-v15-idp/apps/services/user-service/src/auth/auth.service.ts</code></p>
<p>Added <code>family</code> field to JwtPayload for refresh tokens:</p>
<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">JwtPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">roles</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">  </span><span class="nx">tid?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">jti</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;access&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;refresh&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">family?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="c1">// Token family for refresh token rotation</span>
<span class="w">  </span><span class="nx">iat?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">exp?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="3-token-generation-with-family">3. Token Generation with Family<a class="headerlink" href="#3-token-generation-with-family" title="Permanent link">&para;</a></h3>
<p>Updated <code>generateTokens()</code> method:</p>
<ul>
<li>Accepts optional <code>family</code> parameter</li>
<li>Generates new family ID on initial login</li>
<li>Reuses family ID on token rotation</li>
<li>Stores refresh token in PostgreSQL with family information</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">generateTokens</span><span class="p">(</span>
<span class="w">  </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">,</span>
<span class="w">  </span><span class="nx">family?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span>
<span class="w">  </span><span class="nx">access_token</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">refresh_token</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">expires_in</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">token_type</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenFamily</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">family</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">uuidv4</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// ... token generation ...</span>

<span class="w">  </span><span class="c1">// Store refresh token in database</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">prisma</span><span class="p">.</span><span class="nx">refreshToken</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">user.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">jti</span><span class="o">:</span><span class="w"> </span><span class="kt">refreshJti</span><span class="p">,</span>
<span class="w">      </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="kt">tokenFamily</span><span class="p">,</span>
<span class="w">      </span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="kt">refresh_token</span><span class="p">,</span>
<span class="w">      </span><span class="nx">expiresAt</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="4-token-family-invalidation">4. Token Family Invalidation<a class="headerlink" href="#4-token-family-invalidation" title="Permanent link">&para;</a></h3>
<p>New method <code>invalidateTokenFamily()</code>:</p>
<ul>
<li>Marks all tokens in family as revoked in PostgreSQL</li>
<li>Blacklists all tokens in family in Redis</li>
<li>Logs security warning</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">invalidateTokenFamily</span><span class="p">(</span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Mark all tokens in family as revoked in database</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">prisma</span><span class="p">.</span><span class="nx">refreshToken</span><span class="p">.</span><span class="nx">updateMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">family</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revoked</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Get all tokens in family to revoke in Redis</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">familyTokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">prisma</span><span class="p">.</span><span class="nx">refreshToken</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">family</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">select</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jti</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Revoke each token in Redis</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">revokePromises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">familyTokens</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">revocationStore</span><span class="p">.</span><span class="nx">revokeToken</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">jti</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">expiresIn</span><span class="o">:</span><span class="w"> </span><span class="kt">JWTConfig.REFRESH_TOKEN_EXPIRE_DAYS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="p">,</span>
<span class="w">      </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;token_reuse_detected&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">revokePromises</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="5-refresh-token-rotation">5. Refresh Token Rotation<a class="headerlink" href="#5-refresh-token-rotation" title="Permanent link">&para;</a></h3>
<p>Completely rewritten <code>refreshToken()</code> method:</p>
<p><strong>Security Checks:</strong></p>
<ol>
<li>Verify JWT signature and expiration</li>
<li>Verify token type is 'refresh'</li>
<li>Check token exists in database</li>
<li><strong>Check if token was already used (reuse detection)</strong></li>
<li>Check if token is revoked</li>
<li>Check if token is expired</li>
<li>Verify user account is still active</li>
</ol>
<p><strong>Rotation Process:</strong></p>
<ol>
<li>Mark current token as USED in database</li>
<li>Store <code>replacedBy</code> JTI for audit trail</li>
<li>Blacklist old token in Redis (5 min TTL for detection window)</li>
<li>Generate new token pair with same family</li>
<li>Return new access and refresh tokens</li>
</ol>
<p><strong>Reuse Detection:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Check if token was already used (replay attack detection)</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">storedToken</span><span class="p">.</span><span class="nx">used</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span>
<span class="w">    </span><span class="sb">`Token reuse detected! Token: </span><span class="si">${</span><span class="nx">payload</span><span class="p">.</span><span class="nx">jti</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="si">}</span><span class="sb">..., Family: </span><span class="si">${</span><span class="nx">payload</span><span class="p">.</span><span class="nx">family</span><span class="o">?</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="si">}</span><span class="sb">...`</span><span class="p">,</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Invalidate entire token family</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">family</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">invalidateTokenFamily</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">family</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">UnauthorizedException</span><span class="p">(</span>
<span class="w">    </span><span class="s2">&quot;Token reuse detected - all tokens in family have been invalidated&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="6-api-updates">6. API Updates<a class="headerlink" href="#6-api-updates" title="Permanent link">&para;</a></h3>
<p><strong>Controller:</strong> <code>/home/user/sahool-unified-v15-idp/apps/services/user-service/src/auth/auth.controller.ts</code></p>
<p>Updated <code>/auth/refresh</code> endpoint to return new refresh token:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">@ApiResponse</span><span class="p">({</span>
<span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">200</span><span class="p">,</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Token refreshed successfully with rotation&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">schema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">access_token</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">refresh_token</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// NEW: rotated refresh token</span>
<span class="w">      </span><span class="nx">expires_in</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">token_type</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
<span class="k">async</span><span class="w"> </span><span class="nx">refreshToken</span><span class="p">(</span><span class="kd">@Body</span><span class="p">()</span><span class="w"> </span><span class="nx">refreshTokenDto</span><span class="o">:</span><span class="w"> </span><span class="kt">RefreshTokenDto</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">refreshToken</span><span class="p">(</span><span class="nx">refreshTokenDto</span><span class="p">.</span><span class="nx">refreshToken</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="7-frontend-updates">7. Frontend Updates<a class="headerlink" href="#7-frontend-updates" title="Permanent link">&para;</a></h3>
<p><strong>Admin App:</strong> <code>/home/user/sahool-unified-v15-idp/apps/admin/src/app/api/auth/refresh/route.ts</code></p>
<p>Updated to store new refresh token in cookies:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Update refresh token (always rotated now)</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">refresh_token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">cookieStore</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;sahool_admin_refresh_token&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">refresh_token</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">httpOnly</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">secure</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.NODE_ENV</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sameSite</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">maxAge</span><span class="o">:</span><span class="w"> </span><span class="kt">604800</span><span class="p">,</span><span class="w"> </span><span class="c1">// 7 days</span>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="security-benefits">Security Benefits<a class="headerlink" href="#security-benefits" title="Permanent link">&para;</a></h2>
<h3 id="1-token-reuse-detection">1. Token Reuse Detection<a class="headerlink" href="#1-token-reuse-detection" title="Permanent link">&para;</a></h3>
<ul>
<li>Each token can only be used once</li>
<li>Reuse triggers immediate security response</li>
<li>All related tokens are invalidated</li>
</ul>
<h3 id="2-reduced-attack-window">2. Reduced Attack Window<a class="headerlink" href="#2-reduced-attack-window" title="Permanent link">&para;</a></h3>
<ul>
<li>Used tokens blacklisted in Redis for 5 minutes</li>
<li>Detects concurrent reuse attempts</li>
<li>Fast response time for security events</li>
</ul>
<h3 id="3-audit-trail">3. Audit Trail<a class="headerlink" href="#3-audit-trail" title="Permanent link">&para;</a></h3>
<ul>
<li>Complete history of token rotation in database</li>
<li><code>replacedBy</code> field tracks token lineage</li>
<li>Security logs for all reuse attempts</li>
</ul>
<h3 id="4-family-based-invalidation">4. Family-based Invalidation<a class="headerlink" href="#4-family-based-invalidation" title="Permanent link">&para;</a></h3>
<ul>
<li>Single compromised token doesn't invalidate all user sessions</li>
<li>Only affected token family is invalidated</li>
<li>Other login sessions remain valid</li>
</ul>
<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h2>
<h3 id="environment-variables">Environment Variables<a class="headerlink" href="#environment-variables" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># JWT Configuration</span>
<span class="nv">JWT_SECRET_KEY</span><span class="o">=</span>your-secret-key-min-32-chars
<span class="nv">JWT_ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="o">=</span><span class="m">30</span>
<span class="nv">JWT_REFRESH_TOKEN_EXPIRE_DAYS</span><span class="o">=</span><span class="m">7</span>

<span class="c1"># Redis Configuration (for token blacklisting)</span>
<span class="nv">REDIS_URL</span><span class="o">=</span>redis://localhost:6379/0
<span class="c1"># OR</span>
<span class="nv">REDIS_HOST</span><span class="o">=</span>localhost
<span class="nv">REDIS_PORT</span><span class="o">=</span><span class="m">6379</span>
<span class="nv">REDIS_DB</span><span class="o">=</span><span class="m">0</span>
<span class="nv">REDIS_PASSWORD</span><span class="o">=</span>optional-password
</code></pre></div>

<h3 id="token-expiration-times">Token Expiration Times<a class="headerlink" href="#token-expiration-times" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Access Token:</strong> 30 minutes (default)</li>
<li><strong>Refresh Token:</strong> 7 days (default)</li>
<li><strong>Used Token Blacklist TTL:</strong> 5 minutes (detection window)</li>
</ul>
<h2 id="migration">Migration<a class="headerlink" href="#migration" title="Permanent link">&para;</a></h2>
<h3 id="1-run-prisma-migration">1. Run Prisma Migration<a class="headerlink" href="#1-run-prisma-migration" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>apps/services/user-service
npx<span class="w"> </span>prisma<span class="w"> </span>migrate<span class="w"> </span>dev<span class="w"> </span>--name<span class="w"> </span>add_refresh_token_rotation
</code></pre></div>

<p>Or run the SQL migration manually:</p>
<div class="codehilite"><pre><span></span><code>psql<span class="w"> </span>-U<span class="w"> </span>your_user<span class="w"> </span>-d<span class="w"> </span>your_database<span class="w"> </span>-f<span class="w"> </span>prisma/migrations/add_refresh_token_rotation.sql
</code></pre></div>

<h3 id="2-generate-prisma-client">2. Generate Prisma Client<a class="headerlink" href="#2-generate-prisma-client" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>npx<span class="w"> </span>prisma<span class="w"> </span>generate
</code></pre></div>

<h3 id="3-restart-services">3. Restart Services<a class="headerlink" href="#3-restart-services" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Restart user service</span>
docker-compose<span class="w"> </span>restart<span class="w"> </span>user-service

<span class="c1"># Or if running locally</span>
npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>

<h2 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h2>
<h3 id="test-token-rotation">Test Token Rotation<a class="headerlink" href="#test-token-rotation" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Login</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:3000/api/v1/auth/login<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;email&quot;:&quot;user@sahool.com&quot;,&quot;password&quot;:&quot;password123&quot;}&#39;</span>

<span class="c1"># Response:</span>
<span class="c1"># {</span>
<span class="c1">#   &quot;access_token&quot;: &quot;eyJ...&quot;,</span>
<span class="c1">#   &quot;refresh_token&quot;: &quot;eyJ...&quot;,</span>
<span class="c1">#   &quot;expires_in&quot;: 1800,</span>
<span class="c1">#   &quot;token_type&quot;: &quot;Bearer&quot;</span>
<span class="c1"># }</span>

<span class="c1"># 2. Refresh token (first time - should work)</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:3000/api/v1/auth/refresh<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;refreshToken&quot;:&quot;eyJ...&quot;}&#39;</span>

<span class="c1"># Response:</span>
<span class="c1"># {</span>
<span class="c1">#   &quot;access_token&quot;: &quot;eyJ...&quot;,</span>
<span class="c1">#   &quot;refresh_token&quot;: &quot;eyJ...&quot;,  # NEW rotated token</span>
<span class="c1">#   &quot;expires_in&quot;: 1800,</span>
<span class="c1">#   &quot;token_type&quot;: &quot;Bearer&quot;</span>
<span class="c1"># }</span>

<span class="c1"># 3. Try to reuse old refresh token (should fail)</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:3000/api/v1/auth/refresh<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;refreshToken&quot;:&quot;eyJ...&quot;}&#39;</span><span class="w">  </span><span class="c1"># Old token</span>

<span class="c1"># Response:</span>
<span class="c1"># {</span>
<span class="c1">#   &quot;statusCode&quot;: 401,</span>
<span class="c1">#   &quot;message&quot;: &quot;Token reuse detected - all tokens in family have been invalidated&quot;</span>
<span class="c1"># }</span>
</code></pre></div>

<h3 id="test-database-state">Test Database State<a class="headerlink" href="#test-database-state" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Check refresh tokens for a user</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">jti</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="p">,</span><span class="w"> </span><span class="n">used</span><span class="p">,</span><span class="w"> </span><span class="n">used_at</span><span class="p">,</span><span class="w"> </span><span class="n">replaced_by</span><span class="p">,</span><span class="w"> </span><span class="n">revoked</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">refresh_tokens</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;your-user-id&#39;</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>

<span class="c1">-- Check token family</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">jti</span><span class="p">,</span><span class="w"> </span><span class="n">used</span><span class="p">,</span><span class="w"> </span><span class="n">revoked</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="p">,</span><span class="w"> </span><span class="n">replaced_by</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">refresh_tokens</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;family-id&#39;</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div>

<h3 id="test-redis-blacklist">Test Redis Blacklist<a class="headerlink" href="#test-redis-blacklist" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Connect to Redis</span>
redis-cli

<span class="c1"># Check for revoked tokens</span>
KEYS<span class="w"> </span>revoked:token:*

<span class="c1"># Check specific token</span>
GET<span class="w"> </span>revoked:token:your-jti-here

<span class="c1"># Check TTL</span>
TTL<span class="w"> </span>revoked:token:your-jti-here
</code></pre></div>

<h2 id="monitoring">Monitoring<a class="headerlink" href="#monitoring" title="Permanent link">&para;</a></h2>
<h3 id="key-metrics-to-monitor">Key Metrics to Monitor<a class="headerlink" href="#key-metrics-to-monitor" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Token Reuse Attempts:</strong> Count of reuse detection events</li>
<li><strong>Family Invalidations:</strong> Number of families invalidated</li>
<li><strong>Token Rotation Rate:</strong> Successful refreshes per time period</li>
<li><strong>Failed Refresh Attempts:</strong> Invalid/expired/revoked tokens</li>
</ol>
<h3 id="log-messages">Log Messages<a class="headerlink" href="#log-messages" title="Permanent link">&para;</a></h3>
<p><strong>Successful Rotation:</strong></p>
<div class="codehilite"><pre><span></span><code>Token refreshed for user: usr_123, Old JTI: abc123..., New JTI: def456...
</code></pre></div>

<p><strong>Reuse Detection:</strong></p>
<div class="codehilite"><pre><span></span><code>Token reuse detected! Token: abc123..., Family: xyz789...
Token family invalidated due to reuse detection: family=xyz789...
</code></pre></div>

<h2 id="best-practices">Best Practices<a class="headerlink" href="#best-practices" title="Permanent link">&para;</a></h2>
<h3 id="client-implementation">Client Implementation<a class="headerlink" href="#client-implementation" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Always store new refresh token</strong> returned from refresh endpoint</li>
<li><strong>Never reuse old refresh tokens</strong> after rotation</li>
<li><strong>Handle 401 errors</strong> by redirecting to login</li>
<li><strong>Implement retry logic</strong> with exponential backoff</li>
<li><strong>Use secure storage</strong> (httpOnly cookies for web, secure storage for mobile)</li>
</ol>
<h3 id="server-configuration">Server Configuration<a class="headerlink" href="#server-configuration" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Set appropriate TTLs</strong> based on security requirements</li>
<li><strong>Monitor reuse attempts</strong> for security anomalies</li>
<li><strong>Clean up expired tokens</strong> periodically from database</li>
<li><strong>Use Redis for fast blacklisting</strong> to reduce database load</li>
<li><strong>Log all security events</strong> for audit trail</li>
</ol>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h2>
<h3 id="issue-token-reuse-detected-on-legitimate-requests">Issue: "Token reuse detected" on legitimate requests<a class="headerlink" href="#issue-token-reuse-detected-on-legitimate-requests" title="Permanent link">&para;</a></h3>
<p><strong>Cause:</strong> Race condition - client made concurrent refresh requests</p>
<p><strong>Solution:</strong></p>
<ul>
<li>Implement request queuing on client side</li>
<li>Use mutex/lock for refresh operations</li>
<li>Increase Redis TTL for detection window</li>
</ul>
<h3 id="issue-all-user-sessions-invalidated-unexpectedly">Issue: All user sessions invalidated unexpectedly<a class="headerlink" href="#issue-all-user-sessions-invalidated-unexpectedly" title="Permanent link">&para;</a></h3>
<p><strong>Cause:</strong> Token reuse in one session invalidated entire family</p>
<p><strong>Solution:</strong></p>
<ul>
<li>Each login creates a NEW family</li>
<li>Different devices/sessions have different families</li>
<li>Only the compromised session is invalidated</li>
</ul>
<h3 id="issue-high-redis-memory-usage">Issue: High Redis memory usage<a class="headerlink" href="#issue-high-redis-memory-usage" title="Permanent link">&para;</a></h3>
<p><strong>Cause:</strong> Many used tokens in Redis</p>
<p><strong>Solution:</strong></p>
<ul>
<li>Reduce detection window TTL (currently 5 minutes)</li>
<li>Implement Redis eviction policy (LRU)</li>
<li>Monitor and adjust based on usage patterns</li>
</ul>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics">OAuth 2.0 Security Best Practices</a></li>
<li><a href="https://auth0.com/docs/secure/tokens/refresh-tokens/refresh-token-rotation">Refresh Token Rotation</a></li>
<li><a href="https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html">OWASP Token Security</a></li>
</ul>
<h2 id="files-modified">Files Modified<a class="headerlink" href="#files-modified" title="Permanent link">&para;</a></h2>
<ol>
<li><code>/home/user/sahool-unified-v15-idp/apps/services/user-service/prisma/schema.prisma</code></li>
<li><code>/home/user/sahool-unified-v15-idp/apps/services/user-service/src/auth/auth.service.ts</code></li>
<li><code>/home/user/sahool-unified-v15-idp/apps/services/user-service/src/auth/auth.controller.ts</code></li>
<li><code>/home/user/sahool-unified-v15-idp/apps/admin/src/app/api/auth/refresh/route.ts</code></li>
</ol>
<h2 id="files-created">Files Created<a class="headerlink" href="#files-created" title="Permanent link">&para;</a></h2>
<ol>
<li><code>/home/user/sahool-unified-v15-idp/apps/services/user-service/prisma/migrations/add_refresh_token_rotation.sql</code></li>
<li><code>/home/user/sahool-unified-v15-idp/docs/REFRESH_TOKEN_ROTATION.md</code></li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>