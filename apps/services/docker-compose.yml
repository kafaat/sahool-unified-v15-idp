version: "3.8"

services:
  # ==========================================================================
  # Infrastructure
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-sahool}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-sahool_events}
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sahool"]
      interval: 5s
      retries: 5

  nats:
    image: nats:2-alpine
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["-js", "-m", "8222"]

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  # ==========================================================================
  # SAHOOL Kernel Services v15.3
  # ==========================================================================

  satellite-service:
    build:
      context: ./satellite-service
      dockerfile: Dockerfile
    ports:
      - "8090:8090"
    environment:
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis://redis:6379
    depends_on:
      - nats
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

  indicators-service:
    build:
      context: ./indicators-service
      dockerfile: Dockerfile
    ports:
      - "8091:8091"
    environment:
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis://redis:6379
      - POSTGRES_HOST=postgres
    depends_on:
      - postgres
      - nats
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

  weather-advanced:
    build:
      context: ./weather-advanced
      dockerfile: Dockerfile
    ports:
      - "8092:8092"
    environment:
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis://redis:6379
    depends_on:
      - nats
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8092/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

  # خدمة التقويم الفلكي الزراعي اليمني
  astronomical-calendar:
    build:
      context: ./astronomical-calendar
      dockerfile: Dockerfile
    ports:
      - "8111:8111"
    environment:
      - WEATHER_SERVICE_URL=http://weather-advanced:8092
    depends_on:
      - weather-advanced
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8111/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

  fertilizer-advisor:
    build:
      context: ./fertilizer-advisor
      dockerfile: Dockerfile
    ports:
      - "8093:8093"
    environment:
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis://redis:6379
      - POSTGRES_HOST=postgres
    depends_on:
      - postgres
      - nats
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8093/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

  irrigation-smart:
    build:
      context: ./irrigation-smart
      dockerfile: Dockerfile
    ports:
      - "8094:8094"
    environment:
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis://redis:6379
      - POSTGRES_HOST=postgres
    depends_on:
      - postgres
      - nats
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8094/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  pg_data:
