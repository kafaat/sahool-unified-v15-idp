// ═══════════════════════════════════════════════════════════════════════════
// SAHOOL Field Core - Prisma Schema
// Database: PostgreSQL with PostGIS Extension
// ═══════════════════════════════════════════════════════════════════════════

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  // Direct URL for migrations (bypasses PgBouncer connection pooler)
  directUrl  = env("DATABASE_URL_DIRECT")
  extensions = [postgis]
  // TLS/SSL enforcement for secure connections
  // Requires DATABASE_URL to include sslmode=require parameter
  // Connection pooling parameters are configured in DATABASE_URL
  // Example: postgresql://user:pass@pgbouncer:6432/db?sslmode=require&connection_limit=8&pool_timeout=20&connect_timeout=10
}

// ─────────────────────────────────────────────────────────────────────────────
// Farm Entity - المزارع
// Farm locations and boundaries with geospatial support
// ─────────────────────────────────────────────────────────────────────────────

model Farm {
  id      String @id @default(uuid()) @db.Uuid
  version Int    @default(1) // Optimistic locking

  // Basic Info
  name     String @db.VarChar(255)
  tenantId String @map("tenant_id") @db.VarChar(100)
  ownerId  String @map("owner_id") @db.VarChar(100)

  // Geospatial (PostGIS)
  location Unsupported("geometry(Point, 4326)")? // Farm headquarters
  boundary Unsupported("geometry(Polygon, 4326)")? // Farm boundary

  // Calculated Fields
  totalAreaHectares Decimal? @map("total_area_hectares") @db.Decimal(10, 4)

  // Contact & Address
  address String? @db.VarChar(500)
  phone   String? @db.VarChar(50)
  email   String? @db.VarChar(255)

  // Flexible Metadata
  metadata Json? @db.JsonB

  // Sync Metadata
  isDeleted       Boolean  @default(false) @map("is_deleted")
  serverUpdatedAt DateTime @default(now()) @map("server_updated_at") @db.Timestamptz
  etag            String?  @default(uuid()) @db.VarChar(64)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  fields Field[]

  // Indexes
  @@index([tenantId], name: "idx_farm_tenant")
  @@index([ownerId], name: "idx_farm_owner")
  @@index([serverUpdatedAt], name: "idx_farm_sync")
  @@index([isDeleted], name: "idx_farm_deleted")
  @@index([isDeleted, serverUpdatedAt], name: "idx_farm_deleted_sync")
  @@map("farms")
}

// ─────────────────────────────────────────────────────────────────────────────
// Field Entity - الحقول الزراعية
// Core geospatial entity with sync support
// ─────────────────────────────────────────────────────────────────────────────

model Field {
  id      String @id @default(uuid()) @db.Uuid
  version Int    @default(1) // Optimistic locking

  // Basic Info
  name     String  @db.VarChar(255)
  tenantId String  @map("tenant_id") @db.VarChar(100)
  cropType String  @map("crop_type") @db.VarChar(100)
  ownerId  String? @map("owner_id") @db.Uuid

  // Farm Reference
  farmId String? @map("farm_id") @db.Uuid
  farm   Farm?   @relation(fields: [farmId], references: [id], onDelete: SetNull)

  // Geospatial (PostGIS) - handled via raw SQL
  // boundary: geometry(Polygon, 4326)
  // centroid: geometry(Point, 4326)
  boundary Unsupported("geometry(Polygon, 4326)")?
  centroid Unsupported("geometry(Point, 4326)")?

  // Calculated Fields
  areaHectares Decimal? @map("area_hectares") @db.Decimal(10, 4)

  // Health & Analysis
  healthScore Decimal? @map("health_score") @db.Decimal(3, 2)
  ndviValue   Decimal? @map("ndvi_value") @db.Decimal(4, 3)

  // Status & Dates
  status          FieldStatus @default(active)
  plantingDate    DateTime?   @map("planting_date") @db.Date
  expectedHarvest DateTime?   @map("expected_harvest") @db.Date

  // Agricultural Info
  irrigationType String? @map("irrigation_type") @db.VarChar(50)
  soilType       String? @map("soil_type") @db.VarChar(100)

  // Flexible Metadata (JSONB)
  metadata Json? @db.JsonB

  // Sync Metadata
  isDeleted       Boolean  @default(false) @map("is_deleted")
  serverUpdatedAt DateTime @default(now()) @map("server_updated_at") @db.Timestamptz
  etag            String?  @default(uuid()) @db.VarChar(64)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  boundaryHistory FieldBoundaryHistory[]
  tasks           Task[]
  ndviReadings    NdviReading[]

  // Indexes
  @@index([tenantId], name: "idx_field_tenant")
  @@index([farmId], name: "idx_field_farm")
  @@index([ownerId], name: "idx_field_owner")
  @@index([serverUpdatedAt], name: "idx_field_sync")
  @@index([status], name: "idx_field_status")
  @@index([cropType], name: "idx_field_crop")
  @@index([isDeleted], name: "idx_field_deleted")
  @@index([tenantId, status, cropType], name: "idx_field_tenant_status_crop")
  @@index([isDeleted, serverUpdatedAt], name: "idx_field_deleted_sync")
  @@map("fields")
}

// ─────────────────────────────────────────────────────────────────────────────
// Field Boundary History - سجل تغييرات الحدود
// Audit trail for boundary changes (for rollback support)
// ─────────────────────────────────────────────────────────────────────────────

model FieldBoundaryHistory {
  id String @id @default(uuid()) @db.Uuid

  // Field Reference
  fieldId         String @map("field_id") @db.Uuid
  versionAtChange Int    @map("version_at_change")

  // Boundary Snapshots (PostGIS)
  previousBoundary Unsupported("geometry(Polygon, 4326)")? @map("previous_boundary")
  newBoundary      Unsupported("geometry(Polygon, 4326)")? @map("new_boundary")

  // Change Metrics
  areaChangeHectares Decimal? @map("area_change_hectares") @db.Decimal(10, 4)

  // Change Metadata
  changedBy    String?      @map("changed_by") @db.VarChar(255)
  changeReason String?      @map("change_reason") @db.VarChar(500)
  changeSource ChangeSource @default(api) @map("change_source")
  deviceId     String?      @map("device_id") @db.VarChar(100)

  // Timestamp
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  field Field @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([fieldId], name: "idx_history_field")
  @@index([createdAt], name: "idx_history_date")
  @@map("field_boundary_history")
}

// ─────────────────────────────────────────────────────────────────────────────
// Sync Status - حالة المزامنة للأجهزة
// Tracks mobile device sync status
// ─────────────────────────────────────────────────────────────────────────────

model SyncStatus {
  id String @id @default(uuid()) @db.Uuid

  // Device Identification
  deviceId String @map("device_id") @db.VarChar(100)
  userId   String @map("user_id") @db.VarChar(100)
  tenantId String @map("tenant_id") @db.VarChar(100)

  // Sync State
  lastSyncAt      DateTime?  @map("last_sync_at") @db.Timestamptz
  lastSyncVersion BigInt     @default(0) @map("last_sync_version")
  status          SyncState  @default(idle)

  // Pending Operations
  pendingUploads   Int @default(0) @map("pending_uploads")
  pendingDownloads Int @default(0) @map("pending_downloads")
  conflictsCount   Int @default(0) @map("conflicts_count")

  // Error Tracking
  lastError String? @map("last_error") @db.Text

  // Device Info (JSONB)
  deviceInfo Json? @map("device_info") @db.JsonB

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Indexes
  @@unique([deviceId, userId], name: "idx_sync_device_user")
  @@index([tenantId], name: "idx_sync_tenant")
  @@map("sync_status")
}

// ─────────────────────────────────────────────────────────────────────────────
// Task - المهام الزراعية
// Tasks linked to fields
// ─────────────────────────────────────────────────────────────────────────────

model Task {
  id String @id @default(uuid()) @db.Uuid

  // Task Info
  title       String    @db.VarChar(255)
  titleAr     String?   @map("title_ar") @db.VarChar(255)
  description String?   @db.Text
  taskType    TaskType  @default(other) @map("task_type")
  priority    Priority  @default(medium)
  status      TaskState @default(pending)

  // Scheduling
  dueDate       DateTime? @map("due_date") @db.Timestamptz
  scheduledTime String?   @map("scheduled_time") @db.VarChar(10) // HH:MM
  completedAt   DateTime? @map("completed_at") @db.Timestamptz

  // Assignment
  assignedTo String? @map("assigned_to") @db.VarChar(100)
  createdBy  String  @map("created_by") @db.VarChar(100)

  // Field Reference
  fieldId String? @map("field_id") @db.Uuid
  field   Field?  @relation(fields: [fieldId], references: [id], onDelete: SetNull)

  // Duration
  estimatedMinutes Int? @map("estimated_minutes")
  actualMinutes    Int? @map("actual_minutes")

  // Completion Evidence
  completionNotes String? @map("completion_notes") @db.Text
  evidence        Json?   @db.JsonB // Array of {type, url, capturedAt}

  // Sync
  serverUpdatedAt DateTime @default(now()) @map("server_updated_at") @db.Timestamptz

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Indexes
  @@index([fieldId], name: "idx_task_field")
  @@index([status], name: "idx_task_status")
  @@index([dueDate], name: "idx_task_due")
  @@map("tasks")
}

// ─────────────────────────────────────────────────────────────────────────────
// NDVI Reading - قراءات NDVI
// Historical NDVI values for fields
// ─────────────────────────────────────────────────────────────────────────────

model NdviReading {
  id String @id @default(uuid()) @db.Uuid

  // Field Reference
  fieldId String @map("field_id") @db.Uuid
  field   Field  @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  // NDVI Data
  value       Decimal   @db.Decimal(4, 3) // -1.000 to 1.000
  capturedAt  DateTime  @map("captured_at") @db.Timestamptz
  source      String    @default("satellite") @db.VarChar(50) // satellite, drone, manual
  cloudCover  Decimal?  @map("cloud_cover") @db.Decimal(5, 2) // 0-100%
  quality     String?   @db.VarChar(20) // good, moderate, poor

  // Satellite Info
  satelliteName String? @map("satellite_name") @db.VarChar(50)
  bandInfo      Json?   @map("band_info") @db.JsonB

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Indexes
  @@index([fieldId, capturedAt], name: "idx_ndvi_field_date")
  @@map("ndvi_readings")
}

// ─────────────────────────────────────────────────────────────────────────────
// Pest Incident - حوادث الآفات
// Tracks pest detection and monitoring
// ─────────────────────────────────────────────────────────────────────────────

model PestIncident {
  id String @id @default(uuid()) @db.Uuid

  // References
  fieldId       String  @map("field_id") @db.Uuid
  cropSeasonId  String? @map("crop_season_id") @db.Uuid
  tenantId      String  @map("tenant_id") @db.VarChar(100)

  // Pest Information
  pestType      PestType      @map("pest_type")
  pestName      String        @map("pest_name") @db.VarChar(255)
  severityLevel Int           @map("severity_level") // 1-5 scale
  affectedArea  Decimal       @map("affected_area") @db.Decimal(10, 4) // hectares
  status        IncidentStatus @default(DETECTED)

  // Detection Details
  detectedAt DateTime @map("detected_at") @db.Timestamptz
  reportedBy String   @map("reported_by") @db.VarChar(255)

  // Location & Evidence
  location Json?  @db.JsonB // {lat, lng, coordinates}
  photos   Json?  @db.JsonB // Array of photo URLs
  notes    String? @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  treatments PestTreatment[]

  // Indexes
  @@index([fieldId], name: "idx_pest_incident_field")
  @@index([tenantId], name: "idx_pest_incident_tenant")
  @@index([status], name: "idx_pest_incident_status")
  @@index([detectedAt], name: "idx_pest_incident_date")
  @@index([tenantId, status, detectedAt], name: "idx_pest_tenant_status_date")
  @@map("pest_incidents")
}

// ─────────────────────────────────────────────────────────────────────────────
// Pest Treatment - علاجات الآفات
// Records treatment actions taken for pest incidents
// ─────────────────────────────────────────────────────────────────────────────

model PestTreatment {
  id String @id @default(uuid()) @db.Uuid

  // References
  incidentId String @map("incident_id") @db.Uuid
  tenantId   String @map("tenant_id") @db.VarChar(100)

  // Treatment Details
  treatmentDate DateTime @map("treatment_date") @db.Timestamptz
  method        String   @db.VarChar(255)
  productUsed   String   @map("product_used") @db.VarChar(255)
  productId     String?  @map("product_id") @db.Uuid

  // Application Details
  quantity   Decimal @db.Decimal(10, 3)
  unit       String  @db.VarChar(50)
  appliedBy  String  @map("applied_by") @db.VarChar(255)

  // Results
  effectiveness Int?     @db.SmallInt // 1-5 scale
  cost          Decimal? @db.Decimal(10, 2)
  notes         String?  @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  incident PestIncident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([incidentId], name: "idx_pest_treatment_incident")
  @@index([tenantId], name: "idx_pest_treatment_tenant")
  @@index([treatmentDate], name: "idx_pest_treatment_date")
  @@map("pest_treatments")
}

// ─────────────────────────────────────────────────────────────────────────────
// Enums
// ─────────────────────────────────────────────────────────────────────────────

enum FieldStatus {
  active
  fallow
  harvested
  preparing
  inactive

  @@map("field_status")
}

enum ChangeSource {
  mobile
  web
  api
  system

  @@map("change_source")
}

enum SyncState {
  idle
  syncing
  error
  conflict

  @@map("sync_state")
}

enum TaskType {
  irrigation
  fertilization
  spraying
  scouting
  maintenance
  sampling
  harvest
  planting
  other

  @@map("task_type")
}

enum Priority {
  low
  medium
  high
  urgent

  @@map("priority")
}

enum TaskState {
  pending
  in_progress
  completed
  cancelled
  overdue

  @@map("task_state")
}

enum PestType {
  INSECT
  FUNGUS
  BACTERIA
  VIRUS
  WEED
  RODENT
  BIRD
  NEMATODE
  OTHER

  @@map("pest_type")
}

enum IncidentStatus {
  DETECTED
  MONITORING
  TREATING
  RESOLVED
  RECURRING

  @@map("incident_status")
}
