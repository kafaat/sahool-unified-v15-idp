// SAHOOL Research Core - Prisma Schema
// نواة البحث العلمي - مخطط Prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Direct URL for migrations (bypasses PgBouncer connection pooler)
  directUrl = env("DATABASE_URL_DIRECT")
  // TLS/SSL enforcement for secure connections
  // Requires DATABASE_URL to include sslmode=require parameter
  // Connection pooling parameters are configured in DATABASE_URL
  // Example: postgresql://user:pass@pgbouncer:6432/db?sslmode=require&connection_limit=8&pool_timeout=20&connect_timeout=10
}

enum ExperimentStatus {
  draft
  active
  locked
  completed
  archived
}

enum SampleType {
  soil
  plant
  water
  pest
  other
}

enum TreatmentType {
  fertilizer
  pesticide
  irrigation
  seed_variety
  other
}

enum LogCategory {
  observation
  measurement
  treatment
  harvest
  weather
  pest
  planting
  germination
  other
}

// ═══════════════════════════════════════════════════════════════════════════════
// Germplasm & Seed Management - إدارة الأصول الوراثية والبذور
// Based on MIAPPE, BrAPI, and GRIN-Global standards
// ═══════════════════════════════════════════════════════════════════════════════

enum GermplasmType {
  seed
  cutting
  tissue
  pollen
  other
}

enum SeedQualityGrade {
  certified       // بذور معتمدة
  foundation      // بذور أساس
  registered      // بذور مسجلة
  breeder         // بذور مربي
  commercial      // بذور تجارية
  farmer_saved    // بذور محفوظة من المزارع
}

// الأصول الوراثية - Germplasm Accession
model Germplasm {
  id                    String            @id @default(uuid())
  accessionNumber       String            @unique @map("accession_number") @db.VarChar(50)
  commonName            String            @map("common_name") @db.VarChar(255)
  commonNameAr          String?           @map("common_name_ar") @db.VarChar(255)
  scientificName        String?           @map("scientific_name") @db.VarChar(255)
  genus                 String?           @db.VarChar(100)
  species               String?           @db.VarChar(100)
  subspecies            String?           @db.VarChar(100)
  cultivar              String?           @db.VarChar(100)
  variety               String?           @db.VarChar(100)
  pedigree              String?           @db.Text
  type                  GermplasmType     @default(seed)

  // Origin - المنشأ
  countryOfOrigin       String?           @map("country_of_origin") @db.VarChar(100)
  regionOfOrigin        String?           @map("region_of_origin") @db.VarChar(255)
  collectionSite        String?           @map("collection_site") @db.VarChar(255)
  collectionDate        DateTime?         @map("collection_date") @db.Date
  collectedBy           String?           @map("collected_by")
  donorInstitution      String?           @map("donor_institution") @db.VarChar(255)
  donorAccessionNumber  String?           @map("donor_accession_number") @db.VarChar(50)

  // Characteristics - الخصائص
  growthHabit           String?           @map("growth_habit") @db.VarChar(100)
  maturityDays          Int?              @map("maturity_days")
  yieldPotential        String?           @map("yield_potential") @db.VarChar(100)
  droughtTolerance      String?           @map("drought_tolerance") @db.VarChar(50)
  diseaseResistance     Json              @default("{}") @map("disease_resistance")
  pestResistance        Json              @default("{}") @map("pest_resistance")
  qualityTraits         Json              @default("{}") @map("quality_traits")

  // Storage - التخزين
  storageLocation       String?           @map("storage_location") @db.VarChar(255)
  storageConditions     String?           @map("storage_conditions") @db.VarChar(255)
  storageTemperature    Decimal?          @map("storage_temperature") @db.Decimal(5, 2)
  storageHumidity       Decimal?          @map("storage_humidity") @db.Decimal(5, 2)

  // Availability - التوفر
  isAvailable           Boolean           @default(true) @map("is_available")
  quantityAvailable     Decimal?          @map("quantity_available") @db.Decimal(10, 3)
  quantityUnit          String?           @map("quantity_unit") @db.VarChar(50)

  description           String?           @db.Text
  descriptionAr         String?           @map("description_ar") @db.Text
  photos                String[]          @default([])
  documents             String[]          @default([])
  metadata              Json              @default("{}")
  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  seedLots              SeedLot[]
  plantings             Planting[]

  @@index([isAvailable], name: "idx_germplasm_available")
  @@index([type], name: "idx_germplasm_type")
  @@index([commonName], name: "idx_germplasm_common_name")
  @@map("germplasm")
}

// دفعات البذور - Seed Lots
model SeedLot {
  id                    String            @id @default(uuid())
  germplasmId           String            @map("germplasm_id")
  lotNumber             String            @unique @map("lot_number") @db.VarChar(50)

  // Quantity - الكمية
  initialQuantity       Decimal           @map("initial_quantity") @db.Decimal(10, 3)
  currentQuantity       Decimal           @map("current_quantity") @db.Decimal(10, 3)
  quantityUnit          String            @map("quantity_unit") @db.VarChar(50)
  seedCount             Int?              @map("seed_count")
  thousandSeedWeight    Decimal?          @map("thousand_seed_weight") @db.Decimal(8, 3)

  // Quality - الجودة
  qualityGrade          SeedQualityGrade  @default(commercial) @map("quality_grade")
  germinationRate       Decimal?          @map("germination_rate") @db.Decimal(5, 2)
  germinationTestDate   DateTime?         @map("germination_test_date") @db.Date
  purityPercentage      Decimal?          @map("purity_percentage") @db.Decimal(5, 2)
  moistureContent       Decimal?          @map("moisture_content") @db.Decimal(5, 2)
  vigorIndex            Decimal?          @map("vigor_index") @db.Decimal(5, 2)

  // Production - الإنتاج
  productionDate        DateTime?         @map("production_date") @db.Date
  harvestDate           DateTime?         @map("harvest_date") @db.Date
  productionLocation    String?           @map("production_location") @db.VarChar(255)
  productionSeason      String?           @map("production_season") @db.VarChar(50)
  producedBy            String?           @map("produced_by")

  // Certification - الاعتماد
  certificationNumber   String?           @map("certification_number") @db.VarChar(100)
  certifiedBy           String?           @map("certified_by") @db.VarChar(255)
  certificationDate     DateTime?         @map("certification_date") @db.Date
  expiryDate            DateTime?         @map("expiry_date") @db.Date

  // Treatment - معالجة البذور
  isTreated             Boolean           @default(false) @map("is_treated")
  treatmentType         String?           @map("treatment_type") @db.VarChar(100)
  treatmentProduct      String?           @map("treatment_product") @db.VarChar(255)
  treatmentDate         DateTime?         @map("treatment_date") @db.Date

  // Storage - التخزين
  storageLocation       String?           @map("storage_location") @db.VarChar(255)
  storageConditions     String?           @map("storage_conditions") @db.VarChar(255)

  notes                 String?           @db.Text
  notesAr               String?           @map("notes_ar") @db.Text
  photos                String[]          @default([])
  documents             String[]          @default([])
  metadata              Json              @default("{}")
  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  germplasm             Germplasm         @relation(fields: [germplasmId], references: [id], onDelete: Cascade)
  plantings             Planting[]

  @@index([germplasmId], name: "idx_seed_lot_germplasm")
  @@index([qualityGrade], name: "idx_seed_lot_quality")
  @@index([expiryDate], name: "idx_seed_lot_expiry")
  @@index([productionDate], name: "idx_seed_lot_production")
  @@map("seed_lots")
}

// الزراعة/البذر - Planting Event
model Planting {
  id                    String            @id @default(uuid())
  experimentId          String            @map("experiment_id")
  plotId                String?           @map("plot_id")
  germplasmId           String            @map("germplasm_id")
  seedLotId             String?           @map("seed_lot_id")

  // Planting Details - تفاصيل الزراعة
  plantingDate          DateTime          @map("planting_date") @db.Date
  plantingMethod        String?           @map("planting_method") @db.VarChar(100)
  seedingRate           Decimal?          @map("seeding_rate") @db.Decimal(10, 3)
  seedingRateUnit       String?           @map("seeding_rate_unit") @db.VarChar(50)
  seedsPerHill          Int?              @map("seeds_per_hill")
  seedDepth             Decimal?          @map("seed_depth") @db.Decimal(5, 2)
  seedDepthUnit         String?           @map("seed_depth_unit") @db.VarChar(20)

  // Spacing - المسافات
  rowSpacing            Decimal?          @map("row_spacing") @db.Decimal(6, 2)
  plantSpacing          Decimal?          @map("plant_spacing") @db.Decimal(6, 2)
  spacingUnit           String?           @map("spacing_unit") @db.VarChar(20)

  // Area - المساحة
  plantedArea           Decimal?          @map("planted_area") @db.Decimal(10, 2)
  plantedAreaUnit       String?           @map("planted_area_unit") @db.VarChar(20)
  numberOfRows          Int?              @map("number_of_rows")
  plantsPerRow          Int?              @map("plants_per_row")
  totalPlantsExpected   Int?              @map("total_plants_expected")

  // Germination - الإنبات
  germinationDate       DateTime?         @map("germination_date") @db.Date
  emergenceDate         DateTime?         @map("emergence_date") @db.Date
  germinationCount      Int?              @map("germination_count")
  germinationPercentage Decimal?          @map("germination_percentage") @db.Decimal(5, 2)

  // Thinning - الخف
  thinningDate          DateTime?         @map("thinning_date") @db.Date
  finalPlantCount       Int?              @map("final_plant_count")

  plantedBy             String            @map("planted_by")
  notes                 String?           @db.Text
  notesAr               String?           @map("notes_ar") @db.Text
  photos                String[]          @default([])
  metadata              Json              @default("{}")
  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  experiment            Experiment        @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  germplasm             Germplasm         @relation(fields: [germplasmId], references: [id])
  seedLot               SeedLot?          @relation(fields: [seedLotId], references: [id])

  @@index([experimentId], name: "idx_planting_experiment")
  @@index([plotId], name: "idx_planting_plot")
  @@index([germplasmId], name: "idx_planting_germplasm")
  @@index([seedLotId], name: "idx_planting_seed_lot")
  @@index([plantingDate], name: "idx_planting_date")
  @@index([experimentId, plantingDate], name: "idx_planting_exp_date")
  @@map("plantings")
}

model Experiment {
  id                    String           @id @default(uuid())
  title                 String           @db.VarChar(255)
  titleAr               String?          @map("title_ar") @db.VarChar(255)
  description           String?          @db.Text
  descriptionAr         String?          @map("description_ar") @db.Text
  hypothesis            String?          @db.Text
  hypothesisAr          String?          @map("hypothesis_ar") @db.Text
  startDate             DateTime         @map("start_date") @db.Date
  endDate               DateTime?        @map("end_date") @db.Date
  status                ExperimentStatus @default(draft)
  lockedAt              DateTime?        @map("locked_at")
  lockedBy              String?          @map("locked_by")
  principalResearcherId String           @map("principal_researcher_id")
  organizationId        String?          @map("organization_id")
  farmId                String?          @map("farm_id")
  metadata              Json             @default("{}")
  tags                  String[]         @default([])
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")
  version               Int              @default(1)

  protocols     ResearchProtocol[]
  plots         ResearchPlot[]
  treatments    Treatment[]
  logs          ResearchDailyLog[]
  samples       LabSample[]
  collaborators ExperimentCollaborator[]
  auditLogs     ExperimentAuditLog[]
  plantings     Planting[]

  @@index([status], name: "idx_experiment_status")
  @@index([principalResearcherId], name: "idx_experiment_pi")
  @@index([organizationId], name: "idx_experiment_org")
  @@index([farmId], name: "idx_experiment_farm")
  @@index([startDate], name: "idx_experiment_start_date")
  @@index([endDate], name: "idx_experiment_end_date")
  @@index([status, startDate], name: "idx_experiment_status_date")
  @@map("experiments")
}

model ResearchProtocol {
  id                  String      @id @default(uuid())
  experimentId        String      @map("experiment_id")
  name                String      @db.VarChar(255)
  nameAr              String?     @map("name_ar") @db.VarChar(255)
  description         String?     @db.Text
  descriptionAr       String?     @map("description_ar") @db.Text
  methodology         String      @db.Text
  methodologyAr       String?     @map("methodology_ar") @db.Text
  variables           Json        @default("{}")
  measurementSchedule Json        @default("{}") @map("measurement_schedule")
  equipmentRequired   String[]    @default([]) @map("equipment_required")
  safetyGuidelines    String?     @map("safety_guidelines") @db.Text
  version             Int         @default(1)
  approvedBy          String?     @map("approved_by")
  approvedAt          DateTime?   @map("approved_at")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  experiment Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@index([experimentId], name: "idx_protocol_experiment")
  @@map("research_protocols")
}

model ResearchPlot {
  id              String     @id @default(uuid())
  experimentId    String     @map("experiment_id")
  plotCode        String     @map("plot_code") @db.VarChar(50)
  name            String?    @db.VarChar(255)
  nameAr          String?    @map("name_ar") @db.VarChar(255)
  areaSqm         Decimal?   @map("area_sqm") @db.Decimal(10, 2)
  soilType        String?    @map("soil_type") @db.VarChar(100)
  soilPh          Decimal?   @map("soil_ph") @db.Decimal(4, 2)
  previousCrop    String?    @map("previous_crop") @db.VarChar(100)
  replicateNumber Int        @default(1) @map("replicate_number")
  blockNumber     Int?       @map("block_number")
  rowNumber       Int?       @map("row_number")
  columnNumber    Int?       @map("column_number")
  metadata        Json       @default("{}")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  experiment Experiment         @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  treatments Treatment[]
  logs       ResearchDailyLog[]
  samples    LabSample[]

  @@unique([experimentId, plotCode])
  @@map("research_plots")
}

model Treatment {
  id                   String        @id @default(uuid())
  experimentId         String        @map("experiment_id")
  plotId               String?       @map("plot_id")
  treatmentCode        String        @map("treatment_code") @db.VarChar(50)
  name                 String        @db.VarChar(255)
  nameAr               String?       @map("name_ar") @db.VarChar(255)
  type                 TreatmentType
  description          String?       @db.Text
  descriptionAr        String?       @map("description_ar") @db.Text
  dosage               String?       @db.VarChar(100)
  dosageUnit           String?       @map("dosage_unit") @db.VarChar(50)
  applicationMethod    String?       @map("application_method") @db.VarChar(100)
  applicationFrequency String?       @map("application_frequency") @db.VarChar(100)
  startDate            DateTime?     @map("start_date") @db.Date
  endDate              DateTime?     @map("end_date") @db.Date
  isControl            Boolean       @default(false) @map("is_control")
  parameters           Json          @default("{}")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")

  experiment Experiment         @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  plot       ResearchPlot?      @relation(fields: [plotId], references: [id], onDelete: SetNull)
  logs       ResearchDailyLog[]

  @@index([experimentId], name: "idx_treatment_experiment")
  @@index([plotId], name: "idx_treatment_plot")
  @@index([type], name: "idx_treatment_type")
  @@index([isControl], name: "idx_treatment_control")
  @@map("treatments")
}

model ResearchDailyLog {
  id                String      @id @default(uuid())
  experimentId      String      @map("experiment_id")
  plotId            String?     @map("plot_id")
  treatmentId       String?     @map("treatment_id")
  logDate           DateTime    @map("log_date") @db.Date
  logTime           String?     @map("log_time") @db.VarChar(8)
  category          LogCategory
  title             String      @db.VarChar(255)
  titleAr           String?     @map("title_ar") @db.VarChar(255)
  notes             String?     @db.Text
  notesAr           String?     @map("notes_ar") @db.Text
  measurements      Json        @default("{}")
  weatherConditions Json        @default("{}") @map("weather_conditions")
  photos            String[]    @default([])
  attachments       String[]    @default([])
  recordedBy        String      @map("recorded_by")
  deviceId          String?     @map("device_id") @db.VarChar(100)
  offlineId         String?     @unique @map("offline_id") @db.VarChar(100)
  hash              String?     @db.VarChar(64)
  syncedAt          DateTime?   @map("synced_at")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  experiment Experiment    @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  plot       ResearchPlot? @relation(fields: [plotId], references: [id], onDelete: SetNull)
  treatment  Treatment?    @relation(fields: [treatmentId], references: [id], onDelete: SetNull)
  samples    LabSample[]

  @@index([experimentId], name: "idx_daily_log_experiment")
  @@index([plotId], name: "idx_daily_log_plot")
  @@index([treatmentId], name: "idx_daily_log_treatment")
  @@index([logDate], name: "idx_daily_log_date")
  @@index([category], name: "idx_daily_log_category")
  @@index([experimentId, logDate], name: "idx_daily_log_exp_date")
  @@index([recordedBy], name: "idx_daily_log_recorder")
  @@map("research_daily_logs")
}

model LabSample {
  id                 String     @id @default(uuid())
  experimentId       String     @map("experiment_id")
  plotId             String?    @map("plot_id")
  logId              String?    @map("log_id")
  sampleCode         String     @unique @map("sample_code") @db.VarChar(100)
  type               SampleType
  description        String?    @db.Text
  descriptionAr      String?    @map("description_ar") @db.Text
  collectionDate     DateTime   @map("collection_date") @db.Date
  collectionTime     String?    @map("collection_time") @db.VarChar(8)
  collectedBy        String     @map("collected_by")
  storageLocation    String?    @map("storage_location") @db.VarChar(255)
  storageConditions  String?    @map("storage_conditions") @db.VarChar(255)
  quantity           Decimal?   @db.Decimal(10, 3)
  quantityUnit       String?    @map("quantity_unit") @db.VarChar(50)
  analysisStatus     String     @default("pending") @map("analysis_status") @db.VarChar(50)
  analysisResults    Json       @default("{}") @map("analysis_results")
  analyzedBy         String?    @map("analyzed_by")
  analyzedAt         DateTime?  @map("analyzed_at")
  photos             String[]   @default([])
  metadata           Json       @default("{}")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  experiment Experiment        @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  plot       ResearchPlot?     @relation(fields: [plotId], references: [id], onDelete: SetNull)
  log        ResearchDailyLog? @relation(fields: [logId], references: [id], onDelete: SetNull)

  @@index([experimentId], name: "idx_lab_sample_experiment")
  @@index([plotId], name: "idx_lab_sample_plot")
  @@index([logId], name: "idx_lab_sample_log")
  @@index([type], name: "idx_lab_sample_type")
  @@index([analysisStatus], name: "idx_lab_sample_status")
  @@index([collectionDate], name: "idx_lab_sample_collection_date")
  @@index([experimentId, collectionDate], name: "idx_lab_sample_exp_date")
  @@map("lab_samples")
}

model DigitalSignature {
  id                 String    @id @default(uuid())
  entityType         String    @map("entity_type") @db.VarChar(50)
  entityId           String    @map("entity_id")
  signerId           String    @map("signer_id")
  signatureHash      String    @map("signature_hash") @db.VarChar(128)
  algorithm          String    @default("HMAC-SHA256") @db.VarChar(50)
  payloadHash        String    @map("payload_hash") @db.VarChar(128)
  timestamp          DateTime  @default(now())
  ipAddress          String?   @map("ip_address") @db.VarChar(45)
  deviceInfo         Json      @default("{}") @map("device_info")
  purpose            String?   @db.VarChar(100)
  isValid            Boolean   @default(true) @map("is_valid")
  invalidatedAt      DateTime? @map("invalidated_at")
  invalidatedReason  String?   @map("invalidated_reason") @db.Text
  createdAt          DateTime  @default(now()) @map("created_at")

  @@unique([entityType, entityId, signerId, purpose])
  @@index([entityType, entityId], name: "idx_signature_entity")
  @@index([signerId], name: "idx_signature_signer")
  @@index([isValid], name: "idx_signature_valid")
  @@map("digital_signatures")
}

model ExperimentCollaborator {
  id           String    @id @default(uuid())
  experimentId String    @map("experiment_id")
  userId       String    @map("user_id")
  role         String    @db.VarChar(50)
  permissions  Json      @default("{\"read\": true, \"write\": false, \"admin\": false}")
  invitedBy    String?   @map("invited_by")
  acceptedAt   DateTime? @map("accepted_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  experiment Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@unique([experimentId, userId])
  @@map("experiment_collaborators")
}

model ExperimentAuditLog {
  id           String    @id @default(uuid())
  experimentId String?   @map("experiment_id")
  entityType   String    @map("entity_type") @db.VarChar(50)
  entityId     String    @map("entity_id")
  action       String    @db.VarChar(50)
  oldValues    Json?     @map("old_values")
  newValues    Json?     @map("new_values")
  changedBy    String    @map("changed_by")
  changedAt    DateTime  @default(now()) @map("changed_at")
  ipAddress    String?   @map("ip_address") @db.VarChar(45)
  userAgent    String?   @map("user_agent") @db.Text

  experiment Experiment? @relation(fields: [experimentId], references: [id], onDelete: SetNull)

  @@index([experimentId], name: "idx_audit_log_experiment")
  @@index([entityType, entityId], name: "idx_audit_log_entity")
  @@index([changedBy], name: "idx_audit_log_user")
  @@index([changedAt], name: "idx_audit_log_date")
  @@index([action], name: "idx_audit_log_action")
  @@map("experiment_audit_log")
}
