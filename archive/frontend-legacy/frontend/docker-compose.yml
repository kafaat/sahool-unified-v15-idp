version: "3.8"

services:
  # ==========================================================================
  # SAHOOL Frontend Services
  # ==========================================================================

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - API_URL=http://api-gateway:8080
      - WS_URL=ws://ws-gateway:8081
    depends_on:
      - ws-gateway
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 3

  ws-gateway:
    build:
      context: ./ws-gateway
      dockerfile: Dockerfile
    ports:
      - "8081:8081"
    environment:
      - NATS_URL=nats://nats:4222
    depends_on:
      - nats
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Infrastructure (for standalone dev)
  nats:
    image: nats:2-alpine
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["-js", "-m", "8222"]

  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - dashboard
      - ws-gateway
