# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL NATS Cluster - Node 1 Configuration
# High Availability Multi-Cluster Setup with JetStream Replication
# ═══════════════════════════════════════════════════════════════════════════════

# Server Configuration
server_name: sahool-nats-node1
listen: 0.0.0.0:4222

# Unique Server ID (required for clustering)
server_tags: [
    "env:production",
    "region:primary",
    "node:1",
    "cluster:sahool-cluster",
    "security:hardened"
]

# HTTP Monitoring
http_port: 8222

# ─────────────────────────────────────────────────────────────────────────────
# JetStream Configuration with Replication Factor 3
# ─────────────────────────────────────────────────────────────────────────────
jetstream {
    store_dir: /data/jetstream

    # Memory and storage limits
    max_memory_store: 2GB
    max_file_store: 20GB

    # At-rest encryption
    key: $NATS_JETSTREAM_KEY
    cipher: "aes"

    # Domain for multi-cluster setup
    domain: sahool

    # Unique tag for this node
    unique_tag: "node-1"

    # Sync configuration for cluster replication
    # This ensures data is replicated across all 3 nodes
    sync_interval: "2m"
}

# ─────────────────────────────────────────────────────────────────────────────
# TLS Configuration - Client Connections
# ─────────────────────────────────────────────────────────────────────────────
tls {
    cert_file: "/etc/nats/certs/server.crt"
    key_file: "/etc/nats/certs/server.key"
    ca_file: "/etc/nats/certs/ca.crt"

    # Enforce TLS for all client connections
    verify: true
    verify_and_map: true

    # Timeout for TLS handshake
    timeout: 2

    # Modern cipher suites only
    cipher_suites: [
        "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384",
        "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384",
        "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256",
        "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
    ]

    # Minimum TLS version 1.2
    min_version: "1.2"
}

# ─────────────────────────────────────────────────────────────────────────────
# System Account
# ─────────────────────────────────────────────────────────────────────────────
system_account: SYS

# ─────────────────────────────────────────────────────────────────────────────
# Accounts Configuration
# ─────────────────────────────────────────────────────────────────────────────
accounts {
    # System account for internal monitoring
    SYS: {
        users: [
            {
                user: $NATS_SYSTEM_USER
                password: $NATS_SYSTEM_PASSWORD
            }
        ]
    }

    # Application account with JetStream enabled
    APP: {
        jetstream: enabled

        users: [
            # Admin user - full access
            {
                user: $NATS_ADMIN_USER
                password: $NATS_ADMIN_PASSWORD

                permissions = {
                    publish = { allow = [">"] }
                    subscribe = { allow = [">"] }
                }

                connection_limits = {
                    max_connections: 10
                    max_subscriptions: 100
                    max_payload: 8MB
                    max_pending: 64MB
                }
            },

            # Application services user
            {
                user: $NATS_USER
                password: $NATS_PASSWORD

                permissions = {
                    publish = {
                        allow = [
                            "sahool.>",
                            "field.>",
                            "weather.>",
                            "iot.>",
                            "notification.>",
                            "marketplace.>",
                            "billing.>",
                            "chat.>",
                            "alert.>",
                            "_INBOX.>",
                        ]
                        deny = ["$SYS.>", "$JS.API.SYSTEM.>"]
                    }
                    subscribe = {
                        allow = [
                            "sahool.>",
                            "field.>",
                            "weather.>",
                            "iot.>",
                            "notification.>",
                            "marketplace.>",
                            "billing.>",
                            "chat.>",
                            "alert.>",
                            "_INBOX.>",
                            "$JS.API.CONSUMER.>",
                            "$JS.API.STREAM.>",
                        ]
                        deny = ["$SYS.>"]
                    }
                }

                connection_limits = {
                    max_connections: 100
                    max_subscriptions: 500
                    max_payload: 8MB
                    max_pending: 64MB
                }
            },

            # Monitoring user - read-only
            {
                user: $NATS_MONITOR_USER
                password: $NATS_MONITOR_PASSWORD

                permissions = {
                    publish = { deny = [">"] }
                    subscribe = {
                        allow = [
                            "sahool.>",
                            "field.>",
                            "weather.>",
                            "iot.>",
                            "notification.>",
                            "marketplace.>",
                            "billing.>",
                            "chat.>",
                            "alert.>",
                        ]
                        deny = ["$SYS.>", "$JS.API.>"]
                    }
                }

                connection_limits = {
                    max_connections: 5
                    max_subscriptions: 50
                    max_payload: 1MB
                    max_pending: 8MB
                }
            }
        ]
    }
}

# ─────────────────────────────────────────────────────────────────────────────
# Cluster Configuration - High Availability
# ─────────────────────────────────────────────────────────────────────────────
cluster {
    name: sahool-cluster
    listen: 0.0.0.0:6222

    # Cluster TLS - Encrypted inter-node communication
    tls {
        cert_file: "/etc/nats/certs/server.crt"
        key_file: "/etc/nats/certs/server.key"
        ca_file: "/etc/nats/certs/ca.crt"
        verify: true
        timeout: 2

        # Same cipher suites as client TLS
        cipher_suites: [
            "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384",
            "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384",
            "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256",
            "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
        ]
        min_version: "1.2"
    }

    # Cluster authentication
    authorization {
        user: $NATS_CLUSTER_USER
        password: $NATS_CLUSTER_PASSWORD
        timeout: 2
    }

    # Cluster routes - Full mesh topology
    # Node 1 connects to Node 2 and Node 3
    routes = [
        nats://$NATS_CLUSTER_USER:$NATS_CLUSTER_PASSWORD@nats-node2:6222
        nats://$NATS_CLUSTER_USER:$NATS_CLUSTER_PASSWORD@nats-node3:6222
    ]

    # Connection pool for cluster communication
    pool_size: 5

    # Advertise this node's address to other cluster members
    # This is the address other nodes will use to connect
    # Use environment variable for flexibility
    # advertise: $NATS_ADVERTISE_HOST:6222
}

# ─────────────────────────────────────────────────────────────────────────────
# Gateway Configuration - Super-Cluster for Multi-Region Setup
# ─────────────────────────────────────────────────────────────────────────────
gateway {
    name: sahool-dc1
    listen: 0.0.0.0:7222

    # Gateway TLS - Encrypted inter-datacenter communication
    tls {
        cert_file: "/etc/nats/certs/server.crt"
        key_file: "/etc/nats/certs/server.key"
        ca_file: "/etc/nats/certs/ca.crt"
        verify: true
        timeout: 5

        cipher_suites: [
            "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384",
            "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384",
            "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256",
            "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
        ]
        min_version: "1.2"
    }

    # Gateway authentication
    authorization {
        user: $NATS_GATEWAY_USER
        password: $NATS_GATEWAY_PASSWORD
        timeout: 5
    }

    # Gateway connections to other data centers
    # Uncomment and configure for multi-region setup
    # gateways: [
    #     {
    #         name: "sahool-dc2"
    #         url: "nats://$NATS_GATEWAY_USER:$NATS_GATEWAY_PASSWORD@dc2-gateway-node1:7222"
    #         tls {
    #             cert_file: "/etc/nats/certs/server.crt"
    #             key_file: "/etc/nats/certs/server.key"
    #             ca_file: "/etc/nats/certs/ca.crt"
    #         }
    #     },
    #     {
    #         name: "sahool-dc3"
    #         url: "nats://$NATS_GATEWAY_USER:$NATS_GATEWAY_PASSWORD@dc3-gateway-node1:7222"
    #         tls {
    #             cert_file: "/etc/nats/certs/server.crt"
    #             key_file: "/etc/nats/certs/server.key"
    #             ca_file: "/etc/nats/certs/ca.crt"
    #         }
    #     }
    # ]

    # Advertise this gateway's address
    # advertise: $NATS_GATEWAY_ADVERTISE_HOST:7222

    # Connection settings
    connect_retries: 5
    reject_unknown: false
}

# ─────────────────────────────────────────────────────────────────────────────
# Logging Configuration
# ─────────────────────────────────────────────────────────────────────────────
debug: false
trace: false
logtime: true
log_file: "/dev/stdout"
logfile_size_limit: 100MB
max_traced_msg_len: 1024

# ─────────────────────────────────────────────────────────────────────────────
# Performance & Security Limits
# ─────────────────────────────────────────────────────────────────────────────
max_connections: 2000
max_control_line: 4KB
max_payload: 8MB
max_pending: 64MB

# Ping settings for connection health
ping_interval: 120s
ping_max: 3

# Connection timeouts
write_deadline: 10s

# Slow consumer protection
max_pending_size: 64MB
slow_consumer_timeout: 5s

# Connection limits per IP
max_connections_per_ip: 200

# Port configuration
port: 4222

# ─────────────────────────────────────────────────────────────────────────────
# Leafnode Configuration (Optional - for edge deployments)
# ─────────────────────────────────────────────────────────────────────────────
# Leafnodes allow remote NATS servers to connect as leaves
# Useful for edge locations or IoT gateways
# leafnodes {
#     listen: 0.0.0.0:7422
#
#     tls {
#         cert_file: "/etc/nats/certs/server.crt"
#         key_file: "/etc/nats/certs/server.key"
#         ca_file: "/etc/nats/certs/ca.crt"
#         verify: true
#     }
#
#     authorization {
#         user: $NATS_LEAFNODE_USER
#         password: $NATS_LEAFNODE_PASSWORD
#         timeout: 5
#     }
# }

# ═══════════════════════════════════════════════════════════════════════════════
# Configuration Notes for Node 1
# ═══════════════════════════════════════════════════════════════════════════════
#
# This is the primary node in a 3-node NATS cluster configuration.
#
# Environment Variables Required:
# ─────────────────────────────
# Authentication:
#   - NATS_ADMIN_USER, NATS_ADMIN_PASSWORD
#   - NATS_USER, NATS_PASSWORD
#   - NATS_MONITOR_USER, NATS_MONITOR_PASSWORD
#   - NATS_SYSTEM_USER, NATS_SYSTEM_PASSWORD
#
# Cluster Communication:
#   - NATS_CLUSTER_USER, NATS_CLUSTER_PASSWORD
#
# Gateway Communication (optional):
#   - NATS_GATEWAY_USER, NATS_GATEWAY_PASSWORD
#
# Encryption:
#   - NATS_JETSTREAM_KEY (32-byte base64 encoded key for at-rest encryption)
#
# Advertise Addresses (optional):
#   - NATS_ADVERTISE_HOST (for cluster communication)
#   - NATS_GATEWAY_ADVERTISE_HOST (for gateway communication)
#
# High Availability Features:
# ──────────────────────────
# 1. JetStream Replication Factor 3: Data is replicated across all 3 nodes
# 2. Full Mesh Cluster Topology: Each node connects to all other nodes
# 3. Automatic Failover: If this node fails, clients reconnect to node 2 or 3
# 4. Gateway Support: Can connect to other data centers for geo-replication
# 5. TLS Everywhere: All communication (client, cluster, gateway) is encrypted
#
# JetStream Configuration:
# ───────────────────────
# When creating streams, use replication factor 3:
#   nats stream add --replicas=3 <stream-name>
#
# This ensures that stream data is replicated across all 3 nodes for HA.
#
# Health Monitoring:
# ─────────────────
# - HTTP endpoint: http://localhost:8222/healthz
# - Cluster status: http://localhost:8222/routez
# - JetStream status: http://localhost:8222/jsz
#
# ═══════════════════════════════════════════════════════════════════════════════
