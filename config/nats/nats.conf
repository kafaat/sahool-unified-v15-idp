# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL NATS Server Configuration with Authentication
# Secured configuration for production deployment
# ═══════════════════════════════════════════════════════════════════════════════

# Server Configuration
server_name: sahool-nats
listen: 0.0.0.0:4222

# HTTP Monitoring
http_port: 8222

# JetStream Configuration
jetstream {
    store_dir: /data

    # Memory limits
    max_memory_store: 1GB
    max_file_store: 10GB

    # Domain for multi-cluster setup (optional)
    # domain: sahool
}

# ─────────────────────────────────────────────────────────────────────────────
# Authentication & Authorization
# ─────────────────────────────────────────────────────────────────────────────

# User Authentication
# Credentials are injected via environment variables at runtime
authorization {
    # Default permissions for all authenticated users
    default_permissions = {
        publish = {
            # Allow publishing to all subjects by default
            allow = [">"]
        }
        subscribe = {
            # Allow subscribing to all subjects by default
            allow = [">"]
        }
    }

    # Service-specific users with granular permissions
    users = [
        # Admin user - full access to all operations
        {
            user: $NATS_ADMIN_USER
            password: $NATS_ADMIN_PASSWORD
            permissions = {
                publish = {
                    allow = [">"]
                }
                subscribe = {
                    allow = [">"]
                }
            }
        },

        # Application services user - standard access
        {
            user: $NATS_USER
            password: $NATS_PASSWORD
            permissions = {
                publish = {
                    allow = [
                        "sahool.>",           # All SAHOOL events
                        "field.>",            # Field operations
                        "weather.>",          # Weather events
                        "iot.>",              # IoT sensor data
                        "notification.>",     # Notifications
                        "marketplace.>",      # Marketplace events
                        "billing.>",          # Billing events
                        "chat.>",             # Chat messages
                        "alert.>",            # Alert events
                        "_INBOX.>",           # Request-reply patterns
                        "$JS.API.>",          # JetStream API (stream/consumer management)
                    ]
                }
                subscribe = {
                    allow = [
                        "sahool.>",
                        "field.>",
                        "weather.>",
                        "iot.>",
                        "notification.>",
                        "marketplace.>",
                        "billing.>",
                        "chat.>",
                        "alert.>",
                        "_INBOX.>",
                        "$JS.API.>",          # JetStream API responses
                    ]
                }
            }
        },

        # Read-only monitoring user
        {
            user: $NATS_MONITOR_USER
            password: $NATS_MONITOR_PASSWORD
            permissions = {
                publish = {
                    # No publish permissions
                    deny = [">"]
                }
                subscribe = {
                    # Can subscribe to all subjects for monitoring
                    allow = [">"]
                }
            }
        }
    ]
}

# ─────────────────────────────────────────────────────────────────────────────
# Cluster Configuration (for high availability)
# ─────────────────────────────────────────────────────────────────────────────
# Uncomment for multi-node setup
# cluster {
#     name: sahool-cluster
#     listen: 0.0.0.0:6222
#
#     authorization {
#         user: $NATS_CLUSTER_USER
#         password: $NATS_CLUSTER_PASSWORD
#         timeout: 2
#     }
#
#     routes = [
#         nats://nats-1:6222
#         nats://nats-2:6222
#         nats://nats-3:6222
#     ]
# }

# ─────────────────────────────────────────────────────────────────────────────
# Logging Configuration
# ─────────────────────────────────────────────────────────────────────────────
debug: false
trace: false
logtime: true
log_file: "/dev/stdout"

# ─────────────────────────────────────────────────────────────────────────────
# Performance & Limits
# ─────────────────────────────────────────────────────────────────────────────
max_connections: 1000
max_control_line: 4096
max_payload: 8MB
max_pending: 64MB
ping_interval: 120s
ping_max: 3

# Connection timeouts
write_deadline: 10s

# TLS Configuration (for production - uncomment and configure)
# ─────────────────────────────────────────────────────────────────────────────
# TLS disabled for development (certificates not available)
# tls {
#     cert_file: "/etc/nats/certs/server.crt"
#     key_file: "/etc/nats/certs/server.key"
#     ca_file: "/etc/nats/certs/ca.crt"
#     verify: true
#     timeout: 2
# }

# ─────────────────────────────────────────────────────────────────────────────
# System Account (for internal NATS monitoring)
# ─────────────────────────────────────────────────────────────────────────────
# System account disabled for development (requires account definition)
# system_account: SYSTEM

# ═══════════════════════════════════════════════════════════════════════════════
# Configuration Notes:
# ═══════════════════════════════════════════════════════════════════════════════
#
# 1. Environment Variables Required:
#    - NATS_ADMIN_USER: Administrator username (full access)
#    - NATS_ADMIN_PASSWORD: Administrator password
#    - NATS_USER: Application services username
#    - NATS_PASSWORD: Application services password
#    - NATS_MONITOR_USER: Monitoring/read-only username
#    - NATS_MONITOR_PASSWORD: Monitoring password
#
# 2. Security Best Practices:
#    - Use strong, randomly generated passwords (32+ characters)
#    - Enable TLS in production environments
#    - Regularly rotate credentials
#    - Use separate credentials per environment (dev/staging/prod)
#    - Consider using NATS NKey authentication for enhanced security
#
# 3. Subject Namespacing:
#    - All subjects are prefixed with module names (sahool., field., etc.)
#    - This allows for granular permission control
#    - _INBOX.> is required for request-reply patterns
#
# 4. JetStream Notes:
#    - Persistent storage for message streams
#    - Enables replay, retention policies, and guaranteed delivery
#    - Adjust memory/file limits based on your workload
#
# ═══════════════════════════════════════════════════════════════════════════════
