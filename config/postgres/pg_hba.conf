# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - PostgreSQL Host-Based Authentication (pg_hba.conf)
# Security-hardened configuration with TLS enforcement
# Last Updated: 2026-01-06
# ═══════════════════════════════════════════════════════════════════════════════
#
# SECURITY NOTES:
# - All remote connections REQUIRE SSL/TLS (hostssl)
# - No plain 'host' entries (unencrypted) for remote connections
# - SCRAM-SHA-256 authentication for strong password hashing
# - Docker network ranges: 172.16.0.0/12, 10.0.0.0/8
# - Replication connections use separate authentication
#
# Format:
# TYPE  DATABASE        USER            ADDRESS                 METHOD
# ═══════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────
# Local Socket Connections (Unix domain socket)
# ─────────────────────────────────────────────────────────────────────────────
# Postgres superuser via local socket (for administrative tasks)
local   all             postgres                                peer

# All other local socket connections
local   all             all                                     scram-sha-256

# ─────────────────────────────────────────────────────────────────────────────
# Replication Connections (Primary → Replica)
# ─────────────────────────────────────────────────────────────────────────────
# Allow replication user from Docker network (SSL required)
hostssl replication     replicator      172.16.0.0/12          scram-sha-256
hostssl replication     replicator      10.0.0.0/8             scram-sha-256
hostssl replication     replicator      192.168.0.0/16         scram-sha-256

# Allow primary user for replication slot management
hostssl replication     sahool          172.16.0.0/12          scram-sha-256
hostssl replication     sahool          10.0.0.0/8             scram-sha-256

# ─────────────────────────────────────────────────────────────────────────────
# PgBouncer Connection Pooler (from Docker network)
# ─────────────────────────────────────────────────────────────────────────────
# PgBouncer connects to PostgreSQL (SSL required for production)
hostssl sahool          sahool          172.16.0.0/12          scram-sha-256
hostssl sahool          sahool          10.0.0.0/8             scram-sha-256
hostssl sahool          sahool          192.168.0.0/16         scram-sha-256

# ─────────────────────────────────────────────────────────────────────────────
# Application Service Connections (from Docker network)
# ─────────────────────────────────────────────────────────────────────────────
# All microservices connecting to database (SSL required)
hostssl all             sahool          172.16.0.0/12          scram-sha-256
hostssl all             sahool          10.0.0.0/8             scram-sha-256
hostssl all             sahool          192.168.0.0/16         scram-sha-256

# ─────────────────────────────────────────────────────────────────────────────
# Administrative Connections (from Docker network)
# ─────────────────────────────────────────────────────────────────────────────
# Allow postgres superuser for maintenance (SSL required)
hostssl all             postgres        172.16.0.0/12          scram-sha-256
hostssl all             postgres        10.0.0.0/8             scram-sha-256

# ─────────────────────────────────────────────────────────────────────────────
# Localhost Connections (for development and testing)
# ─────────────────────────────────────────────────────────────────────────────
# Allow connections from localhost (container itself)
hostssl all             all             127.0.0.1/32           scram-sha-256
hostssl all             all             ::1/128                scram-sha-256

# ─────────────────────────────────────────────────────────────────────────────
# Development Mode (COMMENT OUT IN PRODUCTION)
# ─────────────────────────────────────────────────────────────────────────────
# For local development, allow non-SSL connections from Docker network
# SECURITY WARNING: Remove these lines in production!
# host    all             sahool          172.16.0.0/12          scram-sha-256
# host    all             sahool          10.0.0.0/8             scram-sha-256

# ─────────────────────────────────────────────────────────────────────────────
# Explicit Deny (Reject all other connections)
# ─────────────────────────────────────────────────────────────────────────────
# Reject any connection that doesn't match rules above
host    all             all             all                     reject
hostssl all             all             all                     reject

# ═══════════════════════════════════════════════════════════════════════════════
# End of pg_hba.conf
# ═══════════════════════════════════════════════════════════════════════════════
#
# TESTING COMMANDS:
# - Test connection: psql "sslmode=require host=postgres user=sahool dbname=sahool"
# - Check SSL: SELECT ssl, version FROM pg_stat_ssl;
# - View connections: SELECT * FROM pg_stat_activity;
#
