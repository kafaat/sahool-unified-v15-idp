# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - PostgreSQL 16 Replica Configuration
# Standby/Replica Server Settings
# Last Updated: 2026-01-06
# ═══════════════════════════════════════════════════════════════════════════════
#
# This configuration extends postgresql.conf for replica servers
# It includes standby-specific settings for streaming replication
#
# ═══════════════════════════════════════════════════════════════════════════════

# Include base configuration
include = '/etc/postgresql/postgresql.conf'

# ─────────────────────────────────────────────────────────────────────────────
# Standby/Replica Specific Settings
# ─────────────────────────────────────────────────────────────────────────────

# Hot Standby Configuration
hot_standby = on                        # Allow read queries on standby
hot_standby_feedback = on               # Send feedback to prevent query conflicts
max_standby_streaming_delay = 30s       # Max delay before canceling queries
wal_receiver_timeout = 60s              # Timeout for WAL receiver

# Standby Query Configuration
max_standby_archive_delay = 30s         # Max delay before canceling queries (archive)
hot_standby_feedback = on               # Prevent query conflicts on primary

# ─────────────────────────────────────────────────────────────────────────────
# Recovery Settings (for standby server)
# ─────────────────────────────────────────────────────────────────────────────
# These are typically set in standby.signal file or recovery.conf (PostgreSQL < 12)
# For PostgreSQL 16, use standby.signal file and set connection string

# Primary connection info (set via environment or primary_conninfo parameter)
# primary_conninfo = 'host=postgres port=5432 user=replicator password=replica_password application_name=postgres-replica'
# primary_slot_name = 'replica_slot'    # Use replication slot for reliability

# ─────────────────────────────────────────────────────────────────────────────
# Resource Settings (can be lower than primary)
# ─────────────────────────────────────────────────────────────────────────────
# Replicas can have less resources since they're primarily for reads

# Override memory settings if needed (optional)
# shared_buffers = 1GB                  # Can be lower than primary
# effective_cache_size = 3GB            # Adjust based on replica resources

# ─────────────────────────────────────────────────────────────────────────────
# Logging for Replica
# ─────────────────────────────────────────────────────────────────────────────
log_filename = 'postgresql-replica-%Y-%m-%d_%H%M%S.log'
log_line_prefix = '%t [%p] [REPLICA]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Log replication lag
log_min_duration_statement = 1000       # Log queries > 1 second

# ─────────────────────────────────────────────────────────────────────────────
# Promote to Primary (if needed)
# ─────────────────────────────────────────────────────────────────────────────
# To promote replica to primary:
# 1. Stop replication: pg_ctl promote
# 2. Or create trigger file: touch /tmp/postgresql.trigger.5432
# 3. Or use: SELECT pg_promote();

# ═══════════════════════════════════════════════════════════════════════════════
# End of Replica Configuration
# ═══════════════════════════════════════════════════════════════════════════════
