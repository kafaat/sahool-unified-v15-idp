# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - PostgreSQL 16 Production Configuration
# High Availability & Performance Optimized
# Hardware Target: 4 vCPU, 8GB RAM, SSD Storage
# Last Updated: 2026-01-06
# ═══════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────
# Connection Settings
# ─────────────────────────────────────────────────────────────────────────────
listen_addresses = '*'
port = 5432
max_connections = 300
superuser_reserved_connections = 3

# Connection timeout and keepalive settings
tcp_keepalives_idle = 60               # Start keepalives after 60s
tcp_keepalives_interval = 10           # Send keepalive every 10s
tcp_keepalives_count = 6               # Drop connection after 6 failed keepalives
client_connection_check_interval = 10  # Check client connection every 10s

# ─────────────────────────────────────────────────────────────────────────────
# Memory Settings (Optimized for 8GB RAM)
# ─────────────────────────────────────────────────────────────────────────────
shared_buffers = 2GB                    # 25% of RAM
effective_cache_size = 6GB              # 75% of RAM (includes OS cache)
maintenance_work_mem = 512MB            # For VACUUM, CREATE INDEX
work_mem = 20MB                         # Per sort/hash operation
wal_buffers = 64MB                      # WAL buffer size
huge_pages = try                        # Try to use huge pages if available

# ─────────────────────────────────────────────────────────────────────────────
# Query Planning (Optimized for SSD)
# ─────────────────────────────────────────────────────────────────────────────
default_statistics_target = 200         # Better query planning
random_page_cost = 1.1                  # For SSD storage
effective_io_concurrency = 200          # For SSD parallelism
seq_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# ─────────────────────────────────────────────────────────────────────────────
# Write Ahead Log (WAL) - Critical for Replication
# ─────────────────────────────────────────────────────────────────────────────
wal_level = replica                     # Enable streaming replication
fsync = on                              # Ensure data durability
synchronous_commit = on                 # Wait for WAL write before commit
wal_sync_method = fdatasync             # Fast data sync
full_page_writes = on                   # Prevent partial page writes
wal_compression = on                    # Compress WAL records
wal_log_hints = on                      # Required for pg_rewind
wal_buffers = 64MB
min_wal_size = 2GB                      # Minimum WAL size
max_wal_size = 8GB                      # Maximum WAL size before checkpoint
wal_keep_size = 2GB                     # Keep at least 2GB of WAL for replicas

# ─────────────────────────────────────────────────────────────────────────────
# Checkpoints (Spread checkpoint writes)
# ─────────────────────────────────────────────────────────────────────────────
checkpoint_completion_target = 0.9      # Spread checkpoint over 90% of interval
checkpoint_timeout = 15min              # Checkpoint every 15 minutes
checkpoint_warning = 30s                # Warn if checkpoints too frequent

# ─────────────────────────────────────────────────────────────────────────────
# Replication (Primary Server Configuration)
# ─────────────────────────────────────────────────────────────────────────────
max_wal_senders = 10                    # Max number of replication connections
max_replication_slots = 10              # Max replication slots
hot_standby = on                        # Allow queries on standby
hot_standby_feedback = on               # Prevent query conflicts on standby
wal_sender_timeout = 60s                # Timeout for replication connections

# Synchronous Replication (Optional - uncomment for synchronous mode)
# synchronous_standby_names = 'postgres-replica'  # Wait for this standby
# synchronous_commit = on                # Wait for replica confirmation

# ─────────────────────────────────────────────────────────────────────────────
# WAL Archiving (For Point-in-Time Recovery with S3/MinIO)
# ─────────────────────────────────────────────────────────────────────────────
# WAL-G Configuration for S3-compatible storage (MinIO/AWS S3)
# - Provides continuous WAL archiving to object storage
# - Enables point-in-time recovery (PITR)
# - Supports disaster recovery scenarios
#
# Prerequisites:
# - WAL-G installed in PostgreSQL container
# - S3/MinIO credentials configured (see .env.example)
# - S3 bucket created (e.g., sahool-wal-archive)
#
# Archive Strategy:
# 1. Primary: WAL-G archives directly to S3/MinIO
# 2. Fallback: Local filesystem copy for quick recovery
#
# Configuration environment variables (set in docker-compose):
# - WALG_S3_PREFIX: S3 path for WAL archives
# - AWS_ENDPOINT: S3/MinIO endpoint URL
# - AWS_ACCESS_KEY_ID: S3 access key
# - AWS_SECRET_ACCESS_KEY: S3 secret key
# - AWS_REGION: S3 region (default: us-east-1)
# ─────────────────────────────────────────────────────────────────────────────

archive_mode = on

# WAL-G archive command (primary method - archives to S3/MinIO)
# Uses wal-archive.sh script which handles both WAL-G and local filesystem
archive_command = '/usr/local/bin/wal-archive.sh %p %f'

# Archive timeout - forces WAL switch every hour even if not full
# Ensures maximum 1 hour data loss in disaster scenarios
archive_timeout = 1h

# Restore command for Point-in-Time Recovery (PITR)
# Used during recovery from backups - fetches WAL files from S3/MinIO
# Uncomment when performing PITR (typically set in recovery.conf or recovery.signal)
# restore_command = '/usr/local/bin/wal-restore.sh %f %p'

# ─────────────────────────────────────────────────────────────────────────────
# Logging (Comprehensive for Production)
# ─────────────────────────────────────────────────────────────────────────────
logging_collector = on
log_destination = 'stderr'
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# What to log
log_min_duration_statement = 1000       # Log queries > 1 second
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_lock_waits = on                     # Log lock waits
log_statement = 'ddl'                   # Log all DDL statements
log_temp_files = 0                      # Log all temp file usage
log_autovacuum_min_duration = 250ms     # Log autovacuum runs > 250ms
log_replication_commands = on           # Log replication commands

# ─────────────────────────────────────────────────────────────────────────────
# Auto-Vacuum (Aggressive for high-write workload)
# ─────────────────────────────────────────────────────────────────────────────
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s                # Check for work every 30s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000

# ─────────────────────────────────────────────────────────────────────────────
# SSL/TLS Configuration (Enforced)
# ─────────────────────────────────────────────────────────────────────────────
ssl = on
ssl_cert_file = '/var/lib/postgresql/certs/server.crt'
ssl_key_file = '/var/lib/postgresql/certs/server.key'
ssl_ca_file = '/var/lib/postgresql/certs/ca.crt'
ssl_min_protocol_version = 'TLSv1.3'    # Enforce TLS 1.3
ssl_prefer_server_ciphers = on
ssl_ciphers = 'HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4'
ssl_ecdh_curve = 'prime256v1'
password_encryption = scram-sha-256      # SCRAM-SHA-256 password hashing

# ─────────────────────────────────────────────────────────────────────────────
# Security & Row-Level Security
# ─────────────────────────────────────────────────────────────────────────────
row_security = on                       # Enable row-level security

# ─────────────────────────────────────────────────────────────────────────────
# Performance Monitoring Extensions
# ─────────────────────────────────────────────────────────────────────────────
shared_preload_libraries = 'pg_stat_statements,auto_explain'

# pg_stat_statements configuration
pg_stat_statements.track = all          # Track all statements
pg_stat_statements.max = 10000          # Store 10,000 statements
pg_stat_statements.track_utility = on   # Track utility commands

# auto_explain configuration
auto_explain.log_min_duration = '1s'    # Log queries taking > 1s
auto_explain.log_analyze = on           # Include ANALYZE data
auto_explain.log_buffers = on           # Include buffer usage
auto_explain.log_timing = on            # Include timing information
auto_explain.log_triggers = on          # Include trigger info
auto_explain.log_verbose = off          # Don't include verbose output

# ─────────────────────────────────────────────────────────────────────────────
# Performance Tracking
# ─────────────────────────────────────────────────────────────────────────────
track_activities = on
track_activity_query_size = 2048        # Track longer query strings
track_counts = on
track_io_timing = on                    # Track I/O timing (slight overhead)
track_wal_io_timing = on                # Track WAL I/O timing
track_functions = all                   # Track function execution

# ─────────────────────────────────────────────────────────────────────────────
# Lock Management
# ─────────────────────────────────────────────────────────────────────────────
deadlock_timeout = 1s                   # Detect deadlocks after 1s
max_locks_per_transaction = 64          # Default is usually fine
max_pred_locks_per_transaction = 64

# ─────────────────────────────────────────────────────────────────────────────
# Statement Timeout (Prevent runaway queries)
# ─────────────────────────────────────────────────────────────────────────────
# statement_timeout = 300000            # 5 minutes (uncomment if needed)
# lock_timeout = 60000                  # 60 seconds (uncomment if needed)
idle_in_transaction_session_timeout = 600000  # 10 minutes

# ─────────────────────────────────────────────────────────────────────────────
# Locale & Formatting
# ─────────────────────────────────────────────────────────────────────────────
datestyle = 'iso, mdy'
timezone = 'Asia/Riyadh'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# ─────────────────────────────────────────────────────────────────────────────
# PostGIS Settings
# ─────────────────────────────────────────────────────────────────────────────
# PostGIS extensions are loaded via CREATE EXTENSION

# ─────────────────────────────────────────────────────────────────────────────
# Background Writer (Optimize write performance)
# ─────────────────────────────────────────────────────────────────────────────
bgwriter_delay = 200ms                  # Background writer delay
bgwriter_lru_maxpages = 100             # Max pages to write per round
bgwriter_lru_multiplier = 2.0           # Multiplier for next round

# ─────────────────────────────────────────────────────────────────────────────
# Parallel Query Execution
# ─────────────────────────────────────────────────────────────────────────────
max_parallel_workers_per_gather = 2     # Parallel workers per query
max_parallel_maintenance_workers = 2    # Parallel workers for maintenance
max_parallel_workers = 4                # Total parallel workers
parallel_leader_participation = on

# ─────────────────────────────────────────────────────────────────────────────
# Cost-Based Vacuum Delay (Prevent vacuum from overwhelming I/O)
# ─────────────────────────────────────────────────────────────────────────────
vacuum_cost_delay = 0                   # No delay (use I/O limits instead)
vacuum_cost_page_hit = 1
vacuum_cost_page_miss = 10
vacuum_cost_page_dirty = 20
vacuum_cost_limit = 200

# ─────────────────────────────────────────────────────────────────────────────
# JIT Compilation (PostgreSQL 16 feature)
# ─────────────────────────────────────────────────────────────────────────────
jit = on                                # Enable JIT compilation
jit_above_cost = 100000                 # Use JIT for expensive queries
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

# ═══════════════════════════════════════════════════════════════════════════════
# End of Configuration
# ═══════════════════════════════════════════════════════════════════════════════
