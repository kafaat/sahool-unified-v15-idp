
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Complete developer guide for the SAHOOL Agricultural Platform">
      
      
        <meta name="author" content="KAFAAT Team">
      
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>SAHOOL Platform - Disaster Recovery Runbook - SAHOOL Developer Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="light-green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sahool-platform-disaster-recovery-runbook" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="SAHOOL Developer Documentation" class="md-header__button md-logo" aria-label="SAHOOL Developer Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SAHOOL Developer Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SAHOOL Platform - Disaster Recovery Runbook
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../index.md" class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting-started/installation.md" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../services/overview.md" class="md-tabs__link">
          
  
  
  Services

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/authentication/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../development/setup.md" class="md-tabs__link">
          
  
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contributing/guidelines.md" class="md-tabs__link">
          
  
  
  Contributing

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SAHOOL Developer Documentation" class="md-nav__button md-logo" aria-label="SAHOOL Developer Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    SAHOOL Developer Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/installation.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/quickstart.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/architecture.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Services
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Services
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../services/overview.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../services/starter.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Starter Package
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../services/professional.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Professional Package
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../services/enterprise.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Enterprise Package
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/authentication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Authentication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/field-ops.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Field Operations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/weather/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Weather
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/satellite.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Satellite
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/setup.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/testing.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/deployment.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Contributing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/guidelines.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Guidelines
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/code-style.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Style
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="sahool-platform-disaster-recovery-runbook">SAHOOL Platform - Disaster Recovery Runbook<a class="headerlink" href="#sahool-platform-disaster-recovery-runbook" title="Permanent link">&para;</a></h1>
<h1 id="_1">Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ¹Ø§ÙÙŠ Ù…Ù† Ø§Ù„ÙƒÙˆØ§Ø±Ø« Ù„Ù…Ù†ØµØ© Ø³Ù‡ÙˆÙ„<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p><strong>Version:</strong> 2.0.0
<strong>Last Updated:</strong> 2026-01-06
<strong>Classification:</strong> CRITICAL - Internal Use Only
<strong>Owner:</strong> Platform Infrastructure &amp; DR Team</p>
<hr />
<h2 id="table-of-contents">ğŸ“‹ Table of Contents | Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#executive-summary">Executive Summary</a></li>
<li><a href="#emergency-contacts">Emergency Contacts</a></li>
<li><a href="#rtorpo-targets">RTO/RPO Targets</a></li>
<li><a href="#postgresql-failover-procedures">PostgreSQL Failover Procedures</a></li>
<li><a href="#multi-region-failover">Multi-Region Failover</a></li>
<li><a href="#complete-datacenter-loss-recovery">Complete Datacenter Loss Recovery</a></li>
<li><a href="#service-specific-recovery">Service-Specific Recovery</a></li>
<li><a href="#rollback-procedures">Rollback Procedures</a></li>
<li><a href="#post-recovery-checklist">Post-Recovery Checklist</a></li>
<li><a href="#appendix-command-reference">Appendix: Command Reference</a></li>
</ol>
<hr />
<h2 id="executive-summary">Executive Summary<a class="headerlink" href="#executive-summary" title="Permanent link">&para;</a></h2>
<p>This runbook provides step-by-step procedures for disaster recovery scenarios in the SAHOOL agricultural platform. It covers automated and manual failover procedures, complete datacenter loss recovery, and service-specific recovery operations.</p>
<p><strong>Critical Information:</strong>
- <strong>RTO Target:</strong> 2 hours for database, 6 hours for full system
- <strong>RPO Target:</strong> &lt;5 minutes (with streaming replication)
- <strong>On-Call Escalation:</strong> +966-XXX-XXXX-XXX
- <strong>Incident Slack Channel:</strong> #platform-incidents
- <strong>DR Team Email:</strong> dr-team@sahool.sa</p>
<hr />
<h2 id="emergency-contacts">Emergency Contacts<a class="headerlink" href="#emergency-contacts" title="Permanent link">&para;</a></h2>
<h3 id="primary-dr-team">Primary DR Team<a class="headerlink" href="#primary-dr-team" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Role</th>
<th>Name</th>
<th>Phone</th>
<th>Email</th>
<th>Availability</th>
</tr>
</thead>
<tbody>
<tr>
<td>DR Lead</td>
<td>[Name]</td>
<td>+966-XXX-XXX-XXX</td>
<td>dr-lead@sahool.sa</td>
<td>24/7</td>
</tr>
<tr>
<td>Database Admin</td>
<td>[Name]</td>
<td>+966-XXX-XXX-XXX</td>
<td>dba@sahool.sa</td>
<td>24/7</td>
</tr>
<tr>
<td>Infrastructure Lead</td>
<td>[Name]</td>
<td>+966-XXX-XXX-XXX</td>
<td>infra-lead@sahool.sa</td>
<td>24/7</td>
</tr>
<tr>
<td>Security Lead</td>
<td>[Name]</td>
<td>+966-XXX-XXX-XXX</td>
<td>security@sahool.sa</td>
<td>On-call</td>
</tr>
<tr>
<td>Platform Architect</td>
<td>[Name]</td>
<td>+966-XXX-XXX-XXX</td>
<td>architect@sahool.sa</td>
<td>On-call</td>
</tr>
</tbody>
</table>
<h3 id="external-contacts">External Contacts<a class="headerlink" href="#external-contacts" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>Contact</th>
<th>Phone</th>
<th>Email</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWS Support</td>
<td>Enterprise</td>
<td>+966-XXX-XXX-XXX</td>
<td>aws-support@sahool.sa</td>
</tr>
<tr>
<td>Network Provider</td>
<td>STC</td>
<td>+966-XXX-XXX-XXX</td>
<td>support@stc.sa</td>
</tr>
<tr>
<td>MinIO Support</td>
<td>Community</td>
<td>N/A</td>
<td>support@min.io</td>
</tr>
</tbody>
</table>
<h3 id="escalation-path">Escalation Path<a class="headerlink" href="#escalation-path" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>Level 1: On-Call Engineer (0-15 min)
    â†“
Level 2: DR Lead (15-30 min)
    â†“
Level 3: Infrastructure Lead + Database Admin (30-60 min)
    â†“
Level 4: CTO / Platform Architect (60+ min)
</code></pre></div>

<hr />
<h2 id="rtorpo-targets">RTO/RPO Targets<a class="headerlink" href="#rtorpo-targets" title="Permanent link">&para;</a></h2>
<h3 id="component-level-targets">Component-Level Targets<a class="headerlink" href="#component-level-targets" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>RTO</th>
<th>RPO</th>
<th>Failover Type</th>
<th>Priority</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>PostgreSQL</strong></td>
<td>30 seconds</td>
<td>&lt;5 seconds</td>
<td>Automated</td>
<td>Critical</td>
</tr>
<tr>
<td><strong>Redis</strong></td>
<td>15 seconds</td>
<td>0</td>
<td>Automated</td>
<td>Critical</td>
</tr>
<tr>
<td><strong>NATS</strong></td>
<td>2 minutes</td>
<td>0</td>
<td>Manual</td>
<td>High</td>
</tr>
<tr>
<td><strong>MinIO</strong></td>
<td>30 minutes</td>
<td>15 minutes</td>
<td>Manual</td>
<td>High</td>
</tr>
<tr>
<td><strong>Kong Gateway</strong></td>
<td>1 minute</td>
<td>0</td>
<td>Automated</td>
<td>Critical</td>
</tr>
<tr>
<td><strong>Application Services</strong></td>
<td>5 minutes</td>
<td>0</td>
<td>Automated</td>
<td>High</td>
</tr>
</tbody>
</table>
<h3 id="disaster-scenario-targets">Disaster Scenario Targets<a class="headerlink" href="#disaster-scenario-targets" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>RTO</th>
<th>RPO</th>
<th>Recovery Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>Single PostgreSQL node failure</td>
<td>30 seconds</td>
<td>&lt;5 seconds</td>
<td>Automated failover</td>
</tr>
<tr>
<td>Redis master failure</td>
<td>15 seconds</td>
<td>0</td>
<td>Sentinel failover</td>
</tr>
<tr>
<td>Single AZ failure</td>
<td>5 minutes</td>
<td>&lt;5 seconds</td>
<td>K8s auto-healing</td>
</tr>
<tr>
<td>Region failure</td>
<td>2 hours</td>
<td>&lt;5 minutes</td>
<td>Manual region switch</td>
</tr>
<tr>
<td>Complete datacenter loss</td>
<td>6 hours</td>
<td>&lt;15 minutes</td>
<td>Full DR activation</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="postgresql-failover-procedures">PostgreSQL Failover Procedures<a class="headerlink" href="#postgresql-failover-procedures" title="Permanent link">&para;</a></h2>
<h3 id="scenario-1-automated-failover-primary-node-failure">Scenario 1: Automated Failover (Primary Node Failure)<a class="headerlink" href="#scenario-1-automated-failover-primary-node-failure" title="Permanent link">&para;</a></h3>
<p><strong>Detection:</strong> Patroni automatically detects primary failure via health checks (5-10 seconds)</p>
<p><strong>Automatic Actions:</strong>
1. Patroni detects primary is unreachable
2. ETCD consensus confirms failure
3. Best replica is selected (lowest lag)
4. Replica is promoted to primary
5. HAProxy routes traffic to new primary
6. Old primary rejoins as replica (when available)</p>
<p><strong>Expected RTO:</strong> 15-30 seconds
<strong>Expected RPO:</strong> &lt;5 seconds (synchronous replication)</p>
<p><strong>Monitoring:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Watch cluster status during failover</span>
watch<span class="w"> </span>-n<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="s1">&#39;/home/user/sahool-unified-v15-idp/scripts/disaster-recovery/failover-postgres.sh status&#39;</span>

<span class="c1"># Check HAProxy stats</span>
curl<span class="w"> </span>http://localhost:7000/stats
</code></pre></div>

<p><strong>No manual intervention required unless:</strong>
- Failover does not complete within 2 minutes
- Multiple nodes fail simultaneously
- Data corruption is suspected</p>
<h3 id="scenario-2-planned-switchover-maintenance">Scenario 2: Planned Switchover (Maintenance)<a class="headerlink" href="#scenario-2-planned-switchover-maintenance" title="Permanent link">&para;</a></h3>
<p><strong>Use Case:</strong> Planned maintenance, patching, or testing</p>
<p><strong>Prerequisites:</strong>
- [ ] Announce maintenance window
- [ ] Verify all replicas are healthy and synchronized
- [ ] Verify replication lag is minimal (&lt;1MB)
- [ ] Take backup before proceeding
- [ ] Notify stakeholders</p>
<p><strong>Procedure:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Step 1: Verify cluster health</span>
<span class="nb">cd</span><span class="w"> </span>/home/user/sahool-unified-v15-idp
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>check

<span class="c1"># Step 2: Check current topology</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>status

<span class="c1"># Step 3: Perform switchover to best candidate</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>switchover

<span class="c1"># Step 4: Or switchover to specific node</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>switchover<span class="w"> </span>postgres-replica1

<span class="c1"># Step 5: Verify new primary</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>verify
</code></pre></div>

<p><strong>Expected Duration:</strong> 15-30 seconds
<strong>Expected Downtime:</strong> &lt;5 seconds</p>
<p><strong>Rollback:</strong>
If issues occur, switch back to original primary:</p>
<div class="codehilite"><pre><span></span><code>./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>switchover<span class="w"> </span>postgres-primary
</code></pre></div>

<h3 id="scenario-3-manual-failover-emergency">Scenario 3: Manual Failover (Emergency)<a class="headerlink" href="#scenario-3-manual-failover-emergency" title="Permanent link">&para;</a></h3>
<p><strong>When to Use:</strong>
- Automated failover failed
- Primary node experiencing severe performance issues
- Data corruption suspected
- Compliance or security incident</p>
<p><strong>Emergency Procedure:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Step 1: Assess situation</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>status<span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>/tmp/dr-status.log

<span class="c1"># Step 2: If primary is healthy but needs failover</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>switchover

<span class="c1"># Step 3: If primary is unhealthy/unreachable</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>failover

<span class="c1"># Step 4: Verify cluster health</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>verify

<span class="c1"># Step 5: Test database connectivity</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>sahool-postgres-haproxy<span class="w"> </span>nc<span class="w"> </span>-z<span class="w"> </span>localhost<span class="w"> </span><span class="m">5432</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>sahool-postgres-primary<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT version();&quot;</span>
</code></pre></div>

<p><strong>Post-Failover Actions:</strong>
1. Document the incident
2. Verify application connectivity
3. Check replication status
4. Review logs for errors
5. Notify stakeholders
6. Schedule post-mortem</p>
<h3 id="scenario-4-split-brain-prevention">Scenario 4: Split-Brain Prevention<a class="headerlink" href="#scenario-4-split-brain-prevention" title="Permanent link">&para;</a></h3>
<p><strong>Detection:</strong> Multiple nodes claim to be primary</p>
<p><strong>Prevention Mechanisms:</strong>
- ETCD consensus requires quorum
- Patroni uses distributed locks
- Synchronous replication prevents data divergence
- Watchdog timers prevent dual primary</p>
<p><strong>If Split-Brain Occurs:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Step 1: STOP all applications immediately</span>
docker-compose<span class="w"> </span>-f<span class="w"> </span>docker-compose.yml<span class="w"> </span>stop<span class="w"> </span>api-gateway<span class="w"> </span>field-service

<span class="c1"># Step 2: Identify true primary (most recent LSN)</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>postgres-primary<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-c<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;SELECT pg_current_wal_lsn();&quot;</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>postgres-replica1<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-c<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;SELECT pg_last_wal_receive_lsn();&quot;</span>

<span class="c1"># Step 3: Demote false primary via Patroni</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://postgres-replica1:8008/reinitialize

<span class="c1"># Step 4: Verify single primary</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>status

<span class="c1"># Step 5: Restart applications</span>
docker-compose<span class="w"> </span>-f<span class="w"> </span>docker-compose.yml<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div>

<hr />
<h2 id="multi-region-failover">Multi-Region Failover<a class="headerlink" href="#multi-region-failover" title="Permanent link">&para;</a></h2>
<h3 id="architecture-overview">Architecture Overview<a class="headerlink" href="#architecture-overview" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>Primary Region: Riyadh (me-south-1)
â”œâ”€â”€ EKS Cluster (3 AZs)
â”œâ”€â”€ RDS Multi-AZ Primary
â”œâ”€â”€ ElastiCache (3 nodes)
â””â”€â”€ S3 with Cross-Region Replication

Secondary Region: Jeddah (me-central-1)
â”œâ”€â”€ Standby EKS Cluster
â”œâ”€â”€ RDS Read Replica (can be promoted)
â”œâ”€â”€ S3 Replica Bucket
â””â”€â”€ Warm Standby Configuration
</code></pre></div>

<h3 id="scenario-1-planned-region-failover">Scenario 1: Planned Region Failover<a class="headerlink" href="#scenario-1-planned-region-failover" title="Permanent link">&para;</a></h3>
<p><strong>Use Case:</strong> Planned maintenance, testing, or region migration</p>
<p><strong>Prerequisites:</strong>
- [ ] Secondary region infrastructure is healthy
- [ ] Database replication lag is minimal
- [ ] DNS TTL reduced to 60 seconds (24 hours before)
- [ ] All teams notified
- [ ] Runbook reviewed</p>
<p><strong>Procedure:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Phase 1: Pre-Failover Checks (15 minutes)</span>
<span class="c1"># â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

<span class="c1"># Check secondary region health</span>
aws<span class="w"> </span>eks<span class="w"> </span>describe-cluster<span class="w"> </span>--name<span class="w"> </span>sahool-jeddah<span class="w"> </span>--region<span class="w"> </span>me-central-1

<span class="c1"># Check RDS replica lag</span>
aws<span class="w"> </span>rds<span class="w"> </span>describe-db-instances<span class="w"> </span>--db-instance-identifier<span class="w"> </span>sahool-db-replica<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--region<span class="w"> </span>me-central-1<span class="w"> </span>--query<span class="w"> </span><span class="s1">&#39;DBInstances[0].ReplicaLag&#39;</span>

<span class="c1"># Verify S3 replication</span>
aws<span class="w"> </span>s3api<span class="w"> </span>get-bucket-replication<span class="w"> </span>--bucket<span class="w"> </span>sahool-backups-primary<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--region<span class="w"> </span>me-south-1

<span class="c1"># Phase 2: Prepare Secondary Region (30 minutes)</span>
<span class="c1"># â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

<span class="c1"># Promote RDS read replica to standalone</span>
aws<span class="w"> </span>rds<span class="w"> </span>promote-read-replica<span class="w"> </span>--db-instance-identifier<span class="w"> </span>sahool-db-replica<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--region<span class="w"> </span>me-central-1

<span class="c1"># Wait for promotion to complete</span>
aws<span class="w"> </span>rds<span class="w"> </span><span class="nb">wait</span><span class="w"> </span>db-instance-available<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--db-instance-identifier<span class="w"> </span>sahool-db-replica<span class="w"> </span>--region<span class="w"> </span>me-central-1

<span class="c1"># Update application configuration in Jeddah cluster</span>
kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>sahool-jeddah
kubectl<span class="w"> </span>create<span class="w"> </span>configmap<span class="w"> </span>app-config<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--from-literal<span class="o">=</span><span class="nv">DB_HOST</span><span class="o">=</span>sahool-db-replica.xxxxx.me-central-1.rds.amazonaws.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>-

<span class="c1"># Phase 3: DNS Failover (5 minutes)</span>
<span class="c1"># â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

<span class="c1"># Update Route53 to point to Jeddah</span>
aws<span class="w"> </span>route53<span class="w"> </span>change-resource-record-sets<span class="w"> </span>--hosted-zone-id<span class="w"> </span>ZXXXXX<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--change-batch<span class="w"> </span>file://dns-failover-jeddah.json

<span class="c1"># Phase 4: Verification (15 minutes)</span>
<span class="c1"># â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

<span class="c1"># Test application endpoints</span>
curl<span class="w"> </span>-I<span class="w"> </span>https://api.sahool.sa/health
curl<span class="w"> </span>-I<span class="w"> </span>https://api.sahool.sa/v1/status

<span class="c1"># Verify database connectivity</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>deploy/api-gateway<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>psql<span class="w"> </span>-h<span class="w"> </span><span class="nv">$DB_HOST</span><span class="w"> </span>-U<span class="w"> </span>sahool<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT version();&quot;</span>

<span class="c1"># Check application logs</span>
kubectl<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>deploy/api-gateway<span class="w"> </span>--tail<span class="o">=</span><span class="m">100</span>

<span class="c1"># Phase 5: Monitor (60 minutes)</span>
<span class="c1"># â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>

<span class="c1"># Monitor error rates</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--all-namespaces
kubectl<span class="w"> </span>top<span class="w"> </span>nodes

<span class="c1"># Check application metrics</span>
curl<span class="w"> </span>http://prometheus.sahool.sa/api/v1/query?query<span class="o">=</span>up
</code></pre></div>

<p><strong>Expected RTO:</strong> 60 minutes
<strong>Expected RPO:</strong> &lt;5 minutes</p>
<h3 id="scenario-2-emergency-region-failover">Scenario 2: Emergency Region Failover<a class="headerlink" href="#scenario-2-emergency-region-failover" title="Permanent link">&para;</a></h3>
<p><strong>When to Use:</strong>
- Complete region outage
- Network partition
- Natural disaster
- Critical security incident</p>
<p><strong>Fast-Track Procedure:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># EMERGENCY FAILOVER - EXECUTE IMMEDIATELY</span>

<span class="c1"># 1. Promote Jeddah RDS (2 minutes)</span>
aws<span class="w"> </span>rds<span class="w"> </span>promote-read-replica<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--db-instance-identifier<span class="w"> </span>sahool-db-replica<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--region<span class="w"> </span>me-central-1<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--backup-retention-period<span class="w"> </span><span class="m">30</span>

<span class="c1"># 2. Update DNS (1 minute)</span>
aws<span class="w"> </span>route53<span class="w"> </span>change-resource-record-sets<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--hosted-zone-id<span class="w"> </span>ZXXXXX<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--change-batch<span class="w"> </span>file://emergency-failover.json

<span class="c1"># 3. Scale up Jeddah EKS (3 minutes)</span>
kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>sahool-jeddah
kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>api-gateway<span class="w"> </span>--replicas<span class="o">=</span><span class="m">10</span>
kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>field-service<span class="w"> </span>--replicas<span class="o">=</span><span class="m">5</span>

<span class="c1"># 4. Verify (2 minutes)</span>
curl<span class="w"> </span>https://api.sahool.sa/health
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-A

<span class="c1"># Total Expected Time: 8-10 minutes</span>
</code></pre></div>

<p><strong>Communication Template:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nl">INCIDENT</span><span class="p">:</span><span class="w"> </span><span class="k">Primary</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="p">(</span><span class="n">Riyadh</span><span class="p">)</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">unavailable</span>
<span class="nl">STATUS</span><span class="p">:</span><span class="w"> </span><span class="n">Failing</span><span class="w"> </span><span class="k">over</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">secondary</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="p">(</span><span class="n">Jeddah</span><span class="p">)</span>
<span class="nl">ETA</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">minutes</span>
<span class="n">EXPECTED</span><span class="w"> </span><span class="nl">IMPACT</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">minutes</span><span class="w"> </span><span class="n">downtime</span>
<span class="nl">UPDATES</span><span class="p">:</span><span class="w"> </span><span class="k">Every</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">minutes</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">#platform</span><span class="o">-</span><span class="n">incidents</span>

<span class="k">Next</span><span class="w"> </span><span class="k">Update</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">TIME</span><span class="o">]</span>
<span class="n">DR</span><span class="w"> </span><span class="nl">Lead</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">NAME</span><span class="o">]</span>
</code></pre></div>

<hr />
<h2 id="complete-datacenter-loss-recovery">Complete Datacenter Loss Recovery<a class="headerlink" href="#complete-datacenter-loss-recovery" title="Permanent link">&para;</a></h2>
<h3 id="scenario-total-infrastructure-loss">Scenario: Total Infrastructure Loss<a class="headerlink" href="#scenario-total-infrastructure-loss" title="Permanent link">&para;</a></h3>
<p><strong>Assumption:</strong> All infrastructure destroyed, must rebuild from backups</p>
<p><strong>Recovery Phases:</strong></p>
<h3 id="phase-1-assessment-preparation-30-minutes">Phase 1: Assessment &amp; Preparation (30 minutes)<a class="headerlink" href="#phase-1-assessment-preparation-30-minutes" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Gather DR team</span>
<span class="c1"># 2. Assess scope of damage</span>
<span class="c1"># 3. Locate latest backups</span>
<span class="c1"># 4. Verify backup integrity</span>
<span class="c1"># 5. Prepare clean environment</span>

<span class="c1"># List available backups</span>
aws<span class="w"> </span>s3<span class="w"> </span>ls<span class="w"> </span>s3://sahool-backups/postgres/daily/<span class="w"> </span>--recursive

<span class="c1"># Verify latest backup</span>
aws<span class="w"> </span>s3<span class="w"> </span>cp<span class="w"> </span>s3://sahool-backups/postgres/daily/latest/metadata.json<span class="w"> </span>-<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>.

<span class="c1"># Check WAL archive availability</span>
aws<span class="w"> </span>s3<span class="w"> </span>ls<span class="w"> </span>s3://sahool-wal-archive/<span class="w"> </span>--recursive<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-20
</code></pre></div>

<h3 id="phase-2-infrastructure-provisioning-60-90-minutes">Phase 2: Infrastructure Provisioning (60-90 minutes)<a class="headerlink" href="#phase-2-infrastructure-provisioning-60-90-minutes" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Deploy new EKS cluster via Terraform</span>
<span class="nb">cd</span><span class="w"> </span>/home/user/sahool-unified-v15-idp/infrastructure/terraform/aws/riyadh
terraform<span class="w"> </span>init
terraform<span class="w"> </span>plan<span class="w"> </span>-out<span class="o">=</span>dr-recovery.tfplan
terraform<span class="w"> </span>apply<span class="w"> </span>dr-recovery.tfplan

<span class="c1"># 2. Configure kubectl</span>
aws<span class="w"> </span>eks<span class="w"> </span>update-kubeconfig<span class="w"> </span>--name<span class="w"> </span>sahool-dr-cluster<span class="w"> </span>--region<span class="w"> </span>me-south-1

<span class="c1"># 3. Deploy core infrastructure</span>
helm<span class="w"> </span>install<span class="w"> </span>redis<span class="w"> </span>bitnami/redis<span class="w"> </span>-f<span class="w"> </span>values-redis-ha.yaml
helm<span class="w"> </span>install<span class="w"> </span>postgresql<span class="w"> </span>bitnami/postgresql-ha<span class="w"> </span>-f<span class="w"> </span>values-postgres-ha.yaml
helm<span class="w"> </span>install<span class="w"> </span>nats<span class="w"> </span>nats/nats<span class="w"> </span>-f<span class="w"> </span>values-nats.yaml
helm<span class="w"> </span>install<span class="w"> </span>minio<span class="w"> </span>minio/minio<span class="w"> </span>-f<span class="w"> </span>values-minio.yaml

<span class="c1"># 4. Wait for all pods to be ready</span>
kubectl<span class="w"> </span><span class="nb">wait</span><span class="w"> </span>--for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>ready<span class="w"> </span>pod<span class="w"> </span>--all<span class="w"> </span>--timeout<span class="o">=</span>600s
</code></pre></div>

<h3 id="phase-3-database-recovery-45-90-minutes">Phase 3: Database Recovery (45-90 minutes)<a class="headerlink" href="#phase-3-database-recovery-45-90-minutes" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Restore PostgreSQL from backup</span>
<span class="nb">cd</span><span class="w"> </span>/home/user/sahool-unified-v15-idp/scripts/backup

<span class="c1"># Download latest backup</span>
aws<span class="w"> </span>s3<span class="w"> </span>sync<span class="w"> </span>s3://sahool-backups/postgres/daily/latest/<span class="w"> </span>/tmp/restore/

<span class="c1"># Restore database</span>
./restore_postgres.sh<span class="w"> </span>/tmp/restore/sahool_20260106_020000.dump

<span class="c1"># 2. Apply WAL files for PITR</span>
<span class="c1"># Restore to specific point in time</span>
<span class="nv">RECOVERY_TARGET</span><span class="o">=</span><span class="s2">&quot;2026-01-06 01:55:00&quot;</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>postgres-primary<span class="w"> </span>sh<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">  echo \&quot;recovery_target_time = &#39;</span><span class="si">${</span><span class="nv">RECOVERY_TARGET</span><span class="si">}</span><span class="s2">&#39;\&quot; &gt;&gt; /var/lib/postgresql/data/recovery.conf</span>
<span class="s2">  pg_ctl restart</span>
<span class="s2">&quot;</span>

<span class="c1"># 3. Verify database</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>postgres-primary<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT COUNT(*) FROM farms;&quot;</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>postgres-primary<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT pg_last_wal_replay_lsn();&quot;</span>
</code></pre></div>

<h3 id="phase-4-application-deployment-30-45-minutes">Phase 4: Application Deployment (30-45 minutes)<a class="headerlink" href="#phase-4-application-deployment-30-45-minutes" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Deploy applications via ArgoCD</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>infrastructure/deployment/argocd/

<span class="c1"># 2. Sync all applications</span>
argocd<span class="w"> </span>app<span class="w"> </span>sync<span class="w"> </span>sahool-api-gateway
argocd<span class="w"> </span>app<span class="w"> </span>sync<span class="w"> </span>sahool-field-service
argocd<span class="w"> </span>app<span class="w"> </span>sync<span class="w"> </span>sahool-admin-dashboard

<span class="c1"># 3. Verify deployments</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>sahool-prod
kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-n<span class="w"> </span>sahool-prod
</code></pre></div>

<h3 id="phase-5-verification-testing-45-minutes">Phase 5: Verification &amp; Testing (45 minutes)<a class="headerlink" href="#phase-5-verification-testing-45-minutes" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Run DR test suite</span>
<span class="nb">cd</span><span class="w"> </span>/home/user/sahool-unified-v15-idp/scripts/disaster-recovery
./test-failover.sh<span class="w"> </span>comprehensive

<span class="c1"># 2. Manual verification</span>
curl<span class="w"> </span>https://api.sahool.sa/health
curl<span class="w"> </span>https://api.sahool.sa/v1/farms?limit<span class="o">=</span><span class="m">10</span>

<span class="c1"># 3. Database integrity checks</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>postgres-primary<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-d<span class="w"> </span>sahool<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||&#39;.&#39;||tablename))</span>
<span class="s">FROM pg_tables</span>
<span class="s">WHERE schemaname = &#39;public&#39;</span>
<span class="s">ORDER BY pg_total_relation_size(schemaname||&#39;.&#39;||tablename) DESC</span>
<span class="s">LIMIT 10;</span>
<span class="s">EOF</span>
</code></pre></div>

<h3 id="phase-6-dns-cutover-15-minutes">Phase 6: DNS Cutover (15 minutes)<a class="headerlink" href="#phase-6-dns-cutover-15-minutes" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Update DNS to point to new infrastructure</span>
aws<span class="w"> </span>route53<span class="w"> </span>change-resource-record-sets<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--hosted-zone-id<span class="w"> </span>ZXXXXX<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--change-batch<span class="w"> </span>file://dns-recovery.json

<span class="c1"># Verify DNS propagation</span>
dig<span class="w"> </span>api.sahool.sa<span class="w"> </span>+short
curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Host: api.sahool.sa&quot;</span><span class="w"> </span>http://<span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>api-gateway<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.loadBalancer.ingress[0].hostname}&#39;</span><span class="k">)</span>
</code></pre></div>

<p><strong>Total Recovery Time:</strong> 3.5 - 6.5 hours
<strong>Aligns with RTO target:</strong> 6 hours âœ…</p>
<hr />
<h2 id="service-specific-recovery">Service-Specific Recovery<a class="headerlink" href="#service-specific-recovery" title="Permanent link">&para;</a></h2>
<h3 id="redis-recovery">Redis Recovery<a class="headerlink" href="#redis-recovery" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Check Redis Sentinel status</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>sahool-redis-sentinel<span class="w"> </span>redis-cli<span class="w"> </span>-p<span class="w"> </span><span class="m">26379</span><span class="w"> </span>SENTINEL<span class="w"> </span>get-master-addr-by-name<span class="w"> </span>mymaster

<span class="c1"># Manual failover if needed</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>sahool-redis-sentinel<span class="w"> </span>redis-cli<span class="w"> </span>-p<span class="w"> </span><span class="m">26379</span><span class="w"> </span>SENTINEL<span class="w"> </span>failover<span class="w"> </span>mymaster

<span class="c1"># Verify replication</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>sahool-redis<span class="w"> </span>redis-cli<span class="w"> </span>INFO<span class="w"> </span>replication
</code></pre></div>

<h3 id="nats-recovery">NATS Recovery<a class="headerlink" href="#nats-recovery" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Restore NATS JetStream data</span>
<span class="nb">cd</span><span class="w"> </span>/home/user/sahool-unified-v15-idp/scripts/backup
./backup_nats.sh<span class="w"> </span>restore<span class="w"> </span>/backups/nats/latest

<span class="c1"># Verify streams</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>sahool-nats<span class="w"> </span>nats<span class="w"> </span>stream<span class="w"> </span>ls
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>sahool-nats<span class="w"> </span>nats<span class="w"> </span>stream<span class="w"> </span>info<span class="w"> </span>EVENTS
</code></pre></div>

<h3 id="minio-recovery">MinIO Recovery<a class="headerlink" href="#minio-recovery" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Restore MinIO data</span>
<span class="nb">cd</span><span class="w"> </span>/home/user/sahool-unified-v15-idp/scripts/backup
./restore_minio.sh<span class="w"> </span>/backups/minio/latest

<span class="c1"># Verify buckets</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>sahool-minio<span class="w"> </span>mc<span class="w"> </span>ls<span class="w"> </span>local/
</code></pre></div>

<hr />
<h2 id="rollback-procedures">Rollback Procedures<a class="headerlink" href="#rollback-procedures" title="Permanent link">&para;</a></h2>
<h3 id="rollback-after-failed-failover">Rollback After Failed Failover<a class="headerlink" href="#rollback-after-failed-failover" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Stop all application traffic</span>
kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>--all<span class="w"> </span>--replicas<span class="o">=</span><span class="m">0</span>

<span class="c1"># 2. Restore original primary</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>switchover<span class="w"> </span>postgres-primary-original

<span class="c1"># 3. Verify restoration</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>verify

<span class="c1"># 4. Resume traffic</span>
kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>api-gateway<span class="w"> </span>--replicas<span class="o">=</span><span class="m">10</span>
</code></pre></div>

<h3 id="rollback-after-region-failover">Rollback After Region Failover<a class="headerlink" href="#rollback-after-region-failover" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Reduce DNS TTL (if not already done)</span>
<span class="c1"># 2. Revert DNS to primary region</span>
aws<span class="w"> </span>route53<span class="w"> </span>change-resource-record-sets<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--hosted-zone-id<span class="w"> </span>ZXXXXX<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--change-batch<span class="w"> </span>file://dns-rollback-riyadh.json

<span class="c1"># 3. Scale down secondary region</span>
kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>sahool-jeddah
kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>--all<span class="w"> </span>--replicas<span class="o">=</span><span class="m">1</span>

<span class="c1"># 4. Demote promoted RDS replica back to replica</span>
<span class="c1"># Note: This requires re-creating replication, cannot demote directly</span>
</code></pre></div>

<hr />
<h2 id="post-recovery-checklist">Post-Recovery Checklist<a class="headerlink" href="#post-recovery-checklist" title="Permanent link">&para;</a></h2>
<h3 id="immediate-within-1-hour">Immediate (Within 1 hour)<a class="headerlink" href="#immediate-within-1-hour" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Verify all services are operational</li>
<li>[ ] Check database replication status</li>
<li>[ ] Review error logs for anomalies</li>
<li>[ ] Validate backup processes are running</li>
<li>[ ] Confirm monitoring and alerting is active</li>
<li>[ ] Update incident documentation</li>
<li>[ ] Notify all stakeholders of recovery completion</li>
</ul>
<h3 id="short-term-within-24-hours">Short-term (Within 24 hours)<a class="headerlink" href="#short-term-within-24-hours" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Complete incident report</li>
<li>[ ] Review and update runbooks based on learnings</li>
<li>[ ] Replenish consumed backups</li>
<li>[ ] Verify data integrity across all services</li>
<li>[ ] Check financial transaction consistency</li>
<li>[ ] Review access logs for security concerns</li>
<li>[ ] Update DR test schedule</li>
</ul>
<h3 id="medium-term-within-1-week">Medium-term (Within 1 week)<a class="headerlink" href="#medium-term-within-1-week" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Conduct post-mortem meeting</li>
<li>[ ] Document lessons learned</li>
<li>[ ] Update DR procedures</li>
<li>[ ] Train team on any new procedures</li>
<li>[ ] Review and optimize RTO/RPO targets</li>
<li>[ ] Update monitoring thresholds</li>
<li>[ ] Schedule follow-up DR drill</li>
</ul>
<hr />
<h2 id="appendix-command-reference">Appendix: Command Reference<a class="headerlink" href="#appendix-command-reference" title="Permanent link">&para;</a></h2>
<h3 id="quick-status-checks">Quick Status Checks<a class="headerlink" href="#quick-status-checks" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># PostgreSQL cluster status</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>status

<span class="c1"># HAProxy stats</span>
curl<span class="w"> </span>http://localhost:7000/stats

<span class="c1"># Database connection</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>postgres-primary<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT version();&quot;</span>

<span class="c1"># Replication lag</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>postgres-primary<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-c<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;SELECT client_addr, state, sent_lsn, write_lsn, flush_lsn, replay_lsn,</span>
<span class="s2">   pg_wal_lsn_diff(sent_lsn, replay_lsn) AS lag_bytes</span>
<span class="s2">   FROM pg_stat_replication;&quot;</span>

<span class="c1"># Redis Sentinel status</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>sahool-redis-sentinel<span class="w"> </span>redis-cli<span class="w"> </span>-p<span class="w"> </span><span class="m">26379</span><span class="w"> </span>SENTINEL<span class="w"> </span>masters

<span class="c1"># Kubernetes cluster health</span>
kubectl<span class="w"> </span>get<span class="w"> </span>nodes
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--all-namespaces
kubectl<span class="w"> </span>top<span class="w"> </span>nodes
</code></pre></div>

<h3 id="emergency-commands">Emergency Commands<a class="headerlink" href="#emergency-commands" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Emergency stop all services</span>
docker-compose<span class="w"> </span>-f<span class="w"> </span>docker-compose.yml<span class="w"> </span>stop

<span class="c1"># Emergency PostgreSQL failover</span>
./scripts/disaster-recovery/failover-postgres.sh<span class="w"> </span>failover

<span class="c1"># Force promote specific replica</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://postgres-replica1:8008/failover<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;candidate&quot;:&quot;postgres-replica1&quot;}&#39;</span>

<span class="c1"># Emergency database backup</span>
./scripts/backup/backup_postgres.sh<span class="w"> </span>manual
</code></pre></div>

<hr />
<h2 id="document-control">Document Control<a class="headerlink" href="#document-control" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
<th>Author</th>
<th>Changes</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.0.0</td>
<td>2025-12-27</td>
<td>DR Team</td>
<td>Initial version</td>
</tr>
<tr>
<td>2.0.0</td>
<td>2026-01-06</td>
<td>DR Team</td>
<td>Added PostgreSQL HA procedures, multi-region failover</td>
</tr>
</tbody>
</table>
<p><strong>Next Review Date:</strong> 2026-04-06
<strong>Classification:</strong> CRITICAL - Internal Use Only
<strong>Distribution:</strong> DR Team, Infrastructure Team, On-Call Engineers</p>
<hr />
<p><strong>END OF RUNBOOK</strong></p>
<p><em>For questions or clarifications, contact: dr-team@sahool.sa</em></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>