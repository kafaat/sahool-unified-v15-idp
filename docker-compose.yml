# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL v15.3.2 Docker Compose
# Complete platform deployment configuration
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # Infrastructure Services
  # ─────────────────────────────────────────────────────────────────────────────

  # قاعدة البيانات المكانية (PostGIS)
  # SECURITY: POSTGRES_PASSWORD MUST be set in .env file - never use defaults in production!
  postgres:
    image: postgis/postgis:16-3.4
    container_name: sahool-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-sahool}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infra/postgres/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sahool}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - sahool-network

  # API Gateway (Kong)
  # SECURITY: Kong admin port is restricted to localhost only
  kong:
    image: kong:3.9
    container_name: sahool-kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 127.0.0.1:8001
    ports:
      - "8000:8000"
      - "127.0.0.1:8001:8001"
    volumes:
      - ./infra/kong/kong.yml:/kong/declarative/kong.yml
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - sahool-network

  nats:
    image: nats:2.10.24-alpine
    container_name: sahool-nats
    command: ["--jetstream", "--store_dir=/data", "-m", "8222"]
    volumes:
      - nats_data:/data
    ports:
      - "4222:4222"
      - "127.0.0.1:8222:8222"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - sahool-network

  # SECURITY: REDIS_PASSWORD MUST be set in .env file
  redis:
    image: redis:7.4-alpine
    container_name: sahool-redis
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${REDIS_PASSWORD:?REDIS_PASSWORD is required}"]
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:?REDIS_PASSWORD is required}
    volumes:
      - redis_data:/data
    ports:
      - "127.0.0.1:6379:6379"
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a $${REDIS_PASSWORD} ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - sahool-network

  # Qdrant Vector Database - قاعدة البيانات المتجهة للـ RAG
  # Used by ai-advisor for semantic search and embeddings
  qdrant:
    image: qdrant/qdrant:v1.10.1
    container_name: sahool-qdrant
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - "127.0.0.1:6333:6333"
      - "127.0.0.1:6334:6334"
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  mqtt:
    image: eclipse-mosquitto:2.0.20
    container_name: sahool-mqtt
    volumes:
      - ./infra/mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./infra/mqtt/passwd:/mosquitto/config/passwd:ro
      - mqtt_data:/mosquitto/data
      - mqtt_logs:/mosquitto/log
    ports:
      - "127.0.0.1:1883:1883"
      - "127.0.0.1:9001:9001"
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -h localhost -u ${MQTT_USER:-sahool_iot} -P ${MQTT_PASSWORD:-changeme} -t '$$SYS/#' -C 1 -W 3 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Core Geospatial Service (NEW)
  # ─────────────────────────────────────────────────────────────────────────────

  # خدمة الحقول الجغرافية (Field Core)
  field_core:
    build:
      context: ./apps/services/field-core
      dockerfile: Dockerfile
    container_name: sahool-field-core
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER:-sahool}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-sahool}
      - DB_NAME=${POSTGRES_DB:-sahool}
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Application Services
  # ─────────────────────────────────────────────────────────────────────────────

  field_ops:
    build:
      context: ./apps/services/field-ops
      dockerfile: Dockerfile
    container_name: sahool-field-ops
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-RS256}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  ndvi_engine:
    build:
      context: ./apps/services/ndvi-engine
      dockerfile: Dockerfile
    container_name: sahool-ndvi-engine
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-RS256}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - PORT=8107
    ports:
      - "8107:8107"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8107/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  weather_core:
    build:
      context: ./apps/services/weather-core
      dockerfile: Dockerfile
    container_name: sahool-weather-core
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-RS256}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - PORT=8108
      # Weather Multi-Provider Configuration
      - USE_MULTI_PROVIDER=${USE_MULTI_PROVIDER:-true}
      - USE_MOCK_WEATHER=${USE_MOCK_WEATHER:-false}
      - OPENWEATHERMAP_API_KEY=${OPENWEATHERMAP_API_KEY:-}
      - WEATHERAPI_KEY=${WEATHERAPI_KEY:-}
    ports:
      - "8108:8108"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8108/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  field_chat:
    build:
      context: ./apps/services/field-chat
      dockerfile: Dockerfile
    container_name: sahool-field-chat
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-RS256}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "8099:8099"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8099/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  iot_gateway:
    build:
      context: ./apps/services/iot-gateway
      dockerfile: Dockerfile
    container_name: sahool-iot-gateway
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - MQTT_BROKER=mqtt
      - MQTT_PORT=1883
      - MQTT_USER=${MQTT_USER:-sahool_iot}
      - MQTT_PASSWORD=${MQTT_PASSWORD:?MQTT_PASSWORD is required}
      - MQTT_TOPIC=sahool/sensors/#
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-RS256}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - PORT=8106
    ports:
      - "8106:8106"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      mqtt:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8106/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  agro_advisor:
    build:
      context: ./apps/services/agro-advisor
      dockerfile: Dockerfile
    container_name: sahool-agro-advisor
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-RS256}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - PORT=8105
    ports:
      - "8105:8105"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8105/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  ws_gateway:
    build:
      context: ./apps/services/ws-gateway
      dockerfile: Dockerfile
    container_name: sahool-ws-gateway
    environment:
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-RS256}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:8080}
      - PORT=8081
    ports:
      - "8081:8081"
    depends_on:
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  crop_health:
    build:
      context: ./apps/services/crop-health
      dockerfile: Dockerfile
    container_name: sahool-crop-health
    environment:
      - CDN_BASE_URL=${CDN_BASE_URL:-https://cdn.sahool.io}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8100:8100"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # Agro Rules Worker - NATS event-driven worker
  agro_rules:
    build:
      context: ./apps/services/agro-rules
      dockerfile: Dockerfile
    container_name: sahool-agro-rules
    environment:
      - NATS_URL=nats://nats:4222
      - FIELDOPS_URL=http://field_ops:8080
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    depends_on:
      nats:
        condition: service_healthy
      field_ops:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # NEW Microservices (Polyglot Architecture)
  # ─────────────────────────────────────────────────────────────────────────────

  # Task Service (Python + FastAPI) - إدارة المهام الزراعية
  task_service:
    build:
      context: ./apps/services/task-service
      dockerfile: Dockerfile
    container_name: sahool-task-service
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8103:8103"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8103/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # Equipment Service (Python + FastAPI) - إدارة المعدات
  equipment_service:
    build:
      context: ./apps/services/equipment-service
      dockerfile: Dockerfile
    container_name: sahool-equipment-service
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8101:8101"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8101/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # Provider Configuration Service (Python + FastAPI) - إدارة المزودين
  provider_config:
    build:
      context: ./apps/services/provider-config
      dockerfile: Dockerfile
    container_name: sahool-provider-config
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8104:8104"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8104/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Sahool Vision & Virtual Sensors (AI Services)
  # سهول فيجن ومحرك المستشعرات الافتراضية
  # ─────────────────────────────────────────────────────────────────────────────

  # Sahool Vision AI - Crop Health Detection (Python + TensorFlow)
  crop_health_ai:
    build:
      context: ./apps/services/crop-health-ai
      dockerfile: Dockerfile
    container_name: sahool-crop-health-ai
    environment:
      - PORT=8095
      - MODEL_PATH=/app/models/plant_disease.tflite
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8095:8095"
    volumes:
      - ./models:/app/models:ro
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8095/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # Virtual Sensors Engine - FAO-56 ET0 Calculations (Python + FastAPI)
  virtual_sensors:
    build:
      context: ./apps/services/virtual-sensors
      dockerfile: Dockerfile
    container_name: sahool-virtual-sensors
    environment:
      - PORT=8096
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8096:8096"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # Community Chat Service - Real-time messaging (Node.js + Socket.io)
  community_chat:
    build:
      context: ./apps/services/community-chat
      dockerfile: Dockerfile
    container_name: sahool-community-chat
    environment:
      - PORT=8097
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - NATS_URL=nats://nats:4222
    ports:
      - "8097:8097"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8097/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network


  # Yield Engine - ML Crop Yield Prediction (Python + FastAPI)
  yield_engine:
    build:
      context: ./apps/services/yield-engine
      dockerfile: Dockerfile
    container_name: sahool-yield-engine
    environment:
      - PORT=8098
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8098:8098"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8098/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # Irrigation Smart - Smart Irrigation Management (Python + FastAPI)
  # الري الذكي - إدارة الري باستخدام FAO-56 Penman-Monteith
  irrigation_smart:
    build:
      context: ./apps/services/irrigation-smart
      dockerfile: Dockerfile
    container_name: sahool-irrigation-smart
    environment:
      - PORT=8094
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - IOT_GATEWAY_URL=http://iot_gateway:8106
    ports:
      - "8094:8094"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8094/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # Fertilizer Advisor - Smart Fertilization Recommendations (Python + FastAPI)
  # مستشار التسميد - توصيات التسميد الذكية
  fertilizer_advisor:
    build:
      context: ./apps/services/fertilizer-advisor
      dockerfile: Dockerfile
    container_name: sahool-fertilizer-advisor
    environment:
      - PORT=8093
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8093:8093"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8093/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # Indicators Service - Agricultural KPIs & Analytics (Python + FastAPI)
  # خدمة المؤشرات - مؤشرات الأداء الزراعية والتحليلات
  indicators_service:
    build:
      context: ./apps/services/indicators-service
      dockerfile: Dockerfile
    container_name: sahool-indicators-service
    environment:
      - PORT=8091
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8091:8091"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # Satellite Service - NDVI Analysis & Satellite Imagery (Python + FastAPI)
  # خدمة الأقمار الصناعية - تحليل NDVI وصور الأقمار الصناعية
  satellite_service:
    build:
      context: ./apps/services/satellite-service
      dockerfile: Dockerfile
    container_name: sahool-satellite-service
    environment:
      - PORT=8090
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - PLANET_API_KEY=${PLANET_API_KEY:-}
      - PLANET_CLIENT_ID=${PLANET_CLIENT_ID:-}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8090:8090"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # Weather Advanced Service - Agricultural Weather Forecasting (Python + FastAPI)
  # خدمة الطقس المتقدمة - التنبؤ بالطقس الزراعي
  weather_advanced:
    build:
      context: ./apps/services/weather-advanced
      dockerfile: Dockerfile
    container_name: sahool-weather-advanced
    environment:
      - PORT=8092
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY:-}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8092:8092"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8092/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Notification Service - Push notifications & alerts (Python + FastAPI)
  # خدمة الإشعارات - التنبيهات والإشعارات الذكية
  # ─────────────────────────────────────────────────────────────────────────────

  notification_service:
    build:
      context: ./apps/services/notification-service
      dockerfile: Dockerfile
    container_name: sahool-notification-service
    environment:
      - PORT=8110
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - NATS_URL=nats://nats:4222
    ports:
      - "8110:8110"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8110/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Research Core - Scientific Research Management (NestJS)
  # نواة البحث العلمي - إدارة التجارب الزراعية
  # ─────────────────────────────────────────────────────────────────────────────

  research_core:
    build:
      context: ./apps/services/research-core
      dockerfile: Dockerfile
    container_name: sahool-research-core
    environment:
      - PORT=3015
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - SIGNATURE_SECRET_KEY=${JWT_SECRET_KEY}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:8080}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "3015:3015"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3015/api/v1/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Disaster Assessment Service (NestJS) - خدمة تقييم الكوارث
  # Based on: Agricultural Remote Sensing On-Demand Service Model (Article)
  # ─────────────────────────────────────────────────────────────────────────────

  disaster_assessment:
    build:
      context: ./apps/services/disaster-assessment
      dockerfile: Dockerfile
    container_name: sahool-disaster-assessment
    environment:
      - PORT=3020
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://sahool.com,https://app.sahool.com}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "3020:3020"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3020/api/v1/disasters/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Yield Prediction Service (NestJS) - خدمة التنبؤ بالإنتاجية
  # Based on: Agricultural Remote Sensing On-Demand Service Model (Article)
  # ─────────────────────────────────────────────────────────────────────────────

  yield_prediction:
    build:
      context: ./apps/services/yield-prediction
      dockerfile: Dockerfile
    container_name: sahool-yield-prediction
    environment:
      - PORT=3021
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://sahool.com,https://app.sahool.com}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "3021:3021"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3021/api/v1/yield/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # LAI Estimation Service (NestJS) - خدمة تقدير مؤشر مساحة الأوراق
  # Based on: LAI-TransNet Two-Stage Transfer Learning Framework
  # Reference: Artificial Intelligence in Agriculture (2025), IF: 12.4
  # ─────────────────────────────────────────────────────────────────────────────

  lai_estimation:
    build:
      context: ./apps/services/lai-estimation
      dockerfile: Dockerfile
    container_name: sahool-lai-estimation
    environment:
      - PORT=3022
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://sahool.com,https://app.sahool.com}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "3022:3022"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3022/api/v1/lai/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Crop Growth Model Service (NestJS) - خدمة نموذج نمو المحاصيل
  # Based on: WOFOST, DSSAT, APSIM mechanistic crop models
  # Features: Phenology, Photosynthesis (Farquhar), Biomass partitioning
  # ─────────────────────────────────────────────────────────────────────────────

  crop_growth_model:
    build:
      context: ./apps/services/crop-growth-model
      dockerfile: Dockerfile
    container_name: sahool-crop-growth-model
    environment:
      - PORT=3023
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://sahool.com,https://app.sahool.com}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "3023:3023"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3023/api/v1/simulation/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # Marketplace & FinTech Service (NestJS)
  # سوق سهول والخدمات المالية
  # ─────────────────────────────────────────────────────────────────────────────

  marketplace_service:
    build:
      context: ./apps/services/marketplace-service
      dockerfile: Dockerfile
    container_name: sahool-marketplace
    environment:
      - PORT=3010
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://sahool.com,https://app.sahool.com}
    ports:
      - "3010:3010"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3010/api/v1/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Admin Dashboard (Next.js)
  # لوحة تحكم المشرفين
  # ─────────────────────────────────────────────────────────────────────────────

  admin_dashboard:
    build:
      context: ./archive/frontend-legacy/frontend/dashboard
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost
    container_name: sahool-admin-dashboard
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://localhost
    ports:
      - "3001:3001"
    depends_on:
      - crop_health_ai
      - virtual_sensors
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Billing Core Service - خدمة الفوترة الأساسية
  # Subscription management, invoicing, payments
  # ─────────────────────────────────────────────────────────────────────────────

  billing_core:
    build:
      context: ./apps/services/billing-core
      dockerfile: Dockerfile
    container_name: sahool-billing-core
    environment:
      - PORT=8089
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - NATS_URL=nats://nats:4222
      - STRIPE_API_KEY=${STRIPE_API_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - THARWATT_BASE_URL=${THARWATT_BASE_URL:-https://developers-test.tharwatt.com:5253}
      - THARWATT_API_KEY=${THARWATT_API_KEY:-}
      - THARWATT_MERCHANT_ID=${THARWATT_MERCHANT_ID:-}
      - THARWATT_WEBHOOK_SECRET=${THARWATT_WEBHOOK_SECRET:-}
    ports:
      - "8089:8089"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # AI Advisor Service - خدمة المستشار الذكي المتعدد الوكلاء
  # Multi-Agent AI system with LangChain, RAG, and Claude integration
  # ─────────────────────────────────────────────────────────────────────────────

  ai_advisor:
    build:
      context: ./apps/services/ai-advisor
      dockerfile: Dockerfile
    container_name: sahool-ai-advisor
    environment:
      - SERVICE_PORT=8112
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # External service URLs
      - CROP_HEALTH_URL=http://crop_health_ai:8095
      - WEATHER_URL=http://weather_core:8108
      - SATELLITE_URL=http://satellite_service:8090
      - AGRO_ADVISOR_URL=http://agro_advisor:8105
      - NDVI_URL=http://ndvi_engine:8107
      # RAG Configuration
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - EMBEDDING_MODEL=paraphrase-multilingual-MiniLM-L12-v2
      # NATS Configuration
      - NATS_URL=nats://nats:4222
    ports:
      - "8112:8112"
    depends_on:
      - qdrant
      - nats
      - crop_health_ai
      - weather_core
      - agro_advisor
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8112/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Astronomical Calendar Service - خدمة التقويم الفلكي الزراعي اليمني
  # Yemeni agricultural astronomical calendar
  # ─────────────────────────────────────────────────────────────────────────────

  astronomical_calendar:
    build:
      context: ./apps/services/astronomical-calendar
      dockerfile: Dockerfile
    container_name: sahool-astronomical-calendar
    environment:
      - PORT=8111
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - WEATHER_SERVICE_URL=http://weather_advanced:8092
    ports:
      - "8111:8111"
    depends_on:
      - weather_advanced
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8111/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Observability Stack (Prometheus + Grafana)
  # المراقبة والرصد
  # ─────────────────────────────────────────────────────────────────────────────

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: sahool-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observability/alerts:/etc/prometheus/alerts:ro
      - prometheus_data:/prometheus
    ports:
      - "127.0.0.1:9090:9090"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

  grafana:
    image: grafana/grafana:10.2.0
    container_name: sahool-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD is required}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3002}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    ports:
      - "3002:3000"
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - sahool-network

# ─────────────────────────────────────────────────────────────────────────────
# Networks
# ─────────────────────────────────────────────────────────────────────────────

networks:
  sahool-network:
    driver: bridge
    name: sahool-network

# ─────────────────────────────────────────────────────────────────────────────
# Volumes
# ─────────────────────────────────────────────────────────────────────────────

volumes:
  postgres_data:
    name: sahool-postgres-data
  nats_data:
    name: sahool-nats-data
  redis_data:
    name: sahool-redis-data
  qdrant_data:
    name: sahool-qdrant-data
  mqtt_data:
    name: sahool-mqtt-data
  mqtt_logs:
    name: sahool-mqtt-logs
  prometheus_data:
    name: sahool-prometheus-data
  grafana_data:
    name: sahool-grafana-data
