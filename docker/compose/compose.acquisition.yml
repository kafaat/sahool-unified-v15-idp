version: '3.8'
services:
  iot-service:
    build:
      context: ../../apps/services/iot-service
      dockerfile: Dockerfile
    ports:
    - 8117:8117
    environment:
    - PORT=8117
    - NODE_ENV=production
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8117/health
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '400'
          memory: 512Mi
  satellite-service:
    build:
      context: ../../apps/services/satellite-service
      dockerfile: Dockerfile
    ports:
    - 9190:9190
    environment:
    - PORT=9190
    - ENVIRONMENT=production
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:9190/health
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '600'
          memory: 768Mi
  weather-advanced:
    build:
      context: ../../apps/services/weather-advanced
      dockerfile: Dockerfile
    ports:
    - 9092:9092
    environment:
    - PORT=9092
    - ENVIRONMENT=production
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:9092/health
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '300'
          memory: 256Mi
  virtual-sensors:
    build:
      context: ../../apps/services/virtual-sensors
      dockerfile: Dockerfile
    ports:
    - 8119:8119
    environment:
    - PORT=8119
    - ENVIRONMENT=production
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8119/health
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '400'
          memory: 384Mi
    depends_on:
    - weather-advanced
    - satellite-service
  weather-service:
    build:
      context: ../../apps/services/weather-service
      dockerfile: Dockerfile
    ports:
    - 8092:8092
    environment:
    - PORT=8092
    - ENVIRONMENT=production
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8092/health
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '300'
          memory: 256Mi
    depends_on:
    - postgres
    - redis
    - nats
  astronomical-calendar:
    build:
      context: ../../apps/services/astronomical-calendar
      dockerfile: Dockerfile
    ports:
    - 8111:8111
    environment:
    - PORT=8111
    - ENVIRONMENT=production
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8111/healthz
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '200'
          memory: 256Mi
    depends_on:
    - postgres
    - redis
  iot-gateway:
    build:
      context: ../../apps/services/iot-gateway
      dockerfile: Dockerfile
    ports:
    - 8106:8106
    environment:
    - PORT=8106
    - ENVIRONMENT=production
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8106/healthz
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '300'
          memory: 256Mi
    depends_on:
    - postgres
    - redis
    - nats
    - mqtt
networks:
  sahool-network:
    driver: bridge
