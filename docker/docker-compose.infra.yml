# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - Infrastructure Services
# خدمات البنية التحتية لمنصة سهول
#
# Usage:
#   docker-compose -f docker/docker-compose.infra.yml up -d
#   docker-compose -f docker/docker-compose.infra.yml up -d --wait
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # PostgreSQL + PostGIS (Spatial Database)
  # ─────────────────────────────────────────────────────────────────────────────
  postgres:
    image: postgis/postgis:16-3.4
    container_name: sahool-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-sahool}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-sahool}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../infrastructure/core/postgres/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "127.0.0.1:${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sahool} -d ${POSTGRES_DB:-sahool}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Database Migrator
  # ─────────────────────────────────────────────────────────────────────────────
  db-migrator:
    image: postgis/postgis:16-3.4
    container_name: sahool-db-migrator
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_USER: ${POSTGRES_USER:-sahool}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-sahool}
    volumes:
      - ../infrastructure/core/postgres/migrations:/migrations:ro
      - ../scripts/run-migrations.sh:/run-migrations.sh:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Waiting for PostgreSQL to be ready..."
        until pg_isready -h postgres -U ${POSTGRES_USER:-sahool}; do
          echo "PostgreSQL not ready yet..."
          sleep 2
        done
        echo "PostgreSQL is ready!"

        echo "Running migrations..."
        for f in /migrations/*.sql; do
          if [ -f "$$f" ]; then
            echo "Executing $$f..."
            PGPASSWORD=$$POSTGRES_PASSWORD psql -h postgres -U $$POSTGRES_USER -d $$POSTGRES_DB -f "$$f" || true
          fi
        done

        echo "Migrations complete!"
    networks:
      - sahool-network
    restart: "no"

  # ─────────────────────────────────────────────────────────────────────────────
  # Redis (Cache & Sessions)
  # ─────────────────────────────────────────────────────────────────────────────
  redis:
    image: redis:7.4-alpine
    container_name: sahool-redis
    command:
      - redis-server
      - --appendonly
      - "yes"
      - --requirepass
      - "${REDIS_PASSWORD:?REDIS_PASSWORD is required}"
      - --maxmemory
      - "256mb"
      - --maxmemory-policy
      - "allkeys-lru"
    volumes:
      - redis_data:/data
    ports:
      - "127.0.0.1:${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # NATS (Message Queue with JetStream)
  # ─────────────────────────────────────────────────────────────────────────────
  nats:
    image: nats:2.10.24-alpine
    container_name: sahool-nats
    command:
      - "--jetstream"
      - "--store_dir=/data"
      - "-m"
      - "8222"
      - "--name"
      - "sahool-nats"
    volumes:
      - nats_data:/data
    ports:
      - "${NATS_PORT:-4222}:4222"
      - "127.0.0.1:${NATS_MONITOR_PORT:-8222}:8222"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # MQTT (IoT Message Broker)
  # ─────────────────────────────────────────────────────────────────────────────
  mqtt:
    image: eclipse-mosquitto:2.0.20
    container_name: sahool-mqtt
    volumes:
      - ../infrastructure/core/mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ../infrastructure/core/mqtt/passwd:/mosquitto/config/passwd:ro
      - ../infrastructure/core/mqtt/acl:/mosquitto/config/acl:ro
      - mqtt_data:/mosquitto/data
      - mqtt_logs:/mosquitto/log
    ports:
      - "${MQTT_PORT:-1883}:1883"
      - "${MQTT_WS_PORT:-9001}:9001"
    healthcheck:
      test: ["CMD-SHELL", "timeout 3 sh -c 'cat < /dev/null > /dev/tcp/localhost/1883' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - sahool-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Kong (API Gateway)
  # ─────────────────────────────────────────────────────────────────────────────
  kong:
    image: kong:3.9
    container_name: sahool-kong
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: "127.0.0.1:8001"
      KONG_LOG_LEVEL: notice
    ports:
      - "${API_GATEWAY_PORT:-8000}:8000"
      - "127.0.0.1:8001:8001"
    volumes:
      - ../infrastructure/gateway/kong-legacy:/kong/declarative:ro
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - sahool-network

# ─────────────────────────────────────────────────────────────────────────────
# Networks
# ─────────────────────────────────────────────────────────────────────────────
networks:
  sahool-network:
    name: sahool-network
    driver: bridge

# ─────────────────────────────────────────────────────────────────────────────
# Volumes
# ─────────────────────────────────────────────────────────────────────────────
volumes:
  postgres_data:
    name: sahool-postgres-data
  redis_data:
    name: sahool-redis-data
  nats_data:
    name: sahool-nats-data
  mqtt_data:
    name: sahool-mqtt-data
  mqtt_logs:
    name: sahool-mqtt-logs
