# ═══════════════════════════════════════════════════════════════════════════════
# Docker Compose - Secrets Management Configuration
# Docker Swarm / Docker Compose secrets for production deployments
# ═══════════════════════════════════════════════════════════════════════════════

version: '3.8'

# ─────────────────────────────────────────────────────────────────────────────
# Secrets Definition
# ─────────────────────────────────────────────────────────────────────────────
secrets:
  # Database secrets
  postgres_password:
    file: ./secrets/postgres_password.txt
    # Or use external secret:
    # external: true

  postgres_replication_password:
    file: ./secrets/postgres_replication_password.txt

  # Redis secrets
  redis_password:
    file: ./secrets/redis_password.txt

  # NATS secrets
  nats_user:
    file: ./secrets/nats_user.txt

  nats_password:
    file: ./secrets/nats_password.txt

  # JWT secrets
  jwt_secret_key:
    file: ./secrets/jwt_secret_key.txt

  jwt_private_key:
    file: ./secrets/jwt_private.pem

  jwt_public_key:
    file: ./secrets/jwt_public.pem

  # Encryption keys
  encryption_key:
    file: ./secrets/encryption_key.txt

  # MinIO secrets
  minio_root_user:
    file: ./secrets/minio_root_user.txt

  minio_root_password:
    file: ./secrets/minio_root_password.txt

  # TLS certificates
  postgres_tls_cert:
    file: ./certs/postgres/server.crt

  postgres_tls_key:
    file: ./certs/postgres/server.key

  redis_tls_cert:
    file: ./certs/redis/server.crt

  redis_tls_key:
    file: ./certs/redis/server.key

  nats_tls_cert:
    file: ./certs/nats/server.crt

  nats_tls_key:
    file: ./certs/nats/server.key

  ca_cert:
    file: ./certs/ca.crt

# ─────────────────────────────────────────────────────────────────────────────
# Services Configuration with Secrets
# ─────────────────────────────────────────────────────────────────────────────
services:
  # PostgreSQL with secrets
  postgres:
    image: postgres:16-alpine
    secrets:
      - postgres_password
      - postgres_tls_cert
      - postgres_tls_key
      - ca_cert
    environment:
      # Use secrets via file paths
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_SSL_CERT_FILE: /run/secrets/postgres_tls_cert
      POSTGRES_SSL_KEY_FILE: /run/secrets/postgres_tls_key
      POSTGRES_SSL_CA_FILE: /run/secrets/ca_cert

  # Redis with secrets
  redis:
    image: redis:7.4-alpine
    secrets:
      - redis_password
      - redis_tls_cert
      - redis_tls_key
      - ca_cert
    command: >
      redis-server
      --requirepass $$(cat /run/secrets/redis_password)
      --tls-port 6380
      --tls-cert-file /run/secrets/redis_tls_cert
      --tls-key-file /run/secrets/redis_tls_key
      --tls-ca-cert-file /run/secrets/ca_cert

  # NATS with secrets
  nats:
    image: nats:2.10.24-alpine
    secrets:
      - nats_user
      - nats_password
      - nats_tls_cert
      - nats_tls_key
      - ca_cert
    environment:
      NATS_USER_FILE: /run/secrets/nats_user
      NATS_PASSWORD_FILE: /run/secrets/nats_password
      NATS_TLS_CERT_FILE: /run/secrets/nats_tls_cert
      NATS_TLS_KEY_FILE: /run/secrets/nats_tls_key
      NATS_TLS_CA_FILE: /run/secrets/ca_cert

  # Application services with secrets
  field-ops:
    image: sahool/field-ops:latest
    secrets:
      - postgres_password
      - redis_password
      - nats_password
      - jwt_secret_key
      - encryption_key
      - ca_cert
    environment:
      # Secrets loaded from files
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      NATS_PASSWORD_FILE: /run/secrets/nats_password
      JWT_SECRET_KEY_FILE: /run/secrets/jwt_secret_key
      ENCRYPTION_KEY_FILE: /run/secrets/encryption_key
      CA_CERT_FILE: /run/secrets/ca_cert

      # Or use Vault
      SECRET_BACKEND: vault
      VAULT_ADDR: https://vault:8200
      VAULT_ROLE_ID: ${VAULT_ROLE_ID}
      VAULT_SECRET_ID: ${VAULT_SECRET_ID}

  # MinIO with secrets
  minio:
    image: minio/minio:latest
    secrets:
      - minio_root_user
      - minio_root_password
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/minio_root_user
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/minio_root_password
    command: server /data --console-address ":9001"

  # Vault (for secrets management)
  vault:
    image: hashicorp/vault:1.17
    cap_add:
      - IPC_LOCK
    volumes:
      - vault-data:/vault/data
      - vault-logs:/vault/logs
      - ./infrastructure/core/vault/vault-production.hcl:/vault/config/vault.hcl
    secrets:
      - source: postgres_tls_cert
        target: /vault/certs/vault.crt
      - source: postgres_tls_key
        target: /vault/certs/vault.key
    command: server

volumes:
  vault-data:
  vault-logs:

# ─────────────────────────────────────────────────────────────────────────────
# Notes
# ─────────────────────────────────────────────────────────────────────────────
#
# Creating secrets:
#
# 1. Create secret files:
#    mkdir -p secrets
#    openssl rand -base64 32 > secrets/postgres_password.txt
#    openssl rand -base64 32 > secrets/redis_password.txt
#    chmod 600 secrets/*
#
# 2. For Docker Swarm, create secrets:
#    docker secret create postgres_password secrets/postgres_password.txt
#    docker secret create redis_password secrets/redis_password.txt
#
# 3. For Kubernetes, use External Secrets Operator:
#    See: /gitops/secrets/external-secrets-operator.yaml
#
# 4. For Vault integration:
#    - Set VAULT_ADDR, VAULT_ROLE_ID, VAULT_SECRET_ID
#    - Secrets will be loaded from Vault automatically
#
# Security best practices:
# - Never commit secrets/ directory to Git
# - Use .gitignore to exclude secrets/
# - Rotate secrets regularly (see automated-rotation-scheduler.sh)
# - Use Vault or cloud secrets managers for production
# - Enable audit logging for secret access
# ═══════════════════════════════════════════════════════════════════════════════
