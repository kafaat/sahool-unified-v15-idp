# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Services Registry - سجل الخدمات المعتمدة
# Single Source of Truth for all microservices
# ═══════════════════════════════════════════════════════════════════════════════

version: "3.0.0"
last_updated: "2025-12-19"

# ─────────────────────────────────────────────────────────────────────────────
# Event Architecture Layers
# ─────────────────────────────────────────────────────────────────────────────

event_architecture:
  layers:
    acquisition:
      description: "Data ingestion layer - طبقة جمع البيانات"
      services: [satellite-service, iot-service, weather-advanced, virtual-sensors]
      rules:
        - "No business logic"
        - "Only ingestion + normalization"
        - "Produces raw/normalized events"

    intelligence:
      description: "Feature extraction & AI layer - طبقة الذكاء"
      services: [indicators-service, lai-estimation, crop-health-ai, disaster-assessment]
      rules:
        - "Consumes from Acquisition"
        - "Produces computed features/assessments"
        - "No direct user interaction"

    decision:
      description: "Advisory & planning layer - طبقة القرار"
      services: [crop-growth-model, fertilizer-advisor, irrigation-smart, yield-engine, yield-prediction]
      rules:
        - "Consumes from Intelligence"
        - "Produces recommendations/plans"
        - "Domain logic here"

    business:
      description: "Business operations layer - طبقة الأعمال"
      services: [notification-service, marketplace-service, billing-core, community-chat, research-core]
      rules:
        - "Consumes from Decision"
        - "User-facing operations"
        - "No raw data processing"

  events_registry: "packages/shared/events/index.json"
  transport: "nats"
  subject_pattern: "sahool.{tenant_id}.{event_type}"

# ─────────────────────────────────────────────────────────────────────────────
# Source of Truth
# ─────────────────────────────────────────────────────────────────────────────

source_of_truth:
  services_root: "apps/services"
  web_root: "apps/web"
  admin_root: "apps/admin"
  mobile_root: "apps/mobile"
  packages_root: "packages"
  shared_root: "shared"

# ─────────────────────────────────────────────────────────────────────────────
# Service Categories
# ─────────────────────────────────────────────────────────────────────────────

categories:
  core:
    description: "Core platform services"
    description_ar: "خدمات المنصة الأساسية"

  crop:
    description: "Crop management and modeling"
    description_ar: "إدارة ونمذجة المحاصيل"

  analytics:
    description: "Data analytics and predictions"
    description_ar: "تحليل البيانات والتنبؤات"

  integration:
    description: "External integrations and IoT"
    description_ar: "التكاملات الخارجية وإنترنت الأشياء"

  community:
    description: "Community and marketplace"
    description_ar: "المجتمع والسوق"

# ─────────────────────────────────────────────────────────────────────────────
# Approved Services (v15.3 → v16)
# ─────────────────────────────────────────────────────────────────────────────

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # CROP GROWTH MODEL - نموذج نمو المحاصيل
  # ═══════════════════════════════════════════════════════════════════════════
  crop-growth-model:
    name: "Crop Growth Model"
    name_ar: "نموذج نمو المحاصيل"
    category: crop
    layer: decision
    path: "apps/services/crop-growth-model"
    port: 3000
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - GrowthStageEstimated.v1
        - BiomassEstimated.v1
      consumes:
        - FieldIndicatorsComputed.v1
        - WeatherForecastReady.v1
        - LAIEstimated.v1

    modules:
      - id: phenology
        name: "Phenology Tracking"
        name_ar: "تتبع الفينولوجيا"
        endpoint: "/phenology"

      - id: photosynthesis
        name: "Photosynthesis Model"
        name_ar: "نموذج التمثيل الضوئي"
        endpoint: "/photosynthesis"

      - id: biomass
        name: "Biomass Accumulation"
        name_ar: "تراكم الكتلة الحيوية"
        endpoint: "/biomass"

      - id: simulation
        name: "Growth Simulation"
        name_ar: "محاكاة النمو"
        endpoint: "/simulation"

      - id: root-growth
        name: "Root Growth Model"
        name_ar: "نموذج نمو الجذور"
        endpoint: "/root-growth"

      - id: water-balance
        name: "Water Balance (FAO-56)"
        name_ar: "توازن المياه"
        endpoint: "/water-balance"

      - id: satellite-data
        name: "Satellite Data Selector"
        name_ar: "محدد بيانات الأقمار"
        endpoint: "/satellite-data"

      - id: irrigation-decision
        name: "Irrigation Decision Support"
        name_ar: "دعم قرارات الري"
        endpoint: "/irrigation-decision"

      - id: multi-agent-advisor
        name: "Multi-Agent Advisory"
        name_ar: "المستشار متعدد الوكلاء"
        endpoint: "/advisor"

      - id: voice-guidance
        name: "Voice Guidance (Arabic)"
        name_ar: "الإرشاد الصوتي"
        endpoint: "/voice-guidance"

      - id: web-data-collector
        name: "Web Data Collector"
        name_ar: "جامع بيانات الويب"
        endpoint: "/web-data"

      - id: digital-twin-core
        name: "Digital Twin Core"
        name_ar: "التوأم الرقمي"
        endpoint: "/digital-twin"

      - id: rs-world-model
        name: "RS World Model"
        name_ar: "نموذج العالم للاستشعار"
        endpoint: "/rs-world-model"

      - id: planting-strategy
        name: "Planting Strategy Optimizer"
        name_ar: "محسّن استراتيجية الزراعة"
        endpoint: "/planting-strategy"

      - id: gis-integration
        name: "GIS Integration"
        name_ar: "تكامل نظم المعلومات الجغرافية"
        endpoint: "/gis"

    dependencies: []
    environment:
      - NODE_ENV
      - PORT
    resources:
      cpu: "500m"
      memory: "512Mi"
      replicas: 2

  # ═══════════════════════════════════════════════════════════════════════════
  # DISASTER ASSESSMENT - تقييم الكوارث
  # ═══════════════════════════════════════════════════════════════════════════
  disaster-assessment:
    name: "Disaster Assessment"
    name_ar: "تقييم الكوارث"
    category: analytics
    layer: intelligence
    path: "apps/services/disaster-assessment"
    port: 3001
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - DisasterRiskScored.v1
        - DisasterEventDetected.v1
      consumes:
        - WeatherAlertIssued.v1
        - SatelliteSceneIngested.v1
        - SensorReadingIngested.v1
    database:
      type: postgresql
      name: sahool_disaster
    dependencies:
      - weather-advanced
      - satellite-service
    resources:
      cpu: "300m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # LAI ESTIMATION - تقدير مؤشر مساحة الأوراق
  # ═══════════════════════════════════════════════════════════════════════════
  lai-estimation:
    name: "LAI Estimation"
    name_ar: "تقدير LAI"
    category: analytics
    layer: intelligence
    path: "apps/services/lai-estimation"
    port: 3002
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - LAIEstimated.v1
      consumes:
        - IndexTileReady.v1
        - FieldIndicatorsComputed.v1
    dependencies:
      - satellite-service
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # YIELD PREDICTION - تنبؤ الغلة
  # ═══════════════════════════════════════════════════════════════════════════
  yield-prediction:
    name: "Yield Prediction"
    name_ar: "تنبؤ الغلة"
    category: analytics
    layer: decision
    path: "apps/services/yield-prediction"
    port: 3003
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - YieldPredicted.v1
        - YieldConfidenceUpdated.v1
      consumes:
        - YieldEstimated.v1
        - WeatherForecastReady.v1
        - FieldIndicatorsComputed.v1
    dependencies:
      - crop-growth-model
      - weather-advanced
      - lai-estimation
    resources:
      cpu: "500m"
      memory: "512Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # MARKETPLACE SERVICE - خدمة السوق
  # ═══════════════════════════════════════════════════════════════════════════
  marketplace-service:
    name: "Marketplace Service"
    name_ar: "خدمة السوق"
    category: community
    layer: business
    path: "apps/services/marketplace-service"
    port: 3004
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - OrderCreated.v1
        - OrderPaid.v1
      consumes:
        - FertilizerPlanProposed.v1
        - YieldPredicted.v1
    database:
      type: postgresql
      name: sahool_marketplace
    dependencies: []
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 2

  # ═══════════════════════════════════════════════════════════════════════════
  # COMMUNITY CHAT - دردشة المجتمع
  # ═══════════════════════════════════════════════════════════════════════════
  community-chat:
    name: "Community Chat"
    name_ar: "دردشة المجتمع"
    category: community
    layer: business
    path: "apps/services/community-chat"
    port: 3005
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - CommunityPostCreated.v1
      consumes:
        - DisasterEventDetected.v1
        - CropHealthAssessed.v1
    database:
      type: postgresql
      name: sahool_chat
    dependencies: []
    resources:
      cpu: "300m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # IOT SERVICE - خدمة إنترنت الأشياء
  # ═══════════════════════════════════════════════════════════════════════════
  iot-service:
    name: "IoT Gateway"
    name_ar: "بوابة إنترنت الأشياء"
    category: integration
    layer: acquisition
    path: "apps/services/iot-service"
    port: 3006
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - SensorReadingIngested.v1
        - DeviceStatusChanged.v1
        - SensorAlert.v1
      consumes:
        - IrrigationPlanProposed.v1
    database:
      type: timescaledb
      name: sahool_iot
    message_broker:
      type: mqtt
      topics:
        - "sahool/sensors/#"
        - "sahool/devices/#"
    dependencies: []
    resources:
      cpu: "400m"
      memory: "512Mi"
      replicas: 2

  # ═══════════════════════════════════════════════════════════════════════════
  # RESEARCH CORE - نواة البحث العلمي
  # ═══════════════════════════════════════════════════════════════════════════
  research-core:
    name: "Research Core"
    name_ar: "نواة البحث العلمي"
    category: core
    layer: business
    path: "apps/services/research-core"
    port: 3015
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - TrialCreated.v1
        - ObservationLogged.v1
      consumes:
        - FieldIndicatorsComputed.v1
        - CropHealthAssessed.v1
        - YieldPredicted.v1
    database:
      type: postgresql
      name: sahool_research
    dependencies: []
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # BILLING CORE - خدمة الفوترة
  # ═══════════════════════════════════════════════════════════════════════════
  billing-core:
    name: "Billing Core"
    name_ar: "خدمة الفوترة"
    category: core
    layer: business
    path: "apps/services/billing-core"
    port: 8021
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - InvoiceIssued.v1
        - PaymentFailed.v1
      consumes:
        - OrderPaid.v1
        - SubscriptionChanged.v1
    database:
      type: postgresql
      name: sahool_billing
    dependencies: []
    resources:
      cpu: "300m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # SATELLITE SERVICE - خدمة الأقمار الصناعية
  # ═══════════════════════════════════════════════════════════════════════════
  satellite-service:
    name: "Satellite Service"
    name_ar: "خدمة الأقمار الصناعية"
    category: analytics
    layer: acquisition
    path: "apps/services/satellite-service"
    port: 8090
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - SatelliteSceneIngested.v1
        - RasterTileReady.v1
        - IndexTileReady.v1
      consumes: []
    database:
      type: postgresql
      name: sahool_satellite
    dependencies: []
    resources:
      cpu: "600m"
      memory: "768Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # WEATHER ADVANCED - خدمة الطقس المتقدمة
  # ═══════════════════════════════════════════════════════════════════════════
  weather-advanced:
    name: "Weather Advanced"
    name_ar: "خدمة الطقس المتقدمة"
    category: integration
    layer: acquisition
    path: "apps/services/weather-advanced"
    port: 8092
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - WeatherObserved.v1
        - WeatherForecastReady.v1
        - WeatherAlertIssued.v1
      consumes: []
    database:
      type: postgresql
      name: sahool_weather
    external_apis:
      - openweathermap
      - weatherapi
    dependencies: []
    resources:
      cpu: "300m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # INDICATORS SERVICE - خدمة المؤشرات
  # ═══════════════════════════════════════════════════════════════════════════
  indicators-service:
    name: "Indicators Service"
    name_ar: "خدمة المؤشرات"
    category: analytics
    layer: intelligence
    path: "apps/services/indicators-service"
    port: 8091
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - FieldIndicatorsComputed.v1
      consumes:
        - IndexTileReady.v1
        - VirtualSensorEstimated.v1
        - WeatherObserved.v1
    database:
      type: postgresql
      name: sahool_indicators
    dependencies:
      - satellite-service
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # CROP HEALTH AI - سهول فيجن
  # ═══════════════════════════════════════════════════════════════════════════
  crop-health-ai:
    name: "Crop Health AI"
    name_ar: "سهول فيجن - كشف الأمراض"
    category: analytics
    layer: intelligence
    path: "apps/services/crop-health-ai"
    port: 8095
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - CropHealthAssessed.v1
        - CropStressDetected.v1
      consumes:
        - FieldIndicatorsComputed.v1
        - LAIEstimated.v1
        - WeatherObserved.v1
    dependencies:
      - satellite-service
    resources:
      cpu: "800m"
      memory: "1Gi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # VIRTUAL SENSORS - المستشعرات الافتراضية
  # ═══════════════════════════════════════════════════════════════════════════
  virtual-sensors:
    name: "Virtual Sensors"
    name_ar: "المستشعرات الافتراضية"
    category: analytics
    layer: acquisition
    path: "apps/services/virtual-sensors"
    port: 8096
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - VirtualSensorEstimated.v1
      consumes:
        - SensorReadingIngested.v1
        - WeatherObserved.v1
        - IndexTileReady.v1
    dependencies:
      - weather-advanced
      - satellite-service
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # YIELD ENGINE - محرك التنبؤ بالإنتاجية
  # ═══════════════════════════════════════════════════════════════════════════
  yield-engine:
    name: "Yield Engine"
    name_ar: "محرك التنبؤ بالإنتاجية"
    category: analytics
    layer: decision
    path: "apps/services/yield-engine"
    port: 8098
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - YieldEstimated.v1
      consumes:
        - GrowthStageEstimated.v1
        - BiomassEstimated.v1
        - FieldIndicatorsComputed.v1
    dependencies:
      - crop-growth-model
      - weather-advanced
    resources:
      cpu: "500m"
      memory: "512Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # FERTILIZER ADVISOR - مستشار التسميد
  # ═══════════════════════════════════════════════════════════════════════════
  fertilizer-advisor:
    name: "Fertilizer Advisor"
    name_ar: "مستشار التسميد"
    category: core
    layer: decision
    path: "apps/services/fertilizer-advisor"
    port: 8093
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - FertilizerPlanProposed.v1
      consumes:
        - GrowthStageEstimated.v1
        - FieldIndicatorsComputed.v1
        - CropHealthAssessed.v1
    database:
      type: postgresql
      name: sahool_fertilizer
    dependencies:
      - crop-growth-model
      - satellite-service
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # IRRIGATION SMART - الري الذكي
  # ═══════════════════════════════════════════════════════════════════════════
  irrigation-smart:
    name: "Irrigation Smart"
    name_ar: "الري الذكي"
    category: core
    layer: decision
    path: "apps/services/irrigation-smart"
    port: 8094
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - IrrigationPlanProposed.v1
        - IrrigationAlertIssued.v1
      consumes:
        - WeatherForecastReady.v1
        - VirtualSensorEstimated.v1
        - CropStressDetected.v1
    database:
      type: postgresql
      name: sahool_irrigation
    dependencies:
      - weather-advanced
      - virtual-sensors
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # NOTIFICATION SERVICE - خدمة الإشعارات
  # ═══════════════════════════════════════════════════════════════════════════
  notification-service:
    name: "Notification Service"
    name_ar: "خدمة الإشعارات"
    category: core
    layer: business
    path: "apps/services/notification-service"
    port: 8110
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - NotificationQueued.v1
        - NotificationSent.v1
      consumes:
        - CropStressDetected.v1
        - DisasterRiskScored.v1
        - IrrigationAlertIssued.v1
        - FertilizerPlanProposed.v1
        - YieldPredicted.v1
        - GrowthStageEstimated.v1
    database:
      type: postgresql
      name: sahool_notifications
    dependencies: []
    resources:
      cpu: "200m"
      memory: "256Mi"
      replicas: 1

# ─────────────────────────────────────────────────────────────────────────────
# Applications (Frontend)
# ─────────────────────────────────────────────────────────────────────────────

applications:
  web:
    name: "SAHOOL Dashboard"
    name_ar: "لوحة تحكم سهول"
    path: "apps/web"
    port: 3000
    status: active

  admin:
    name: "Admin Panel"
    name_ar: "لوحة الإدارة"
    path: "apps/admin"
    port: 3001
    status: active

  mobile:
    name: "SAHOOL Field App"
    name_ar: "تطبيق سهول الميداني"
    path: "apps/mobile"
    status: active

# ─────────────────────────────────────────────────────────────────────────────
# API Gateway Configuration
# ─────────────────────────────────────────────────────────────────────────────

gateway:
  type: kong
  config_path: "infra/kong/kong.yml"
  global_rate_limit:
    minute: 60
    hour: 2000
  authentication:
    type: jwt
    algorithm: RS256

# ─────────────────────────────────────────────────────────────────────────────
# Infrastructure Dependencies
# ─────────────────────────────────────────────────────────────────────────────

infrastructure:
  databases:
    postgresql:
      version: "15"
      host: "${POSTGRES_HOST:-localhost}"
      port: 5432
    timescaledb:
      version: "2.11"
      host: "${TIMESCALE_HOST:-localhost}"
      port: 5432
    redis:
      version: "7"
      host: "${REDIS_HOST:-localhost}"
      port: 6379

  message_brokers:
    mqtt:
      host: "${MQTT_HOST:-localhost}"
      port: 1883
    rabbitmq:
      host: "${RABBITMQ_HOST:-localhost}"
      port: 5672

  observability:
    prometheus:
      port: 9090
    grafana:
      port: 3000
    loki:
      port: 3100

# ─────────────────────────────────────────────────────────────────────────────
# Deployment Environments
# ─────────────────────────────────────────────────────────────────────────────

environments:
  development:
    replicas: 1
    resources_multiplier: 0.5
    debug: true

  staging:
    replicas: 1
    resources_multiplier: 0.75
    debug: false

  production:
    replicas: 2
    resources_multiplier: 1.0
    debug: false
    autoscaling:
      enabled: true
      min_replicas: 2
      max_replicas: 10
      target_cpu: 70

# ─────────────────────────────────────────────────────────────────────────────
# Governance Rules
# ─────────────────────────────────────────────────────────────────────────────

governance:
  rules:
    - id: GOV-001
      rule: "New services MUST be in apps/services/"
      enforce: true

    - id: GOV-002
      rule: "No services in kernel/, kernel-services-v15.3/, or root"
      enforce: true

    - id: GOV-003
      rule: "All services MUST have /health endpoint"
      enforce: true

    - id: GOV-004
      rule: "All services MUST have Dockerfile"
      enforce: true

    - id: GOV-005
      rule: "Frontend apps MUST be in apps/{web,admin,mobile}"
      enforce: true
