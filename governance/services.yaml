# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Services Registry - سجل الخدمات المعتمدة
# Single Source of Truth for all microservices
# ═══════════════════════════════════════════════════════════════════════════════

version: "3.0.0"
last_updated: "2026-01-14"

# ─────────────────────────────────────────────────────────────────────────────
# Event Architecture Layers
# ─────────────────────────────────────────────────────────────────────────────

event_architecture:
  layers:
    acquisition:
      description: "Data ingestion layer - طبقة جمع البيانات"
      services: [satellite-service, iot-service, weather-advanced, virtual-sensors, weather-service]
      rules:
        - "No business logic"
        - "Only ingestion + normalization"
        - "Produces raw/normalized events"

    intelligence:
      description: "Feature extraction & AI layer - طبقة الذكاء"
      services: [indicators-service, lai-estimation, crop-health-ai, disaster-assessment, agro-rules, crop-intelligence-service, ndvi-processor, field-intelligence, vegetation-analysis-service, skills-service]
      rules:
        - "Consumes from Acquisition"
        - "Produces computed features/assessments"
        - "No direct user interaction"

    decision:
      description: "Advisory & planning layer - طبقة القرار"
      services: [crop-growth-model, fertilizer-advisor, irrigation-smart, yield-engine, yield-prediction, advisory-service]
      rules:
        - "Consumes from Intelligence"
        - "Produces recommendations/plans"
        - "Domain logic here"

    business:
      description: "Business operations layer - طبقة الأعمال"
      services: [notification-service, marketplace-service, billing-core, community-chat, research-core, mcp-server, task-service, equipment-service, ws-gateway]
      rules:
        - "Consumes from Decision"
        - "User-facing operations"
        - "No raw data processing"

  events_registry: "packages/shared/events/index.json"
  transport: "nats"
  subject_pattern: "sahool.{tenant_id}.{event_type}"

# ─────────────────────────────────────────────────────────────────────────────
# Source of Truth
# ─────────────────────────────────────────────────────────────────────────────

source_of_truth:
  services_root: "apps/services"
  web_root: "apps/web"
  admin_root: "apps/admin"
  mobile_root: "apps/mobile"
  packages_root: "packages"
  shared_root: "shared"

# ─────────────────────────────────────────────────────────────────────────────
# Service Categories
# ─────────────────────────────────────────────────────────────────────────────

categories:
  core:
    description: "Core platform services"
    description_ar: "خدمات المنصة الأساسية"

  crop:
    description: "Crop management and modeling"
    description_ar: "إدارة ونمذجة المحاصيل"

  analytics:
    description: "Data analytics and predictions"
    description_ar: "تحليل البيانات والتنبؤات"

  integration:
    description: "External integrations and IoT"
    description_ar: "التكاملات الخارجية وإنترنت الأشياء"

  community:
    description: "Community and marketplace"
    description_ar: "المجتمع والسوق"

# ─────────────────────────────────────────────────────────────────────────────
# Approved Services (v15.3 → v16)
# ─────────────────────────────────────────────────────────────────────────────

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # CROP GROWTH MODEL - نموذج نمو المحاصيل
  # ═══════════════════════════════════════════════════════════════════════════
  crop-growth-model:
    name: "Crop Growth Model"
    name_ar: "نموذج نمو المحاصيل"
    type: nestjs
    category: crop
    layer: decision
    path: "apps/services/crop-growth-model"
    port: 3023
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - GrowthStageEstimated.v1
        - BiomassEstimated.v1
      consumes:
        - FieldIndicatorsComputed.v1
        - WeatherForecastReady.v1
        - LAIEstimated.v1

    modules:
      - id: phenology
        name: "Phenology Tracking"
        name_ar: "تتبع الفينولوجيا"
        endpoint: "/phenology"

      - id: photosynthesis
        name: "Photosynthesis Model"
        name_ar: "نموذج التمثيل الضوئي"
        endpoint: "/photosynthesis"

      - id: biomass
        name: "Biomass Accumulation"
        name_ar: "تراكم الكتلة الحيوية"
        endpoint: "/biomass"

      - id: simulation
        name: "Growth Simulation"
        name_ar: "محاكاة النمو"
        endpoint: "/simulation"

      - id: root-growth
        name: "Root Growth Model"
        name_ar: "نموذج نمو الجذور"
        endpoint: "/root-growth"

      - id: water-balance
        name: "Water Balance (FAO-56)"
        name_ar: "توازن المياه"
        endpoint: "/water-balance"

      - id: satellite-data
        name: "Satellite Data Selector"
        name_ar: "محدد بيانات الأقمار"
        endpoint: "/satellite-data"

      - id: irrigation-decision
        name: "Irrigation Decision Support"
        name_ar: "دعم قرارات الري"
        endpoint: "/irrigation-decision"

      - id: multi-agent-advisor
        name: "Multi-Agent Advisory"
        name_ar: "المستشار متعدد الوكلاء"
        endpoint: "/advisor"

      - id: voice-guidance
        name: "Voice Guidance (Arabic)"
        name_ar: "الإرشاد الصوتي"
        endpoint: "/voice-guidance"

      - id: web-data-collector
        name: "Web Data Collector"
        name_ar: "جامع بيانات الويب"
        endpoint: "/web-data"

      - id: digital-twin-core
        name: "Digital Twin Core"
        name_ar: "التوأم الرقمي"
        endpoint: "/digital-twin"

      - id: rs-world-model
        name: "RS World Model"
        name_ar: "نموذج العالم للاستشعار"
        endpoint: "/rs-world-model"

      - id: planting-strategy
        name: "Planting Strategy Optimizer"
        name_ar: "محسّن استراتيجية الزراعة"
        endpoint: "/planting-strategy"

      - id: gis-integration
        name: "GIS Integration"
        name_ar: "تكامل نظم المعلومات الجغرافية"
        endpoint: "/gis"

    dependencies: []
    environment:
      - NODE_ENV
      - PORT
    resources:
      cpu: "500m"
      memory: "512Mi"
      replicas: 2

  # ═══════════════════════════════════════════════════════════════════════════
  # DISASTER ASSESSMENT - تقييم الكوارث
  # ═══════════════════════════════════════════════════════════════════════════
  disaster-assessment:
    name: "Disaster Assessment"
    name_ar: "تقييم الكوارث"
    type: nestjs
    category: analytics
    layer: intelligence
    path: "apps/services/disaster-assessment"
    port: 3020
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - DisasterRiskScored.v1
        - DisasterEventDetected.v1
      consumes:
        - WeatherAlertIssued.v1
        - SatelliteSceneIngested.v1
        - SensorReadingIngested.v1
    database:
      type: postgresql
      name: sahool_disaster
    dependencies:
      - weather-advanced
      - satellite-service
    resources:
      cpu: "300m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # LAI ESTIMATION - تقدير مؤشر مساحة الأوراق
  # ═══════════════════════════════════════════════════════════════════════════
  lai-estimation:
    name: "LAI Estimation"
    name_ar: "تقدير LAI"
    type: nestjs
    category: analytics
    layer: intelligence
    path: "apps/services/lai-estimation"
    port: 3022
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - LAIEstimated.v1
      consumes:
        - IndexTileReady.v1
        - FieldIndicatorsComputed.v1
    dependencies:
      - satellite-service
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # YIELD PREDICTION - تنبؤ الغلة
  # ═══════════════════════════════════════════════════════════════════════════
  yield-prediction:
    name: "Yield Prediction"
    name_ar: "تنبؤ الغلة"
    type: nestjs
    category: analytics
    layer: decision
    path: "apps/services/yield-prediction"
    port: 3021
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - YieldPredicted.v1
        - YieldConfidenceUpdated.v1
      consumes:
        - YieldEstimated.v1
        - WeatherForecastReady.v1
        - FieldIndicatorsComputed.v1
    dependencies:
      - crop-growth-model
      - weather-advanced
      - lai-estimation
    resources:
      cpu: "500m"
      memory: "512Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # MARKETPLACE SERVICE - خدمة السوق
  # ═══════════════════════════════════════════════════════════════════════════
  marketplace-service:
    name: "Marketplace Service"
    name_ar: "خدمة السوق"
    type: nestjs
    category: community
    layer: business
    path: "apps/services/marketplace-service"
    port: 3010
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - OrderCreated.v1
        - OrderPaid.v1
      consumes:
        - FertilizerPlanProposed.v1
        - YieldPredicted.v1
    database:
      type: postgresql
      name: sahool_marketplace
    dependencies: []
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 2

  # ═══════════════════════════════════════════════════════════════════════════
  # COMMUNITY CHAT - دردشة المجتمع
  # ═══════════════════════════════════════════════════════════════════════════
  community-chat:
    name: "Community Chat"
    name_ar: "دردشة المجتمع"
    type: nestjs
    category: community
    layer: business
    path: "apps/services/community-chat"
    port: 8097
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - CommunityPostCreated.v1
      consumes:
        - DisasterEventDetected.v1
        - CropHealthAssessed.v1
    database:
      type: postgresql
      name: sahool_chat
    dependencies: []
    resources:
      cpu: "300m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # IOT SERVICE - خدمة إنترنت الأشياء
  # ═══════════════════════════════════════════════════════════════════════════
  iot-service:
    name: "IoT Gateway"
    name_ar: "بوابة إنترنت الأشياء"
    type: nestjs
    category: integration
    layer: acquisition
    path: "apps/services/iot-service"
    port: 8117
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - SensorReadingIngested.v1
        - DeviceStatusChanged.v1
        - SensorAlert.v1
      consumes:
        - IrrigationPlanProposed.v1
    database:
      type: timescaledb
      name: sahool_iot
    message_broker:
      type: mqtt
      topics:
        - "sahool/sensors/#"
        - "sahool/devices/#"
    dependencies: []
    resources:
      cpu: "400m"
      memory: "512Mi"
      replicas: 2

  # ═══════════════════════════════════════════════════════════════════════════
  # RESEARCH CORE - نواة البحث العلمي
  # ═══════════════════════════════════════════════════════════════════════════
  research-core:
    name: "Research Core"
    name_ar: "نواة البحث العلمي"
    type: nestjs
    category: core
    layer: business
    path: "apps/services/research-core"
    port: 3015
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - TrialCreated.v1
        - ObservationLogged.v1
      consumes:
        - FieldIndicatorsComputed.v1
        - CropHealthAssessed.v1
        - YieldPredicted.v1
    database:
      type: postgresql
      name: sahool_research
    dependencies: []
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # BILLING CORE - خدمة الفوترة
  # ═══════════════════════════════════════════════════════════════════════════
  billing-core:
    name: "Billing Core"
    name_ar: "خدمة الفوترة"
    type: python
    category: core
    layer: business
    path: "apps/services/billing-core"
    port: 8089
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - InvoiceIssued.v1
        - PaymentFailed.v1
      consumes:
        - OrderPaid.v1
        - SubscriptionChanged.v1
    database:
      type: postgresql
      name: sahool_billing
    dependencies: []
    resources:
      cpu: "300m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # SATELLITE SERVICE - خدمة الأقمار الصناعية (DEPRECATED)
  # ═══════════════════════════════════════════════════════════════════════════
  satellite-service:
    name: "Satellite Service"
    name_ar: "خدمة الأقمار الصناعية"
    type: python
    category: analytics
    layer: acquisition
    path: "apps/services/satellite-service"
    port: 8090
    protocol: http
    health_endpoint: "/health"
    status: deprecated
    replaced_by: vegetation-analysis-service
    deprecation_date: "2026-01-11"
    version: "15.4.0"
    events:
      produces:
        - SatelliteSceneIngested.v1
        - RasterTileReady.v1
        - IndexTileReady.v1
        - FieldIndicatorsComputed.v1
      consumes: []
    database:
      type: postgresql
      name: sahool_satellite
    dependencies:
      - sahool-eo  # eo-learn integration package
    integrations:
      eo_learn:
        package: "packages/sahool-eo"
        credentials: "governance/credentials.yaml"
        env_vars:
          - SENTINEL_HUB_CLIENT_ID
          - SENTINEL_HUB_CLIENT_SECRET
    resources:
      cpu: "600m"
      memory: "768Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # WEATHER ADVANCED - خدمة الطقس المتقدمة (DEPRECATED)
  # ═══════════════════════════════════════════════════════════════════════════
  weather-advanced:
    name: "Weather Advanced"
    name_ar: "خدمة الطقس المتقدمة"
    type: python
    category: integration
    layer: acquisition
    path: "apps/services/weather-advanced"
    port: 8092
    protocol: http
    health_endpoint: "/health"
    status: deprecated
    replaced_by: weather-service
    deprecation_date: "2026-01-11"
    events:
      produces:
        - WeatherObserved.v1
        - WeatherForecastReady.v1
        - WeatherAlertIssued.v1
      consumes: []
    database:
      type: postgresql
      name: sahool_weather
    external_apis:
      - openweathermap
      - weatherapi
    dependencies: []
    resources:
      cpu: "300m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # INDICATORS SERVICE - خدمة المؤشرات
  # ═══════════════════════════════════════════════════════════════════════════
  indicators-service:
    name: "Indicators Service"
    name_ar: "خدمة المؤشرات"
    type: python
    category: analytics
    layer: intelligence
    path: "apps/services/indicators-service"
    port: 8091
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - FieldIndicatorsComputed.v1
      consumes:
        - IndexTileReady.v1
        - VirtualSensorEstimated.v1
        - WeatherObserved.v1
    database:
      type: postgresql
      name: sahool_indicators
    dependencies:
      - satellite-service
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # CROP HEALTH AI - سهول فيجن (DEPRECATED)
  # ═══════════════════════════════════════════════════════════════════════════
  crop-health-ai:
    name: "Crop Health AI"
    name_ar: "سهول فيجن - كشف الأمراض"
    type: python
    category: analytics
    layer: intelligence
    path: "apps/services/crop-health-ai"
    port: 8095
    protocol: http
    health_endpoint: "/health"
    status: deprecated
    replaced_by: crop-intelligence-service
    deprecation_date: "2026-01-11"
    events:
      produces:
        - CropHealthAssessed.v1
        - CropStressDetected.v1
      consumes:
        - FieldIndicatorsComputed.v1
        - LAIEstimated.v1
        - WeatherObserved.v1
    dependencies:
      - satellite-service
    resources:
      cpu: "800m"
      memory: "1Gi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # VIRTUAL SENSORS - المستشعرات الافتراضية
  # ═══════════════════════════════════════════════════════════════════════════
  virtual-sensors:
    name: "Virtual Sensors"
    name_ar: "المستشعرات الافتراضية"
    type: python
    category: analytics
    layer: acquisition
    path: "apps/services/virtual-sensors"
    port: 8119
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - VirtualSensorEstimated.v1
      consumes:
        - SensorReadingIngested.v1
        - WeatherObserved.v1
        - IndexTileReady.v1
    dependencies:
      - weather-advanced
      - satellite-service
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # YIELD ENGINE - محرك التنبؤ بالإنتاجية
  # ═══════════════════════════════════════════════════════════════════════════
  yield-engine:
    name: "Yield Engine"
    name_ar: "محرك التنبؤ بالإنتاجية"
    type: python
    category: analytics
    layer: decision
    path: "apps/services/yield-engine"
    port: 8098
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - YieldEstimated.v1
      consumes:
        - GrowthStageEstimated.v1
        - BiomassEstimated.v1
        - FieldIndicatorsComputed.v1
    dependencies:
      - crop-growth-model
      - weather-advanced
    resources:
      cpu: "500m"
      memory: "512Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # FERTILIZER ADVISOR - مستشار التسميد (DEPRECATED)
  # ═══════════════════════════════════════════════════════════════════════════
  fertilizer-advisor:
    name: "Fertilizer Advisor"
    name_ar: "مستشار التسميد"
    type: python
    category: core
    layer: decision
    path: "apps/services/fertilizer-advisor"
    port: 8093
    protocol: http
    health_endpoint: "/health"
    status: deprecated
    replaced_by: advisory-service
    deprecation_date: "2026-01-11"
    events:
      produces:
        - FertilizerPlanProposed.v1
      consumes:
        - GrowthStageEstimated.v1
        - FieldIndicatorsComputed.v1
        - CropHealthAssessed.v1
    database:
      type: postgresql
      name: sahool_fertilizer
    dependencies:
      - crop-growth-model
      - satellite-service
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # IRRIGATION SMART - الري الذكي
  # ═══════════════════════════════════════════════════════════════════════════
  irrigation-smart:
    name: "Irrigation Smart"
    name_ar: "الري الذكي"
    type: python
    category: core
    layer: decision
    path: "apps/services/irrigation-smart"
    port: 8094
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - IrrigationPlanProposed.v1
        - IrrigationAlertIssued.v1
      consumes:
        - WeatherForecastReady.v1
        - VirtualSensorEstimated.v1
        - CropStressDetected.v1
    database:
      type: postgresql
      name: sahool_irrigation
    dependencies:
      - weather-advanced
      - virtual-sensors
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # NOTIFICATION SERVICE - خدمة الإشعارات
  # ═══════════════════════════════════════════════════════════════════════════
  notification-service:
    name: "Notification Service"
    name_ar: "خدمة الإشعارات"
    type: python
    category: core
    layer: business
    path: "apps/services/notification-service"
    port: 8110
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - NotificationQueued.v1
        - NotificationSent.v1
      consumes:
        - CropStressDetected.v1
        - DisasterRiskScored.v1
        - IrrigationAlertIssued.v1
        - FertilizerPlanProposed.v1
        - YieldPredicted.v1
        - GrowthStageEstimated.v1
    database:
      type: postgresql
      name: sahool_notifications
    dependencies: []
    resources:
      cpu: "200m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # MCP SERVER - خادم بروتوكول سياق النموذج
  # ═══════════════════════════════════════════════════════════════════════════
  mcp-server:
    name: "MCP Server"
    name_ar: "خادم MCP"
    type: python
    category: integration
    layer: business
    path: "apps/services/mcp-server"
    port: 8200
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces: []
      consumes: []
    dependencies:
      - kong
    resources:
      cpu: "200m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # AGRO RULES - قواعد الزراعة
  # ═══════════════════════════════════════════════════════════════════════════
  agro-rules:
    name: "Agro Rules Worker"
    name_ar: "عامل القواعد الزراعية"
    type: python
    category: crop
    layer: intelligence
    path: "apps/services/agro-rules"
    port: 8151
    protocol: http
    health_endpoint: "/healthz"
    status: active
    events:
      produces:
        - AgroRuleEvaluated.v1
      consumes:
        - FieldIndicatorsComputed.v1
        - WeatherForecastReady.v1
    dependencies:
      - nats
    resources:
      cpu: "200m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # CROP INTELLIGENCE SERVICE - خدمة ذكاء المحاصيل
  # ═══════════════════════════════════════════════════════════════════════════
  crop-intelligence-service:
    name: "Crop Intelligence Service"
    name_ar: "خدمة ذكاء المحاصيل"
    type: python
    category: crop
    layer: intelligence
    path: "apps/services/crop-intelligence-service"
    port: 8095
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - CropHealthAssessed.v1
        - DiseaseDetected.v1
      consumes:
        - IndexTileReady.v1
        - SatelliteSceneIngested.v1
    dependencies:
      - satellite-service
    resources:
      cpu: "500m"
      memory: "512Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # EQUIPMENT SERVICE - خدمة المعدات
  # ═══════════════════════════════════════════════════════════════════════════
  equipment-service:
    name: "Equipment Service"
    name_ar: "خدمة المعدات"
    type: python
    category: core
    layer: business
    path: "apps/services/equipment-service"
    port: 8101
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - EquipmentStatusUpdated.v1
      consumes: []
    database:
      type: postgresql
      name: sahool_equipment
    dependencies: []
    resources:
      cpu: "200m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # TASK SERVICE - خدمة المهام
  # ═══════════════════════════════════════════════════════════════════════════
  task-service:
    name: "Task Service"
    name_ar: "خدمة المهام"
    type: python
    category: core
    layer: business
    path: "apps/services/task-service"
    port: 8103
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - TaskCreated.v1
        - TaskCompleted.v1
      consumes:
        - IrrigationAlertIssued.v1
        - FertilizerPlanProposed.v1
    database:
      type: postgresql
      name: sahool_tasks
    dependencies: []
    resources:
      cpu: "200m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # WS GATEWAY - بوابة WebSocket
  # ═══════════════════════════════════════════════════════════════════════════
  ws-gateway:
    name: "WebSocket Gateway"
    name_ar: "بوابة WebSocket"
    type: python
    category: integration
    layer: business
    path: "apps/services/ws-gateway"
    port: 8081
    protocol: websocket
    health_endpoint: "/health"
    status: active
    events:
      produces: []
      consumes:
        - NotificationSent.v1
    dependencies:
      - nats
    resources:
      cpu: "300m"
      memory: "256Mi"
      replicas: 2

  # ═══════════════════════════════════════════════════════════════════════════
  # NDVI PROCESSOR - معالج NDVI
  # ═══════════════════════════════════════════════════════════════════════════
  ndvi-processor:
    name: "NDVI Processor"
    name_ar: "معالج NDVI"
    type: python
    category: analytics
    layer: intelligence
    path: "apps/services/ndvi-processor"
    port: 8118
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - NDVIProcessed.v1
      consumes:
        - SatelliteSceneIngested.v1
    dependencies:
      - satellite-service
    resources:
      cpu: "500m"
      memory: "512Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # FIELD INTELLIGENCE - ذكاء الحقول
  # ═══════════════════════════════════════════════════════════════════════════
  field-intelligence:
    name: "Field Intelligence"
    name_ar: "ذكاء الحقول"
    type: python
    category: analytics
    layer: intelligence
    path: "apps/services/field-intelligence"
    port: 8120
    protocol: http
    health_endpoint: "/health"
    status: active
    events:
      produces:
        - FieldAnalysisCompleted.v1
      consumes:
        - FieldIndicatorsComputed.v1
        - NDVIProcessed.v1
    dependencies:
      - indicators-service
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # VEGETATION ANALYSIS SERVICE - خدمة تحليل الغطاء النباتي
  # Replaces: satellite-service (deprecated)
  # ═══════════════════════════════════════════════════════════════════════════
  vegetation-analysis-service:
    name: "Vegetation Analysis Service"
    name_ar: "خدمة تحليل الغطاء النباتي"
    type: python
    category: analytics
    layer: intelligence
    path: "apps/services/vegetation-analysis-service"
    port: 8090
    protocol: http
    health_endpoint: "/health"
    status: active
    replaces: satellite-service
    events:
      produces:
        - VegetationIndexCalculated.v1
        - NDVITimeseriesReady.v1
        - FieldBoundaryDetected.v1
      consumes:
        - SatelliteSceneIngested.v1
        - WeatherDataReady.v1
    dependencies:
      - postgres
      - redis
      - nats
    resources:
      cpu: "500m"
      memory: "512Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # WEATHER SERVICE - خدمة الطقس
  # Replaces: weather-advanced (deprecated)
  # ═══════════════════════════════════════════════════════════════════════════
  weather-service:
    name: "Weather Service"
    name_ar: "خدمة الطقس"
    type: python
    category: integration
    layer: acquisition
    path: "apps/services/weather-service"
    port: 8092
    protocol: http
    health_endpoint: "/health"
    status: active
    replaces: weather-advanced
    events:
      produces:
        - WeatherForecastReady.v1
        - WeatherAlertIssued.v1
      consumes: []
    dependencies:
      - postgres
      - redis
      - nats
    resources:
      cpu: "300m"
      memory: "256Mi"
      replicas: 1

  # ═══════════════════════════════════════════════════════════════════════════
  # SKILLS SERVICE - خدمة المهارات
  # AI-powered farmer skills assessment and learning recommendations
  # ═══════════════════════════════════════════════════════════════════════════
  skills-service:
    name: "Skills Service"
    name_ar: "خدمة المهارات"
    description: "AI-powered farmer skills assessment and adaptive learning recommendations"
    description_ar: "تقييم مهارات المزارعين والتوصيات التعليمية المخصصة"
    type: python
    category: crop
    layer: intelligence
    path: "apps/services/skills-service"
    port: 8121
    protocol: http
    health_endpoint: "/health"
    readiness_endpoint: "/readyz"
    status: active
    version: "1.0.0"
    events:
      produces:
        - FarmerSkillsAssessed.v1
        - LearningPathRecommended.v1
        - SkillsProgressTracked.v1
      consumes:
        - FieldIndicatorsComputed.v1
        - TaskCompleted.v1
        - CropHealthAssessed.v1
        - YieldPredicted.v1
    database:
      type: postgresql
      name: sahool_skills
      schema: "skills"
    cache:
      type: redis
      purpose: "skill profile caching, learning recommendations cache"
      ttl: 3600
    dependencies:
      - postgres
      - redis
      - nats
    modules:
      - id: skill-assessment
        name: "Skill Assessment Engine"
        name_ar: "محرك تقييم المهارات"
        endpoint: "/assessment"
        description: "Evaluates farmer competency levels across multiple dimensions"

      - id: learning-pathway
        name: "Learning Pathway Generator"
        name_ar: "مولد مسار التعلم"
        endpoint: "/learning-path"
        description: "Generates personalized learning recommendations"

      - id: skill-progress
        name: "Progress Tracking"
        name_ar: "تتبع التقدم"
        endpoint: "/progress"
        description: "Monitors skill development over time"

      - id: competency-matrix
        name: "Competency Matrix"
        name_ar: "مصفوفة الكفاءات"
        endpoint: "/competencies"
        description: "Maps agricultural competencies and skill levels"

      - id: adaptive-learning
        name: "Adaptive Learning Engine"
        name_ar: "محرك التعلم التكيفي"
        endpoint: "/adaptive"
        description: "Adjusts learning content based on farmer performance"

      - id: peer-benchmarking
        name: "Peer Benchmarking"
        name_ar: "المقارنة مع الأقران"
        endpoint: "/benchmarking"
        description: "Compares skills against peer groups for motivation"

    environment:
      - DATABASE_URL
      - REDIS_URL
      - NATS_URL
      - SKILL_ASSESSMENT_MODEL
      - LEARNING_RECOMMENDATION_ENGINE
    resources:
      cpu: "400m"
      memory: "512Mi"
      replicas: 1
      autoscaling:
        enabled: true
        min_replicas: 1
        max_replicas: 3
        target_cpu: 75
    monitoring:
      metrics:
        - skill_assessments_total
        - learning_paths_generated_total
        - farmer_engagement_score
        - skill_improvement_rate
      alerts:
        - "AssessmentLatencyHigh"
        - "LearningEngineError"
        - "SkillDataQualityIssue"

  # ═══════════════════════════════════════════════════════════════════════════
  # ADVISORY SERVICE - خدمة الاستشارات
  # Replaces: fertilizer-advisor (deprecated)
  # ═══════════════════════════════════════════════════════════════════════════
  advisory-service:
    name: "Advisory Service"
    name_ar: "خدمة الاستشارات"
    type: python
    category: core
    layer: decision
    path: "apps/services/advisory-service"
    port: 8093
    protocol: http
    health_endpoint: "/health"
    status: active
    replaces: fertilizer-advisor
    events:
      produces:
        - AdvisoryGenerated.v1
        - FertilizerRecommendation.v1
      consumes:
        - SoilAnalysisCompleted.v1
        - CropHealthAssessed.v1
        - WeatherForecastReady.v1
    dependencies:
      - postgres
      - redis
      - nats
    resources:
      cpu: "400m"
      memory: "384Mi"
      replicas: 1

# ─────────────────────────────────────────────────────────────────────────────
# Applications (Frontend)
# ─────────────────────────────────────────────────────────────────────────────

applications:
  web:
    name: "SAHOOL Dashboard"
    name_ar: "لوحة تحكم سهول"
    path: "apps/web"
    port: 3000
    status: active

  admin:
    name: "Admin Panel"
    name_ar: "لوحة الإدارة"
    path: "apps/admin"
    port: 3001
    status: active

  mobile:
    name: "SAHOOL Field App"
    name_ar: "تطبيق سهول الميداني"
    path: "apps/mobile"
    status: active

# ─────────────────────────────────────────────────────────────────────────────
# API Gateway Configuration
# ─────────────────────────────────────────────────────────────────────────────

gateway:
  type: kong
  config_path: "infra/kong/kong.yml"
  global_rate_limit:
    minute: 60
    hour: 2000
  authentication:
    type: jwt
    algorithm: RS256

# ─────────────────────────────────────────────────────────────────────────────
# Infrastructure Dependencies
# ─────────────────────────────────────────────────────────────────────────────

infrastructure:
  databases:
    postgresql:
      version: "15"
      host: "${POSTGRES_HOST:-localhost}"
      port: 5432
    timescaledb:
      version: "2.11"
      host: "${TIMESCALE_HOST:-localhost}"
      port: 5432
    redis:
      version: "7"
      host: "${REDIS_HOST:-localhost}"
      port: 6379

  message_brokers:
    mqtt:
      host: "${MQTT_HOST:-localhost}"
      port: 1883
    rabbitmq:
      host: "${RABBITMQ_HOST:-localhost}"
      port: 5672

  observability:
    prometheus:
      port: 9090
    grafana:
      port: 3000
    loki:
      port: 3100

# ─────────────────────────────────────────────────────────────────────────────
# Shared Packages
# ─────────────────────────────────────────────────────────────────────────────

packages:
  sahool-eo:
    name: "SAHOOL EO"
    name_ar: "حزمة الاستشعار عن بعد"
    description: "eo-learn integration for Earth Observation"
    path: "packages/sahool-eo"
    version: "1.0.0"
    type: python
    dependencies:
      required:
        - numpy>=1.21.0
        - scipy>=1.7.0
        - pyyaml>=6.0
      optional:
        - eo-learn>=1.4.0
        - sentinelhub>=3.9.0
        - s2cloudless>=1.7.0
    features:
      - "Sentinel-2 data fetching"
      - "Cloud masking (SCL + s2cloudless)"
      - "Vegetation indices (NDVI, EVI, LAI, NDWI, SAVI)"
      - "Field monitoring workflows"
      - "Yield prediction workflows"
      - "Time series analysis"
    external_credentials:
      - name: "Sentinel Hub"
        env_vars: ["SENTINEL_HUB_CLIENT_ID", "SENTINEL_HUB_CLIENT_SECRET"]
        url: "https://www.sentinel-hub.com/"
        required: false

  shared-events:
    name: "Shared Events"
    name_ar: "الأحداث المشتركة"
    description: "Event schemas for event-driven architecture"
    path: "packages/shared/events"
    version: "1.0.0"
    type: json-schema

# ─────────────────────────────────────────────────────────────────────────────
# Deployment Environments
# ─────────────────────────────────────────────────────────────────────────────

environments:
  development:
    replicas: 1
    resources_multiplier: 0.5
    debug: true

  staging:
    replicas: 1
    resources_multiplier: 0.75
    debug: false

  production:
    replicas: 2
    resources_multiplier: 1.0
    debug: false
    autoscaling:
      enabled: true
      min_replicas: 2
      max_replicas: 10
      target_cpu: 70

# ─────────────────────────────────────────────────────────────────────────────
# Governance Rules
# ─────────────────────────────────────────────────────────────────────────────

governance:
  rules:
    - id: GOV-001
      rule: "New services MUST be in apps/services/"
      enforce: true

    - id: GOV-002
      rule: "No services in kernel/, kernel-services-v15.3/, or root"
      enforce: true

    - id: GOV-003
      rule: "All services MUST have /health endpoint"
      enforce: true

    - id: GOV-004
      rule: "All services MUST have Dockerfile"
      enforce: true

    - id: GOV-005
      rule: "Frontend apps MUST be in apps/{web,admin,mobile}"
      enforce: true
