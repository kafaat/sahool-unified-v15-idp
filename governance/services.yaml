# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - Services Registry (Single Source of Truth)
# Generated: 2024-12-19
# ═══════════════════════════════════════════════════════════════════════════════

version: "2.0.0"
last_updated: "2024-12-19"
owner: sahool-platform

source_of_truth:
  services_root: "kernel-services-v15.3"
  legacy_root: "kernel/services"  # FROZEN
  shared_packages: "packages"
  shared_domain: "shared/domain"

defaults:
  health_path: "/healthz"
  metrics_path: "/metrics"
  log_level: "INFO"

# ═══════════════════════════════════════════════════════════════════════════════
# ACTIVE SERVICES (18 services in kernel-services-v15.3)
# ═══════════════════════════════════════════════════════════════════════════════

services:

  # ─────────────────────────────────────────────────────────────────────────────
  # NestJS Services
  # ─────────────────────────────────────────────────────────────────────────────

  crop-growth-model:
    name_ar: "نموذج نمو المحاصيل"
    path: "kernel-services-v15.3/crop-growth-model"
    runtime: nestjs
    port: 3023
    modules: 15
    db: [postgres, redis]
    events_produces: [GrowthSimulated, PhenologyUpdated, YieldPredicted]
    events_consumes: [FieldCreated, WeatherUpdated]
    status: active

  disaster-assessment:
    name_ar: "تقييم الكوارث"
    path: "kernel-services-v15.3/disaster-assessment"
    runtime: nestjs
    port: 3020
    db: [postgres, redis]
    events_produces: [DisasterDetected, AlertIssued]
    status: active

  lai-estimation:
    name_ar: "تقدير مؤشر مساحة الأوراق"
    path: "kernel-services-v15.3/lai-estimation"
    runtime: nestjs
    port: 3022
    db: [postgres]
    events_produces: [LAIComputed]
    status: active

  yield-prediction:
    name_ar: "التنبؤ بالإنتاجية"
    path: "kernel-services-v15.3/yield-prediction"
    runtime: nestjs
    port: 3021
    db: [postgres]
    events_produces: [YieldForecast]
    status: active

  marketplace-service:
    name_ar: "سوق سهول"
    path: "kernel-services-v15.3/marketplace-service"
    runtime: nestjs
    port: 3010
    db: [postgres, redis]
    events_produces: [OrderCreated, PaymentProcessed]
    status: active

  research-core:
    name_ar: "نواة البحث العلمي"
    path: "kernel-services-v15.3/research-core"
    runtime: nestjs
    port: 3015
    db: [postgres, redis]
    events_produces: [ExperimentCreated, ObservationLogged]
    status: active

  # ─────────────────────────────────────────────────────────────────────────────
  # Python FastAPI Services
  # ─────────────────────────────────────────────────────────────────────────────

  billing-core:
    name_ar: "خدمة الفوترة"
    path: "kernel-services-v15.3/billing-core"
    runtime: python-fastapi
    port: 8021
    db: [postgres]
    status: active

  crop-health-ai:
    name_ar: "سهول فيجن - كشف الأمراض"
    path: "kernel-services-v15.3/crop-health-ai"
    runtime: python-fastapi
    port: 8095
    db: []
    events_produces: [DiseaseDetected, HealthAssessment]
    status: active

  virtual-sensors:
    name_ar: "المستشعرات الافتراضية"
    path: "kernel-services-v15.3/virtual-sensors"
    runtime: python-fastapi
    port: 8096
    db: []
    events_produces: [ET0Computed]
    status: active

  yield-engine:
    name_ar: "محرك التنبؤ بالإنتاجية"
    path: "kernel-services-v15.3/yield-engine"
    runtime: python-fastapi
    port: 8098
    db: []
    events_produces: [YieldPredicted]
    status: active

  fertilizer-advisor:
    name_ar: "مستشار التسميد"
    path: "kernel-services-v15.3/fertilizer-advisor"
    runtime: python-fastapi
    port: 8093
    db: [postgres]
    events_produces: [FertilizerRecommendation]
    status: active

  irrigation-smart:
    name_ar: "الري الذكي"
    path: "kernel-services-v15.3/irrigation-smart"
    runtime: python-fastapi
    port: 8094
    db: [postgres]
    events_produces: [IrrigationSchedule]
    status: active

  satellite-service:
    name_ar: "خدمة الأقمار الصناعية"
    path: "kernel-services-v15.3/satellite-service"
    runtime: python-fastapi
    port: 8090
    db: [postgres]
    events_produces: [NdviComputed, SatelliteImageReceived]
    status: active

  weather-advanced:
    name_ar: "خدمة الطقس المتقدمة"
    path: "kernel-services-v15.3/weather-advanced"
    runtime: python-fastapi
    port: 8092
    db: [postgres]
    events_produces: [WeatherUpdated, WeatherForecast]
    status: active

  indicators-service:
    name_ar: "خدمة المؤشرات"
    path: "kernel-services-v15.3/indicators-service"
    runtime: python-fastapi
    port: 8091
    db: [postgres]
    events_produces: [IndicatorComputed]
    status: active

  notification-service:
    name_ar: "خدمة الإشعارات"
    path: "kernel-services-v15.3/notification-service"
    runtime: python-fastapi
    port: 8110
    db: [postgres, redis]
    events_produces: [NotificationSent]
    status: active

  iot-service:
    name_ar: "بوابة إنترنت الأشياء"
    path: "kernel-services-v15.3/iot-service"
    runtime: python-fastapi
    port: 8106
    db: [timescaledb, mqtt]
    events_produces: [SensorReading]
    status: active

  # ─────────────────────────────────────────────────────────────────────────────
  # Node.js Services
  # ─────────────────────────────────────────────────────────────────────────────

  community-chat:
    name_ar: "الدردشة المجتمعية"
    path: "kernel-services-v15.3/community-chat"
    runtime: nodejs
    port: 8097
    db: [redis]
    events_produces: [MessageSent]
    status: active

# ═══════════════════════════════════════════════════════════════════════════════
# FROZEN SERVICES (kernel/services) - DO NOT ADD NEW SERVICES
# ═══════════════════════════════════════════════════════════════════════════════

frozen_services:
  status: "FROZEN"
  reason: "Superseded by kernel-services-v15.3"
  migration_target: "v16"
  path: "kernel/services"
  marker_file: "kernel/services/FROZEN.md"

  services:
    field_core: { port: 3000, v15_equivalent: null }
    field_ops: { port: 8080, v15_equivalent: null }
    ndvi_engine: { port: 8107, v15_equivalent: satellite-service }
    weather_core: { port: 8108, v15_equivalent: weather-advanced }
    field_chat: { port: 8099, v15_equivalent: community-chat }
    iot_gateway: { port: 8106, v15_equivalent: iot-service }
    agro_advisor: { port: 8105, v15_equivalent: fertilizer-advisor }
    ws_gateway: { port: 8089, v15_equivalent: null }
    crop_health: { port: 8100, v15_equivalent: crop-health-ai }
    agro_rules: { port: null, v15_equivalent: null }
    task_service: { port: 8103, v15_equivalent: null }
    equipment_service: { port: 8101, v15_equivalent: null }
    community_service: { port: 8102, v15_equivalent: community-chat }
    provider_config: { port: 8104, v15_equivalent: null }

# ═══════════════════════════════════════════════════════════════════════════════
# SHARED PACKAGES
# ═══════════════════════════════════════════════════════════════════════════════

packages:
  advisor:
    path: "packages/advisor"
    description: "AI advisory system (RAG, LLM, context)"

  field-suite:
    path: "packages/field-suite"
    description: "Spatial & field domain models"

  shared-domain:
    path: "shared/domain"
    description: "Auth, Users, Tenancy"

# ═══════════════════════════════════════════════════════════════════════════════
# INFRASTRUCTURE
# ═══════════════════════════════════════════════════════════════════════════════

infrastructure:
  postgres: { image: "postgis/postgis:16-3.4", port: 5432 }
  redis: { image: "redis:7.4-alpine", port: 6379 }
  nats: { image: "nats:2.10.24-alpine", ports: [4222, 8222] }
  mqtt: { image: "eclipse-mosquitto:2", ports: [1883, 9001] }
  kong: { image: "kong:3.9", ports: [8000, 8001] }
  prometheus: { image: "prom/prometheus:v2.48.0", port: 9090 }
  grafana: { image: "grafana/grafana:10.2.0", port: 3002 }

# ═══════════════════════════════════════════════════════════════════════════════
# GOVERNANCE RULES
# ═══════════════════════════════════════════════════════════════════════════════

governance:
  rules:
    - id: GOV-001
      rule: "New services MUST be in kernel-services-v15.3"
      enforce: true

    - id: GOV-002
      rule: "No new services in kernel/services (FROZEN)"
      enforce: true

    - id: GOV-003
      rule: "All services MUST have /healthz endpoint"
      enforce: true

    - id: GOV-004
      rule: "All services MUST have Dockerfile"
      enforce: true

  contacts:
    backend: "kernel-services-v15.3/"
    frontend: "web/"
    devops: "infra/ + helm/ + gitops/"
