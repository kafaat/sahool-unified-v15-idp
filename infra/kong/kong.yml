# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - Kong API Gateway Configuration
# Declarative configuration for DB-less mode
# Version: 16.0.0 - Security Enhanced
# ═══════════════════════════════════════════════════════════════════════════════

_format_version: "3.0"
_transform: true

# ─────────────────────────────────────────────────────────────────────────────
# Upstreams with Health Checks
# ─────────────────────────────────────────────────────────────────────────────

upstreams:
  - name: field-ops-upstream
    targets:
      - target: sahool-field-ops:8080
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: ndvi-engine-upstream
    targets:
      - target: sahool-ndvi-engine:8107
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: weather-upstream
    targets:
      - target: sahool-weather-core:8108
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: chat-upstream
    targets:
      - target: sahool-field-chat:8099
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: iot-upstream
    targets:
      - target: sahool-iot-gateway:8106
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: advisor-upstream
    targets:
      - target: sahool-agro-advisor:8105
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: ws-gateway-upstream
    targets:
      - target: sahool-ws-gateway:8081
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: crop-health-upstream
    targets:
      - target: sahool-crop-health:8100
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: field-core-upstream
    targets:
      - target: sahool-field-core:3000
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: task-upstream
    targets:
      - target: sahool-task-service:8103
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: equipment-upstream
    targets:
      - target: sahool-equipment-service:8101
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: community-upstream
    targets:
      - target: sahool-community-service:8102
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: provider-config-upstream
    targets:
      - target: sahool-provider-config:8104
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: satellite-upstream
    targets:
      - target: sahool-satellite-service:8090
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: indicators-upstream
    targets:
      - target: sahool-indicators-service:8091
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: weather-advanced-upstream
    targets:
      - target: sahool-weather-advanced:8092
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: astronomical-calendar-upstream
    targets:
      - target: sahool-astronomical-calendar:8111
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: fertilizer-upstream
    targets:
      - target: sahool-fertilizer-advisor:8093
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: irrigation-upstream
    targets:
      - target: sahool-irrigation-smart:8094
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: crop-health-ai-upstream
    targets:
      - target: sahool-crop-health-ai:8095
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: virtual-sensors-upstream
    targets:
      - target: sahool-virtual-sensors:8096
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: community-chat-upstream
    targets:
      - target: sahool-community-chat:8097
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: yield-engine-upstream
    targets:
      - target: sahool-yield-engine:8098
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: crop-growth-upstream
    targets:
      - target: sahool-crop-growth-model:3023
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /api/v1/simulation/health
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: notification-upstream
    targets:
      - target: sahool-notification-service:8110
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: research-core-upstream
    targets:
      - target: sahool-research-core:3015
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /api/v1/healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: disaster-assessment-upstream
    targets:
      - target: sahool-disaster-assessment:3020
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /api/v1/disasters/health
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: yield-prediction-upstream
    targets:
      - target: sahool-yield-prediction:3021
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /api/v1/yield/health
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: lai-estimation-upstream
    targets:
      - target: sahool-lai-estimation:3022
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /api/v1/lai/health
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: marketplace-upstream
    targets:
      - target: sahool-marketplace:3010
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /api/v1/healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  - name: billing-core-upstream
    targets:
      - target: sahool-billing-core:8089
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

# ─────────────────────────────────────────────────────────────────────────────
# JWT Consumers for Authentication
# ─────────────────────────────────────────────────────────────────────────────

consumers:
  - username: sahool-web-app
    custom_id: web-client
    jwt_secrets:
      - key: sahool-web-key
        algorithm: HS256
        secret: sahool-web-secret-change-in-production

  - username: sahool-mobile-app
    custom_id: mobile-client
    jwt_secrets:
      - key: sahool-mobile-key
        algorithm: HS256
        secret: sahool-mobile-secret-change-in-production

  - username: sahool-internal-service
    custom_id: internal-service
    jwt_secrets:
      - key: sahool-internal-key
        algorithm: HS256
        secret: sahool-internal-secret-change-in-production

# ─────────────────────────────────────────────────────────────────────────────
# Services Definition (Using Upstreams)
# ─────────────────────────────────────────────────────────────────────────────

services:
  # Field Operations Service
  - name: field-ops-service
    host: field-ops-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: field-ops-route
        paths:
          - /api/v1/fields
          - /api/v1/tasks
          - /api/v1/assignments
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 2000
              policy: local

  # NDVI Engine Service
  - name: ndvi-engine-service
    host: ndvi-engine-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 120000
    read_timeout: 120000
    routes:
      - name: ndvi-route
        paths:
          - /api/v1/ndvi
          - /api/v1/satellite
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # Weather Core Service
  - name: weather-service
    host: weather-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: weather-route
        paths:
          - /api/v1/weather
          - /api/v1/forecast
        strip_path: false

  # Field Chat Service
  - name: chat-service
    host: chat-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: chat-route
        paths:
          - /api/v1/chat
          - /api/v1/messages
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 120
              hour: 3000
              policy: local

  # IoT Gateway Service
  - name: iot-service
    host: iot-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: iot-route
        paths:
          - /api/v1/iot
          - /api/v1/sensors
          - /api/v1/devices
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 200
              hour: 10000
              policy: local

  # Agro Advisor Service
  - name: advisor-service
    host: advisor-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 90000
    read_timeout: 90000
    routes:
      - name: advisor-route
        paths:
          - /api/v1/advisor
          - /api/v1/recommendations
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # WebSocket Gateway Service
  - name: ws-gateway-service
    host: ws-gateway-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 3600000
    read_timeout: 3600000
    routes:
      - name: ws-route
        paths:
          - /ws
          - /api/v1/realtime
        strip_path: false

  # Crop Health Service
  - name: crop-health-service
    host: crop-health-upstream
    port: 80
    protocol: http
    path: /api/v1
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: crop-health-route
        paths:
          - /api/v1/crop-health
        strip_path: true

  # Field Core Service (Advanced field management)
  - name: field-core-service
    host: field-core-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: field-core-route
        paths:
          - /api/v1/fields/sync
          - /api/v1/fields/batch
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 20
              hour: 200
              policy: local

  # Task Service
  - name: task-service
    host: task-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: task-route
        paths:
          - /api/v1/tasks
        strip_path: false

  # Equipment Service
  - name: equipment-service
    host: equipment-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: equipment-route
        paths:
          - /api/v1/equipment
        strip_path: false

  # Community Service
  - name: community-service
    host: community-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: community-route
        paths:
          - /api/v1/posts
          - /api/v1/comments
          - /api/v1/stories
          - /api/v1/community
          - /api/v1/experts
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1500
              policy: local

  # Provider Configuration Service
  - name: provider-config-service
    host: provider-config-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: provider-config-route
        paths:
          - /api/v1/providers
          - /api/v1/config
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # ─────────────────────────────────────────────────────────────────────────────
  # SAHOOL v15.3 Services
  # ─────────────────────────────────────────────────────────────────────────────

  # Satellite Service - NDVI Analysis (v15.3)
  - name: satellite-service-v15
    host: satellite-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 180000
    read_timeout: 180000
    routes:
      - name: satellite-v15-route
        paths:
          - /api/v1/satellite/analyze
          - /api/v1/satellite/timeseries
          - /api/v1/satellite/imagery
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 20
              hour: 300
              policy: local

  # Indicators Service - Agricultural KPIs (v15.3)
  - name: indicators-service-v15
    host: indicators-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: indicators-v15-route
        paths:
          - /api/v1/indicators
          - /api/v1/dashboard
          - /api/v1/kpi
        strip_path: false

  # Weather Advanced Service (v15.3)
  - name: weather-advanced-service
    host: weather-advanced-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: weather-advanced-route
        paths:
          - /api/v1/weather/advanced
          - /api/v1/weather/alerts
          - /api/v1/agricultural-calendar
        strip_path: false

  # Astronomical Calendar Service (v15.5)
  # خدمة التقويم الفلكي الزراعي اليمني
  - name: astronomical-calendar-service
    host: astronomical-calendar-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: astronomical-calendar-route
        paths:
          - /api/v1/astronomical
          - /api/v1/astronomical/today
          - /api/v1/astronomical/week
          - /api/v1/astronomical/moon
          - /api/v1/astronomical/mansions
          - /api/v1/astronomical/proverbs
          - /api/v1/astronomical/wisdom
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 2000
              policy: local

  # Fertilizer Advisor Service (v15.3)
  - name: fertilizer-advisor-service
    host: fertilizer-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 90000
    read_timeout: 90000
    routes:
      - name: fertilizer-route
        paths:
          - /api/v1/fertilizer
          - /api/v1/fertilizer/recommend
          - /api/v1/soil/interpret
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # Irrigation Smart Service (v15.3)
  - name: irrigation-smart-service
    host: irrigation-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: irrigation-route
        paths:
          - /api/v1/irrigation
          - /api/v1/irrigation/calculate
          - /api/v1/water-balance
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1000
              policy: local

  # Crop Health AI Service - Sahool Vision (v15.3)
  - name: crop-health-ai-service
    host: crop-health-ai-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 120000
    read_timeout: 120000
    routes:
      - name: crop-health-ai-route
        paths:
          - /api/v1/diagnose
          - /api/v1/diseases
          - /api/v1/treatment
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 20
              hour: 300
              policy: local

  # Virtual Sensors Service (v15.3)
  - name: virtual-sensors-service
    host: virtual-sensors-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: virtual-sensors-route
        paths:
          - /api/v1/et0
          - /api/v1/etc
          - /api/v1/soil-moisture
          - /api/v1/virtual-sensors
        strip_path: false

  # Community Chat Service (v15.3)
  - name: community-chat-service
    host: community-chat-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: community-chat-route
        paths:
          - /api/v1/chat/requests
          - /api/v1/chat/rooms
          - /api/v1/chat/experts
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              hour: 2500
              policy: local

  # Yield Engine Service (v15.3)
  - name: yield-engine-service
    host: yield-engine-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 90000
    read_timeout: 90000
    routes:
      - name: yield-route
        paths:
          - /api/v1/yield
          - /api/v1/yield/predict
          - /api/v1/yield/historical
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # Crop Growth Model Service (v15.3)
  # Advanced crop modeling with Digital Twin, RS World Model, and Planting Strategy
  - name: crop-growth-service
    host: crop-growth-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 120000
    read_timeout: 120000
    routes:
      # Digital Twin Core - التوأم الرقمي للمحاصيل
      # Multi-layer architecture with edge computing and hybrid modeling
      - name: digital-twin-route
        paths:
          - /api/v1/digital-twin
          - /api/v1/digital-twin/architecture
          - /api/v1/digital-twin/edge-nodes
          - /api/v1/digital-twin/data/satellite
          - /api/v1/digital-twin/data/drone
          - /api/v1/digital-twin/data/ground-sensors
          - /api/v1/digital-twin/data/fuse
          - /api/v1/digital-twin/models
          - /api/v1/digital-twin/models/wofost
          - /api/v1/digital-twin/models/ml
          - /api/v1/digital-twin/models/deep-learning
          - /api/v1/digital-twin/models/llm
          - /api/v1/digital-twin/models/hybrid-ensemble
          - /api/v1/digital-twin/assimilate
          - /api/v1/digital-twin/state
          - /api/v1/digital-twin/demo
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              # Digital twin operations - compute intensive
              minute: 20
              hour: 300
              policy: local

      # RS World Model - نموذج العالم للاستشعار عن بعد
      # Based on RemoteBAGEL (arxiv:2509.17808) - First World Model for Remote Sensing
      - name: rs-world-model-route
        paths:
          - /api/v1/rs-world-model
          - /api/v1/rs-world-model/architecture
          - /api/v1/rs-world-model/scenarios
          - /api/v1/rs-world-model/benchmarks
          - /api/v1/rs-world-model/capabilities
          - /api/v1/rs-world-model/reason
          - /api/v1/rs-world-model/expand
          - /api/v1/rs-world-model/partition
          - /api/v1/rs-world-model/evaluate
          - /api/v1/rs-world-model/demo
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              # World model spatial reasoning - compute intensive
              minute: 20
              hour: 300
              policy: local

      # Planting Strategy Optimizer - محسّن استراتيجية الزراعة
      # Wheat planting methods: equal row, wide strip, space broadcasting, small basin
      - name: planting-strategy-route
        paths:
          - /api/v1/planting-strategy
          - /api/v1/planting-strategy/methods
          - /api/v1/planting-strategy/optimize
          - /api/v1/planting-strategy/plan
          - /api/v1/planting-strategy/density
          - /api/v1/planting-strategy/fertilizer
          - /api/v1/planting-strategy/irrigation
          - /api/v1/planting-strategy/compare
          - /api/v1/planting-strategy/analyze-field
          - /api/v1/planting-strategy/digital-twin
          - /api/v1/planting-strategy/crops
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              # Planting optimization calculations
              minute: 30
              hour: 500
              policy: local

      # GIS Integration Service - خدمة تكامل نظم المعلومات الجغرافية
      # Based on GeoSuite/QCarta patterns - OGC WMS, WFS, WMTS
      - name: gis-integration-route
        paths:
          - /api/v1/gis
          - /api/v1/gis/layers
          - /api/v1/gis/wms
          - /api/v1/gis/wfs
          - /api/v1/gis/spatial
          - /api/v1/gis/fields
          - /api/v1/gis/analysis
          - /api/v1/gis/routing
          - /api/v1/gis/projects
          - /api/v1/gis/basemaps
          - /api/v1/gis/utils
          - /api/v1/gis/demo
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              # GIS operations - variable load
              minute: 50
              hour: 1000
              policy: local

  # ─────────────────────────────────────────────────────────────────────────────
  # New Services (v15.5)
  # ─────────────────────────────────────────────────────────────────────────────

  # Notification Service - خدمة الإشعارات والتنبيهات
  - name: notification-service
    host: notification-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: notification-route
        paths:
          - /api/v1/notifications
          - /api/v1/notifications/send
          - /api/v1/notifications/preferences
          - /api/v1/notifications/history
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              hour: 2000
              policy: local

  # Research Core Service - نواة البحث العلمي
  - name: research-core-service
    host: research-core-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: research-core-route
        paths:
          - /api/v1/research
          - /api/v1/experiments
          - /api/v1/trials
          - /api/v1/research/data
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1000
              policy: local

  # Disaster Assessment Service - خدمة تقييم الكوارث
  - name: disaster-assessment-service
    host: disaster-assessment-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 90000
    read_timeout: 90000
    routes:
      - name: disaster-assessment-route
        paths:
          - /api/v1/disasters
          - /api/v1/disasters/assess
          - /api/v1/disasters/alerts
          - /api/v1/disasters/reports
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # Yield Prediction Service - خدمة التنبؤ بالإنتاجية
  - name: yield-prediction-service
    host: yield-prediction-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 90000
    read_timeout: 90000
    routes:
      - name: yield-prediction-route
        paths:
          - /api/v1/yield-prediction
          - /api/v1/yield-prediction/forecast
          - /api/v1/yield-prediction/models
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # LAI Estimation Service - خدمة تقدير مؤشر مساحة الأوراق
  - name: lai-estimation-service
    host: lai-estimation-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 90000
    read_timeout: 90000
    routes:
      - name: lai-estimation-route
        paths:
          - /api/v1/lai
          - /api/v1/lai/estimate
          - /api/v1/lai/timeseries
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # Marketplace Service - سوق سهول والخدمات المالية
  - name: marketplace-service-v15
    host: marketplace-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: marketplace-route
        paths:
          - /api/v1/marketplace
          - /api/v1/marketplace/products
          - /api/v1/marketplace/orders
          - /api/v1/marketplace/listings
          - /api/v1/marketplace/vendors
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1500
              policy: local

  # Billing Core Service - خدمة الفوترة الأساسية
  - name: billing-core-service
    host: billing-core-upstream
    port: 80
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: billing-core-route
        paths:
          - /api/v1/billing
          - /api/v1/subscriptions
          - /api/v1/invoices
          - /api/v1/payments
          - /api/v1/plans
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1000
              policy: local
      # Tharwatt Payment Webhook - ويب هوك ثروات
      - name: tharwatt-webhook-route
        paths:
          - /api/v1/webhooks/tharwatt
        strip_path: false
        methods:
          - POST
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              policy: local
      # Stripe Payment Webhook - ويب هوك سترايب
      - name: stripe-webhook-route
        paths:
          - /api/v1/webhooks/stripe
        strip_path: false
        methods:
          - POST
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              policy: local

# ─────────────────────────────────────────────────────────────────────────────
# Global Plugins
# ─────────────────────────────────────────────────────────────────────────────

plugins:
  # JWT Authentication (Global)
  - name: jwt
    config:
      key_claim_name: iss
      claims_to_verify:
        - exp
      run_on_preflight: false
      # Anonymous consumer for public endpoints
      # anonymous: ~

  # Rate Limiting (Global Default)
  - name: rate-limiting
    config:
      minute: 60
      hour: 2000
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      redis_ssl: false

  # CORS (Secured - Whitelist Only)
  - name: cors
    config:
      origins:
        - https://sahool.com
        - https://app.sahool.com
        - https://admin.sahool.com
        - https://api.sahool.com
        - https://staging.sahool.com
        - https://dev.sahool.com
        # Mobile app origins
        - capacitor://localhost
        - ionic://localhost
        # Local development (remove in production)
        - http://localhost:3000
        - http://localhost:8080
        - http://localhost:5173
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Tenant-ID
        - X-Request-ID
        - X-User-ID
        - X-Device-ID
      exposed_headers:
        - X-Request-ID
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
        - X-RateLimit-Reset
      credentials: true
      max_age: 3600
      preflight_continue: false

  # Request/Response Logging
  - name: file-log
    config:
      path: /dev/stdout
      reopen: true

  # Request ID / Correlation ID
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true

  # Response Transformer (Security Headers)
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Content-Type-Options: nosniff"
          - "X-Frame-Options: DENY"
          - "X-XSS-Protection: 1; mode=block"
          - "Referrer-Policy: strict-origin-when-cross-origin"

  # Request Size Limiting
  - name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes
      require_content_length: false

  # IP Restriction (Optional - enable for admin endpoints)
  # - name: ip-restriction
  #   config:
  #     allow:
  #       - 10.0.0.0/8
  #       - 172.16.0.0/12
  #       - 192.168.0.0/16
