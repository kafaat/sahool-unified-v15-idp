# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - Kong API Gateway Configuration
# Declarative configuration for DB-less mode
# Version: 16.0.0 - Security Enhanced
# ═══════════════════════════════════════════════════════════════════════════════

_format_version: "3.0"
_transform: true

# ─────────────────────────────────────────────────────────────────────────────
# Upstreams with Health Checks
# ─────────────────────────────────────────────────────────────────────────────

# YAML anchor for standard healthcheck configuration
x-healthcheck-config: &standard-healthcheck
  active:
    type: http
    http_path: /health
    healthy:
      interval: 10
      successes: 2
    unhealthy:
      interval: 5
      http_failures: 3
      timeouts: 3
  passive:
    healthy:
      successes: 5
    unhealthy:
      http_failures: 5
      timeouts: 3

upstreams:
  - name: field-ops-upstream
    targets:
      - target: sahool-field-ops:8080
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: ndvi-engine-upstream
    targets:
      - target: sahool-ndvi-engine:8107
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: weather-upstream
    targets:
      - target: sahool-weather-core:8108
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: chat-upstream
    targets:
      - target: sahool-field-chat:8099
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: iot-upstream
    targets:
      - target: sahool-iot-gateway:8106
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: advisor-upstream
    targets:
      - target: sahool-agro-advisor:8105
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: ws-gateway-upstream
    targets:
      - target: sahool-ws-gateway:8089
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: crop-health-upstream
    targets:
      - target: sahool-crop-health:8100
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: field-core-upstream
    targets:
      - target: sahool-field-core:3000
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: task-upstream
    targets:
      - target: sahool-task-service:8103
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: equipment-upstream
    targets:
      - target: sahool-equipment-service:8101
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: community-upstream
    targets:
      - target: sahool-community-service:8102
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: provider-config-upstream
    targets:
      - target: sahool-provider-config:8104
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: satellite-upstream
    targets:
      - target: sahool-satellite-service:8090
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: indicators-upstream
    targets:
      - target: sahool-indicators-service:8091
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: weather-advanced-upstream
    targets:
      - target: sahool-weather-advanced:8092
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: fertilizer-upstream
    targets:
      - target: sahool-fertilizer-advisor:8093
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: irrigation-upstream
    targets:
      - target: sahool-irrigation-smart:8094
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: crop-health-ai-upstream
    targets:
      - target: sahool-crop-health-ai:8095
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: virtual-sensors-upstream
    targets:
      - target: sahool-virtual-sensors:8096
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: community-chat-upstream
    targets:
      - target: sahool-community-chat:8097
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: yield-engine-upstream
    targets:
      - target: sahool-yield-engine:8098
        weight: 100
    healthchecks:
      <<: *standard-healthcheck

  - name: marketplace-upstream
    targets:
      - target: sahool-marketplace:3010
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /api/v1/healthz
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  # Disaster Assessment Service - خدمة تقييم الكوارث (v16.0)
  - name: disaster-assessment-upstream
    targets:
      - target: sahool-disaster-assessment:3020
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /api/v1/disasters/health
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  # Yield Prediction Service - خدمة التنبؤ بالإنتاجية (v16.0)
  - name: yield-prediction-upstream
    targets:
      - target: sahool-yield-prediction:3021
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /api/v1/yield/health
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

  # LAI Estimation Service - خدمة تقدير مؤشر مساحة الأوراق (v16.0)
  # Based on LAI-TransNet research (AI in Agriculture 2025, IF: 12.4)
  - name: lai-estimation-upstream
    targets:
      - target: sahool-lai-estimation:3022
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /api/v1/lai/health
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 3

# ─────────────────────────────────────────────────────────────────────────────
# JWT Consumers for Authentication
# Note: RSA public keys are provided via environment variables
# ─────────────────────────────────────────────────────────────────────────────

consumers:
  - username: sahool-web-app
    custom_id: web-client
    jwt_secrets:
      - key: sahool-web-key
        algorithm: RS256
        rsa_public_key: ${SAHOOL_WEB_JWT_PUBLIC_KEY}

  - username: sahool-mobile-app
    custom_id: mobile-client
    jwt_secrets:
      - key: sahool-mobile-key
        algorithm: RS256
        rsa_public_key: ${SAHOOL_MOBILE_JWT_PUBLIC_KEY}

  - username: sahool-internal-service
    custom_id: internal-service
    jwt_secrets:
      - key: sahool-internal-key
        algorithm: RS256
        rsa_public_key: ${SAHOOL_INTERNAL_JWT_PUBLIC_KEY}

  # Anonymous consumer for public endpoints (health checks, docs, etc.)
  - username: anonymous
    custom_id: anonymous-access

# ─────────────────────────────────────────────────────────────────────────────
# Services Definition (Using Upstreams)
# ─────────────────────────────────────────────────────────────────────────────

services:
  # Field Operations Service
  - name: field-ops-service
    host: field-ops-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: field-ops-route
        paths:
          - /api/v1/fields
          - /api/v1/tasks
          - /api/v1/assignments
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 2000
              policy: local

  # NDVI Engine Service
  - name: ndvi-engine-service
    host: ndvi-engine-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 120000
    read_timeout: 120000
    routes:
      - name: ndvi-route
        paths:
          - /api/v1/ndvi
          - /api/v1/satellite
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # Weather Core Service
  - name: weather-service
    host: weather-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: weather-route
        paths:
          - /api/v1/weather
          - /api/v1/forecast
        strip_path: false

  # Field Chat Service
  - name: chat-service
    host: chat-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: chat-route
        paths:
          - /api/v1/chat
          - /api/v1/messages
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 120
              hour: 3000
              policy: local

  # IoT Gateway Service
  - name: iot-service
    host: iot-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: iot-route
        paths:
          - /api/v1/iot
          - /api/v1/sensors
          - /api/v1/devices
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              # IoT devices typically send sensor readings every 30 seconds (200/min = ~3 devices/user)
              # Higher limits accommodate multiple devices per farm with real-time telemetry
              minute: 200
              hour: 10000
              policy: local

  # Agro Advisor Service
  - name: advisor-service
    host: advisor-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 90000
    read_timeout: 90000
    routes:
      - name: advisor-route
        paths:
          - /api/v1/advisor
          - /api/v1/recommendations
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              # AI-powered advisor service requires significant compute resources (5-30s per request)
              # Lower limits prevent resource exhaustion while supporting typical user workflows
              minute: 30
              hour: 500
              policy: local

  # WebSocket Gateway Service
  - name: ws-gateway-service
    host: ws-gateway-upstream
    retries: 3
    connect_timeout: 30000
    # NOTE: WebSocket connections are designed to be long-lived. The 1-hour
    # write_timeout and read_timeout values below are intentional idle timeouts
    # for real-time sessions. Operators may reduce these based on capacity and
    # workload characteristics if shorter-lived connections are acceptable.
    write_timeout: 3600000
    read_timeout: 3600000
    routes:
      - name: ws-route
        paths:
          - /ws
          - /api/v1/realtime
        strip_path: false

  # Crop Health Service
  - name: crop-health-service
    host: crop-health-upstream
    path: /api/v1
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: crop-health-route
        paths:
          - /api/v1/crop-health
        strip_path: true

  # Field Core Service (Advanced field management)
  - name: field-core-service
    host: field-core-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: field-core-route
        paths:
          - /api/v1/fields/sync
          - /api/v1/fields/batch
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 20
              hour: 200
              policy: local

  # Task Service
  - name: task-service
    host: task-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: task-route
        paths:
          - /api/v1/tasks
        strip_path: false

  # Equipment Service
  - name: equipment-service
    host: equipment-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: equipment-route
        paths:
          - /api/v1/equipment
        strip_path: false

  # Community Service
  - name: community-service
    host: community-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: community-route
        paths:
          - /api/v1/posts
          - /api/v1/comments
          - /api/v1/stories
          - /api/v1/community
          - /api/v1/experts
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1500
              policy: local

  # Provider Configuration Service
  - name: provider-config-service
    host: provider-config-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: provider-config-route
        paths:
          - /api/v1/providers
          - /api/v1/config
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # ─────────────────────────────────────────────────────────────────────────────
  # SAHOOL v15.3 Services
  # ─────────────────────────────────────────────────────────────────────────────

  # Satellite Service - NDVI Analysis (v15.3)
  - name: satellite-service-v15
    host: satellite-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 180000
    read_timeout: 180000
    routes:
      - name: satellite-v15-route
        paths:
          - /api/v1/satellite/analyze
          - /api/v1/satellite/timeseries
          - /api/v1/satellite/imagery
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 20
              hour: 300
              policy: local

  # Indicators Service - Agricultural KPIs (v15.3)
  - name: indicators-service-v15
    host: indicators-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: indicators-v15-route
        paths:
          - /api/v1/indicators
          - /api/v1/dashboard
          - /api/v1/kpi
        strip_path: false

  # Weather Advanced Service (v15.3)
  - name: weather-advanced-service
    host: weather-advanced-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: weather-advanced-route
        paths:
          - /api/v1/weather/advanced
          - /api/v1/weather/alerts
          - /api/v1/agricultural-calendar
        strip_path: false

  # Fertilizer Advisor Service (v15.3)
  - name: fertilizer-advisor-service
    host: fertilizer-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 90000
    read_timeout: 90000
    routes:
      - name: fertilizer-route
        paths:
          - /api/v1/fertilizer
          - /api/v1/fertilizer/recommend
          - /api/v1/soil/interpret
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # Irrigation Smart Service (v15.3)
  - name: irrigation-smart-service
    host: irrigation-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: irrigation-route
        paths:
          - /api/v1/irrigation
          - /api/v1/irrigation/calculate
          - /api/v1/water-balance
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1000
              policy: local

  # Crop Health AI Service - Sahool Vision (v15.3)
  - name: crop-health-ai-service
    host: crop-health-ai-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 120000
    read_timeout: 120000
    routes:
      - name: crop-health-ai-route
        paths:
          - /api/v1/diagnose
          - /api/v1/diseases
          - /api/v1/treatment
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 20
              hour: 300
              policy: local

  # Virtual Sensors Service (v15.3)
  - name: virtual-sensors-service
    host: virtual-sensors-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: virtual-sensors-route
        paths:
          - /api/v1/et0
          - /api/v1/etc
          - /api/v1/soil-moisture
          - /api/v1/virtual-sensors
        strip_path: false

  # Community Chat Service (v15.3)
  - name: community-chat-service
    host: community-chat-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: community-chat-route
        paths:
          - /api/v1/chat/requests
          - /api/v1/chat/rooms
          - /api/v1/chat/experts
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              hour: 2500
              policy: local

  # Yield Engine Service (v15.3)
  - name: yield-engine-service
    host: yield-engine-upstream
    retries: 3
    connect_timeout: 30000
    write_timeout: 90000
    read_timeout: 90000
    routes:
      - name: yield-route
        paths:
          - /api/v1/yield
          - /api/v1/yield/predict
          - /api/v1/yield/historical
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # Marketplace & FinTech Service (v16.0)
  - name: marketplace-service
    host: marketplace-upstream
    port: 3010
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: marketplace-route
        paths:
          - /api/v1/market/marketplace
          - /api/v1/market/products
          - /api/v1/market/orders
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1500
              policy: local
      - name: fintech-route
        paths:
          - /api/v1/fintech/wallet
          - /api/v1/fintech/loans
          - /api/v1/fintech/credit
          - /api/v1/fintech/transactions
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # ─────────────────────────────────────────────────────────────────────────────
  # Agricultural Remote Sensing Services (v16.0)
  # Based on: Agricultural Remote Sensing On-Demand Service Model
  # ─────────────────────────────────────────────────────────────────────────────

  # Disaster Assessment Service - خدمة تقييم الكوارث الزراعية
  - name: disaster-assessment-service
    host: disaster-assessment-upstream
    port: 3020
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 90000
    read_timeout: 90000
    routes:
      - name: disaster-route
        paths:
          - /api/v1/disasters
          - /api/v1/disasters/report
          - /api/v1/disasters/assess
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1000
              policy: local
      - name: disaster-alerts-route
        paths:
          - /api/v1/alerts
          - /api/v1/alerts/early-warning
          - /api/v1/alerts/subscribe
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              hour: 2000
              policy: local
      - name: risk-assessment-route
        paths:
          - /api/v1/risk/flood
          - /api/v1/risk/drought
          - /api/v1/risk/frost
          - /api/v1/risk/pest
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 500
              policy: local

  # Yield Prediction Service - خدمة التنبؤ بالإنتاجية الزراعية
  - name: yield-prediction-service
    host: yield-prediction-upstream
    port: 3021
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 120000
    read_timeout: 120000
    routes:
      - name: yield-prediction-route
        paths:
          - /api/v1/yield/predict
          - /api/v1/yield/growth-stage
          - /api/v1/yield/harvest-date
          - /api/v1/yield/maturity
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              # Yield predictions involve ML models - moderate rate limiting
              minute: 30
              hour: 500
              policy: local
      - name: yield-regional-route
        paths:
          - /api/v1/yield/regional
          - /api/v1/yield/history
          - /api/v1/yield/statistics
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1000
              policy: local

  # LAI Estimation Service - خدمة تقدير مؤشر مساحة الأوراق
  # Based on LAI-TransNet Two-Stage Transfer Learning (AI in Agriculture 2025)
  - name: lai-estimation-service
    host: lai-estimation-upstream
    port: 3022
    protocol: http
    retries: 3
    connect_timeout: 30000
    write_timeout: 90000
    read_timeout: 90000
    routes:
      - name: lai-estimation-route
        paths:
          - /api/v1/lai/estimate
          - /api/v1/lai/calculate
          - /api/v1/lai/timeseries
          - /api/v1/lai/compare
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              # LAI estimation uses ML models - moderate rate limiting
              minute: 30
              hour: 500
              policy: local
      - name: vegetation-indices-route
        paths:
          - /api/v1/indices
          - /api/v1/indices/calculate
          - /api/v1/indices/health
          - /api/v1/indices/info
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 60
              hour: 1500
              policy: local
      - name: lai-model-route
        paths:
          - /api/v1/lai/model
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              minute: 30
              hour: 300
              policy: local

# ─────────────────────────────────────────────────────────────────────────────
# Global Plugins
# ─────────────────────────────────────────────────────────────────────────────

plugins:
  # JWT Authentication (Global)
  - name: jwt
    config:
      key_claim_name: iss
      claims_to_verify:
        - exp
      run_on_preflight: false
      # Anonymous consumer allows public endpoints like health checks
      anonymous: anonymous-access

  # Rate Limiting (Global Default)
  - name: rate-limiting
    config:
      minute: 60
      hour: 2000
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      redis_ssl: false

  # CORS (Secured - Whitelist Only)
  - name: cors
    config:
      origins:
        - https://sahool.com
        - https://app.sahool.com
        - https://admin.sahool.com
        - https://api.sahool.com
        - https://staging.sahool.com
        - https://dev.sahool.com
        # Mobile app origins
        - capacitor://localhost
        - ionic://localhost
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Tenant-ID
        - X-Request-ID
        - X-User-ID
        - X-Device-ID
      exposed_headers:
        - X-Request-ID
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
        - X-RateLimit-Reset
      credentials: true
      max_age: 3600
      preflight_continue: false

  # Request/Response Logging
  - name: file-log
    config:
      path: /dev/stdout
      reopen: true

  # Request ID / Correlation ID
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true

  # Response Transformer (Security Headers)
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Content-Type-Options: nosniff"
          - "X-Frame-Options: DENY"
          - "X-XSS-Protection: 1; mode=block"
          - "Referrer-Policy: strict-origin-when-cross-origin"

  # Request Size Limiting
  - name: request-size-limiting
    config:
      # Set to 100MB for large file uploads (satellite imagery, crop health images)
      # NOTE: This high limit should be paired with:
      # 1. File type validation at application layer
      # 2. Authenticated upload endpoints (JWT required)
      # 3. Rate limiting on upload endpoints
      # 4. Consider implementing streaming uploads for very large files
      allowed_payload_size: 100
      size_unit: megabytes
      require_content_length: false

  # IP Restriction (Optional - enable for admin endpoints)
  # - name: ip-restriction
  #   config:
  #     allow:
  #       - 10.0.0.0/8
  #       - 172.16.0.0/12
  #       - 192.168.0.0/16
