# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - Kong API Gateway Configuration
# Declarative configuration for DB-less mode
# ═══════════════════════════════════════════════════════════════════════════════

_format_version: "3.0"
_transform: true

# ─────────────────────────────────────────────────────────────────────────────
# Services Definition
# ─────────────────────────────────────────────────────────────────────────────

services:
  # Field Operations Service
  - name: field-ops-service
    url: http://sahool-field-ops:8080
    routes:
      - name: field-ops-route
        paths:
          - /api/v1/fields
          - /api/v1/tasks
          - /api/v1/assignments
        strip_path: false

  # NDVI Engine Service
  - name: ndvi-engine-service
    url: http://sahool-ndvi-engine:8107
    routes:
      - name: ndvi-route
        paths:
          - /api/v1/ndvi
          - /api/v1/satellite
        strip_path: false

  # Weather Core Service
  - name: weather-service
    url: http://sahool-weather-core:8108
    routes:
      - name: weather-route
        paths:
          - /api/v1/weather
          - /api/v1/forecast
        strip_path: false

  # Field Chat Service
  - name: chat-service
    url: http://sahool-field-chat:8099
    routes:
      - name: chat-route
        paths:
          - /api/v1/chat
          - /api/v1/messages
        strip_path: false

  # IoT Gateway Service
  - name: iot-service
    url: http://sahool-iot-gateway:8106
    routes:
      - name: iot-route
        paths:
          - /api/v1/iot
          - /api/v1/sensors
          - /api/v1/devices
        strip_path: false

  # Agro Advisor Service
  - name: advisor-service
    url: http://sahool-agro-advisor:8105
    routes:
      - name: advisor-route
        paths:
          - /api/v1/advisor
          - /api/v1/recommendations
        strip_path: false

  # WebSocket Gateway Service
  - name: ws-gateway-service
    url: http://sahool-ws-gateway:8089
    routes:
      - name: ws-route
        paths:
          - /ws
          - /api/v1/realtime
        strip_path: false

  # Crop Health Service
  - name: crop-health-service
    url: http://sahool-crop-health:8100/api/v1
    routes:
      - name: crop-health-route
        paths:
          - /api/v1/crop-health
        strip_path: true

  # Field Core Service (Advanced field management)
  - name: field-core-service
    url: http://sahool-field-core:3000
    routes:
      - name: field-core-route
        paths:
          - /api/v1/fields/sync
          - /api/v1/fields/batch
        strip_path: false

  # Task Service (NEW)
  - name: task-service
    url: http://sahool-task-service:8103
    routes:
      - name: task-route
        paths:
          - /api/v1/tasks
        strip_path: false

  # Equipment Service (NEW)
  - name: equipment-service
    url: http://sahool-equipment-service:8101
    routes:
      - name: equipment-route
        paths:
          - /api/v1/equipment
        strip_path: false

  # Community Service (NEW)
  - name: community-service
    url: http://sahool-community-service:8102
    routes:
      - name: community-route
        paths:
          - /api/v1/posts
          - /api/v1/comments
          - /api/v1/stories
          - /api/v1/community
          - /api/v1/experts
        strip_path: false

  # Provider Configuration Service (NEW)
  - name: provider-config-service
    url: http://sahool-provider-config:8104
    routes:
      - name: provider-config-route
        paths:
          - /api/v1/providers
          - /api/v1/config
        strip_path: false

  # ─────────────────────────────────────────────────────────────────────────────
  # SAHOOL v15.3 Services
  # ─────────────────────────────────────────────────────────────────────────────

  # Satellite Service - NDVI Analysis (v15.3)
  - name: satellite-service-v15
    url: http://sahool-satellite-service:8090
    routes:
      - name: satellite-v15-route
        paths:
          - /api/v1/satellite/analyze
          - /api/v1/satellite/timeseries
          - /api/v1/satellite/imagery
        strip_path: false

  # Indicators Service - Agricultural KPIs (v15.3)
  - name: indicators-service-v15
    url: http://sahool-indicators-service:8091
    routes:
      - name: indicators-v15-route
        paths:
          - /api/v1/indicators
          - /api/v1/dashboard
          - /api/v1/kpi
        strip_path: false

  # Weather Advanced Service (v15.3)
  - name: weather-advanced-service
    url: http://sahool-weather-advanced:8092
    routes:
      - name: weather-advanced-route
        paths:
          - /api/v1/weather/advanced
          - /api/v1/weather/alerts
          - /api/v1/agricultural-calendar
        strip_path: false

  # Fertilizer Advisor Service (v15.3)
  - name: fertilizer-advisor-service
    url: http://sahool-fertilizer-advisor:8093
    routes:
      - name: fertilizer-route
        paths:
          - /api/v1/fertilizer
          - /api/v1/fertilizer/recommend
          - /api/v1/soil/interpret
        strip_path: false

  # Irrigation Smart Service (v15.3)
  - name: irrigation-smart-service
    url: http://sahool-irrigation-smart:8094
    routes:
      - name: irrigation-route
        paths:
          - /api/v1/irrigation
          - /api/v1/irrigation/calculate
          - /api/v1/water-balance
        strip_path: false

  # Crop Health AI Service - Sahool Vision (v15.3)
  - name: crop-health-ai-service
    url: http://sahool-crop-health-ai:8095
    routes:
      - name: crop-health-ai-route
        paths:
          - /api/v1/diagnose
          - /api/v1/diseases
          - /api/v1/treatment
        strip_path: false

  # Virtual Sensors Service (v15.3)
  - name: virtual-sensors-service
    url: http://sahool-virtual-sensors:8096
    routes:
      - name: virtual-sensors-route
        paths:
          - /api/v1/et0
          - /api/v1/etc
          - /api/v1/soil-moisture
          - /api/v1/virtual-sensors
        strip_path: false

  # Community Chat Service (v15.3)
  - name: community-chat-service
    url: http://sahool-community-chat:8097
    routes:
      - name: community-chat-route
        paths:
          - /api/v1/chat/requests
          - /api/v1/chat/rooms
          - /api/v1/chat/experts
        strip_path: false

  # Yield Engine Service (v15.3)
  - name: yield-engine-service
    url: http://sahool-yield-engine:8098
    routes:
      - name: yield-route
        paths:
          - /api/v1/yield
          - /api/v1/yield/predict
          - /api/v1/yield/historical
        strip_path: false

# ─────────────────────────────────────────────────────────────────────────────
# Global Plugins
# ─────────────────────────────────────────────────────────────────────────────

plugins:
  # Rate Limiting
  - name: rate-limiting
    config:
      minute: 100
      hour: 5000
      policy: local

  # CORS
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Tenant-ID
        - X-Request-ID
      exposed_headers:
        - X-Request-ID
      credentials: true
      max_age: 3600

  # Request/Response Logging
  - name: file-log
    config:
      path: /dev/stdout
      reopen: true

  # Request ID
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true
