;; PGBouncer Configuration for SAHOOL Platform
;; Connection pooling for PostgreSQL to prevent connection exhaustion

[databases]
;; Main SAHOOL database
;; Password must be explicitly specified in connection string
;; The password should match POSTGRES_PASSWORD from .env file (default: password)
;; SECURITY: In production, ensure this matches your actual PostgreSQL password
sahool = host=postgres port=5432 dbname=sahool user=sahool password=password

;; Read replica (if available)
;; Note: postgres-replica not defined in docker-compose.yml, commented out
;; sahool_readonly = host=postgres-replica port=5432 dbname=sahool auth_user=sahool

;; Wildcard for dynamic database routing
* = host=postgres port=5432

[pgbouncer]
;; ═══════════════════════════════════════════════════════════════════════════
;; Connection Settings
;; ═══════════════════════════════════════════════════════════════════════════

;; Listen on all interfaces
listen_addr = 0.0.0.0
listen_port = 6432

;; Unix socket directory (optional)
; unix_socket_dir = /var/run/pgbouncer

;; Authentication
;; Use auth_query with security definer function for PostgreSQL 16 SCRAM-SHA-256 support
;; Using main database user for auth_query (has access via pgbouncer.get_auth function)
;; Using scram-sha-256 for PostgreSQL 16 compatibility (was md5)
auth_type = scram-sha-256
auth_query = SELECT usename, passwd FROM pgbouncer.get_auth($1)
auth_user = sahool

;; ═══════════════════════════════════════════════════════════════════════════
;; Pool Mode - CRITICAL for performance
;; ═══════════════════════════════════════════════════════════════════════════

;; Transaction mode: best for web applications
;; - Connections returned to pool after each transaction
;; - Cannot use session-level features (prepared statements, temp tables)
pool_mode = transaction

;; Session mode alternative (for apps needing session features):
; pool_mode = session

;; ═══════════════════════════════════════════════════════════════════════════
;; Pool Sizing - Tuned for SAHOOL services (39+ microservices)
;; Based on PostgreSQL audit recommendations (2026-01-06)
;; ═══════════════════════════════════════════════════════════════════════════

;; Maximum connections to PostgreSQL (across all pools)
;; AUDIT FIX: Increased from 150 to 250 for 39+ services
;; Calculation: 39 services × ~6 connections/service = ~234 connections needed
max_db_connections = 250

;; Default pool size per user/database pair
;; AUDIT FIX: Increased from 25 to 30 for better throughput under load
default_pool_size = 30

;; Minimum pool size (keep connections warm)
;; AUDIT FIX: Increased from 5 to 10 to maintain warm connection pool
min_pool_size = 10

;; Reserve connections for superuser
;; AUDIT FIX: Increased reserve pool for maintenance operations
reserve_pool_size = 10

;; Wait this long before using reserve pool
reserve_pool_timeout = 3

;; Maximum client connections to PGBouncer
;; AUDIT FIX: Increased from 500 to 800 to handle peak traffic
max_client_conn = 800

;; ═══════════════════════════════════════════════════════════════════════════
;; Timeouts
;; ═══════════════════════════════════════════════════════════════════════════

;; Close server connection if unused for this many seconds
server_idle_timeout = 600

;; Close client connection if idle for this many seconds
;; OPTIMIZED: Changed from 0 (disabled) to 900s (15 min) to free up idle connections
client_idle_timeout = 900

;; Cancel query if running longer than this
query_timeout = 120

;; Wait this long for a connection from pool
query_wait_timeout = 30

;; Login timeout
client_login_timeout = 60
server_login_retry = 15

;; ═══════════════════════════════════════════════════════════════════════════
;; Connection Lifecycle
;; ═══════════════════════════════════════════════════════════════════════════

;; How long to wait for network response
server_connect_timeout = 5

;; Close and reconnect after this many queries (removed: max_db_connection_queries is not a valid pgbouncer parameter)
;; Use server_lifetime instead to recycle connections periodically

;; Close connection after this many seconds
server_lifetime = 3600

;; Check server health every N seconds
server_check_delay = 30

;; Query to run for health check
server_check_query = SELECT 1

;; ═══════════════════════════════════════════════════════════════════════════
;; Logging
;; ═══════════════════════════════════════════════════════════════════════════

;; Log level (debug, info, warning, error)
;; OPTIMIZED: Added explicit log level for better control
;; NOTE: log_level parameter not supported in this pgbouncer version - using default
; log_level = info

;; Log connections
log_connections = 1

;; Log disconnections
log_disconnections = 1

;; Log pooler errors
log_pooler_errors = 1

;; Statistics period (seconds)
stats_period = 60

;; Syslog integration (optional - enable for centralized logging)
;; OPTIMIZED: Added syslog configuration for production monitoring
; syslog = 1
; syslog_facility = local0
; syslog_ident = pgbouncer-sahool

;; Verbose logging (0-2, higher = more verbose)
;; NOTE: Only enable for debugging (performance impact)
; verbose = 0

;; ═══════════════════════════════════════════════════════════════════════════
;; Admin Console
;; ═══════════════════════════════════════════════════════════════════════════

;; Admin users (can run SHOW commands)
admin_users = pgbouncer_admin

;; Stats users (can run SHOW STATS)
stats_users = pgbouncer_stats

;; Ignore startup parameters from client
;; AUDIT FIX: Added statement_timeout to ignored parameters (services set this at connection)
ignore_startup_parameters = extra_float_digits,jit,statement_timeout

;; ═══════════════════════════════════════════════════════════════════════════
;; Security
;; ═══════════════════════════════════════════════════════════════════════════

;; Disable dangerous features in transaction pooling mode
; disable_pqexec = 0

;; TLS Configuration - SECURITY FIX: Enable TLS for encrypted connections
;; Options: disable, allow, prefer, require, verify-ca, verify-full

;; Server TLS (PgBouncer -> PostgreSQL)
server_tls_sslmode = require
server_tls_ca_file = /etc/certs/ca.crt

;; Client TLS (Applications -> PgBouncer)
client_tls_sslmode = require
client_tls_key_file = /etc/certs/server.key
client_tls_cert_file = /etc/certs/server.crt
