;; PGBouncer Configuration for SAHOOL Platform
;; Connection pooling for PostgreSQL to prevent connection exhaustion

[databases]
;; Main SAHOOL database
;; auth_user connects to PostgreSQL to run auth_query for password verification
;; Note: Password for auth_user connection is handled by edoburu/pgbouncer image
;; The image uses DB_PASSWORD for the auth_user connection when auth_user is set
sahool = host=postgres port=5432 dbname=sahool auth_user=pgbouncer

;; Read replica (if available)
sahool_readonly = host=postgres-replica port=5432 dbname=sahool auth_user=pgbouncer

;; Per-service databases (optional, for isolation)
* = host=postgres port=5432 auth_user=pgbouncer

[pgbouncer]
;; ═══════════════════════════════════════════════════════════════════════════
;; Connection Settings
;; ═══════════════════════════════════════════════════════════════════════════

;; Listen on all interfaces
listen_addr = 0.0.0.0
listen_port = 6432

;; Unix socket directory (optional)
; unix_socket_dir = /var/run/pgbouncer

;; Authentication
;; Use auth_query to support SCRAM-SHA-256 (PostgreSQL 16 default)
;; This queries PostgreSQL directly for password verification
auth_type = scram-sha-256
auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1
auth_user = pgbouncer

;; ═══════════════════════════════════════════════════════════════════════════
;; Pool Mode - CRITICAL for performance
;; ═══════════════════════════════════════════════════════════════════════════

;; Transaction mode: best for web applications
;; - Connections returned to pool after each transaction
;; - Cannot use session-level features (prepared statements, temp tables)
pool_mode = transaction

;; Session mode alternative (for apps needing session features):
; pool_mode = session

;; ═══════════════════════════════════════════════════════════════════════════
;; Pool Sizing - Tuned for SAHOOL services
;; ═══════════════════════════════════════════════════════════════════════════

;; Maximum connections to PostgreSQL (across all pools)
max_db_connections = 100

;; Default pool size per user/database pair
default_pool_size = 20

;; Minimum pool size (keep connections warm)
min_pool_size = 5

;; Reserve connections for superuser
reserve_pool_size = 5

;; Wait this long before using reserve pool
reserve_pool_timeout = 3

;; Maximum client connections to PGBouncer
max_client_conn = 500

;; ═══════════════════════════════════════════════════════════════════════════
;; Timeouts
;; ═══════════════════════════════════════════════════════════════════════════

;; Close server connection if unused for this many seconds
server_idle_timeout = 600

;; Close client connection if idle for this many seconds
client_idle_timeout = 0

;; Cancel query if running longer than this
query_timeout = 120

;; Wait this long for a connection from pool
query_wait_timeout = 30

;; Login timeout
client_login_timeout = 60
server_login_retry = 15

;; ═══════════════════════════════════════════════════════════════════════════
;; Connection Lifecycle
;; ═══════════════════════════════════════════════════════════════════════════

;; How long to wait for network response
server_connect_timeout = 5

;; Close and reconnect after this many queries (removed: max_db_connection_queries is not a valid pgbouncer parameter)
;; Use server_lifetime instead to recycle connections periodically

;; Close connection after this many seconds
server_lifetime = 3600

;; Check server health every N seconds
server_check_delay = 30

;; Query to run for health check
server_check_query = SELECT 1

;; ═══════════════════════════════════════════════════════════════════════════
;; Logging
;; ═══════════════════════════════════════════════════════════════════════════

;; Log connections
log_connections = 1

;; Log disconnections
log_disconnections = 1

;; Log pooler errors
log_pooler_errors = 1

;; Statistics period (seconds)
stats_period = 60

;; ═══════════════════════════════════════════════════════════════════════════
;; Admin Console
;; ═══════════════════════════════════════════════════════════════════════════

;; Admin users (can run SHOW commands)
admin_users = pgbouncer_admin

;; Stats users (can run SHOW STATS)
stats_users = pgbouncer_stats

;; Ignore startup parameters from client
ignore_startup_parameters = extra_float_digits

;; ═══════════════════════════════════════════════════════════════════════════
;; Security
;; ═══════════════════════════════════════════════════════════════════════════

;; Disable dangerous features in transaction pooling mode
; disable_pqexec = 0

;; TLS configuration (for production)
; server_tls_sslmode = require
; server_tls_ca_file = /etc/pgbouncer/ca.crt

;; Client TLS
; client_tls_sslmode = require
; client_tls_cert_file = /etc/pgbouncer/server.crt
; client_tls_key_file = /etc/pgbouncer/server.key
