# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - HAProxy Configuration for PostgreSQL HA
# تكوين HAProxy للتوفر العالي لقاعدة البيانات
# ═══════════════════════════════════════════════════════════════════════════════
# Version: 1.0.0
# Purpose: Load balancing and automatic failover for PostgreSQL cluster
# ═══════════════════════════════════════════════════════════════════════════════

global
    maxconn 4096
    log stdout format raw local0 info
    stats socket /var/run/haproxy.sock mode 600 level admin
    stats timeout 2m

defaults
    log     global
    mode    tcp
    retries 3
    timeout client 30s
    timeout connect 5s
    timeout server 30s
    timeout check 5s

# ─────────────────────────────────────────────────────────────────────────────
# Stats Interface - HAProxy Monitoring
# ─────────────────────────────────────────────────────────────────────────────
listen stats
    mode http
    bind *:7000
    stats enable
    stats uri /
    stats refresh 5s
    stats show-legends
    stats show-node
    stats admin if TRUE

# ─────────────────────────────────────────────────────────────────────────────
# PostgreSQL Primary - Write Operations (Port 5432)
# ─────────────────────────────────────────────────────────────────────────────
listen postgres-primary
    bind *:5432
    mode tcp
    option tcplog
    option httpchk OPTIONS /master
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    # Primary node - write operations
    server postgres-primary 172.25.0.20:5432 maxconn 100 check port 8008
    server postgres-replica1 172.25.0.21:5432 maxconn 100 check port 8008 backup
    server postgres-replica2 172.25.0.22:5432 maxconn 100 check port 8008 backup

# ─────────────────────────────────────────────────────────────────────────────
# PostgreSQL Replicas - Read Operations (Port 5433)
# ─────────────────────────────────────────────────────────────────────────────
listen postgres-replicas
    bind *:5433
    mode tcp
    option tcplog
    option httpchk OPTIONS /replica
    http-check expect status 200
    balance roundrobin
    default-server inter 3s fall 3 rise 2

    # All nodes can serve read queries (including primary for load distribution)
    server postgres-primary 172.25.0.20:5432 maxconn 100 check port 8008
    server postgres-replica1 172.25.0.21:5432 maxconn 100 check port 8008
    server postgres-replica2 172.25.0.22:5432 maxconn 100 check port 8008

# ─────────────────────────────────────────────────────────────────────────────
# Patroni REST API - Cluster Management (Port 8008)
# ─────────────────────────────────────────────────────────────────────────────
listen patroni-api
    bind *:8008
    mode http
    option httplog
    balance roundrobin

    server postgres-primary 172.25.0.20:8008 maxconn 50 check
    server postgres-replica1 172.25.0.21:8008 maxconn 50 check
    server postgres-replica2 172.25.0.22:8008 maxconn 50 check
