_format_version: "3.0"
_transform: true

# ------------------------------------------------------------------------------
# Kong Declarative Config (DB-less)
# Generated from docker-compose.yml
# Fix applied: service.name + service.host (docker DNS) + service.port (internal)
# Only includes services that actually exist in docker-compose.yml
# ------------------------------------------------------------------------------

# Optional: global plugins (applies to all routes/services)
plugins:
  - name: cors
    config:
      origins:
        - "https://sahool.kafaat.com"
        - "https://admin.sahool.kafaat.com"
        - "https://app.sahool.kafaat.com"
        - "https://api.sahool.kafaat.com"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Request-ID
        - X-Tenant-ID
      exposed_headers:
        - X-Request-ID
      credentials: true
      max_age: 3600

  - name: prometheus
    config: {}

  # JWT Authentication with claims verification for token revocation support
  # Note: jti (JWT ID) claim is used for token revocation via blacklist
  - name: jwt
    config:
      # URI parameter names to check for JWT (e.g., ?jwt=<token>)
      uri_param_names:
        - jwt
      # Cookie names to check for JWT (disabled for security)
      cookie_names: []
      # Claims to verify - exp required for revocation support
      claims_to_verify:
        - exp
      # Key claim name (identifies the consumer/issuer)
      key_claim_name: iss
      # Secret is not base64 encoded
      secret_is_base64: false
      # No anonymous access - require valid JWT
      anonymous: null
      # Run JWT validation on preflight (OPTIONS) requests
      run_on_preflight: true
      # Maximum token lifetime (1 hour) - short-lived tokens for security
      maximum_expiration: 3600

  # OpenID Connect plugin for token introspection and revocation checking
  # This enables real-time token validation against the identity provider
  - name: openid-connect
    config:
      # OIDC Issuer URL (identity provider)
      issuer: ${OIDC_ISSUER_URL}
      # Token introspection endpoint for revocation status checking
      introspection_endpoint: ${OIDC_INTROSPECTION_URL}
      # Token endpoint for token exchange
      token_endpoint: ${OIDC_TOKEN_URL}
      # Enable JWT token introspection for revocation checking
      introspect_jwt_tokens: true
      # Verify token signature
      verify_signature: true
      # Cache introspection results (seconds) - short TTL for revocation responsiveness
      introspection_cache_ttl: 60
      # Additional security settings
      ssl_verify: true
      # Scopes to validate
      scopes_required: []
      # Audience claim validation (optional)
      audience_required: []

  # Global rate limiting to prevent token abuse and brute-force attacks
  - name: rate-limiting
    config:
      # Rate limit: 60 requests per minute
      minute: 60
      # Use Redis for distributed rate limiting across Kong nodes
      policy: redis
      # Redis connection settings
      redis_host: redis
      redis_port: 6379
      redis_password: ${REDIS_PASSWORD}
      redis_database: 1
      redis_timeout: 2000
      # Fault tolerant - allow requests if Redis is unavailable
      fault_tolerant: true
      # Show rate limit headers to clients
      hide_client_headers: false

  # Redis-based token blacklist for revocation
  # This plugin checks if the token's jti is in the Redis blacklist
  # Note: Requires custom plugin or use key-auth with Redis for blacklist checking
  # Alternative: Use response-transformer to add revocation headers for downstream validation
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Token-Revocation-Check:enabled"
          - "X-Revocation-Endpoint:/api/v1/auth/revoke"
          - "X-Token-Introspection-Endpoint:/api/v1/auth/introspect"

# ------------------------------------------------------------------------------
# Services + Routes
# NOTE:
# - host MUST be the docker-compose service key (not container_name)
# - port is the container listen port (your PORT env var)
# - Only services that exist in docker-compose.yml are included
# ------------------------------------------------------------------------------

services:
  # -----------------------------
  # Node.js services
  # -----------------------------
  - name: field-management-service
    host: field-management-service
    port: 3000
    protocol: http
    routes:
      - name: field-management-service-route
        paths: ["/api/v1/fields", "/api/v1/field", "/field"]
        strip_path: true
        protocols: ["http", "https"]

  - name: user-service
    host: user-service
    port: 3025
    protocol: http
    routes:
      - name: user-service-route
        paths: ["/api/v1/auth", "/api/v1/users", "/auth", "/users"]
        strip_path: true
        protocols: ["http", "https"]
      # Token revocation endpoint - requires POST method only
      - name: token-revocation-route
        paths: ["/api/v1/auth/revoke", "/auth/revoke"]
        methods: ["POST"]
        strip_path: true
        protocols: ["http", "https"]
      # Token introspection endpoint for revocation status check
      - name: token-introspection-route
        paths: ["/api/v1/auth/introspect", "/auth/introspect"]
        methods: ["POST"]
        strip_path: true
        protocols: ["http", "https"]
      # Token blacklist check endpoint (internal use)
      - name: token-blacklist-route
        paths: ["/api/v1/auth/blacklist", "/auth/blacklist"]
        methods: ["GET", "POST"]
        strip_path: true
        protocols: ["http", "https"]
    plugins:
      # Rate limiting for authentication endpoints to prevent brute-force attacks
      - name: rate-limiting
        config:
          # Stricter limits for auth endpoints
          second: 5
          minute: 30
          hour: 200
          # Use Redis for distributed rate limiting
          policy: redis
          fault_tolerant: true
          hide_client_headers: false
          redis_host: redis
          redis_port: 6379
          redis_password: ${REDIS_PASSWORD}
          redis_database: 1
          redis_timeout: 2000

  - name: marketplace-service
    host: marketplace-service
    port: 3010
    protocol: http
    routes:
      - name: marketplace-service-route
        paths: ["/api/v1/marketplace", "/marketplace"]
        strip_path: true
        protocols: ["http", "https"]

  - name: research-core
    host: research-core
    port: 3015
    protocol: http
    routes:
      - name: research-core-route
        paths: ["/api/v1/research", "/research"]
        strip_path: true
        protocols: ["http", "https"]

  - name: disaster-assessment
    host: disaster-assessment
    port: 3020
    protocol: http
    routes:
      - name: disaster-assessment-route
        paths: ["/api/v1/disaster", "/disaster"]
        strip_path: true
        protocols: ["http", "https"]

  # DEPRECATED (still routable if needed)
  - name: yield-prediction
    host: yield-prediction
    port: 3021
    protocol: http
    routes:
      - name: yield-prediction-route
        paths: ["/yield-legacy"]
        strip_path: true
        protocols: ["http", "https"]

  # DEPRECATED (still routable if needed)
  - name: lai-estimation
    host: lai-estimation
    port: 3022
    protocol: http
    routes:
      - name: lai-estimation-route
        paths: ["/lai-legacy"]
        strip_path: true
        protocols: ["http", "https"]

  # DEPRECATED (still routable if needed)
  - name: crop-growth-model
    host: crop-growth-model
    port: 3023
    protocol: http
    routes:
      - name: crop-growth-model-route
        paths: ["/crop-growth-legacy"]
        strip_path: true
        protocols: ["http", "https"]

  - name: chat-service
    host: chat-service
    port: 8114
    protocol: http
    routes:
      - name: chat-service-route
        paths: ["/api/v1/chat", "/chat"]
        strip_path: true
        protocols: ["http", "https"]

  - name: iot-service
    host: iot-service
    port: 8117
    protocol: http
    routes:
      - name: iot-service-route
        paths: ["/api/v1/iot", "/iot"]
        strip_path: true
        protocols: ["http", "https"]

  # Community Chat - Posts and community features
  - name: community-chat
    host: community-chat
    port: 8097
    protocol: http
    routes:
      - name: community-chat-route
        paths: ["/api/v1/community", "/api/v1/posts", "/community", "/community-chat-legacy"]
        strip_path: true
        protocols: ["http", "https"]

  # -----------------------------
  # Python services
  # -----------------------------
  # DEPRECATED profile (only runs if profile enabled)
  - name: field-ops
    host: field-ops
    port: 8080
    protocol: http
    routes:
      - name: field-ops-route
        paths: ["/field-ops-legacy"]
        strip_path: true
        protocols: ["http", "https"]

  - name: ws-gateway
    host: ws-gateway
    port: 8081
    protocol: http
    routes:
      - name: ws-gateway-route
        paths: ["/ws"]
        strip_path: true
        protocols: ["http", "https"]

  - name: billing-core
    host: billing-core
    port: 8089
    protocol: http
    routes:
      - name: billing-core-route
        paths: ["/api/v1/billing", "/billing"]
        strip_path: true
        protocols: ["http", "https"]

  - name: vegetation-analysis-service
    host: vegetation-analysis-service
    port: 8090
    protocol: http
    routes:
      - name: vegetation-analysis-service-route
        paths: ["/api/v1/vegetation", "/vegetation"]
        strip_path: true
        protocols: ["http", "https"]
      - name: satellite-route
        paths: ["/api/v1/satellite", "/satellite"]
        strip_path: true
        protocols: ["http", "https"]
      - name: ndvi-route
        paths: ["/api/v1/ndvi", "/ndvi"]
        strip_path: true
        protocols: ["http", "https"]

  - name: indicators-service
    host: indicators-service
    port: 8091
    protocol: http
    routes:
      - name: indicators-service-route
        paths: ["/api/v1/indicators", "/indicators"]
        strip_path: true
        protocols: ["http", "https"]

  - name: weather-service
    host: weather-service
    port: 8092
    protocol: http
    routes:
      - name: weather-service-route
        paths: ["/api/v1/weather", "/weather"]
        strip_path: true
        protocols: ["http", "https"]

  - name: advisory-service
    host: advisory-service
    port: 8093
    protocol: http
    routes:
      - name: advisory-service-route
        paths: ["/api/v1/advisory", "/api/v1/fertilizer", "/advisory", "/fertilizer"]
        strip_path: true
        protocols: ["http", "https"]

  - name: irrigation-smart
    host: irrigation-smart
    port: 8094
    protocol: http
    routes:
      - name: irrigation-smart-route
        paths: ["/api/v1/irrigation", "/irrigation"]
        strip_path: true
        protocols: ["http", "https"]

  - name: crop-intelligence-service
    host: crop-intelligence-service
    port: 8095
    protocol: http
    routes:
      - name: crop-intelligence-service-route
        paths: ["/api/v1/crop-health", "/api/v1/crop", "/crop"]
        strip_path: true
        protocols: ["http", "https"]

  - name: virtual-sensors
    host: virtual-sensors
    port: 8119
    protocol: http
    routes:
      - name: virtual-sensors-route
        paths: ["/api/v1/virtual-sensors", "/virtual-sensors"]
        strip_path: true
        protocols: ["http", "https"]

  - name: yield-prediction-service
    host: yield-prediction-service
    port: 8098
    protocol: http
    routes:
      - name: yield-prediction-service-route
        paths: ["/api/v1/yield", "/yield"]
        strip_path: true
        protocols: ["http", "https"]

  - name: field-chat
    host: field-chat
    port: 8099
    protocol: http
    routes:
      - name: field-chat-route
        paths: ["/api/v1/field-chat", "/field-chat"]
        strip_path: true
        protocols: ["http", "https"]

  - name: equipment-service
    host: equipment-service
    port: 8101
    protocol: http
    routes:
      - name: equipment-service-route
        paths: ["/api/v1/equipment", "/equipment"]
        strip_path: true
        protocols: ["http", "https"]

  # gpu profile (only if enabled)
  - name: code-review-service
    host: code-review-service
    port: 8102
    protocol: http
    routes:
      - name: code-review-service-route
        paths: ["/api/v1/code-review", "/code-review"]
        strip_path: true
        protocols: ["http", "https"]

  - name: task-service
    host: task-service
    port: 8103
    protocol: http
    routes:
      - name: task-service-route
        paths: ["/api/v1/tasks", "/api/v1/task", "/task"]
        strip_path: true
        protocols: ["http", "https"]

  - name: provider-config
    host: provider-config
    port: 8104
    protocol: http
    routes:
      - name: provider-config-route
        paths: ["/api/v1/provider-config", "/provider-config"]
        strip_path: true
        protocols: ["http", "https"]

  # Agro Advisor - Agricultural advice and rules
  - name: agro-advisor
    host: agro-advisor
    port: 8105
    protocol: http
    routes:
      - name: agro-advisor-route
        paths: ["/api/v1/agro-advisor", "/api/v1/agro-rules", "/agro-advisor", "/agro-advisor-legacy"]
        strip_path: true
        protocols: ["http", "https"]

  - name: iot-gateway
    host: iot-gateway
    port: 8106
    protocol: http
    routes:
      - name: iot-gateway-route
        paths: ["/api/v1/iot-gateway", "/iot-gateway"]
        strip_path: true
        protocols: ["http", "https"]

  # DEPRECATED
  - name: ndvi-engine
    host: ndvi-engine
    port: 8107
    protocol: http
    routes:
      - name: ndvi-engine-route
        paths: ["/ndvi-engine-legacy"]
        strip_path: true
        protocols: ["http", "https"]

  # Weather Core - Advanced weather assessment (POST-based API with lat/lon)
  - name: weather-core
    host: weather-core
    port: 8108
    protocol: http
    routes:
      - name: weather-core-route
        paths: ["/api/v1/weather-core", "/weather-core", "/weather-core-legacy"]
        strip_path: true
        protocols: ["http", "https"]

  - name: notification-service
    host: notification-service
    port: 8110
    protocol: http
    routes:
      - name: notification-service-route
        paths: ["/api/v1/notifications", "/api/v1/notification", "/notification"]
        strip_path: true
        protocols: ["http", "https"]
      - name: notification-channels-route
        paths: ["/api/v1/channels"]
        strip_path: true
        protocols: ["http", "https"]
      - name: notification-preferences-route
        paths: ["/api/v1/preferences"]
        strip_path: true
        protocols: ["http", "https"]
      - name: notification-alerts-route
        paths: ["/api/v1/alerts", "/alerts"]
        strip_path: true
        protocols: ["http", "https"]
      - name: notification-stats-route
        paths: ["/api/v1/notification-stats"]
        strip_path: true
        protocols: ["http", "https"]
      - name: notification-reminders-route
        paths: ["/api/v1/reminders"]
        strip_path: true
        protocols: ["http", "https"]
      - name: notification-farmers-route
        paths: ["/api/v1/farmers"]
        strip_path: true
        protocols: ["http", "https"]

  - name: astronomical-calendar
    host: astronomical-calendar
    port: 8111
    protocol: http
    routes:
      - name: astronomical-calendar-route
        paths: ["/api/v1/astronomy", "/astronomy"]
        strip_path: true
        protocols: ["http", "https"]

  - name: ai-advisor
    host: ai-advisor
    port: 8112
    protocol: http
    routes:
      - name: ai-advisor-route
        paths: ["/api/v1/ai-advisor", "/ai-advisor"]
        strip_path: true
        protocols: ["http", "https"]

  - name: alert-service
    host: alert-service
    port: 8113
    protocol: http
    routes:
      - name: alert-service-route
        paths: ["/api/v1/alerts", "/alerts"]
        strip_path: true
        protocols: ["http", "https"]

  - name: field-service
    host: field-service
    port: 8115
    protocol: http
    routes:
      - name: field-service-route
        paths: ["/field-service-legacy"]
        strip_path: true
        protocols: ["http", "https"]

  - name: inventory-service
    host: inventory-service
    port: 8116
    protocol: http
    routes:
      - name: inventory-service-route
        paths: ["/api/v1/inventory", "/inventory"]
        strip_path: true
        protocols: ["http", "https"]

  - name: ndvi-processor
    host: ndvi-processor
    port: 8118
    protocol: http
    routes:
      - name: ndvi-processor-route
        paths: ["/ndvi-processor-legacy"]
        strip_path: true
        protocols: ["http", "https"]

  - name: field-intelligence
    host: field-intelligence
    port: 8120
    protocol: http
    routes:
      - name: field-intelligence-route
        paths: ["/api/v1/field-intelligence", "/api/v1/field-core", "/field-intelligence"]
        strip_path: true
        protocols: ["http", "https"]

  - name: mcp-server
    host: mcp-server
    port: 8200
    protocol: http
    routes:
      - name: mcp-server-route
        paths: ["/api/v1/mcp", "/mcp"]
        strip_path: true
        protocols: ["http", "https"]

  - name: skills-service
    host: skills-service
    port: 8121
    protocol: http
    routes:
      - name: skills-service-route
        paths: ["/api/v1/skills", "/skills"]
        strip_path: true
        protocols: ["http", "https"]

  # -----------------------------
  # Token Blacklist Service (Internal)
  # -----------------------------
  # This service handles token revocation and blacklist management
  # It connects to Redis to store/check revoked token JTIs
  - name: token-blacklist-service
    host: user-service
    port: 3025
    protocol: http
    routes:
      # Internal endpoint for token validation (used by other services)
      - name: token-validate-route
        paths: ["/internal/token/validate"]
        methods: ["POST"]
        strip_path: true
        protocols: ["http", "https"]
      # Internal endpoint for batch token validation
      - name: token-batch-validate-route
        paths: ["/internal/token/batch-validate"]
        methods: ["POST"]
        strip_path: true
        protocols: ["http", "https"]
      # Internal endpoint for token revocation events (NATS webhook)
      - name: token-revocation-webhook-route
        paths: ["/internal/token/revocation-webhook"]
        methods: ["POST"]
        strip_path: true
        protocols: ["http", "https"]
    plugins:
      # Strict rate limiting for internal token validation endpoints
      - name: rate-limiting
        config:
          second: 100
          minute: 1000
          policy: redis
          redis_host: redis
          redis_port: 6379
          redis_password: ${REDIS_PASSWORD}
          redis_database: 1
          fault_tolerant: true
          hide_client_headers: true
      # IP restriction - only allow internal services
      - name: ip-restriction
        config:
          allow:
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
            - 127.0.0.1/32
          status: 403
          message: "Access denied - internal endpoint"

  # -----------------------------
  # Platform endpoints
  # -----------------------------
  - name: root-endpoint
    url: http://kong:8000
    routes:
      - name: root-route
        paths: ["/"]
        strip_path: false
        protocols: ["http", "https"]
        methods: ["GET"]
    plugins:
      - name: request-termination
        config:
          status_code: 200
          content_type: "application/json"
          body: '{"platform":"SAHOOL","version":"16.0.0","description":"National Agricultural Intelligence Platform","status":"operational","endpoints":{"/health":"Health check","/ping":"Ping check","/api/v1":"API Gateway"},"documentation":"https://github.com/kafaat/sahool-unified-v15-idp"}'

  - name: health-check
    url: http://kong:8000
    routes:
      - name: health-route
        paths: ["/health", "/ping"]
        strip_path: false
        protocols: ["http", "https"]
        methods: ["GET"]
    plugins:
      - name: request-termination
        config:
          status_code: 200
          message: "SAHOOL Platform is healthy"

# ------------------------------------------------------------------------------
# Intentionally NOT added to Kong (non-HTTP APIs / internal infra / workers)
# - postgres, pgbouncer, redis, nats, nats-prometheus-exporter, mqtt, qdrant
# - etcd, etcd-init, minio, milvus
# - agro-rules (worker, no HTTP)
# - demo-data (client, not an API)
# - ollama / ollama-model-loader (only if you want to expose)
# - crop-health (check if it has HTTP endpoints)
# ------------------------------------------------------------------------------

# ==============================================================================
# TOKEN REVOCATION CONFIGURATION
# ==============================================================================
#
# REQUIRED ENVIRONMENT VARIABLES:
# --------------------------------
# OIDC_ISSUER_URL        - OpenID Connect issuer URL (e.g., https://auth.sahool.kafaat.com)
# OIDC_INTROSPECTION_URL - Token introspection endpoint for revocation checking
# OIDC_TOKEN_URL         - Token endpoint for token exchange/refresh
# REDIS_PASSWORD         - Redis password for rate limiting and blacklist storage
#
# Token Revocation Architecture:
# 1. JWT tokens include a 'jti' (JWT ID) claim for unique identification
# 2. When a token is revoked, its jti is added to a Redis blacklist
# 3. The openid-connect plugin validates tokens against the introspection endpoint
# 4. The user-service handles token revocation via /api/v1/auth/revoke endpoint
# 5. Downstream services validate tokens against the Redis blacklist
#
# Plugins Enabled for Token Revocation:
# 1. jwt           - Validates JWT tokens, checks exp claim, enforces 1-hour max expiration
# 2. openid-connect - Introspects tokens for real-time revocation status
# 3. rate-limiting  - Prevents token abuse with Redis-backed distributed limiting
# 4. response-transformer - Adds revocation headers for downstream validation
#
# Redis Configuration:
# - Key pattern: sahool:revoked_tokens:{jti}
# - TTL: Set to match the token's remaining lifetime (max 1 hour with new config)
# - Redis database: 1 (separate from session storage)
# - Rate limiting data also stored in Redis database 1
#
# Public Revocation Endpoints (via user-service):
# - POST /api/v1/auth/revoke       - Revoke a specific token (requires token in body)
# - POST /api/v1/auth/introspect   - Check if a token is valid/revoked (OIDC-compliant)
# - GET  /api/v1/auth/blacklist    - List revoked tokens (admin only)
# - POST /api/v1/auth/blacklist    - Manually blacklist a token (admin only)
#
# Internal Endpoints (via token-blacklist-service):
# - POST /internal/token/validate       - Validate token against blacklist (internal)
# - POST /internal/token/batch-validate - Batch validate tokens (internal)
# - POST /internal/token/revocation-webhook - Receive revocation events (NATS)
#
# Request Format for /api/v1/auth/revoke:
# {
#   "token": "<JWT_TOKEN_TO_REVOKE>",
#   "reason": "logout|security|admin_action"
# }
#
# Response Format:
# {
#   "success": true,
#   "jti": "<TOKEN_JTI>",
#   "revoked_at": "2025-01-16T12:00:00Z",
#   "expires_at": "2025-01-16T13:00:00Z"
# }
#
# Token Introspection Response (RFC 7662 compliant):
# {
#   "active": true|false,
#   "scope": "read write",
#   "client_id": "sahool-mobile-app",
#   "username": "farmer@example.com",
#   "token_type": "Bearer",
#   "exp": 1705410000,
#   "iat": 1705406400,
#   "sub": "user-uuid",
#   "aud": "sahool-api",
#   "iss": "https://auth.sahool.kafaat.com",
#   "jti": "unique-token-id"
# }
#
# Rate Limiting Tiers:
# - Global: 60 requests/minute (all endpoints)
# - Auth endpoints: 5/second, 30/minute, 200/hour (stricter for security)
# - Internal endpoints: 100/second, 1000/minute (high throughput for service-to-service)
#
# For custom Kong plugin (advanced):
# To implement a pre-function plugin that checks Redis directly:
#
# plugins:
#   - name: pre-function
#     config:
#       access:
#         - |
#           local redis = require "resty.redis"
#           local jwt_decoder = require "kong.plugins.jwt.jwt_parser"
#           local red = redis:new()
#           red:set_timeout(1000)
#           local ok, err = red:connect("redis", 6379)
#           if ok then
#             red:auth(os.getenv("REDIS_PASSWORD"))
#             red:select(1)  -- Use database 1 for token blacklist
#             local token = kong.request.get_header("Authorization")
#             if token then
#               token = token:gsub("Bearer ", "")
#               local jwt, err = jwt_decoder:new(token)
#               if jwt and jwt.claims and jwt.claims.jti then
#                 local revoked = red:get("sahool:revoked_tokens:" .. jwt.claims.jti)
#                 if revoked and revoked ~= ngx.null then
#                   return kong.response.exit(401, { message = "Token has been revoked" })
#                 end
#               end
#             end
#           end
#
# Note: The above pre-function plugin requires Kong Enterprise or custom plugin
# development. For Kong OSS, token revocation is handled by:
# 1. openid-connect plugin introspection (if OIDC provider available)
# 2. user-service middleware which checks Redis on each authenticated request
# ==============================================================================
