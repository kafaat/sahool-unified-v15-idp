# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - Prometheus Alert Rules
# قواعد التنبيهات لمنصة سهول الزراعية
# ═══════════════════════════════════════════════════════════════════════════════
# Version: 1.0.0
# Date: 2025-12-25

groups:
  # ═══════════════════════════════════════════════════════════════════════════
  # Service Availability Alerts - تنبيهات توفر الخدمات
  # ═══════════════════════════════════════════════════════════════════════════
  - name: sahool_service_availability
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 2m
        labels:
          severity: critical
          category: availability
          platform: sahool
        annotations:
          summary: "Service {{ $labels.service }} is down"
          summary_ar: "الخدمة {{ $labels.service }} متوقفة"
          description: |
            Service {{ $labels.service }} ({{ $labels.tier }}) has been down for more than 2 minutes.
            Job: {{ $labels.job }}
            Instance: {{ $labels.instance }}
          description_ar: |
            الخدمة {{ $labels.service }} ({{ $labels.tier }}) متوقفة منذ أكثر من دقيقتين.
            الوظيفة: {{ $labels.job }}
            المثيل: {{ $labels.instance }}
          impact: "Users cannot access {{ $labels.service }} functionality"
          impact_ar: "المستخدمون لا يمكنهم الوصول إلى وظائف {{ $labels.service }}"
          action: "Check service logs and restart if necessary"
          action_ar: "تحقق من سجلات الخدمة وأعد التشغيل إذا لزم الأمر"

      - alert: ServiceDegradedAvailability
        expr: avg_over_time(up[5m]) < 0.95
        for: 5m
        labels:
          severity: warning
          category: availability
          platform: sahool
        annotations:
          summary: "Service {{ $labels.service }} has degraded availability"
          summary_ar: "الخدمة {{ $labels.service }} لديها توفر منخفض"
          description: "Service availability is {{ $value | humanizePercentage }} over the last 5 minutes"
          description_ar: "توفر الخدمة {{ $value | humanizePercentage }} خلال آخر 5 دقائق"

      - alert: MultipleServicesDown
        expr: count(up{tier="application"} == 0) > 3
        for: 1m
        labels:
          severity: critical
          category: availability
          platform: sahool
        annotations:
          summary: "Multiple services are down ({{ $value }} services)"
          summary_ar: "عدة خدمات متوقفة ({{ $value }} خدمة)"
          description: "Platform is experiencing widespread outage"
          description_ar: "المنصة تعاني من انقطاع واسع النطاق"
          action: "URGENT: Check infrastructure services (Postgres, Redis, NATS)"
          action_ar: "عاجل: تحقق من خدمات البنية التحتية (Postgres, Redis, NATS)"

  # ═══════════════════════════════════════════════════════════════════════════
  # Performance Alerts - تنبيهات الأداء
  # ═══════════════════════════════════════════════════════════════════════════
  - name: sahool_service_performance
    interval: 15s
    rules:
      - alert: HighLatencyP95
        expr: |
          histogram_quantile(0.95,
            sum by (service, tier, le) (
              rate(http_request_duration_seconds_bucket[5m])
            )
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          category: performance
          platform: sahool
        annotations:
          summary: "High P95 latency for {{ $labels.service }}"
          summary_ar: "زمن استجابة عالي P95 لخدمة {{ $labels.service }}"
          description: "95th percentile latency is {{ $value }}s (threshold: 500ms)"
          description_ar: "زمن الاستجابة في النسبة المئوية 95 هو {{ $value }} ثانية (الحد: 500 مللي ثانية)"
          impact: "Users experiencing slow response times"
          impact_ar: "المستخدمون يعانون من أوقات استجابة بطيئة"

      - alert: HighLatencyP99
        expr: |
          histogram_quantile(0.99,
            sum by (service, tier, le) (
              rate(http_request_duration_seconds_bucket[5m])
            )
          ) > 1
        for: 3m
        labels:
          severity: critical
          category: performance
          platform: sahool
        annotations:
          summary: "Very high P99 latency for {{ $labels.service }}"
          summary_ar: "زمن استجابة عالي جداً P99 لخدمة {{ $labels.service }}"
          description: "99th percentile latency is {{ $value }}s (threshold: 1s)"
          description_ar: "زمن الاستجابة في النسبة المئوية 99 هو {{ $value }} ثانية (الحد: 1 ثانية)"

      - alert: HighAverageLatency
        expr: |
          rate(http_request_duration_seconds_sum[5m])
          /
          rate(http_request_duration_seconds_count[5m])
          > 0.3
        for: 5m
        labels:
          severity: warning
          category: performance
          platform: sahool
        annotations:
          summary: "High average latency for {{ $labels.service }}"
          summary_ar: "متوسط زمن استجابة عالي لخدمة {{ $labels.service }}"
          description: "Average latency is {{ $value }}s"
          description_ar: "متوسط زمن الاستجابة {{ $value }} ثانية"

  # ═══════════════════════════════════════════════════════════════════════════
  # Error Rate Alerts - تنبيهات معدل الأخطاء
  # ═══════════════════════════════════════════════════════════════════════════
  - name: sahool_error_rates
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: |
          (
            sum by (service, tier) (rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum by (service, tier) (rate(http_requests_total[5m]))
          ) > 0.01
        for: 3m
        labels:
          severity: critical
          category: errors
          platform: sahool
        annotations:
          summary: "High error rate for {{ $labels.service }}"
          summary_ar: "معدل أخطاء عالي لخدمة {{ $labels.service }}"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 1%)"
          description_ar: "معدل الأخطاء {{ $value | humanizePercentage }} (الحد: 1%)"
          impact: "Service reliability is degraded"
          impact_ar: "موثوقية الخدمة منخفضة"
          action: "Check application logs for error patterns"
          action_ar: "تحقق من سجلات التطبيق لأنماط الأخطاء"

      - alert: CriticalErrorRate
        expr: |
          (
            sum by (service, tier) (rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum by (service, tier) (rate(http_requests_total[5m]))
          ) > 0.05
        for: 1m
        labels:
          severity: critical
          category: errors
          platform: sahool
        annotations:
          summary: "CRITICAL: Very high error rate for {{ $labels.service }}"
          summary_ar: "حرج: معدل أخطاء عالي جداً لخدمة {{ $labels.service }}"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
          description_ar: "معدل الأخطاء {{ $value | humanizePercentage }} (الحد: 5%)"
          action: "URGENT: Service may need immediate attention or rollback"
          action_ar: "عاجل: الخدمة قد تحتاج اهتمام فوري أو التراجع عن التحديث"

      - alert: ElevatedClientErrors
        expr: |
          (
            sum by (service, tier) (rate(http_requests_total{status=~"4.."}[5m]))
            /
            sum by (service, tier) (rate(http_requests_total[5m]))
          ) > 0.10
        for: 5m
        labels:
          severity: warning
          category: errors
          platform: sahool
        annotations:
          summary: "Elevated 4xx error rate for {{ $labels.service }}"
          summary_ar: "ارتفاع معدل أخطاء 4xx لخدمة {{ $labels.service }}"
          description: "Client error rate is {{ $value | humanizePercentage }}"
          description_ar: "معدل أخطاء العميل {{ $value | humanizePercentage }}"

  # ═══════════════════════════════════════════════════════════════════════════
  # Database Alerts - تنبيهات قاعدة البيانات
  # ═══════════════════════════════════════════════════════════════════════════
  - name: sahool_database_alerts
    interval: 30s
    rules:
      - alert: DatabaseConnectionPoolExhausted
        expr: |
          (
            pg_stat_database_numbackends{datname="sahool"}
            /
            pg_settings_max_connections
          ) > 0.85
        for: 3m
        labels:
          severity: critical
          category: database
          platform: sahool
        annotations:
          summary: "PostgreSQL connection pool nearly exhausted"
          summary_ar: "مجموعة اتصالات PostgreSQL شبه مستنفدة"
          description: "Database is using {{ $value | humanizePercentage }} of available connections"
          description_ar: "قاعدة البيانات تستخدم {{ $value | humanizePercentage }} من الاتصالات المتاحة"
          impact: "New connections may be rejected"
          impact_ar: "قد يتم رفض الاتصالات الجديدة"
          action: "Investigate connection leaks or increase max_connections"
          action_ar: "تحقق من تسرب الاتصالات أو زيادة max_connections"

      - alert: DatabaseHighConnectionRate
        expr: rate(pg_stat_database_numbackends[5m]) > 50
        for: 5m
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "High database connection rate"
          summary_ar: "معدل اتصال عالي بقاعدة البيانات"
          description: "Connection rate is {{ $value }}/sec"
          description_ar: "معدل الاتصال {{ $value }}/ثانية"

      - alert: DatabaseSlowQueries
        expr: pg_stat_activity_max_tx_duration > 30
        for: 5m
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "Slow database queries detected"
          summary_ar: "تم اكتشاف استعلامات بطيئة في قاعدة البيانات"
          description: "Longest running query: {{ $value }}s"
          description_ar: "أطول استعلام قيد التشغيل: {{ $value }} ثانية"
          action: "Check pg_stat_activity for slow queries"
          action_ar: "تحقق من pg_stat_activity للاستعلامات البطيئة"

      - alert: DatabaseDeadlocks
        expr: rate(pg_stat_database_deadlocks[5m]) > 0
        for: 1m
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "Database deadlocks detected"
          summary_ar: "تم اكتشاف جمود في قاعدة البيانات"
          description: "Deadlock rate: {{ $value }}/sec"
          description_ar: "معدل الجمود: {{ $value }}/ثانية"

      # ─────────────────────────────────────────────────────────────────────────
      # Advanced Database Health Alerts - تنبيهات متقدمة لصحة قاعدة البيانات
      # ─────────────────────────────────────────────────────────────────────────

      - alert: DatabaseWALSizeHigh
        expr: pg_wal_size_bytes > 1073741824  # 1GB
        for: 10m
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "PostgreSQL WAL size is high"
          summary_ar: "حجم WAL لـ PostgreSQL عالي"
          description: "WAL directory size is {{ $value | humanize1024 }}B (threshold: 1GB)"
          description_ar: "حجم دليل WAL هو {{ $value | humanize1024 }}B (الحد: 1GB)"
          impact: "Risk of disk space exhaustion"
          impact_ar: "خطر استنفاد مساحة القرص"
          action: "Check for replication lag or archiving issues. Consider increasing wal_keep_size or fixing replication."
          action_ar: "تحقق من تأخر النسخ المتماثل أو مشاكل الأرشفة"

      - alert: DatabaseWALSizeCritical
        expr: pg_wal_size_bytes > 5368709120  # 5GB
        for: 5m
        labels:
          severity: critical
          category: database
          platform: sahool
        annotations:
          summary: "CRITICAL: PostgreSQL WAL size is critically high"
          summary_ar: "حرج: حجم WAL لـ PostgreSQL عالي جداً"
          description: "WAL directory size is {{ $value | humanize1024 }}B (threshold: 5GB)"
          description_ar: "حجم دليل WAL هو {{ $value | humanize1024 }}B (الحد: 5GB)"
          action: "URGENT: WAL files are accumulating. Check replication and archiving immediately."
          action_ar: "عاجل: ملفات WAL تتراكم. تحقق من النسخ المتماثل والأرشفة فوراً"

      - alert: DatabaseAutovacuumNotRunning
        expr: pg_autovacuum_activity_seconds_since_last_autovacuum > 86400  # 24 hours
        for: 1h
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "Autovacuum has not run recently on table {{ $labels.relname }}"
          summary_ar: "التنظيف التلقائي لم يعمل مؤخراً على الجدول {{ $labels.relname }}"
          description: "Table {{ $labels.schemaname }}.{{ $labels.relname }} has not been vacuumed in {{ $value | humanizeDuration }}"
          description_ar: "الجدول {{ $labels.schemaname }}.{{ $labels.relname }} لم يتم تنظيفه منذ {{ $value | humanizeDuration }}"
          impact: "Table bloat may be increasing, degrading query performance"
          impact_ar: "قد يزداد انتفاخ الجدول، مما يؤثر على أداء الاستعلامات"
          action: "Check autovacuum settings or run manual VACUUM"
          action_ar: "تحقق من إعدادات التنظيف التلقائي أو قم بتشغيل VACUUM يدوياً"

      - alert: DatabaseHighDeadTuples
        expr: pg_autovacuum_activity_dead_tuple_ratio > 0.20  # 20% dead tuples
        for: 15m
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "High dead tuple ratio on table {{ $labels.relname }}"
          summary_ar: "نسبة عالية من الصفوف الميتة على الجدول {{ $labels.relname }}"
          description: "Table {{ $labels.schemaname }}.{{ $labels.relname }} has {{ $value | humanizePercentage }} dead tuples"
          description_ar: "الجدول {{ $labels.schemaname }}.{{ $labels.relname }} لديه {{ $value | humanizePercentage }} صفوف ميتة"
          impact: "Query performance degradation and bloat"
          impact_ar: "تدهور أداء الاستعلامات والانتفاخ"
          action: "Run VACUUM on this table"
          action_ar: "قم بتشغيل VACUUM على هذا الجدول"

      - alert: DatabaseBufferCacheHitRatioLow
        expr: pg_buffer_cache_hit_ratio_cache_hit_ratio < 0.90
        for: 10m
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "Database buffer cache hit ratio is low for {{ $labels.datname }}"
          summary_ar: "نسبة إصابة ذاكرة التخزين المؤقت منخفضة لقاعدة البيانات {{ $labels.datname }}"
          description: "Cache hit ratio is {{ $value | humanizePercentage }} (threshold: 90%)"
          description_ar: "نسبة إصابة الذاكرة المؤقتة {{ $value | humanizePercentage }} (الحد: 90%)"
          impact: "Database is reading from disk more than optimal"
          impact_ar: "قاعدة البيانات تقرأ من القرص أكثر من الأمثل"
          action: "Consider increasing shared_buffers or reviewing query patterns"
          action_ar: "فكر في زيادة shared_buffers أو مراجعة أنماط الاستعلامات"

      - alert: DatabaseDiskSpaceLow
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint=~".*postgres.*|.*data.*"}
            /
            node_filesystem_size_bytes{mountpoint=~".*postgres.*|.*data.*"}
          ) < 0.15
        for: 5m
        labels:
          severity: critical
          category: database
          platform: sahool
        annotations:
          summary: "Database disk space is critically low"
          summary_ar: "مساحة قرص قاعدة البيانات منخفضة جداً"
          description: "Only {{ $value | humanizePercentage }} disk space remaining on {{ $labels.mountpoint }}"
          description_ar: "فقط {{ $value | humanizePercentage }} من مساحة القرص متبقية على {{ $labels.mountpoint }}"
          action: "URGENT: Free up disk space, expand volume, or archive old data"
          action_ar: "عاجل: حرر مساحة القرص، وسّع المجلد، أو أرشف البيانات القديمة"

      - alert: DatabaseDiskSpaceWarning
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint=~".*postgres.*|.*data.*"}
            /
            node_filesystem_size_bytes{mountpoint=~".*postgres.*|.*data.*"}
          ) < 0.25
        for: 10m
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "Database disk space is running low"
          summary_ar: "مساحة قرص قاعدة البيانات تنفد"
          description: "{{ $value | humanizePercentage }} disk space remaining on {{ $labels.mountpoint }}"
          description_ar: "{{ $value | humanizePercentage }} من مساحة القرص متبقية على {{ $labels.mountpoint }}"
          action: "Plan for disk space expansion or data cleanup"
          action_ar: "خطط لتوسيع مساحة القرص أو تنظيف البيانات"

      - alert: DatabaseReplicationLagHigh
        expr: pg_replication_lag_lag_seconds > 10
        for: 5m
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "Replication lag is high for {{ $labels.application_name }}"
          summary_ar: "تأخر النسخ المتماثل عالي لـ {{ $labels.application_name }}"
          description: "Replica {{ $labels.client_addr }} is {{ $value }}s behind primary"
          description_ar: "النسخة المتماثلة {{ $labels.client_addr }} متأخرة {{ $value }} ثانية عن الأساسية"
          impact: "Read replicas may serve stale data"
          impact_ar: "نسخ القراءة قد تقدم بيانات قديمة"
          action: "Check network connectivity and replica performance"
          action_ar: "تحقق من اتصال الشبكة وأداء النسخة المتماثلة"

      - alert: DatabaseReplicationLagCritical
        expr: pg_replication_lag_lag_seconds > 60
        for: 2m
        labels:
          severity: critical
          category: database
          platform: sahool
        annotations:
          summary: "CRITICAL: Replication lag is very high for {{ $labels.application_name }}"
          summary_ar: "حرج: تأخر النسخ المتماثل عالي جداً لـ {{ $labels.application_name }}"
          description: "Replica {{ $labels.client_addr }} is {{ $value }}s behind primary"
          description_ar: "النسخة المتماثلة {{ $labels.client_addr }} متأخرة {{ $value }} ثانية"
          action: "URGENT: Investigate replication issues immediately"
          action_ar: "عاجل: تحقق من مشاكل النسخ المتماثل فوراً"

      - alert: DatabaseTransactionWraparoundWarning
        expr: pg_txid_wraparound_txid_remaining < 500000000  # 500M transactions left
        for: 1h
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "Transaction ID wraparound approaching for {{ $labels.datname }}"
          summary_ar: "اقتراب الالتفاف حول معرف المعاملة لقاعدة البيانات {{ $labels.datname }}"
          description: "Only {{ $value }} transactions until wraparound (threshold: 500M)"
          description_ar: "فقط {{ $value }} معاملة حتى الالتفاف (الحد: 500M)"
          impact: "Database may shut down to prevent data corruption"
          impact_ar: "قد تتوقف قاعدة البيانات لمنع تلف البيانات"
          action: "Run aggressive VACUUM FREEZE on database"
          action_ar: "قم بتشغيل VACUUM FREEZE على قاعدة البيانات"

      - alert: DatabaseTransactionWraparoundCritical
        expr: pg_txid_wraparound_txid_remaining < 100000000  # 100M transactions left
        for: 10m
        labels:
          severity: critical
          category: database
          platform: sahool
        annotations:
          summary: "CRITICAL: Transaction ID wraparound imminent for {{ $labels.datname }}"
          summary_ar: "حرج: الالتفاف حول معرف المعاملة وشيك لقاعدة البيانات {{ $labels.datname }}"
          description: "ONLY {{ $value }} transactions until wraparound!"
          description_ar: "فقط {{ $value }} معاملة حتى الالتفاف!"
          action: "URGENT: Run VACUUM FREEZE immediately to prevent database shutdown"
          action_ar: "عاجل: قم بتشغيل VACUUM FREEZE فوراً لمنع إيقاف قاعدة البيانات"

      - alert: DatabaseUnusedIndexes
        expr: pg_index_usage_idx_scan < 10 and pg_index_usage_index_size_bytes > 10485760  # < 10 scans and > 10MB
        for: 24h
        labels:
          severity: info
          category: database
          platform: sahool
        annotations:
          summary: "Potentially unused index {{ $labels.indexname }} on {{ $labels.tablename }}"
          summary_ar: "فهرس غير مستخدم محتمل {{ $labels.indexname }} على الجدول {{ $labels.tablename }}"
          description: "Index has only {{ $value }} scans but occupies significant space"
          description_ar: "الفهرس لديه فقط {{ $value }} مسح ولكنه يشغل مساحة كبيرة"
          action: "Consider dropping this index if not needed"
          action_ar: "فكر في حذف هذا الفهرس إذا لم يكن مطلوباً"

      - alert: DatabaseLongRunningQueries
        expr: pg_long_running_queries_max_duration_seconds > 300  # 5 minutes
        for: 5m
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "Long-running queries detected in {{ $labels.datname }}"
          summary_ar: "تم اكتشاف استعلامات طويلة التشغيل في {{ $labels.datname }}"
          description: "{{ $labels.query_count }} queries running for more than {{ $value }}s"
          description_ar: "{{ $labels.query_count }} استعلامات تعمل لأكثر من {{ $value }} ثانية"
          action: "Check pg_stat_activity for slow queries and consider optimization"
          action_ar: "تحقق من pg_stat_activity للاستعلامات البطيئة وفكر في التحسين"

      - alert: DatabaseCheckpointTooFrequent
        expr: rate(pg_checkpoint_stats_checkpoints_req[10m]) > rate(pg_checkpoint_stats_checkpoints_timed[10m]) * 2
        for: 30m
        labels:
          severity: warning
          category: database
          platform: sahool
        annotations:
          summary: "PostgreSQL checkpoints are too frequent"
          summary_ar: "نقاط التفتيش في PostgreSQL متكررة جداً"
          description: "Requested checkpoints exceed timed checkpoints significantly"
          description_ar: "نقاط التفتيش المطلوبة تتجاوز نقاط التفتيش المجدولة بشكل كبير"
          impact: "Performance degradation due to frequent I/O operations"
          impact_ar: "تدهور الأداء بسبب عمليات I/O المتكررة"
          action: "Consider increasing max_wal_size or checkpoint_timeout"
          action_ar: "فكر في زيادة max_wal_size أو checkpoint_timeout"

  # ═══════════════════════════════════════════════════════════════════════════
  # Redis Alerts - تنبيهات Redis
  # ═══════════════════════════════════════════════════════════════════════════
  - name: sahool_redis_alerts
    interval: 30s
    rules:
      - alert: RedisMemoryHigh
        expr: |
          (
            redis_memory_used_bytes
            /
            redis_memory_max_bytes
          ) > 0.85
        for: 5m
        labels:
          severity: warning
          category: cache
          platform: sahool
        annotations:
          summary: "Redis memory usage is high"
          summary_ar: "استخدام ذاكرة Redis عالي"
          description: "Redis is using {{ $value | humanizePercentage }} of allocated memory"
          description_ar: "Redis يستخدم {{ $value | humanizePercentage }} من الذاكرة المخصصة"
          impact: "Cache eviction may increase, reducing performance"
          impact_ar: "قد يزداد طرد الذاكرة المؤقتة، مما يقلل الأداء"
          action: "Consider increasing Redis memory limit or reviewing cache policies"
          action_ar: "فكر في زيادة حد ذاكرة Redis أو مراجعة سياسات الذاكرة المؤقتة"

      - alert: RedisCriticalMemory
        expr: |
          (
            redis_memory_used_bytes
            /
            redis_memory_max_bytes
          ) > 0.95
        for: 2m
        labels:
          severity: critical
          category: cache
          platform: sahool
        annotations:
          summary: "CRITICAL: Redis memory nearly exhausted"
          summary_ar: "حرج: ذاكرة Redis شبه مستنفدة"
          description: "Redis is using {{ $value | humanizePercentage }} of allocated memory"
          description_ar: "Redis يستخدم {{ $value | humanizePercentage }} من الذاكرة المخصصة"

      - alert: RedisHighEvictionRate
        expr: rate(redis_evicted_keys_total[5m]) > 100
        for: 5m
        labels:
          severity: warning
          category: cache
          platform: sahool
        annotations:
          summary: "High Redis key eviction rate"
          summary_ar: "معدل طرد مفاتيح Redis عالي"
          description: "Redis is evicting {{ $value }} keys/sec"
          description_ar: "Redis يطرد {{ $value }} مفتاح/ثانية"

      - alert: RedisHighConnectionCount
        expr: redis_connected_clients > 1000
        for: 5m
        labels:
          severity: warning
          category: cache
          platform: sahool
        annotations:
          summary: "High number of Redis connections"
          summary_ar: "عدد كبير من اتصالات Redis"
          description: "{{ $value }} clients connected to Redis"
          description_ar: "{{ $value }} عميل متصل بـ Redis"

  # ═══════════════════════════════════════════════════════════════════════════
  # NATS Message Queue Alerts - تنبيهات نظام الرسائل NATS
  # ═══════════════════════════════════════════════════════════════════════════
  - name: sahool_nats_alerts
    interval: 30s
    rules:
      - alert: NATSQueueBacklog
        expr: nats_consumer_num_pending > 10000
        for: 5m
        labels:
          severity: warning
          category: message-queue
          platform: sahool
        annotations:
          summary: "NATS queue has high backlog"
          summary_ar: "طابور NATS لديه تراكم عالي"
          description: "Consumer {{ $labels.consumer }} has {{ $value }} pending messages"
          description_ar: "المستهلك {{ $labels.consumer }} لديه {{ $value }} رسالة معلقة"
          impact: "Message processing is delayed"
          impact_ar: "معالجة الرسائل متأخرة"
          action: "Check consumer health and processing rate"
          action_ar: "تحقق من صحة المستهلك ومعدل المعالجة"

      - alert: NATSCriticalBacklog
        expr: nats_consumer_num_pending > 50000
        for: 2m
        labels:
          severity: critical
          category: message-queue
          platform: sahool
        annotations:
          summary: "CRITICAL: NATS queue critically backed up"
          summary_ar: "حرج: طابور NATS متراكم بشكل حرج"
          description: "Consumer {{ $labels.consumer }} has {{ $value }} pending messages"
          description_ar: "المستهلك {{ $labels.consumer }} لديه {{ $value }} رسالة معلقة"

      - alert: NATSConsumerLag
        expr: nats_consumer_num_ack_pending > 1000
        for: 5m
        labels:
          severity: warning
          category: message-queue
          platform: sahool
        annotations:
          summary: "NATS consumer has high unacked messages"
          summary_ar: "مستهلك NATS لديه رسائل غير مؤكدة عالية"
          description: "{{ $value }} messages awaiting acknowledgment"
          description_ar: "{{ $value }} رسالة في انتظار التأكيد"

      - alert: NATSSlowConsumer
        expr: rate(nats_consumer_delivered_consumer_seq[5m]) < 10
        for: 10m
        labels:
          severity: warning
          category: message-queue
          platform: sahool
        annotations:
          summary: "NATS consumer is processing slowly"
          summary_ar: "مستهلك NATS يعالج ببطء"
          description: "Processing rate: {{ $value }} messages/sec"
          description_ar: "معدل المعالجة: {{ $value }} رسالة/ثانية"

  # ═══════════════════════════════════════════════════════════════════════════
  # Backup Monitoring Alerts - تنبيهات مراقبة النسخ الاحتياطي
  # ═══════════════════════════════════════════════════════════════════════════
  - name: sahool_backup_alerts
    interval: 60s
    rules:
      - alert: DatabaseBackupOld
        expr: postgres_backup_age_seconds > 86400  # 24 hours
        for: 1h
        labels:
          severity: critical
          category: backup
          platform: sahool
        annotations:
          summary: "Database backup is outdated"
          summary_ar: "النسخة الاحتياطية لقاعدة البيانات قديمة"
          description: "Last backup was {{ $value | humanizeDuration }} ago (threshold: 24 hours)"
          description_ar: "آخر نسخة احتياطية كانت منذ {{ $value | humanizeDuration }} (الحد: 24 ساعة)"
          impact: "Risk of data loss in case of disaster"
          impact_ar: "خطر فقدان البيانات في حالة الكارثة"
          action: "Check backup job and run manual backup if needed"
          action_ar: "تحقق من مهمة النسخ الاحتياطي وقم بتشغيل نسخة احتياطية يدوية إذا لزم الأمر"

      - alert: DatabaseBackupMissing
        expr: postgres_backup_status == 0
        for: 30m
        labels:
          severity: critical
          category: backup
          platform: sahool
        annotations:
          summary: "No database backup found"
          summary_ar: "لم يتم العثور على نسخة احتياطية لقاعدة البيانات"
          description: "No backup files found in backup directory"
          description_ar: "لم يتم العثور على ملفات نسخ احتياطي في دليل النسخ الاحتياطي"
          impact: "CRITICAL: No backup available for disaster recovery"
          impact_ar: "حرج: لا توجد نسخة احتياطية متاحة للاسترداد من الكوارث"
          action: "URGENT: Investigate backup system failure and create backup immediately"
          action_ar: "عاجل: تحقق من فشل نظام النسخ الاحتياطي وأنشئ نسخة احتياطية فوراً"

      - alert: DatabaseBackupTooSmall
        expr: postgres_backup_size_bytes < 10485760 and postgres_backup_status == 1  # < 10MB
        for: 15m
        labels:
          severity: warning
          category: backup
          platform: sahool
        annotations:
          summary: "Database backup file is suspiciously small"
          summary_ar: "ملف النسخة الاحتياطية لقاعدة البيانات صغير بشكل مريب"
          description: "Backup size is only {{ $value | humanize1024 }}B (threshold: 10MB)"
          description_ar: "حجم النسخة الاحتياطية فقط {{ $value | humanize1024 }}B (الحد: 10MB)"
          impact: "Backup may be incomplete or corrupted"
          impact_ar: "قد تكون النسخة الاحتياطية غير كاملة أو تالفة"
          action: "Verify backup integrity and re-run backup if necessary"
          action_ar: "تحقق من سلامة النسخة الاحتياطية وأعد تشغيل النسخ الاحتياطي إذا لزم الأمر"

      - alert: DatabaseBackupCorrupted
        expr: postgres_backup_integrity == 0
        for: 5m
        labels:
          severity: critical
          category: backup
          platform: sahool
        annotations:
          summary: "Database backup integrity check failed"
          summary_ar: "فشل فحص سلامة النسخة الاحتياطية لقاعدة البيانات"
          description: "Backup file failed integrity verification"
          description_ar: "فشل ملف النسخة الاحتياطية في التحقق من السلامة"
          impact: "Backup cannot be used for restoration"
          impact_ar: "لا يمكن استخدام النسخة الاحتياطية للاستعادة"
          action: "URGENT: Create new backup immediately"
          action_ar: "عاجل: أنشئ نسخة احتياطية جديدة فوراً"

      - alert: DatabaseBackupMonitoringStale
        expr: (time() - postgres_backup_monitoring_timestamp_seconds) > 1800  # 30 minutes
        for: 10m
        labels:
          severity: warning
          category: backup
          platform: sahool
        annotations:
          summary: "Backup monitoring has not run recently"
          summary_ar: "لم يتم تشغيل مراقبة النسخ الاحتياطي مؤخراً"
          description: "Backup monitoring script has not reported in {{ $value | humanizeDuration }}"
          description_ar: "لم يبلغ سكريبت مراقبة النسخ الاحتياطي منذ {{ $value | humanizeDuration }}"
          action: "Check backup monitoring cron job or script health"
          action_ar: "تحقق من مهمة cron لمراقبة النسخ الاحتياطي أو صحة السكريبت"

  # ═══════════════════════════════════════════════════════════════════════════
  # Infrastructure Health - صحة البنية التحتية
  # ═══════════════════════════════════════════════════════════════════════════
  - name: sahool_infrastructure_health
    interval: 30s
    rules:
      - alert: PostgreSQLDown
        expr: up{service="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          category: infrastructure
          platform: sahool
        annotations:
          summary: "CRITICAL: PostgreSQL database is down"
          summary_ar: "حرج: قاعدة بيانات PostgreSQL متوقفة"
          description: "Primary database is unavailable - platform-wide outage"
          description_ar: "قاعدة البيانات الرئيسية غير متاحة - انقطاع على مستوى المنصة"
          impact: "ENTIRE PLATFORM IS DOWN"
          impact_ar: "المنصة بأكملها متوقفة"

      - alert: RedisDown
        expr: up{service="redis"} == 0
        for: 1m
        labels:
          severity: critical
          category: infrastructure
          platform: sahool
        annotations:
          summary: "CRITICAL: Redis cache is down"
          summary_ar: "حرج: ذاكرة التخزين المؤقت Redis متوقفة"
          description: "Cache and session store unavailable"
          description_ar: "الذاكرة المؤقتة ومخزن الجلسات غير متاحين"

      - alert: NATSDown
        expr: up{service="nats"} == 0
        for: 1m
        labels:
          severity: critical
          category: infrastructure
          platform: sahool
        annotations:
          summary: "CRITICAL: NATS message queue is down"
          summary_ar: "حرج: نظام الرسائل NATS متوقف"
          description: "Message queue unavailable - async processing stopped"
          description_ar: "نظام الرسائل غير متاح - توقفت المعالجة غير المتزامنة"

      - alert: QdrantDown
        expr: up{service="qdrant"} == 0
        for: 2m
        labels:
          severity: warning
          category: infrastructure
          platform: sahool
        annotations:
          summary: "Qdrant vector database is down"
          summary_ar: "قاعدة البيانات المتجهة Qdrant متوقفة"
          description: "AI advisor RAG functionality unavailable"
          description_ar: "وظيفة RAG للمستشار الذكي غير متاحة"

  # ═══════════════════════════════════════════════════════════════════════════
  # Business Metrics - المؤشرات التجارية
  # ═══════════════════════════════════════════════════════════════════════════
  - name: sahool_business_metrics
    interval: 60s
    rules:
      - alert: LowActiveUsers
        expr: sahool_active_users_gauge < 10
        for: 15m
        labels:
          severity: info
          category: business
          platform: sahool
        annotations:
          summary: "Low active user count"
          summary_ar: "عدد المستخدمين النشطين منخفض"
          description: "Only {{ $value }} active users in the last 15 minutes"
          description_ar: "فقط {{ $value }} مستخدم نشط خلال آخر 15 دقيقة"

      - alert: HighAPIUsageRate
        expr: |
          sum(rate(http_requests_total[5m])) > 1000
        for: 10m
        labels:
          severity: info
          category: business
          platform: sahool
        annotations:
          summary: "High API request rate"
          summary_ar: "معدل طلبات API عالي"
          description: "API receiving {{ $value }} requests/sec"
          description_ar: "API تستقبل {{ $value }} طلب/ثانية"

  # ═══════════════════════════════════════════════════════════════════════════
  # AI/ML Service Alerts - تنبيهات خدمات الذكاء الاصطناعي
  # ═══════════════════════════════════════════════════════════════════════════
  - name: sahool_ai_ml_alerts
    interval: 60s
    rules:
      - alert: AIAdvisorHighLatency
        expr: |
          histogram_quantile(0.95,
            sum by (le) (
              rate(http_request_duration_seconds_bucket{service="ai-advisor"}[5m])
            )
          ) > 3
        for: 5m
        labels:
          severity: warning
          category: ai-ml
          platform: sahool
        annotations:
          summary: "AI Advisor experiencing high latency"
          summary_ar: "المستشار الذكي يعاني من تأخير عالي"
          description: "P95 latency is {{ $value }}s for AI processing"
          description_ar: "زمن الاستجابة P95 هو {{ $value }} ثانية لمعالجة الذكاء الاصطناعي"

      - alert: CropHealthAIModelErrors
        expr: rate(ai_model_errors_total{service="crop-health-ai"}[5m]) > 0.1
        for: 3m
        labels:
          severity: warning
          category: ai-ml
          platform: sahool
        annotations:
          summary: "Crop Health AI model experiencing errors"
          summary_ar: "نموذج الذكاء الاصطناعي لصحة المحاصيل يواجه أخطاء"
          description: "Model error rate: {{ $value }}/sec"
          description_ar: "معدل أخطاء النموذج: {{ $value }}/ثانية"
