# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - Redis Docker Configuration
# تكوين Redis لحاويات Docker - منصة سهول الزراعية
# ═══════════════════════════════════════════════════════════════════════════════
#
# Optimized for Docker environments with enhanced security
# محسن لبيئات Docker مع أمان محسّن
#
# ═══════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────
# NETWORK CONFIGURATION - تكوين الشبكة
# ─────────────────────────────────────────────────────────────────────────────

# Bind to all interfaces (required for Docker networking)
# الارتباط بجميع الواجهات (مطلوب لشبكة Docker)
# Note: Docker's network isolation provides security at container level
bind 0.0.0.0 ::

# Default Redis port
port 6379

# Protected mode: yes (requires password even within Docker network)
# الوضع المحمي: نعم (يتطلب كلمة مرور حتى ضمن شبكة Docker)
protected-mode yes

# TCP keepalive - detect dead connections
# الحفاظ على اتصال TCP - كشف الاتصالات الميتة
tcp-keepalive 60

# TCP backlog - max pending connections
# قائمة انتظار TCP - الحد الأقصى للاتصالات المعلقة
tcp-backlog 511

# Connection timeout (0 = disabled, 300 = 5 minutes recommended)
# مهلة الاتصال (0 = معطل، 300 = 5 دقائق موصى به)
timeout 300

# ─────────────────────────────────────────────────────────────────────────────
# SECURITY - الأمان
# ─────────────────────────────────────────────────────────────────────────────

# CRITICAL: Password authentication (set via environment variable)
# حرج: مصادقة كلمة المرور (يتم تعيينها عبر متغير البيئة)
# This will be set via command line: --requirepass ${REDIS_PASSWORD}
# requirepass ${REDIS_PASSWORD}

# Rename dangerous commands to prevent accidental execution
# إعادة تسمية الأوامر الخطرة لمنع التنفيذ العرضي
rename-command FLUSHDB "SAHOOL_FLUSHDB_DANGER_f5a8d2e9"
rename-command FLUSHALL "SAHOOL_FLUSHALL_DANGER_b3c7f1a4"
rename-command CONFIG "SAHOOL_CONFIG_ADMIN_c8e2d4f6"
rename-command DEBUG ""
rename-command SHUTDOWN "SAHOOL_SHUTDOWN_ADMIN_a9f3e7b1"
rename-command BGSAVE "SAHOOL_BGSAVE_ADMIN_d4b8f2c5"
rename-command BGREWRITEAOF "SAHOOL_BGREWRITEAOF_ADMIN_e7c3a9f2"

# Disable KEYS command in production (use SCAN instead)
# تعطيل أمر KEYS في الإنتاج (استخدم SCAN بدلاً من ذلك)
rename-command KEYS "SAHOOL_KEYS_SCAN_ONLY_f8d3b7e2"

# ─────────────────────────────────────────────────────────────────────────────
# PERSISTENCE - الثبات
# ─────────────────────────────────────────────────────────────────────────────

# AOF (Append Only File) persistence - primary persistence method
# ثبات AOF (ملف الإلحاق فقط) - طريقة الثبات الأساسية
appendonly yes
appendfilename "sahool-appendonly.aof"

# AOF fsync policy: everysec (good balance of performance and safety)
# سياسة مزامنة AOF: كل ثانية (توازن جيد بين الأداء والأمان)
# Options: always (safest, slowest), everysec (recommended), no (fastest, risky)
appendfsync everysec

# Don't fsync during BGSAVE/BGREWRITEAOF to prevent latency spikes
# عدم المزامنة أثناء BGSAVE/BGREWRITEAOF لمنع ارتفاعات الكمون
no-appendfsync-on-rewrite no

# AOF rewrite configuration
# تكوين إعادة كتابة AOF
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF loading options
# خيارات تحميل AOF
aof-load-truncated yes
aof-use-rdb-preamble yes

# RDB snapshots (backup, not primary persistence)
# لقطات RDB (نسخ احتياطي، وليس الثبات الأساسي)
# save <seconds> <changes>
save 900 1      # Save after 15 minutes if at least 1 key changed
save 300 10     # Save after 5 minutes if at least 10 keys changed
save 60 10000   # Save after 1 minute if at least 10000 keys changed

# RDB configuration
# تكوين RDB
dbfilename sahool-dump.rdb
dir /data
rdbcompression yes
rdbchecksum yes
stop-writes-on-bgsave-error yes

# ─────────────────────────────────────────────────────────────────────────────
# MEMORY MANAGEMENT - إدارة الذاكرة
# ─────────────────────────────────────────────────────────────────────────────

# Maximum memory (set via command line for Docker compatibility)
# الذاكرة القصوى (تعيين عبر سطر الأوامر لتوافق Docker)
# maxmemory 512mb

# Eviction policy when memory limit reached
# سياسة الإخلاء عند الوصول إلى حد الذاكرة
# allkeys-lru: Remove least recently used keys (good for cache)
# volatile-lru: Remove LRU keys with TTL (good for sessions + cache)
# noeviction: Return errors when memory limit reached (safest for critical data)
maxmemory-policy allkeys-lru

# Number of samples for LRU/LFU eviction algorithms
# عدد العينات لخوارزميات الإخلاء LRU/LFU
maxmemory-samples 10

# Evict expired keys proactively
# إخلاء المفاتيح منتهية الصلاحية بشكل استباقي
activerehashing yes

# ─────────────────────────────────────────────────────────────────────────────
# CONNECTION LIMITS - حدود الاتصال
# ─────────────────────────────────────────────────────────────────────────────

# Maximum number of clients
# الحد الأقصى لعدد العملاء
maxclients 10000

# Client output buffer limits
# حدود مخزن إخراج العميل
# Format: <class> <hard limit> <soft limit> <soft seconds>
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ─────────────────────────────────────────────────────────────────────────────
# LOGGING - التسجيل
# ─────────────────────────────────────────────────────────────────────────────

# Log level: debug, verbose, notice, warning
# مستوى السجل: تصحيح، مطول، إشعار، تحذير
loglevel notice

# Log to stdout for Docker (Docker captures container logs)
# السجل إلى stdout لـ Docker (يلتقط Docker سجلات الحاوية)
logfile ""

# ─────────────────────────────────────────────────────────────────────────────
# SLOW LOG - سجل الاستعلامات البطيئة
# ─────────────────────────────────────────────────────────────────────────────

# Log queries slower than 10ms (10000 microseconds)
# تسجيل الاستعلامات الأبطأ من 10 مللي ثانية
slowlog-log-slower-than 10000

# Keep last 128 slow queries in memory
# الاحتفاظ بآخر 128 استعلام بطيء في الذاكرة
slowlog-max-len 128

# ─────────────────────────────────────────────────────────────────────────────
# LATENCY MONITORING - مراقبة الكمون
# ─────────────────────────────────────────────────────────────────────────────

# Monitor events taking longer than 100ms
# مراقبة الأحداث التي تستغرق أكثر من 100 مللي ثانية
latency-monitor-threshold 100

# ─────────────────────────────────────────────────────────────────────────────
# ADVANCED CONFIGURATION - التكوين المتقدم
# ─────────────────────────────────────────────────────────────────────────────

# Database count (default: 16)
# عدد قواعد البيانات
databases 16

# Disable RDB saving from command line for security
# تعطيل حفظ RDB من سطر الأوامر للأمان
# (admins must use renamed commands)
# rdbcompression yes

# Lua script time limit (milliseconds)
# حد وقت نص Lua
lua-time-limit 5000

# Notify on key expiration (for session monitoring)
# الإخطار عند انتهاء صلاحية المفتاح (لمراقبة الجلسة)
# K = keyspace events, E = keyevent events, x = expired events
notify-keyspace-events Ex

# HyperLogLog sparse representation bytes limit
# حد بايتات التمثيل المتفرق لـ HyperLogLog
hll-sparse-max-bytes 3000

# Stream macro node max entries
# الحد الأقصى لإدخالات عقدة الماكرو للتدفق
stream-node-max-bytes 4096
stream-node-max-entries 100

# Lists compression configuration
# تكوين ضغط القوائم
list-max-ziplist-size -2
list-compress-depth 0

# Set max intset entries
# تعيين الحد الأقصى لإدخالات intset
set-max-intset-entries 512

# Sorted set ziplist configuration
# تكوين ziplist للمجموعة المرتبة
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# Hash ziplist configuration
# تكوين ziplist للتجزئة
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# Rehashing configuration
# تكوين إعادة التجزئة
activerehashing yes
client-query-buffer-limit 1gb

# Protocol configuration
# تكوين البروتوكول
proto-max-bulk-len 512mb

# Replication configuration (if used)
# تكوين النسخ المتماثل (إذا تم الاستخدام)
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-disable-tcp-nodelay no
repl-backlog-size 1mb
repl-backlog-ttl 3600

# Cluster configuration (disabled for standalone)
# تكوين الكتلة (معطل للوضع المستقل)
# cluster-enabled no

# ─────────────────────────────────────────────────────────────────────────────
# SECURITY NOTES - ملاحظات الأمان
# ─────────────────────────────────────────────────────────────────────────────
#
# 1. Password is set via --requirepass command line argument
# 2. Dangerous commands are renamed to prevent accidental execution
# 3. Protected mode is enabled
# 4. All data is persisted with AOF
# 5. Memory limits prevent DoS attacks
# 6. Connection limits prevent resource exhaustion
# 7. Slow query logging helps identify performance issues
#
# ═══════════════════════════════════════════════════════════════════════════════
