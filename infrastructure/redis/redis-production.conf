# ═══════════════════════════════════════════════════════════════════════════════════════
# SAHOOL IDP - Redis Production Configuration
# إعدادات Redis للإنتاج
# ═══════════════════════════════════════════════════════════════════════════════════════
#
# This configuration closes the "Redis Persistence Gap" by:
# 1. Enabling AOF (Append Only File) persistence
# 2. Configuring authentication (requirepass)
# 3. Hardening security settings
#
# Usage:
#   redis-server /path/to/redis-production.conf
#
# ═══════════════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────
# NETWORK CONFIGURATION
# ─────────────────────────────────────────────────────────────────────────────

# Bind to internal network only (NOT 0.0.0.0 in production!)
bind 127.0.0.1 ::1

# Default port
port 6379

# Disable protected mode since we're using authentication
protected-mode yes

# TCP keepalive (detect dead connections)
tcp-keepalive 300

# ─────────────────────────────────────────────────────────────────────────────
# SECURITY - Closes Session Hijacking Risk
# ─────────────────────────────────────────────────────────────────────────────

# CRITICAL: Set a strong password
# In production, use environment variable: $(REDIS_PASSWORD)
requirepass ${REDIS_PASSWORD:-sahool_redis_secure_2024!}

# Rename dangerous commands to prevent accidental execution
rename-command FLUSHDB "SAHOOL_FLUSHDB_ADMIN_ONLY"
rename-command FLUSHALL "SAHOOL_FLUSHALL_ADMIN_ONLY"
rename-command DEBUG ""
rename-command CONFIG "SAHOOL_CONFIG_ADMIN_ONLY"
rename-command SHUTDOWN "SAHOOL_SHUTDOWN_ADMIN_ONLY"

# ACL for fine-grained access control (Redis 6+)
# Application user - can read/write sessions but not admin commands
user sahool_app on >${REDIS_APP_PASSWORD:-app_secure_pass} ~session:* ~cache:* +@read +@write -@admin -@dangerous

# Admin user - full access
user sahool_admin on >${REDIS_ADMIN_PASSWORD:-admin_secure_pass} ~* +@all

# Disable default user
user default off

# ─────────────────────────────────────────────────────────────────────────────
# PERSISTENCE - AOF (Append Only File)
# Closes the "Data Loss on Restart" Gap
# ─────────────────────────────────────────────────────────────────────────────

# Enable AOF persistence
appendonly yes

# AOF filename
appendfilename "sahool-appendonly.aof"

# Fsync policy:
# - always: Safest, slowest (fsync on every write)
# - everysec: Good compromise (fsync every second) ← RECOMMENDED
# - no: Fastest, relies on OS (not recommended for sessions)
appendfsync everysec

# Don't fsync during BGSAVE/BGREWRITEAOF (prevents latency spikes)
no-appendfsync-on-rewrite no

# AOF rewrite triggers
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF loading on startup
aof-load-truncated yes
aof-use-rdb-preamble yes

# ─────────────────────────────────────────────────────────────────────────────
# RDB SNAPSHOTS (Backup, not primary persistence)
# ─────────────────────────────────────────────────────────────────────────────

# Save RDB snapshots as secondary backup
save 900 1
save 300 10
save 60 10000

# RDB filename
dbfilename sahool-dump.rdb

# Directory for both RDB and AOF files
dir /var/lib/redis/data

# Compress RDB files
rdbcompression yes

# Checksum for RDB integrity
rdbchecksum yes

# ─────────────────────────────────────────────────────────────────────────────
# MEMORY MANAGEMENT
# ─────────────────────────────────────────────────────────────────────────────

# Maximum memory (adjust based on server capacity)
maxmemory 2gb

# Eviction policy when memory limit reached
# allkeys-lru: Remove least recently used keys (good for cache)
# volatile-lru: Remove LRU keys with TTL set (good for sessions + cache mix)
maxmemory-policy volatile-lru

# LRU samples
maxmemory-samples 10

# ─────────────────────────────────────────────────────────────────────────────
# CONNECTION LIMITS
# ─────────────────────────────────────────────────────────────────────────────

# Maximum clients (matches application settings)
maxclients 100

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Timeout for idle connections (0 = disabled)
timeout 300

# ─────────────────────────────────────────────────────────────────────────────
# LOGGING
# ─────────────────────────────────────────────────────────────────────────────

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file (use "" for stdout in Docker)
logfile /var/log/redis/redis-server.log

# Syslog
syslog-enabled yes
syslog-ident redis-sahool
syslog-facility local0

# ─────────────────────────────────────────────────────────────────────────────
# SLOW LOG (Performance monitoring)
# ─────────────────────────────────────────────────────────────────────────────

# Log queries slower than 10ms
slowlog-log-slower-than 10000

# Keep last 128 slow queries
slowlog-max-len 128

# ─────────────────────────────────────────────────────────────────────────────
# LATENCY MONITORING
# ─────────────────────────────────────────────────────────────────────────────

# Monitor events taking longer than 100ms
latency-monitor-threshold 100

# ─────────────────────────────────────────────────────────────────────────────
# TLS/SSL ENCRYPTION (Optional but recommended)
# ─────────────────────────────────────────────────────────────────────────────

# Uncomment to enable TLS
# tls-port 6380
# tls-cert-file /etc/redis/tls/redis.crt
# tls-key-file /etc/redis/tls/redis.key
# tls-ca-cert-file /etc/redis/tls/ca.crt
# tls-auth-clients yes

# ─────────────────────────────────────────────────────────────────────────────
# SAHOOL-SPECIFIC SESSION SETTINGS
# ─────────────────────────────────────────────────────────────────────────────

# Notify on key expiration (for session monitoring)
notify-keyspace-events Ex

# Lua script time limit
lua-time-limit 5000
