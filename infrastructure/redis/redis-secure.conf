# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Platform - Redis Secure Configuration (TLS + ACL Enabled)
# تكوين Redis الآمن مع TLS و ACL - منصة سهول الزراعية
# ═══════════════════════════════════════════════════════════════════════════════
#
# This configuration implements enterprise-grade security:
# - TLS/SSL encryption for data in transit
# - ACL (Access Control Lists) for fine-grained permissions
# - Dangerous command protection
# - Memory limits and eviction policies
# - Comprehensive persistence (AOF + RDB)
#
# Version: 2.0.0
# Last Updated: 2026-01-06
# Based on: Redis Security Audit recommendations
#
# ═══════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────
# NETWORK CONFIGURATION - تكوين الشبكة
# ─────────────────────────────────────────────────────────────────────────────

# Bind to all interfaces (Docker network isolation provides security)
# الارتباط بجميع الواجهات (عزل شبكة Docker يوفر الأمان)
bind 0.0.0.0 ::

# Disable non-TLS port (set to 0 when TLS is enabled)
# تعطيل منفذ غير TLS (تعيين إلى 0 عند تمكين TLS)
# Note: This is overridden when TLS is disabled for compatibility
port 6379

# Protected mode: yes (requires password even within Docker network)
# الوضع المحمي: نعم (يتطلب كلمة مرور حتى ضمن شبكة Docker)
protected-mode yes

# TCP keepalive - detect dead connections
# الحفاظ على اتصال TCP - كشف الاتصالات الميتة
tcp-keepalive 60

# TCP backlog - max pending connections
# قائمة انتظار TCP - الحد الأقصى للاتصالات المعلقة
tcp-backlog 511

# Connection timeout (300 seconds = 5 minutes)
# مهلة الاتصال (300 ثانية = 5 دقائق)
timeout 300

# ─────────────────────────────────────────────────────────────────────────────
# TLS/SSL CONFIGURATION - تكوين TLS/SSL
# ─────────────────────────────────────────────────────────────────────────────

# TLS port (when enabled, set port to 0 and use this)
# منفذ TLS (عند التمكين، قم بتعيين المنفذ إلى 0 واستخدم هذا)
# Uncomment to enable TLS:
# port 0
# tls-port 6379

# TLS Certificate Files
# ملفات شهادة TLS
# tls-cert-file /etc/redis/certs/server.crt
# tls-key-file /etc/redis/certs/server.key
# tls-ca-cert-file /etc/redis/certs/ca.crt

# Client authentication (optional = clients can connect with or without certs)
# مصادقة العميل (اختياري = يمكن للعملاء الاتصال مع أو بدون شهادات)
# tls-auth-clients optional

# TLS protocols (only allow TLS 1.2 and 1.3)
# بروتوكولات TLS (السماح فقط بـ TLS 1.2 و 1.3)
# tls-protocols "TLSv1.2 TLSv1.3"

# Prefer server ciphers for better security
# تفضيل أصفار الخادم لأمان أفضل
# tls-prefer-server-ciphers yes

# Strong cipher suites only
# مجموعات التشفير القوية فقط
# tls-ciphers "HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4"
# tls-ciphersuites "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"

# TLS session caching for performance
# تخزين جلسة TLS مؤقتًا للأداء
# tls-session-caching yes
# tls-session-cache-size 5000
# tls-session-cache-timeout 60

# ─────────────────────────────────────────────────────────────────────────────
# SECURITY - AUTHENTICATION - الأمان - المصادقة
# ─────────────────────────────────────────────────────────────────────────────

# CRITICAL: Password authentication (set via environment variable)
# حرج: مصادقة كلمة المرور (يتم تعيينها عبر متغير البيئة)
# This will be set via command line: --requirepass ${REDIS_PASSWORD}
# requirepass ${REDIS_PASSWORD}

# Master authentication (for replication)
# مصادقة الرئيسي (للنسخ المتماثل)
# masterauth ${REDIS_PASSWORD}

# ─────────────────────────────────────────────────────────────────────────────
# SECURITY - ACL (Access Control Lists) - قوائم التحكم في الوصول
# ─────────────────────────────────────────────────────────────────────────────

# ACL Configuration File (optional, for persistent ACL rules)
# ملف تكوين ACL (اختياري، لقواعد ACL الدائمة)
# aclfile /etc/redis/users.acl

# Disable default user for security (force use of ACL users)
# تعطيل المستخدم الافتراضي للأمان (فرض استخدام مستخدمي ACL)
# Note: Only enable this after ACL users are configured
# user default off nopass nocommands

# Application user - restricted permissions for services
# مستخدم التطبيق - أذونات محدودة للخدمات
# Permissions:
#   - Read/Write access to session:* and cache:* keys only
#   - No admin or dangerous commands
#   - Cannot access other key patterns
# user sahool_app on >${REDIS_APP_PASSWORD} ~session:* ~cache:* +@read +@write +@string +@hash +@list +@set +@sorted-set +@pubsub -@admin -@dangerous -@scripting

# Kong Gateway user - restricted to rate limiting database
# مستخدم Kong Gateway - مقيد بقاعدة بيانات تحديد المعدل
# user kong_gateway on >${REDIS_KONG_PASSWORD} ~ratelimit:* +@read +@write -@admin -@dangerous

# Read-only user for monitoring and reporting
# مستخدم للقراءة فقط للمراقبة وإعداد التقارير
# user sahool_readonly on >${REDIS_READONLY_PASSWORD} ~* +@read +@connection +ping +info +client +cluster +config|get -@write -@admin -@dangerous

# Admin user - full access for operations
# مستخدم المسؤول - وصول كامل للعمليات
# user sahool_admin on >${REDIS_ADMIN_PASSWORD} ~* +@all

# ─────────────────────────────────────────────────────────────────────────────
# SECURITY - DANGEROUS COMMANDS - الأوامر الخطرة
# ─────────────────────────────────────────────────────────────────────────────

# Rename dangerous commands to prevent accidental execution
# إعادة تسمية الأوامر الخطرة لمنع التنفيذ العرضي
rename-command FLUSHDB "SAHOOL_FLUSHDB_DANGER_f5a8d2e9"
rename-command FLUSHALL "SAHOOL_FLUSHALL_DANGER_b3c7f1a4"
rename-command CONFIG "SAHOOL_CONFIG_ADMIN_c8e2d4f6"
rename-command DEBUG ""
rename-command SHUTDOWN "SAHOOL_SHUTDOWN_ADMIN_a9f3e7b1"
rename-command BGSAVE "SAHOOL_BGSAVE_ADMIN_d4b8f2c5"
rename-command BGREWRITEAOF "SAHOOL_BGREWRITEAOF_ADMIN_e7c3a9f2"

# Disable KEYS command in production (use SCAN instead)
# تعطيل أمر KEYS في الإنتاج (استخدم SCAN بدلاً من ذلك)
rename-command KEYS "SAHOOL_KEYS_SCAN_ONLY_f8d3b7e2"

# ─────────────────────────────────────────────────────────────────────────────
# PERSISTENCE - AOF (Append Only File) - الثبات
# ─────────────────────────────────────────────────────────────────────────────

# AOF persistence - primary persistence method
# ثبات AOF - طريقة الثبات الأساسية
appendonly yes
appendfilename "sahool-appendonly.aof"

# AOF fsync policy: everysec (good balance of performance and safety)
# سياسة مزامنة AOF: كل ثانية (توازن جيد بين الأداء والأمان)
# Options: always (safest, slowest), everysec (recommended), no (fastest, risky)
appendfsync everysec

# Don't fsync during BGSAVE/BGREWRITEAOF to prevent latency spikes
# عدم المزامنة أثناء BGSAVE/BGREWRITEAOF لمنع ارتفاعات الكمون
no-appendfsync-on-rewrite no

# AOF rewrite configuration
# تكوين إعادة كتابة AOF
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF loading options
# خيارات تحميل AOF
aof-load-truncated yes
aof-use-rdb-preamble yes

# ─────────────────────────────────────────────────────────────────────────────
# PERSISTENCE - RDB SNAPSHOTS - لقطات RDB
# ─────────────────────────────────────────────────────────────────────────────

# RDB snapshots (backup, not primary persistence)
# لقطات RDB (نسخ احتياطي، وليس الثبات الأساسي)
save 900 1      # Save after 15 minutes if at least 1 key changed
save 300 10     # Save after 5 minutes if at least 10 keys changed
save 60 10000   # Save after 1 minute if at least 10000 keys changed

# RDB configuration
# تكوين RDB
dbfilename sahool-dump.rdb
dir /data
rdbcompression yes
rdbchecksum yes
stop-writes-on-bgsave-error yes

# ─────────────────────────────────────────────────────────────────────────────
# MEMORY MANAGEMENT - إدارة الذاكرة
# ─────────────────────────────────────────────────────────────────────────────

# Maximum memory (set via command line for Docker compatibility)
# الذاكرة القصوى (تعيين عبر سطر الأوامر لتوافق Docker)
# maxmemory 512mb

# Eviction policy when memory limit reached
# سياسة الإخلاء عند الوصول إلى حد الذاكرة
# allkeys-lru: Remove least recently used keys (good for cache)
# volatile-lru: Remove LRU keys with TTL (good for sessions + cache)
# noeviction: Return errors when memory limit reached (safest for critical data)
maxmemory-policy allkeys-lru

# Number of samples for LRU/LFU eviction algorithms
# عدد العينات لخوارزميات الإخلاء LRU/LFU
maxmemory-samples 10

# Evict expired keys proactively
# إخلاء المفاتيح منتهية الصلاحية بشكل استباقي
activerehashing yes

# ─────────────────────────────────────────────────────────────────────────────
# CONNECTION LIMITS - حدود الاتصال
# ─────────────────────────────────────────────────────────────────────────────

# Maximum number of clients
# الحد الأقصى لعدد العملاء
maxclients 10000

# Client output buffer limits
# حدود مخزن إخراج العميل
# Format: <class> <hard limit> <soft limit> <soft seconds>
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ─────────────────────────────────────────────────────────────────────────────
# LOGGING - التسجيل
# ─────────────────────────────────────────────────────────────────────────────

# Log level: debug, verbose, notice, warning
# مستوى السجل: تصحيح، مطول، إشعار، تحذير
loglevel notice

# Log to stdout for Docker (Docker captures container logs)
# السجل إلى stdout لـ Docker (يلتقط Docker سجلات الحاوية)
logfile ""

# ─────────────────────────────────────────────────────────────────────────────
# SLOW LOG - سجل الاستعلامات البطيئة
# ─────────────────────────────────────────────────────────────────────────────

# Log queries slower than 10ms (10000 microseconds)
# تسجيل الاستعلامات الأبطأ من 10 مللي ثانية
slowlog-log-slower-than 10000

# Keep last 256 slow queries in memory (increased from 128)
# الاحتفاظ بآخر 256 استعلام بطيء في الذاكرة (زيادة من 128)
slowlog-max-len 256

# ─────────────────────────────────────────────────────────────────────────────
# LATENCY MONITORING - مراقبة الكمون
# ─────────────────────────────────────────────────────────────────────────────

# Monitor events taking longer than 100ms
# مراقبة الأحداث التي تستغرق أكثر من 100 مللي ثانية
latency-monitor-threshold 100

# ─────────────────────────────────────────────────────────────────────────────
# REPLICATION CONFIGURATION - تكوين النسخ المتماثل
# ─────────────────────────────────────────────────────────────────────────────

# Replication settings (for HA/Sentinel deployments)
# إعدادات النسخ المتماثل (لنشر HA/Sentinel)
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-disable-tcp-nodelay no
repl-backlog-size 1mb
repl-backlog-ttl 3600

# Replica settings
# إعدادات النسخة المتماثلة
replica-serve-stale-data yes
replica-read-only yes
replica-priority 100

# ─────────────────────────────────────────────────────────────────────────────
# ADVANCED CONFIGURATION - التكوين المتقدم
# ─────────────────────────────────────────────────────────────────────────────

# Database count (default: 16)
# عدد قواعد البيانات
databases 16

# Lua script time limit (milliseconds)
# حد وقت نص Lua
lua-time-limit 5000

# Notify on key expiration (for session monitoring)
# الإخطار عند انتهاء صلاحية المفتاح (لمراقبة الجلسة)
# K = keyspace events, E = keyevent events, x = expired events
notify-keyspace-events Ex

# HyperLogLog sparse representation bytes limit
# حد بايتات التمثيل المتفرق لـ HyperLogLog
hll-sparse-max-bytes 3000

# Stream configuration
# تكوين التدفق
stream-node-max-bytes 4096
stream-node-max-entries 100

# Lists compression configuration
# تكوين ضغط القوائم
list-max-ziplist-size -2
list-compress-depth 0

# Set max intset entries
# تعيين الحد الأقصى لإدخالات intset
set-max-intset-entries 512

# Sorted set ziplist configuration
# تكوين ziplist للمجموعة المرتبة
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# Hash ziplist configuration
# تكوين ziplist للتجزئة
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# Rehashing configuration
# تكوين إعادة التجزئة
activerehashing yes
client-query-buffer-limit 1gb

# Protocol configuration
# تكوين البروتوكول
proto-max-bulk-len 512mb

# ─────────────────────────────────────────────────────────────────────────────
# SECURITY SUMMARY - ملخص الأمان
# ─────────────────────────────────────────────────────────────────────────────
#
# ✅ Authentication: Password required (via --requirepass)
# ✅ ACL: Fine-grained user permissions (when enabled)
# ✅ TLS/SSL: Encrypted connections (when enabled)
# ✅ Command Protection: Dangerous commands renamed
# ✅ Network: Protected mode enabled
# ✅ Persistence: AOF + RDB dual persistence
# ✅ Memory: Limits and eviction policy configured
# ✅ Monitoring: Slow log and latency monitoring enabled
# ✅ Connection Limits: Prevent resource exhaustion
# ✅ Timeouts: Detect and close dead connections
#
# DEPLOYMENT NOTES:
# - For TLS: Uncomment TLS settings and mount certificates
# - For ACL: Uncomment ACL users and set passwords via environment
# - For HA: Use docker-compose.redis-ha.yml with Sentinel
# - For Kubernetes: Add --maxmemory and --maxmemory-policy to command
#
# ═══════════════════════════════════════════════════════════════════════════════
