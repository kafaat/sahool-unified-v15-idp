/**
 * Namespace Fix for Android Gradle Plugin 8.0+
 *
 * This script patches third-party Flutter plugins that are missing the required
 * namespace declaration. AGP 8.0+ requires all Android libraries to have
 * a namespace defined in their build.gradle files.
 */

// Map of known plugins and their namespaces
def pluginNamespaces = [
    'isar_flutter_libs': 'dev.isar.isar_flutter_libs',
    'path_provider_android': 'io.flutter.plugins.pathprovider',
    'shared_preferences_android': 'io.flutter.plugins.sharedpreferences',
    'sqflite': 'com.tekartik.sqflite',
    'sqlite3_flutter_libs': 'eu.simonbinder.sqlite3_flutter_libs',
    'connectivity_plus': 'dev.fluttercommunity.plus.connectivity',
    'flutter_secure_storage': 'com.it_nomads.fluttersecurestorage',
    'image_picker_android': 'io.flutter.plugins.imagepicker',
    'camera_android': 'io.flutter.plugins.camera',
    'workmanager': 'dev.fluttercommunity.workmanager',
]

gradle.beforeProject { project ->
    // Skip root project
    if (project == rootProject) return

    project.afterEvaluate {
        if (project.plugins.hasPlugin('com.android.library')) {
            def android = project.extensions.findByName('android')
            if (android != null && (android.namespace == null || android.namespace.toString().isEmpty())) {
                // Try to get from known list first
                def namespace = pluginNamespaces.get(project.name)
                if (namespace == null) {
                    // Generate namespace from project name
                    namespace = "plugin.${project.name.replaceAll('[^a-zA-Z0-9_]', '_')}"
                }
                try {
                    android.namespace = namespace
                    println "✅ Set namespace for ${project.name}: ${namespace}"
                } catch (Exception e) {
                    println "⚠️ Could not set namespace for ${project.name}: ${e.message}"
                }
            }
        }
    }
}

// Also try subprojects approach as backup
subprojects { project ->
    afterEvaluate {
        if (project.plugins.hasPlugin('com.android.library')) {
            def android = project.extensions.findByName('android')
            if (android != null && (android.namespace == null || android.namespace.toString().isEmpty())) {
                def namespace = pluginNamespaces.get(project.name)
                if (namespace == null) {
                    namespace = "plugin.${project.name.replaceAll('[^a-zA-Z0-9_]', '_')}"
                }
                try {
                    android.namespace = namespace
                    println "✅ [backup] Set namespace for ${project.name}: ${namespace}"
                } catch (Exception e) {
                    // Ignore - might already be set
                }
            }
        }
    }
}
