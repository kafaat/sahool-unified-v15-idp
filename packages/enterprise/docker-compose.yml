# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL Enterprise Package - حزمة سهول للمؤسسات
# Complete agricultural platform for large enterprises
# ═══════════════════════════════════════════════════════════════════════════════
#
# Services included:
# - All Professional services
# - AI Services: ai_advisor (with RAG), qdrant
# - IoT: iot_gateway
# - Research: research_core, crop_growth_model, lai_estimation, disaster_assessment
# - Business: marketplace_service, billing_core
# - Monitoring: prometheus, grafana
#
# Usage:
#   docker-compose up -d
#   docker-compose up -d --wait
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # Infrastructure Services
  # ─────────────────────────────────────────────────────────────────────────────

  postgres:
    image: postgis/postgis:16-3.4
    container_name: sahool-enterprise-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-sahool}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../../infra/postgres/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sahool} -d ${POSTGRES_DB:-sahool}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  redis:
    image: redis:7.4-alpine
    container_name: sahool-enterprise-redis
    command: [
      "redis-server",
      "--appendonly", "yes",
      "--requirepass", "${REDIS_PASSWORD:?REDIS_PASSWORD is required}",
      "--maxmemory", "1gb",
      "--maxmemory-policy", "allkeys-lru",
      "--tcp-keepalive", "60"
    ]
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:?REDIS_PASSWORD is required}
    volumes:
      - redis_data:/data
    ports:
      - "127.0.0.1:6379:6379"
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a $${REDIS_PASSWORD} ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '1.0'
          memory: 512M
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  nats:
    image: nats:2.10.24-alpine
    container_name: sahool-enterprise-nats
    command: ["--jetstream", "--store_dir=/data", "-m", "8222"]
    volumes:
      - nats_data:/data
    ports:
      - "127.0.0.1:4222:4222"
      - "127.0.0.1:8222:8222"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '1.0'
          memory: 512M
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # Qdrant Vector Database - قاعدة البيانات المتجهة للـ RAG
  qdrant:
    image: qdrant/qdrant:v1.10.1
    container_name: sahool-enterprise-qdrant
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - "127.0.0.1:6333:6333"
      - "127.0.0.1:6334:6334"
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:6333/readyz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # MQTT Broker - وسيط MQTT لإنترنت الأشياء
  mqtt:
    image: eclipse-mosquitto:2.0.20
    container_name: sahool-enterprise-mqtt
    volumes:
      - ../../infra/mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ../../infra/mqtt/passwd:/mosquitto/config/passwd:ro
      - mqtt_data:/mosquitto/data
      - mqtt_logs:/mosquitto/log
    ports:
      - "127.0.0.1:1883:1883"
      - "127.0.0.1:9001:9001"
    healthcheck:
      test: ["CMD-SHELL", "pidof mosquitto || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Core Services
  # ─────────────────────────────────────────────────────────────────────────────

  field_core:
    build:
      context: ../../apps/services/field-management-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-field-management-service
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER:-sahool}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-sahool}
      - DB_NAME=${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  weather_core:
    build:
      context: ../../apps/services/weather-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-weather-service
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - PORT=8108
      - USE_MULTI_PROVIDER=${USE_MULTI_PROVIDER:-true}
      - USE_MOCK_WEATHER=${USE_MOCK_WEATHER:-false}
      - OPENWEATHERMAP_API_KEY=${OPENWEATHERMAP_API_KEY:-}
      - WEATHERAPI_KEY=${WEATHERAPI_KEY:-}
    ports:
      - "8108:8108"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8108/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  astronomical_calendar:
    build:
      context: ../../apps/services/astronomical-calendar
      dockerfile: Dockerfile
    container_name: sahool-enterprise-astronomical-calendar
    environment:
      - PORT=8111
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - WEATHER_SERVICE_URL=http://weather_core:8108
    ports:
      - "8111:8111"
    depends_on:
      weather_core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8111/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  agro_advisor:
    build:
      context: ../../apps/services/advisory-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-advisory-service
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - PORT=8105
    ports:
      - "8105:8105"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8105/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  notification_service:
    build:
      context: ../../apps/services/notification-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-notification-service
    environment:
      - PORT=8110
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - NATS_URL=nats://nats:4222
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL:-noreply@sahool.com}
      - FCM_SERVER_KEY=${FCM_SERVER_KEY:-}
    ports:
      - "8110:8110"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8110/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Professional Tier Services
  # ─────────────────────────────────────────────────────────────────────────────

  satellite_service:
    build:
      context: ../../apps/services/vegetation-analysis-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-vegetation-analysis-service
    environment:
      - PORT=8090
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - USE_MULTI_PROVIDER=${USE_MULTI_PROVIDER:-true}
      - SENTINEL_HUB_CLIENT_ID=${SENTINEL_HUB_CLIENT_ID:-}
      - SENTINEL_HUB_CLIENT_SECRET=${SENTINEL_HUB_CLIENT_SECRET:-}
      - NASA_EARTHDATA_USERNAME=${NASA_EARTHDATA_USERNAME:-}
      - NASA_EARTHDATA_PASSWORD=${NASA_EARTHDATA_PASSWORD:-}
      - PLANET_API_KEY=${PLANET_API_KEY:-}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8090:8090"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8090/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '3.0'
          memory: 4G
        reservations:
          cpus: '1.5'
          memory: 2G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  ndvi_engine:
    build:
      context: ../../apps/services/vegetation-analysis-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-vegetation-analysis-service
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - PORT=8107
    ports:
      - "8107:8107"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8107/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  crop_health_ai:
    build:
      context: ../../apps/services/crop-intelligence-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-crop-intelligence-service
    environment:
      - PORT=8095
      - MODEL_PATH=/app/models/plant_disease.tflite
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8095:8095"
    volumes:
      - ../../models:/app/models:ro
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8095/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  irrigation_smart:
    build:
      context: ../../apps/services/irrigation-smart
      dockerfile: Dockerfile
    container_name: sahool-enterprise-irrigation-smart
    environment:
      - PORT=8094
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - IOT_GATEWAY_URL=http://iot_gateway:8106
    ports:
      - "8094:8094"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8094/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  virtual_sensors:
    build:
      context: ../../apps/services/virtual-sensors
      dockerfile: Dockerfile
    container_name: sahool-enterprise-virtual-sensors
    environment:
      - PORT=8096
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8096:8096"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8096/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  yield_engine:
    build:
      context: ../../apps/services/yield-prediction-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-yield-prediction-service
    environment:
      - PORT=8098
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8098:8098"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8098/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '3.0'
          memory: 4G
        reservations:
          cpus: '1.5'
          memory: 2G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  fertilizer_advisor:
    build:
      context: ../../apps/services/advisory-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-advisory-service
    environment:
      - PORT=8093
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
    ports:
      - "8093:8093"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8093/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  inventory_service:
    build:
      context: ../../apps/services/inventory-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-inventory-service
    environment:
      - PORT=8113
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - NATS_URL=nats://nats:4222
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
    ports:
      - "8113:8113"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8113/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Enterprise Tier Services
  # ─────────────────────────────────────────────────────────────────────────────

  # AI Advisor - المستشار الذكي المتعدد الوكلاء (Multi-Agent AI with RAG)
  ai_advisor:
    build:
      context: ../../apps/services/ai-advisor
      dockerfile: Dockerfile
    container_name: sahool-enterprise-ai-advisor
    environment:
      - SERVICE_PORT=8112
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      # Multi-Provider LLM Configuration
      - USE_MULTI_PROVIDER=${USE_MULTI_PROVIDER:-true}
      - PRIMARY_LLM_PROVIDER=${PRIMARY_LLM_PROVIDER:-anthropic}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-3-5-sonnet-20241022}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-pro}
      # Service URLs
      - CROP_HEALTH_URL=http://crop_health_ai:8095
      - WEATHER_URL=http://weather_core:8108
      - SATELLITE_URL=http://satellite_service:8090
      - AGRO_ADVISOR_URL=http://agro_advisor:8105
      - NDVI_URL=http://ndvi_engine:8107
      # RAG Configuration
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - EMBEDDING_MODEL=paraphrase-multilingual-MiniLM-L12-v2
      - NATS_URL=nats://nats:4222
    ports:
      - "8112:8112"
    depends_on:
      qdrant:
        condition: service_healthy
      nats:
        condition: service_healthy
      crop_health_ai:
        condition: service_healthy
      weather_core:
        condition: service_healthy
      agro_advisor:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8112/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # IoT Gateway - بوابة إنترنت الأشياء
  iot_gateway:
    build:
      context: ../../apps/services/iot-gateway
      dockerfile: Dockerfile
    container_name: sahool-enterprise-iot-gateway
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - NATS_URL=nats://nats:4222
      - MQTT_BROKER=mqtt
      - MQTT_PORT=1883
      - MQTT_USER=${MQTT_USER:-sahool_iot}
      - MQTT_PASSWORD=${MQTT_PASSWORD:?MQTT_PASSWORD is required}
      - MQTT_TOPIC=sahool/sensors/#
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - PORT=8106
    ports:
      - "8106:8106"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      mqtt:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8106/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # Research Core - نواة البحث العلمي
  research_core:
    build:
      context: ../../apps/services/research-core
      dockerfile: Dockerfile
    container_name: sahool-enterprise-research-core
    environment:
      - PORT=3015
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - SIGNATURE_SECRET_KEY=${JWT_SECRET_KEY}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:8080}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "3015:3015"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3015/api/v1/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # Marketplace Service - سوق سهول
  marketplace_service:
    build:
      context: ../../apps/services/marketplace-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-marketplace
    environment:
      - PORT=3010
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://sahool.com,https://app.sahool.com}
    ports:
      - "3010:3010"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3010/api/v1/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # Billing Core - نواة الفوترة
  billing_core:
    build:
      context: ../../apps/services/billing-core
      dockerfile: Dockerfile
    container_name: sahool-enterprise-billing-core
    environment:
      - PORT=8089
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - NATS_URL=nats://nats:4222
      - STRIPE_API_KEY=${STRIPE_API_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - THARWATT_BASE_URL=${THARWATT_BASE_URL:-https://developers-test.tharwatt.com:5253}
      - THARWATT_API_KEY=${THARWATT_API_KEY:-}
      - THARWATT_MERCHANT_ID=${THARWATT_MERCHANT_ID:-}
      - THARWATT_WEBHOOK_SECRET=${THARWATT_WEBHOOK_SECRET:-}
    ports:
      - "8089:8089"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8089/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # Disaster Assessment - تقييم الكوارث
  disaster_assessment:
    build:
      context: ../../apps/services/disaster-assessment
      dockerfile: Dockerfile
    container_name: sahool-enterprise-disaster-assessment
    environment:
      - PORT=3020
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://sahool.com,https://app.sahool.com}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "3020:3020"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3020/api/v1/disasters/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # Crop Growth Model - نموذج نمو المحاصيل
  crop_growth_model:
    build:
      context: ../../apps/services/crop-intelligence-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-crop-intelligence-service
    environment:
      - PORT=3023
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://sahool.com,https://app.sahool.com}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "3023:3023"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3023/api/v1/simulation/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '3.0'
          memory: 4G
        reservations:
          cpus: '1.5'
          memory: 2G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # LAI Estimation - تقدير مؤشر مساحة الأوراق
  lai_estimation:
    build:
      context: ../../apps/services/vegetation-analysis-service
      dockerfile: Dockerfile
    container_name: sahool-enterprise-vegetation-analysis-service
    environment:
      - PORT=3022
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sahool}:${POSTGRES_PASSWORD:-sahool}@postgres:5432/${POSTGRES_DB:-sahool}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://sahool.com,https://app.sahool.com}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "3022:3022"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3022/api/v1/lai/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '3.0'
          memory: 4G
        reservations:
          cpus: '1.5'
          memory: 2G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  # ─────────────────────────────────────────────────────────────────────────────
  # Observability Stack
  # ─────────────────────────────────────────────────────────────────────────────

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: sahool-enterprise-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    volumes:
      - ../../observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ../../observability/alerts:/etc/prometheus/alerts:ro
      - prometheus_data:/prometheus
    ports:
      - "127.0.0.1:9090:9090"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

  grafana:
    image: grafana/grafana:10.2.0
    container_name: sahool-enterprise-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD is required}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3002}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - ../../observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - ../../observability/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    ports:
      - "127.0.0.1:3002:3000"
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped
    networks:
      - sahool-enterprise-network

# ─────────────────────────────────────────────────────────────────────────────
# Networks
# ─────────────────────────────────────────────────────────────────────────────
networks:
  sahool-enterprise-network:
    driver: bridge
    name: sahool-enterprise-network

# ─────────────────────────────────────────────────────────────────────────────
# Volumes
# ─────────────────────────────────────────────────────────────────────────────
volumes:
  postgres_data:
    name: sahool-enterprise-postgres-data
  redis_data:
    name: sahool-enterprise-redis-data
  nats_data:
    name: sahool-enterprise-nats-data
  qdrant_data:
    name: sahool-enterprise-qdrant-data
  mqtt_data:
    name: sahool-enterprise-mqtt-data
  mqtt_logs:
    name: sahool-enterprise-mqtt-logs
  prometheus_data:
    name: sahool-enterprise-prometheus-data
  grafana_data:
    name: sahool-enterprise-grafana-data
