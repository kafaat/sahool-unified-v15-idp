name: SAHOOL - System Audit & Test

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

env:
  SAHOOL_ENV: ci

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install audit dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/audit/requirements.txt

      - name: Run Governance Audit
        run: python tools/audit/audit.py

      - name: Check for unified runner in kernel
        run: |
          if find kernel/services -name "unified_services.py" | grep -q .; then
            echo "❌ Unified runner detected in kernel services!"
            exit 1
          fi
          echo "✅ No unified runners in kernel"

  test:
    runs-on: ubuntu-latest
    needs: audit
    services:
      nats:
        image: nats:2.10
        ports:
          - 4222:4222
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r shared/requirements.txt
          pip install -r tools/audit/requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run integration tests
        run: pytest tests/integration/ -v --cov=kernel/services
        env:
          NATS_URL: nats://localhost:4222
          REDIS_URL: redis://localhost:6379

  security-scan:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-results.sarif

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif

  performance-test:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run performance tests
        run: k6 run tests/performance/k6-load-test.js
