services:
  postgres:
    image: postgis/postgis:16-3.4
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-sahool}
      POSTGRES_USER: ${POSTGRES_USER:-sahool}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-sahool}
    ports:
    - ${POSTGRES_PORT:-5432}:5432
    volumes:
    - pgdata:/var/lib/postgresql/data
    - ./infrastructure/postgres/init:/docker-entrypoint-initdb.d
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB
      interval: 10s
      timeout: 5s
      retries: 10
  redis:
    image: redis:7-alpine
    command:
    - redis-server
    - --appendonly
    - 'yes'
    ports:
    - ${REDIS_PORT:-6379}:6379
    volumes:
    - redisdata:/data
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 5s
      retries: 10
  auth-service:
    build: ./platform-core/auth-service
    environment:
      PORT: 3001
      DATABASE_URL: ${DATABASE_URL:-postgresql://sahool:sahool@postgres:5432/sahool}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      JWT_ISSUER: ${JWT_ISSUER:-sahool}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-sahool-clients}
      JWT_PRIVATE_KEY_PATH: /run/secrets/jwt_private_key
      JWT_PUBLIC_KEY_PATH: /run/secrets/jwt_public_key
      PASSWORD_PEPPER: ${PASSWORD_PEPPER:-change_me}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    secrets:
    - jwt_private_key
    - jwt_public_key
    ports:
    - 3001:3001
  api-gateway:
    build: ./platform-core/api-gateway
    environment:
      PORT: 3000
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      AUTH_SERVICE_URL: http://auth-service:3001
      JWT_PUBLIC_KEY_PATH: /run/secrets/jwt_public_key
      WEATHER_SERVICE_URL: http://weather-signal:3010
      NDVI_SERVICE_URL: http://ndvi-signal:3011
      CALENDAR_SERVICE_URL: http://astronomical-calendar-signal:3013
      ADVISOR_SERVICE_URL: http://crop-advisor:3020
      TASK_SERVICE_URL: http://task-manager:3030
      ALERT_SERVICE_URL: http://alert-dispatcher:3031
    depends_on:
      auth-service:
        condition: service_started
      redis:
        condition: service_healthy
    secrets:
    - jwt_public_key
    ports:
    - 3000:3000
  weather-signal:
    build: ./signal-producers/weather-signal
    environment:
      PORT: 3010
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
    depends_on:
      redis:
        condition: service_healthy
    ports:
    - 3010:3010
  ndvi-signal:
    build: ./signal-producers/ndvi-signal
    environment:
      PORT: 3011
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
    depends_on:
      redis:
        condition: service_healthy
    ports:
    - 3011:3011
  astronomical-calendar-signal:
    build: ./signal-producers/astronomical-calendar-signal
    environment:
      PORT: 3013
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
    depends_on:
      redis:
        condition: service_healthy
    ports:
    - 3013:3013
  crop-advisor:
    build: ./decision-services/crop-advisor
    environment:
      PORT: 3020
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
    depends_on:
      redis:
        condition: service_healthy
    ports:
    - 3020:3020
  task-manager:
    build: ./execution-services/task-manager
    environment:
      PORT: 3030
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
    depends_on:
      redis:
        condition: service_healthy
    ports:
    - 3030:3030
  alert-dispatcher:
    build: ./execution-services/alert-dispatcher
    environment:
      PORT: 3031
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
    depends_on:
      redis:
        condition: service_healthy
    ports:
    - 3031:3031
  nats:
    image: nats:2.10-alpine
    ports:
    - 4222:4222
    - 8222:8222
    command:
    - -js
    - -m
    - '8222'
secrets:
  jwt_private_key:
    file: ./infrastructure/secrets/jwt_private.pem
  jwt_public_key:
    file: ./infrastructure/secrets/jwt_public.pem
volumes:
  pgdata: null
  redisdata: null
