# ═══════════════════════════════════════════════════════════════════════════════
# OpenTelemetry Collector Configuration for SAHOOL Platform
# تكوين مجمع OpenTelemetry لمنصة سهول
# ═══════════════════════════════════════════════════════════════════════════════
# Version: 1.0.0
# Date: 2025-12-26
# Purpose: Collect, process, and export telemetry data from 44+ microservices

# Receivers - المستقبلات
# Accept telemetry data from various sources
receivers:
  # OTLP gRPC receiver - مستقبل OTLP gRPC
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # Jaeger receiver (for backward compatibility) - مستقبل Jaeger
  jaeger:
    protocols:
      grpc:
        endpoint: 0.0.0.0:14250
      thrift_http:
        endpoint: 0.0.0.0:14268
      thrift_compact:
        endpoint: 0.0.0.0:6831
      thrift_binary:
        endpoint: 0.0.0.0:6832

  # Zipkin receiver - مستقبل Zipkin
  zipkin:
    endpoint: 0.0.0.0:9411

  # Prometheus receiver - مستقبل Prometheus
  prometheus:
    config:
      scrape_configs:
        # Scrape from all SAHOOL services
        - job_name: 'sahool-services'
          scrape_interval: 30s
          static_configs:
            # Core services
            - targets:
                - 'field_core:9090'
                - 'field_ops:9090'
                - 'field_service:9090'
              labels:
                service_group: 'core'

            # Weather services
            - targets:
                - 'weather_core:9090'
                - 'weather_advanced:9090'
              labels:
                service_group: 'weather'

            # Satellite services
            - targets:
                - 'satellite_service:9090'
                - 'ndvi_engine:9090'
                - 'ndvi_processor:9090'
              labels:
                service_group: 'satellite'

            # AI/ML services
            - targets:
                - 'crop_health_ai:9090'
                - 'crop_health:9090'
                - 'crop_growth_model:9090'
                - 'lai_estimation:9090'
                - 'yield_engine:9090'
                - 'yield_prediction:9090'
              labels:
                service_group: 'ai'

            # Advisory services
            - targets:
                - 'ai_advisor:9090'
                - 'agro_advisor:9090'
                - 'agro_rules:9090'
                - 'fertilizer_advisor:9090'
                - 'irrigation_smart:9090'
              labels:
                service_group: 'advisory'

            # IoT services
            - targets:
                - 'iot_gateway:9090'
                - 'iot_service:9090'
                - 'virtual_sensors:9090'
              labels:
                service_group: 'iot'

            # Analytics services
            - targets:
                - 'indicators_service:9090'
                - 'astronomical_calendar:9090'
                - 'disaster_assessment:9090'
              labels:
                service_group: 'analytics'

            # Communication services
            - targets:
                - 'notification_service:9090'
                - 'alert_service:9090'
                - 'chat_service:9090'
                - 'community_chat:9090'
                - 'field_chat:9090'
              labels:
                service_group: 'communication'

            # Business services
            - targets:
                - 'billing_core:9090'
                - 'marketplace_service:9090'
                - 'inventory_service:9090'
                - 'equipment_service:9090'
                - 'task_service:9090'
              labels:
                service_group: 'business'

            # Infrastructure
            - targets:
                - 'ws_gateway:9090'
              labels:
                service_group: 'infrastructure'

# Processors - المعالجات
# Process and transform telemetry data
processors:
  # Batch processor - معالج الدُفعات
  batch:
    timeout: 10s
    send_batch_size: 1024
    send_batch_max_size: 2048

  # Memory limiter - محدد الذاكرة
  memory_limiter:
    check_interval: 1s
    limit_mib: 512
    spike_limit_mib: 128

  # Resource processor - معالج الموارد
  resource:
    attributes:
      - key: service.namespace
        value: sahool
        action: upsert
      - key: deployment.environment
        from_attribute: ENVIRONMENT
        action: insert

  # Attributes processor - معالج السمات
  attributes:
    actions:
      # Add SAHOOL-specific attributes
      - key: platform
        value: sahool
        action: insert
      - key: platform.version
        value: 16.0.0
        action: insert
      - key: region
        value: mena
        action: insert

  # Span processor - معالج النطاقات
  span:
    name:
      # Rename spans for consistency
      from_attributes: ["http.method", "http.route"]
      separator: " "

  # Filter processor - معالج التصفية
  filter:
    traces:
      span:
        # Exclude health check endpoints
        - 'attributes["http.target"] == "/health"'
        - 'attributes["http.target"] == "/ready"'
        - 'attributes["http.target"] == "/metrics"'

  # Tail sampling processor - معالج أخذ العينات الذيلية
  tail_sampling:
    decision_wait: 10s
    num_traces: 100
    expected_new_traces_per_sec: 10
    policies:
      # Always sample errors
      - name: errors
        type: status_code
        status_code:
          status_codes:
            - ERROR
      # Always sample slow requests
      - name: slow_requests
        type: latency
        latency:
          threshold_ms: 1000
      # Sample 10% of other traces
      - name: probabilistic
        type: probabilistic
        probabilistic:
          sampling_percentage: 10

# Exporters - المُصدِّرات
# Send telemetry data to backends
exporters:
  # OTLP exporter to Jaeger - مُصدِّر OTLP إلى Jaeger
  otlp/jaeger:
    endpoint: jaeger:4317
    tls:
      insecure: true

  # Jaeger exporter - مُصدِّر Jaeger
  jaeger:
    endpoint: jaeger:14250
    tls:
      insecure: true

  # Prometheus exporter - مُصدِّر Prometheus
  prometheus:
    endpoint: 0.0.0.0:8889
    namespace: sahool
    const_labels:
      platform: sahool
      version: 16.0.0

  # Logging exporter for debugging - مُصدِّر السجل للتصحيح
  logging:
    loglevel: info
    sampling_initial: 5
    sampling_thereafter: 200

  # Prometheus remote write - كتابة Prometheus عن بعد
  prometheusremotewrite:
    endpoint: http://prometheus:9090/api/v1/write
    tls:
      insecure: true

# Extensions - الإضافات
# Additional capabilities
extensions:
  # Health check extension - إضافة فحص الصحة
  health_check:
    endpoint: 0.0.0.0:13133

  # pprof extension for profiling - إضافة pprof للتحليل
  pprof:
    endpoint: 0.0.0.0:1777

  # zpages extension for debugging - إضافة zpages للتصحيح
  zpages:
    endpoint: 0.0.0.0:55679

# Service - الخدمة
# Configure telemetry pipelines
service:
  extensions:
    - health_check
    - pprof
    - zpages

  pipelines:
    # Traces pipeline - خط معالجة الآثار
    traces:
      receivers:
        - otlp
        - jaeger
        - zipkin
      processors:
        - memory_limiter
        - resource
        - attributes
        - span
        - filter
        - tail_sampling
        - batch
      exporters:
        - otlp/jaeger
        - jaeger
        - logging

    # Metrics pipeline - خط معالجة المقاييس
    metrics:
      receivers:
        - otlp
        - prometheus
      processors:
        - memory_limiter
        - resource
        - attributes
        - batch
      exporters:
        - prometheus
        - prometheusremotewrite
        - logging

    # Logs pipeline - خط معالجة السجلات
    logs:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - resource
        - attributes
        - batch
      exporters:
        - logging

  # Telemetry for the collector itself
  telemetry:
    logs:
      level: info
    metrics:
      level: detailed
      address: 0.0.0.0:8888
