version: '3.8'

# SAHOOL Platform - Load Testing Infrastructure
# Includes k6, InfluxDB for metrics storage, and Grafana for visualization

networks:
  load-test:
    driver: bridge
  sahool-network:
    external: true
    name: sahool-network

volumes:
  influxdb-data:
  grafana-data:

services:
  # InfluxDB for storing k6 metrics
  influxdb:
    image: influxdb:2.7-alpine
    container_name: sahool-loadtest-influxdb
    networks:
      - load-test
    ports:
      - "127.0.0.1:8086:8086"  # Bind to localhost only for security
    environment:
      # Setup mode
      - DOCKER_INFLUXDB_INIT_MODE=setup
      # Admin credentials - MUST use secrets from .env file
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USERNAME:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_ADMIN_TOKEN}
      # Organization and bucket
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG:-sahool}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET:-k6}
      - DOCKER_INFLUXDB_INIT_RETENTION=${INFLUXDB_RETENTION:-30d}
      # TLS Configuration (uncomment when certificates are generated)
      # - INFLUXD_TLS_CERT=${INFLUXDB_TLS_CERT_PATH:-/etc/ssl/influxdb-cert.pem}
      # - INFLUXD_TLS_KEY=${INFLUXDB_TLS_KEY_PATH:-/etc/ssl/influxdb-key.pem}
      # Performance and security settings
      - INFLUXD_STORAGE_CACHE_MAX_MEMORY_SIZE=1073741824  # 1GB cache
      - INFLUXD_STORAGE_CACHE_SNAPSHOT_MEMORY_SIZE=26214400  # 25MB
      - INFLUXD_HTTP_READ_TIMEOUT=30s
      - INFLUXD_HTTP_WRITE_TIMEOUT=30s
      - INFLUXD_HTTP_IDLE_TIMEOUT=120s
      - INFLUXD_QUERY_CONCURRENCY=100
      - INFLUXD_LOG_LEVEL=info
      # Enable metrics endpoint for Prometheus
      - INFLUXD_METRICS_DISABLED=false
    volumes:
      - influxdb-data:/var/lib/influxdb2
      # Mount configuration file (optional)
      - ./config/influxdb/influxdb.conf:/etc/influxdb2/config.yml:ro
      # Mount TLS certificates (uncomment when certificates are generated)
      # - ./ssl/influxdb-load-cert.pem:/etc/ssl/influxdb-cert.pem:ro
      # - ./ssl/influxdb-load-key.pem:/etc/ssl/influxdb-key.pem:ro
    env_file:
      # Load secrets from environment file (NOT committed to git)
      - .env.influxdb.secret
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
        reservations:
          memory: 512M
          cpus: '0.5'

  # Grafana for visualizing k6 metrics
  grafana:
    image: grafana/grafana:10.2.0
    container_name: sahool-loadtest-grafana
    networks:
      - load-test
    ports:
      - "3030:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # k6 load testing tool
  k6:
    image: grafana/k6:0.48.0
    container_name: sahool-loadtest-k6
    networks:
      - load-test
      - sahool-network
    environment:
      # InfluxDB output configuration
      # Use HTTPS when TLS is enabled: influxdb=https://influxdb:8086/k6
      - K6_OUT=influxdb=http://influxdb:8086/k6
      - K6_INFLUXDB_ORGANIZATION=${INFLUXDB_ORG:-sahool}
      - K6_INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-k6}
      - K6_INFLUXDB_INSECURE=false  # Set to true only for self-signed certs
      # Use write-only token from secrets file
      - K6_INFLUXDB_TOKEN=${INFLUXDB_K6_WRITE_TOKEN}
      - BASE_URL=${BASE_URL:-http://sahool-kong:8000}
      - FIELD_SERVICE_URL=${FIELD_SERVICE_URL:-http://sahool-field-ops:8080}
      - WEATHER_URL=${WEATHER_URL:-http://sahool-weather-advanced:8092}
      - BILLING_URL=${BILLING_URL:-http://sahool-billing-core:8089}
      - SATELLITE_URL=${SATELLITE_URL:-http://sahool-satellite-service:8090}
      - EQUIPMENT_URL=${EQUIPMENT_URL:-http://sahool-equipment-service:8101}
      - TASK_URL=${TASK_URL:-http://sahool-task-service:8103}
      - CROP_HEALTH_URL=${CROP_HEALTH_URL:-http://sahool-crop-health-ai:8095}
      - ENVIRONMENT=${ENVIRONMENT:-docker}
    volumes:
      - ./scenarios:/scripts/scenarios
      - ./lib:/scripts/lib
      - ./results:/results
    working_dir: /scripts
    depends_on:
      influxdb:
        condition: service_healthy
    # Override command to run specific test
    # Example: docker-compose -f docker-compose.load.yml run k6 run scenarios/smoke.js
    command: ["run", "--quiet", "scenarios/smoke.js"]

  # k6 Operator (alternative - for Kubernetes integration)
  # Uncomment if using Kubernetes
  # k6-operator:
  #   image: grafana/k6-operator:latest
  #   container_name: sahool-k6-operator
  #   networks:
  #     - load-test

# Helper services for load test preparation

  # Load test data initializer
  load-test-init:
    # Using 8.5.0 - stable curl version for reliable HTTP requests
    # استخدام الإصدار 8.5.0 - إصدار ثابت من curl لطلبات HTTP موثوقة
    image: curlimages/curl:8.5.0
    container_name: sahool-loadtest-init
    networks:
      - load-test
      - sahool-network
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Waiting for services to be ready..."
        sleep 10
        echo "Load test environment ready!"
    depends_on:
      - influxdb
      - grafana

# Usage Instructions:
#
# 1. Start the load testing infrastructure:
#    docker-compose -f docker-compose.load.yml up -d influxdb grafana
#
# 2. Run a specific test:
#    docker-compose -f docker-compose.load.yml run --rm k6 run scenarios/smoke.js
#    docker-compose -f docker-compose.load.yml run --rm k6 run scenarios/load.js
#    docker-compose -f docker-compose.load.yml run --rm k6 run scenarios/stress.js
#    docker-compose -f docker-compose.load.yml run --rm k6 run scenarios/spike.js
#    docker-compose -f docker-compose.load.yml run --rm k6 run scenarios/soak.js
#
# 3. View results in Grafana:
#    Open http://localhost:3030
#    Default credentials: admin/admin
#
# 4. Stop infrastructure:
#    docker-compose -f docker-compose.load.yml down
#
# 5. Clean up (including data):
#    docker-compose -f docker-compose.load.yml down -v
#
# Environment Variables:
# - BASE_URL: Base API gateway URL
# - FIELD_SERVICE_URL: Field service endpoint
# - WEATHER_URL: Weather service endpoint
# - BILLING_URL: Billing service endpoint
# - ENVIRONMENT: Environment name (default: docker)
