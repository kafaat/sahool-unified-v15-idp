# ═══════════════════════════════════════════════════════════════════════════════
# SAHOOL IDP - Advanced Nginx Load Balancer Configuration
# تكوين موازن الحمل المتقدم لمنصة سهول
# ═══════════════════════════════════════════════════════════════════════════════
#
# Features:
# - 5 application instances
# - Advanced health checks
# - Connection limiting
# - Request buffering optimization
# - Caching for static content
#
# ═══════════════════════════════════════════════════════════════════════════════

worker_processes auto;
worker_rlimit_nofile 100000;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 10000;
    use epoll;
    multi_accept on;
}

http {
    # ═══════════════════════════════════════════════════════════════════════════
    # BASIC SETTINGS
    # ═══════════════════════════════════════════════════════════════════════════

    include /etc/nginx/mime.types;
    default_type application/json;

    # Logging format
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'upstream=$upstream_addr rt=$request_time '
                    'uct=$upstream_connect_time uht=$upstream_header_time '
                    'urt=$upstream_response_time';

    log_format json_log escape=json '{'
        '"timestamp":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_addr":"$upstream_addr",'
        '"upstream_response_time":"$upstream_response_time",'
        '"instance_id":"$upstream_http_x_instance_id"'
    '}';

    access_log /var/log/nginx/access.log json_log;

    # ═══════════════════════════════════════════════════════════════════════════
    # PERFORMANCE OPTIMIZATIONS
    # ═══════════════════════════════════════════════════════════════════════════

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # Keep-alive
    keepalive_timeout 65;
    keepalive_requests 10000;

    # Buffers
    client_body_buffer_size 32k;
    client_max_body_size 50m;
    client_header_buffer_size 2k;
    large_client_header_buffers 4 32k;

    # Timeouts
    client_body_timeout 60;
    client_header_timeout 60;
    send_timeout 60;

    # Compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 256;
    gzip_types application/json application/javascript text/css text/plain text/xml;

    # ═══════════════════════════════════════════════════════════════════════════
    # RATE LIMITING
    # ═══════════════════════════════════════════════════════════════════════════

    # API rate limit: 500 req/s per IP (higher for load testing)
    limit_req_zone $binary_remote_addr zone=api_limit:20m rate=500r/s;

    # Auth rate limit: 50 req/s per IP
    limit_req_zone $binary_remote_addr zone=auth_limit:20m rate=50r/s;

    # Connection limit: 200 concurrent per IP
    limit_conn_zone $binary_remote_addr zone=conn_limit:20m;

    # ═══════════════════════════════════════════════════════════════════════════
    # UPSTREAM - 5 Application Instances
    # ═══════════════════════════════════════════════════════════════════════════

    upstream sahool_backend {
        least_conn;

        # 5 application instances
        server sahool-app-1:8080 weight=1 max_fails=3 fail_timeout=30s;
        server sahool-app-2:8080 weight=1 max_fails=3 fail_timeout=30s;
        server sahool-app-3:8080 weight=1 max_fails=3 fail_timeout=30s;
        server sahool-app-4:8080 weight=1 max_fails=3 fail_timeout=30s;
        server sahool-app-5:8080 weight=1 max_fails=3 fail_timeout=30s;

        # Keepalive connections
        keepalive 100;
        keepalive_timeout 120s;
        keepalive_requests 10000;
    }

    # ═══════════════════════════════════════════════════════════════════════════
    # CACHING (optional for static content)
    # ═══════════════════════════════════════════════════════════════════════════

    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m use_temp_path=off;

    # ═══════════════════════════════════════════════════════════════════════════
    # SERVER
    # ═══════════════════════════════════════════════════════════════════════════

    server {
        listen 80;
        server_name localhost;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Request-ID $request_id always;

        # ═══════════════════════════════════════════════════════════════════════
        # HEALTH & STATUS ENDPOINTS
        # ═══════════════════════════════════════════════════════════════════════

        location /nginx-health {
            access_log off;
            return 200 '{"status":"healthy","service":"nginx-lb-advanced","instances":5}';
            add_header Content-Type application/json;
        }

        location /nginx-status {
            access_log off;
            stub_status on;
        }

        # ═══════════════════════════════════════════════════════════════════════
        # AUTHENTICATION ENDPOINTS
        # ═══════════════════════════════════════════════════════════════════════

        location /api/auth/ {
            limit_req zone=auth_limit burst=100 nodelay;
            limit_conn conn_limit 100;

            proxy_pass http://sahool_backend;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        location /auth/ {
            limit_req zone=auth_limit burst=100 nodelay;
            limit_conn conn_limit 100;

            proxy_pass http://sahool_backend;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        # ═══════════════════════════════════════════════════════════════════════
        # API ENDPOINTS
        # ═══════════════════════════════════════════════════════════════════════

        location /api/ {
            limit_req zone=api_limit burst=200 nodelay;
            limit_conn conn_limit 200;

            proxy_pass http://sahool_backend;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        # ═══════════════════════════════════════════════════════════════════════
        # HEALTH CHECK FOR BACKEND
        # ═══════════════════════════════════════════════════════════════════════

        location /healthz {
            access_log off;
            proxy_pass http://sahool_backend;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }

        location /health {
            access_log off;
            proxy_pass http://sahool_backend;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }

        location /metrics {
            access_log off;
            proxy_pass http://sahool_backend;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }

        # ═══════════════════════════════════════════════════════════════════════
        # DEFAULT
        # ═══════════════════════════════════════════════════════════════════════

        location / {
            limit_req zone=api_limit burst=200 nodelay;
            limit_conn conn_limit 200;

            proxy_pass http://sahool_backend;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        # ═══════════════════════════════════════════════════════════════════════
        # ERROR HANDLING
        # ═══════════════════════════════════════════════════════════════════════

        error_page 502 503 504 /50x.json;
        location = /50x.json {
            internal;
            return 503 '{"error":"service_unavailable","message":"Backend servers unavailable","code":503}';
            add_header Content-Type application/json always;
        }

        error_page 429 /429.json;
        location = /429.json {
            internal;
            return 429 '{"error":"rate_limit_exceeded","message":"Too many requests","code":429}';
            add_header Content-Type application/json always;
        }
    }
}
