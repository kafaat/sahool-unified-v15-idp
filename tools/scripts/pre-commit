#!/bin/bash
# SAHOOL Pre-Commit Hook
# Run quality checks before allowing commits

set -e

echo "üîß Running SAHOOL pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get project root
PROJECT_ROOT=$(git rev-parse --show-toplevel)
cd "$PROJECT_ROOT"

# Track failures
FAILED=0

# 1. Check for dependency conflicts
echo -e "\n${YELLOW}1. Checking dependencies...${NC}"
if [ -f "tools/complete-analyzer.py" ]; then
    if python3 tools/complete-analyzer.py --quick-check > /dev/null 2>&1; then
        echo -e "${GREEN}‚úì Dependencies OK${NC}"
    else
        echo -e "${RED}‚úó Dependency conflicts detected${NC}"
        FAILED=1
    fi
else
    echo -e "${YELLOW}‚ö† Analyzer not found, skipping${NC}"
fi

# 2. Check YAML syntax
echo -e "\n${YELLOW}2. Checking YAML files...${NC}"
YAML_ERROR=0
for file in $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(yml|yaml)$'); do
    if [ -f "$file" ]; then
        if python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
            echo -e "${GREEN}‚úì $file${NC}"
        else
            echo -e "${RED}‚úó $file - Invalid YAML${NC}"
            YAML_ERROR=1
        fi
    fi
done
if [ $YAML_ERROR -eq 1 ]; then
    FAILED=1
fi

# 3. Check for secrets
echo -e "\n${YELLOW}3. Checking for secrets...${NC}"
SECRET_PATTERNS="password|secret|api_key|apikey|token|credential"
SECRETS_FOUND=0

for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if [ -f "$file" ] && [[ ! "$file" =~ \.(md|txt|lock)$ ]]; then
        if grep -iE "$SECRET_PATTERNS\s*[:=]" "$file" 2>/dev/null | grep -v "#" | grep -qv "example\|placeholder\|xxx\|your_"; then
            echo -e "${RED}‚úó Potential secret in $file${NC}"
            SECRETS_FOUND=1
        fi
    fi
done

if [ $SECRETS_FOUND -eq 0 ]; then
    echo -e "${GREEN}‚úì No secrets detected${NC}"
else
    echo -e "${YELLOW}‚ö† Review the files above for secrets${NC}"
fi

# 4. Check Python files
echo -e "\n${YELLOW}4. Checking Python files...${NC}"
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)
if [ -n "$PYTHON_FILES" ]; then
    if command -v ruff &> /dev/null; then
        if echo "$PYTHON_FILES" | xargs ruff check --quiet 2>/dev/null; then
            echo -e "${GREEN}‚úì Python linting passed${NC}"
        else
            echo -e "${YELLOW}‚ö† Python linting warnings (non-blocking)${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö† ruff not installed, skipping Python lint${NC}"
    fi
else
    echo -e "${GREEN}‚úì No Python files to check${NC}"
fi

# 5. Check for large files
echo -e "\n${YELLOW}5. Checking file sizes...${NC}"
LARGE_FILES=0
for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file")
        if [ $SIZE -gt 1048576 ]; then  # 1MB
            echo -e "${RED}‚úó $file is larger than 1MB ($SIZE bytes)${NC}"
            LARGE_FILES=1
        fi
    fi
done

if [ $LARGE_FILES -eq 0 ]; then
    echo -e "${GREEN}‚úì All files are under size limit${NC}"
else
    FAILED=1
fi

# 6. Check for TODO/FIXME in critical files
echo -e "\n${YELLOW}6. Checking for unresolved TODOs in critical paths...${NC}"
CRITICAL_PATHS="apps/services/ shared/python-lib/"
TODO_FOUND=0
for path in $CRITICAL_PATHS; do
    for file in $(git diff --cached --name-only --diff-filter=ACM | grep "^$path" || true); do
        if [ -f "$file" ]; then
            if grep -n "TODO\|FIXME\|XXX\|HACK" "$file" 2>/dev/null | head -3; then
                echo -e "${YELLOW}‚ö† TODOs found in $file${NC}"
                TODO_FOUND=1
            fi
        fi
    done
done

if [ $TODO_FOUND -eq 0 ]; then
    echo -e "${GREEN}‚úì No critical TODOs found${NC}"
fi

# Final result
echo -e "\n${'='*50}"
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}‚ùå Pre-commit checks failed${NC}"
    echo -e "Fix the issues above and try again."
    exit 1
else
    echo -e "${GREEN}‚úÖ All pre-commit checks passed${NC}"
    exit 0
fi
